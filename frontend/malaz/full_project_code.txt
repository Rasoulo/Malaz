
// =======================================================
// FILE PATH: lib\core\config\color\app_color.dart
// =======================================================

import 'package:flutter/material.dart';

class AppColors {
  static const Color primaryDark = Color(0xFFEDB95E);
  static const Color primaryLight = Color(0xFFC59232);

  static const Color secondaryDark = Color(0xFF3D3D3D);
  static const Color secondaryLight = Color(0xFF909090);

  static const Color accent = Color(0x2DFFE1ED);
  static const tertiary = Colors.blue;

  static const Color backgroundLight = Color(0xFFFFFCF3);
  static const Color backgroundDark = Color(0xFF1B1A1A);

  static const Color surfaceLight = Color(0xFFFFFFFF);
  static const Color surfaceDark = Color(0xFF2D2C2C);

  static const Color textPrimaryLight = Color(0xFF2C2420);
  static const Color textSecondaryLight = Color(0xFF8D7F7D);
  static const Color textPrimaryDark = Color(0xFFF5E6D3);
  static const Color textSecondaryDark = Color(0xFFA1887F);

  static const Color error = Color(0xFFD32F2F);

  static const LinearGradient premiumGoldGradient = LinearGradient(
    colors: [Color(0xFFFFCD71), Color(0xFFDCC18A)],
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
  );

  static const LinearGradient premiumGoldGradient2 = LinearGradient(
    colors: [Color(0xFFC69B4B), Color(0xFFFFCD71)],
    begin: Alignment.topLeft,
    end: Alignment.bottomRight,
  );
}
// =======================================================
// FILE PATH: lib\core\config\routes\app_routes.dart
// =======================================================

// core/config/routes
import 'dart:async';

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:malaz/presentation/cubits/auth/auth_cubit.dart';
import 'package:malaz/presentation/screens/auth/my_profile/screen/my_profile_screen.dart';
import 'package:malaz/presentation/screens/auth/register/home_register_screen.dart';
import 'package:malaz/presentation/screens/chats/ChatWithAPerson.dart';
import 'package:malaz/presentation/screens/details/details_screen.dart';
import 'package:malaz/presentation/screens/favorites/favorites_screen.dart';
import 'package:malaz/presentation/screens/property/add_property.dart';
import 'package:malaz/presentation/screens/splash_screen/splash_screen.dart';
import 'package:malaz/presentation/screens/auth/login/login_screen.dart';
import 'package:malaz/presentation/screens/main_wrapper/main_wrapper.dart'; // الشاشة الرئيسية
import 'package:malaz/presentation/screens/settings/settings_screen.dart';
import 'package:path/path.dart';

import '../../../domain/entities/apartment/apartment.dart';
import '../../../presentation/screens/auth/reset_password_screen/ResetPasswordScreen.dart';
import '../../../presentation/screens/auth/under_review/under_review.dart';
import '../../service_locator/service_locator.dart';

final GlobalKey<NavigatorState> _rootNavigatorKey = GlobalKey<NavigatorState>();

/// *[GoRouter]
/// GoRouter is a package for Flutter that makes navigation easier.
/// It uses URLs (like a website) to manage your app's screens.
///
/// *[Features_of_GoRouter]:
/// 1.  URL-based Navigation: You define a path (like '/home' or '/details/1') for each screen.
/// 2.  Handles Platform Back Button: It correctly handles the back button on Android and web.
/// 3.  Passing Parameters: You can easily pass data to your routes, either in the path ('/user/:id') or as an [extra] object.
/// 4.  Deep Linking: Allows users to open a specific screen in your app from a URL link.
///
/// *[How_to_use_it]:
/// 1.  [initialLocation]: This is the first route the app will show, usually '/'.
/// 2.  [routes]: This is a list of [GoRoute] objects. Each [GoRoute] defines a screen.
/// 3.  [GoRoute]:
///     - [path]: The URL-like string for the screen.
///     - [name]: An optional, unique name for the route. You can navigate using this name.
///     - [builder]: A function that returns the widget (screen) for this route.
///
/// *[Adding_a_route_WITHOUT_parameters]:
/// This is a simple route. When you navigate to '/settings', it shows the [SettingsScreen].
/// GoRoute(path: '/settings', name: 'settings', builder: (context, state) => const SettingsScreen()),
/// To navigate to it: `context.go('/settings')` or `context.goNamed('settings')`
///
/// *[Adding_a_route_WITH_parameters]:
/// In this example, we pass an [Apartment] object to the [details] screen using the [extra] property.
/// GoRoute(path: '/details', name: 'details', builder: (context, state) => DetailsScreen(apartment: state.extra as Apartment)),
/// To navigate to it: `context.go('/details', extra: myApartmentObject)`
/// :)

final AuthCubit authCubit = sl<AuthCubit>();
GoRouter buildAppRouter() {
  return GoRouter(
    initialLocation: '/',
    refreshListenable: GoRouterRefreshStream(authCubit.stream),
    redirect: (context, state) {
      final authState = authCubit.state;

      final goingToLogin = state.matchedLocation == '/login';
      final goingToRegister = state.matchedLocation == '/home_register';
      final goingToPending = state.matchedLocation == '/pending';
      final goingToSplash = state.matchedLocation == '/';

      /// 1️⃣ أثناء التحميل أو البداية → Splash
      if (authState is AuthInitial) {
        return goingToSplash ? null : '/';
      }

      /// 2️⃣ PENDING له أولوية مطلقة
      else if (authState is AuthPending) {
        return goingToPending ? null : '/pending';
      }

      /// 3️⃣ Authenticated
      else if (authState is AuthAuthenticated) {
        if (goingToLogin || goingToRegister || goingToSplash || goingToPending) {
          return '/home';
        }
        return null;
      }

      /// 4️⃣ Unauthenticated / Error
      else if (authState is AuthUnauthenticated || authState is AuthError) {
        return (goingToLogin || goingToRegister) ? null : '/login';
      }

      return null;
    },

    routes: [
      GoRoute(
        path: '/',
        name: 'splash',
        builder: (context, state) => const SplashScreen(),
      ),

      GoRoute(
          path: '/login',
          name: 'login',
          builder: (context, state) => LoginScreen(formKey: GlobalKey<FormState>()),
          pageBuilder: (context, state) => CustomTransitionPage(
            key: state.pageKey,
            child: LoginScreen(formKey: GlobalKey<FormState>()),
            transitionsBuilder:
                (context, animation, secondaryAnimation, child) {
              return FadeTransition(opacity: animation, child: child);
            },
          ),
      ),

      GoRoute(
        path: '/home',
        name: 'home',
        builder: (context, state) => const MainWrapper(),
      ),

      GoRoute(
        path: '/settings',
        name: 'settings',
        builder: (context, state) => const SettingsScreen(),
      ),

      GoRoute(
          path: '/details',
          name: 'details',
          builder: (context, state) {
            final apartment = state.extra as Apartment;
            return DetailsScreen(apartment: apartment);
          }
      ),

      GoRoute(
          path: '/home_register',
          name: 'home_register',
          builder: (context, state) => HomeRegisterScreen()
      ),

      GoRoute(
        path: '/pending',
        name: 'pending',
        builder: (context, state) => UnderReview(),
      ),

      GoRoute(
        path: '/profile',
        pageBuilder: (context, state) => CustomTransitionPage(
          key: state.pageKey,
          child: const MyProfileScreen(),
          transitionsBuilder: (context, animation, secondaryAnimation, child) {
            return FadeTransition(
              opacity: animation,
              child: SlideTransition(
                position: animation.drive(
                  Tween(begin: const Offset(0.1, 0), end: Offset.zero)
                      .chain(CurveTween(curve: Curves.easeOutCubic)),
                ),
                child: child,
              ),
            );
          },
        ),
      ),

      GoRoute(
        path: '/one_chat',
        name: 'one_chat',
        builder: (context, state) {
          final extras = state.extra as Map<String, dynamic>;

          return ChatWithAPerson(
            conversationId: extras['id'] as int,
            firstName: extras['firstName'] as String,
            lastName: extras['lastName'] as String,
            otherUserId: extras['otherUserId'] as int,
          );
        },
      ),

      GoRoute(
        path: '/reset-password',
        builder: (context, state) => ResetPasswordScreen(phoneNumber: state.extra as String),
      ),

      GoRoute(
        path: '/favorites',
        builder: (context, state) => FavoritesScreen(),
      ),
    ],
    errorBuilder: (context, state) => Scaffold(
      body: Center(
        child: Text('Page not found: ${state.error.toString()}'),
      ),
    ),
  );
}

class GoRouterRefreshStream extends ChangeNotifier {
  GoRouterRefreshStream(Stream stream) {
    notifyListeners();
    _subscription = stream.asBroadcastStream().listen((_) => notifyListeners());
  }

  late final StreamSubscription _subscription;
}

// =======================================================
// FILE PATH: lib\core\config\routes\route_info.dart
// =======================================================

/// TODO: link with app routes required
class RouteNames {
  static const String splash = 'splash';
  static const String login = 'login';
  static const String register = 'register';
  static const String mainWrapper = 'main_wrapper';
  static const String settings = 'settings';
  static const String details = 'details';
  static const String addProperty = 'add_property';
}

class RoutePaths {
  static const String splash = '/';
  static const String login = '/login';
  static const String register = '/register';
  static const String mainWrapper = '/main';
  static const String settings = '/settings';
  static const String details = '/details';
  static const String addProperty = '/add_property';
}
// =======================================================
// FILE PATH: lib\core\config\theme\app_theme.dart
// =======================================================


import 'package:flutter/material.dart';
import '../color/app_color.dart';

class AppTheme {
  AppTheme._();

  static ThemeData get lightTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.light,
      primaryColor: AppColors.primaryLight,
      scaffoldBackgroundColor: AppColors.backgroundLight,
      colorScheme: const ColorScheme.light(
        primary: AppColors.primaryLight,
        secondary: AppColors.secondaryLight,
        background: AppColors.backgroundLight,
        surface: AppColors.surfaceLight,
        error: AppColors.error,
        onPrimary: Colors.white,
        onSecondary: AppColors.textPrimaryLight,
        onBackground: AppColors.textPrimaryLight,
        onSurface: AppColors.textPrimaryLight,
        onError: Colors.white,
        tertiary: AppColors.tertiary,
      ),
    );
  }

  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      primaryColor: AppColors.primaryDark,
      scaffoldBackgroundColor: AppColors.backgroundDark,
      colorScheme: const ColorScheme.dark(
        primary: AppColors.primaryDark,
        secondary: AppColors.secondaryDark,
        background: AppColors.backgroundDark,
        surface: AppColors.surfaceDark,
        error: AppColors.error,
        onPrimary: Colors.white,
        onSecondary: AppColors.textPrimaryDark,
        onBackground: AppColors.textPrimaryDark,
        onSurface: AppColors.textPrimaryDark,
        onError: Colors.white,
        tertiary: AppColors.tertiary,
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\core\constants\app_constants.dart
// =======================================================

class AppConstants {
  static const baseurl = 'http://192.168.1.101:8000/api';
  static const baseurlForPusher = 'http://192.168.1.101:8000/broadcasting/auth';

  /// [SharedPreferences] Keys
  static const String themeKey = 'theme_mode';
  static const String languageKey = 'language_code';

  /// [Failure] Keys
  static const String networkFailureKey = 'NETWORK_FAILURE_KEY';
  static const String unknownFailureKey = 'UNKNOWN_FAILURE_KEY';
  static const String cancelledFailureKey = 'CANCELLED_FAILURE_KEY';

  /// [Authentication] Keys
  static const String tokenKey = 'CACHED_TOKEN';
  static const String userKey = 'CACHED_USER';
  static const String pendingKey = 'IS_PENDING';
  static const String phoneUserKey = 'USER_PHONE';
  static const String passwordUserKey = 'USER_PASSWORD';

  /// [Location] Key
  static const String locationKey = 'CACHED_LOCATION';

  /// [Requesting] keys
  static const numberOfApartmentsEachRequest = 2;
  static const numberOfReviewsEachRequest =  2;
  static const numberOfBookingEachRequest = 5;

  /// [Pusher] keys
  static const String apiKeyForPusher = 'c85e12264ff96015fc05';
  static const String clusterForPusher = 'ap2';

  /// [Logo] key
  static const String LogoPath = 'assets/icons/key_logo.png';

  static String userProfileImage(int userId) => "$baseurl/users/$userId/profile_image";
}
// =======================================================
// FILE PATH: lib\core\errors\error_handler.dart
// =======================================================

import 'package:dio/dio.dart';
import 'package:flutter/src/widgets/framework.dart';
import 'package:malaz/l10n/app_localizations.dart';
import 'package:path/path.dart';
import '../errors/exceptions.dart';

/// TODO: translate
class ErrorHandler {
  static Exception handle(DioException error) {
    switch (error.type) {
      case DioExceptionType.connectionTimeout:
      case DioExceptionType.sendTimeout:
      case DioExceptionType.receiveTimeout:
      case DioExceptionType.connectionError:
        return NetworkException();

      case DioExceptionType.badResponse:
        return _handleBadResponse(error.response);

      case DioExceptionType.cancel:
        return ServerException();

      default:
        return UnexpectedException();
    }
  }

  static Exception _handleBadResponse(Response? response) {
    if (response == null)
      return ServerException(message: 'Unknown server error');

    final statusCode = response.statusCode;
    final data = response.data;
    String message = 'Something went wrong';

    if (data is Map) {
      if (data.containsKey('message') && data['message'] != null) {
        message = data['message'].toString();
      } else if (data.containsKey('error') && data['error'] != null) {
        message = data['error'].toString();
      }
    }

    if (statusCode == 401) {
      return UnauthenticatedException(message);
    }

    if (statusCode == 403) {
      if (message.toLowerCase().contains('does not exist')) {
        return PhoneNotFoundException(message);
      }
    }
    if (statusCode == 422 && data is Map) {
      if (data.containsKey('errors')) {
        final errors = data['errors'];
        if (errors is Map && errors.isNotEmpty) {
          final firstErrorList = errors.values.first;
          if (firstErrorList is List && firstErrorList.isNotEmpty) {
            return ServerException(
                message: firstErrorList.first.toString(), statusCode: 422);
          }
        }
      }
      return ServerException(message: message, statusCode: 422);
    }


    if (statusCode != null && statusCode >= 500) {
      return ServerException(message: 'Server internal error', statusCode: 500);
    }

    return ServerException(message: message, statusCode: statusCode);
  }
}
// =======================================================
// FILE PATH: lib\core\errors\exceptions.dart
// =======================================================


/// Represents errors that occur during data fetching or processing.
class ServerException implements Exception {
  final String? message;
  final int? statusCode;
  final Map<String, dynamic>? errors;

  ServerException({
    this.message,
    this.statusCode,
    this.errors,
  });

  @override
  String toString() => message ?? 'server exception';
}
/// Represents errors that occur when there is no internet connection.
class NetworkException implements Exception {}

class UnexpectedException implements Exception {}

/// Represents errors that occur when there is no cached data available.
class CacheException implements Exception {
  final String message;
  CacheException(this.message);
  @override
  String toString() => message;
}

/// Can be used for other general exceptions.
class GeneralException implements Exception {}

class UnauthenticatedException implements Exception {
  final String message;
  UnauthenticatedException(this.message);
  @override
  String toString() => message;
}

/// This exception appears when the user is in a pending state,
/// meaning an account with that username and password already exists but has not yet been approved by the admin.
class InvalidCredentialsException implements Exception {
  final String message;
  InvalidCredentialsException(this.message);
  @override
  String toString() => message;
}

/// This exception appears when there is no account with that number entered by the user.
class PhoneNotFoundException implements Exception {
  final String? message;
  PhoneNotFoundException(this.message);
  @override
  String toString() => 'PhoneNotFoundException: ${message ?? ''}';
}

/// This exception appears when the password for the accompanying number is incorrect.
class WrongPasswordException implements Exception {
  final String? message;
  WrongPasswordException([this.message]);
  @override
  String toString() => 'WrongPasswordException: ${message ?? ''}';
}

class PendingApprovalException implements Exception {
  final String message;
  PendingApprovalException(this.message);

  @override
  String toString() => message;
}
// =======================================================
// FILE PATH: lib\core\errors\failures.dart
// =======================================================


import 'package:equatable/equatable.dart';

/// [Failure]
///
/// A base class for all failures. Failures are part of the domain layer.
/// the main purpose of it is to handle all exceptions and convert them to failures
/// [Failure] extends from [Equatable] to make [Failure] objects comparable you
/// can search for it
abstract class Failure extends Equatable {
  final String? message;
  const Failure([this.message]);

  @override
  List<Object?> get props => [message];
}

/// Represents a failure that occurs when communicating with a server.
class ServerFailure extends Failure {
  const ServerFailure(super.message);
}

/// Represents a failure that occurs when there is no internet connection.
class CacheFailure extends Failure {
  const CacheFailure(super.message);
}

/// Represents a failure that occurs when accessing cached data.
class OfflineFailure extends Failure {
  const OfflineFailure(super.message);
}

/// Represents other general failures.
class GeneralFailure extends Failure {
  const GeneralFailure([super.message]);
}

/// This failure appears when the user is in a pending state,
/// meaning an account with that username and password already exists but has not yet been approved by the admin.
class InvalidCredentialsFailure extends Failure {
  const InvalidCredentialsFailure(super.message);
}

/// This exception appears when there is no account with that number entered by the user.
class PhoneNotFoundFailure extends Failure {
  const PhoneNotFoundFailure([super.message]);
}

/// This exception appears when the password for the accompanying number is incorrect.
class WrongPasswordFailure extends Failure {
  const WrongPasswordFailure(super.message);
}

class PendingApprovalFailure extends Failure {
  const PendingApprovalFailure()
      : super('Wait until approved by the officials');
}

class NetworkFailure extends Failure {
  const NetworkFailure();
}

class UnauthenticatedFailure extends Failure {
  const UnauthenticatedFailure(super.message);
}

class UnexpectedFailure extends Failure {
  const UnexpectedFailure(super.message);
}
// =======================================================
// FILE PATH: lib\core\network\auth_interceptor.dart
// =======================================================

// core/network/auth_interceptor.dart
import 'package:dio/dio.dart';
import 'package:malaz/data/datasources/local/auth/auth_local_data_source.dart';

class AuthInterceptor extends Interceptor {
  final AuthLocalDatasource localDatasource;

  AuthInterceptor({required this.localDatasource});

  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) async {
    try {
      final token = await localDatasource.getCachedToken();
      print('token is $token');
      if (token != null && token.isNotEmpty) {
        options.headers['Authorization'] = 'Bearer $token';
      }
    } catch (e) {
      /// ignore caching errors here
    }
    handler.next(options);
  }
}

// =======================================================
// FILE PATH: lib\core\network\network_info.dart
// =======================================================

// core/network/network_info.dart
import 'package:internet_connection_checker/internet_connection_checker.dart';

abstract class NetworkInfo {
  Future<bool> get isConnected;
}

class NetworkInfoImpl implements NetworkInfo {
  final InternetConnectionChecker connectionChecker;

  NetworkInfoImpl(this.connectionChecker);

  @override
  Future<bool> get isConnected => connectionChecker.hasConnection;
}
// =======================================================
// FILE PATH: lib\core\network\network_service.dart
// =======================================================



import 'package:dio/dio.dart';

/// [NetWorkService]
///
/// Controls the dealing with dio.
/// why this is useful ? if we need to change any thing about network and we use
/// network queries over 50 places in the project we can only change it here and
/// it's automatically updated in all places.
/// *[baseUrl]
/// - on physical phone = http://10.0.2.2:your_lab_ib/api
/// - on android emulator a= http://10.0.2.2:8000/pi
/// *[crucial_notes] :
/// - do not commit this file after hamwi's commit
/// - put your baseurl according to your situation
/// :)

import '../constants/app_constants.dart';
import '../errors/error_handler.dart';
import '../errors/exceptions.dart';
import 'auth_interceptor.dart';
abstract class NetworkService {
  Future<Response> get(String endpoint, {Map<String, dynamic>? queryParameters});
  Future<Response> post(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters});
  Future<Response> put(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters});
  Future<Response> delete(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters});
  Future<Response> patch(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters});
}
//const baseurl = 'http://192.168.1.102:8000/api/users/'; // ! this baseurl works only for hamwi
class NetworkServiceImpl implements NetworkService {
  final Dio _dio;
  final AuthInterceptor interceptor;

  NetworkServiceImpl(this.interceptor)
      : _dio = Dio(
    BaseOptions(
      baseUrl: AppConstants.baseurl,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      validateStatus: (status) => status != null && status < 500,
      followRedirects: false,
      receiveTimeout: const Duration(seconds: 30),
      connectTimeout: const Duration(seconds: 30),
    ),
  ) {
    _dio.interceptors.add(interceptor);
  }

  @override
  Future<Response> get(String endpoint, {Map<String, dynamic>? queryParameters}) async {
    try {
      final response = await _dio.get(endpoint, queryParameters: queryParameters);
      return response;
    } on DioException catch (e) {
      throw ErrorHandler.handle(e);
    }
  }

  @override
  Future<Response> post(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters}) async {
    try {
      final response = await _dio.post(endpoint, data: data, queryParameters: queryParameters);
      return response;
    } on DioException catch (e) {
      throw ErrorHandler.handle(e);
    }
  }

  @override
  Future<Response> put(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters}) async {
    try {
      final response = await _dio.put(endpoint, data: data, queryParameters: queryParameters);
      return response;
    } on DioException catch (e) {
      throw ErrorHandler.handle(e);
    }
  }

  @override
  Future<Response> delete(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters}) async {
    try {
      final response = await _dio.delete(endpoint, data: data, queryParameters: queryParameters);
      return response;
    } on DioException catch (e) {
      throw ErrorHandler.handle(e);
    }
  }
  @override
  Future<Response> patch(String endpoint, {dynamic data, Map<String, dynamic>? queryParameters}) async {
    try {
      final response = await _dio.patch(endpoint, data: data, queryParameters: queryParameters);

      if (response.statusCode != 200 && response.statusCode != 201) {
        throw DioException(
          requestOptions: response.requestOptions,
          response: response,
          type: DioExceptionType.badResponse,
        );
      }

      return response;
    } on DioException catch (e) {
      throw ErrorHandler.handle(e);
    } catch (e) {
      throw UnexpectedException();
    }
  }
}

// =======================================================
// FILE PATH: lib\core\service_locator\service_locator.dart
// =======================================================

import 'package:get_it/get_it.dart';
import 'package:internet_connection_checker/internet_connection_checker.dart';
import 'package:location/location.dart';
import 'package:malaz/data/datasources/local/auth/auth_local_data_source.dart';
import 'package:malaz/data/datasources/remote/booking/booking_remote_data_source.dart';
import 'package:malaz/data/datasources/remote/favorites/favorites_remote_datasource.dart';
import 'package:malaz/data/datasources/remote/review/review_remote_data_source.dart';
import 'package:malaz/data/repositories/auth/auth_repository_impl.dart';
import 'package:malaz/data/repositories/booking/booking_repository_impl.dart';
import 'package:malaz/data/repositories/review/review_repository_impl.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';
import 'package:malaz/domain/repositories/booking/booking_repository.dart';
import 'package:malaz/domain/repositories/review/review_repository.dart';
import 'package:malaz/domain/usecases/auth/check_auth_usecase.dart';
import 'package:malaz/domain/usecases/auth/get_current_user_usecase.dart';
import 'package:malaz/domain/usecases/auth/login_usecase.dart';
import 'package:malaz/domain/usecases/auth/logout_usecase.dart';
import 'package:malaz/domain/usecases/booking/Get_Booked_Dates_Use_Case.dart';
import 'package:malaz/domain/usecases/booking/make_book_use_case.dart';
import 'package:malaz/domain/usecases/booking/update_status_use_case.dart';
import 'package:malaz/domain/usecases/review/get_review_use_case.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:dio/dio.dart';

import '../../data/datasources/local/location/location_local_data_source.dart';
import '../../data/datasources/remote/apartment/apartment_remote_data_source.dart';
import '../../data/datasources/remote/auth/auth_remote_datasource.dart';
import '../../data/datasources/remote/chat/chat_remote_datasource.dart';
import '../../data/datasources/remote/location/location_remote_data_source.dart';
import '../../data/repositories/apartment/apartment_repository_impl.dart';
import '../../data/repositories/chat/chat_repository_impl.dart';
import '../../data/repositories/favorites/favorites_repository_impl.dart';
import '../../data/repositories/location/location_repository_impl.dart';
import '../../domain/repositories/apartment/apartment_repository.dart';
import '../../domain/repositories/chat/chat_repository.dart';
import '../../domain/repositories/favorites/favorites_repository.dart';
import '../../domain/repositories/location/location_repository.dart';
import '../../domain/usecases/apartment/add_apartment_use_case.dart';
import '../../domain/usecases/apartment/my_apartment_use_case.dart';
import '../../domain/usecases/auth/send_otp_usecase.dart';
import '../../domain/usecases/auth/verify_otp_usecase.dart';
import '../../domain/usecases/auth/register_usecase.dart';
import '../../domain/usecases/booking/My_booking_usecase.dart';
import '../../domain/usecases/booking/all_booking_use_case.dart';
import '../../domain/usecases/booking/update_Booking_Date.dart';
import '../../domain/usecases/favorites/add_favorites_use_case.dart';
import '../../domain/usecases/favorites/delete_favorites_use_case.dart';
import '../../domain/usecases/favorites/get_favorites_use_case.dart';
import '../../domain/usecases/home/apartments_use_case.dart';
import '../../domain/usecases/location/get_current_location_usecase.dart';
import '../../domain/usecases/location/load_saved_location_usecase.dart';
import '../../domain/usecases/location/update_manual_location_usecase.dart';
import '../../domain/usecases/review/add_review_usecase.dart';
import '../../presentation/cubits/auth/auth_cubit.dart';
import '../../presentation/cubits/booking/booking_cubit.dart';
import '../../presentation/cubits/booking/manage_booking.dart';
import '../../presentation/cubits/booking/my_booking.dart';
import '../../presentation/cubits/chat/chat_cubit.dart';
import '../../presentation/cubits/favorites/favorites_cubit.dart';
import '../../presentation/cubits/home/home_cubit.dart';
import '../../presentation/cubits/language/language_cubit.dart';
import '../../presentation/cubits/location/location_cubit.dart';
import '../../presentation/cubits/property/property_cubit.dart';
import '../../presentation/cubits/review/review_cubit.dart';
import '../../presentation/cubits/theme/theme_cubit.dart';
import '../network/auth_interceptor.dart';
import '../network/network_info.dart';
import '../network/network_service.dart';
import 'package:http/http.dart' as http;

/// [GetIt] / [service_locator]
///
/// It's a dependency injection framework for Dart.
/// Think of it as a "Magic Box" where we put our tools (Services/Classes)
/// to retrieve them later anywhere in the app without creating them again.
///
/// *[Definitions]:
/// - [Lazy]: Create the object ONLY when you ask for it (saves memory).
/// - [Singleton]: Create ONE instance and reuse it everywhere (like one fridge for the whole house).
/// - [Factory]: Create a NEW instance every time you ask (like a new plate for every customer).
///
/// *[how_to_use]:
///
/// Instead of creating objects manually like:
/// `final dio = Dio();`  <-- Don't do this!
///
/// You just ask the Service Locator:
/// `final dio = sl<Dio>();`  <-- Do this!
///
/// *[Services_Registered]:
/// - [sharedPreferences]: For caching simple data (Theme, Token, Language).
/// - [Dio]: For network requests (The advanced HTTP client).
/// - [InternetConnectionChecker]: To check if there is REAL internet access.
/// - [NetworkInfo]: To handle connection checks cleanly.
/// - [ThemeCubit]: To handle theme changes.
/// - [LanguageCubit]: To handle language changes.
/// :)

final sl = GetIt.instance;

Future<void> setUpServices() async {
  final sharedPreferences = await SharedPreferences.getInstance();
  sl.registerLazySingleton<SharedPreferences>(() => sharedPreferences);

  sl.registerLazySingleton<Dio>(() => Dio());
  sl.registerLazySingleton<http.Client>(() => http.Client());
  sl.registerLazySingleton<Location>(() => Location());

  sl.registerLazySingleton<NetworkService>(() => NetworkServiceImpl(sl()));


  sl.registerLazySingleton<InternetConnectionChecker>(
          () => InternetConnectionChecker());

  sl.registerLazySingleton<NetworkInfo>(() => NetworkInfoImpl(sl()));

  sl.registerFactory(() => ThemeCubit(sl()));

  sl.registerFactory(() => LanguageCubit(sl()));

  sl.registerFactory(() => BookingCubit(sl<GetBookedDatesUseCase>(), sl<MakeBookUseCase>(),));
  sl.registerFactory(() => ReviewsCubit(sl(),sl()));

  sl.registerFactory(() => ManageBookingCubit(
    sl<GetUserBooking>(),
    sl<UpdateStatus>(),
  ));
  sl.registerFactory(() => MyBookingCubit(sl<GetMyBooking>(),sl<UpdateBookingUseCase>(),sl<UpdateStatus>(),));
  sl.registerFactory(() => HomeCubit(getApartmentsUseCase: sl()));
  sl.registerLazySingleton(() => FavoritesCubit(getFavoritesUseCase: sl(),addFavoriteUseCase: sl(), deleteFavoriteUseCase: sl()));

  sl.registerLazySingleton(() => AddApartmentUseCase(sl()));

  sl.registerLazySingleton(() => GetMyApartmentsUseCase(sl()));

  sl.registerLazySingleton(() => GetApartmentsUseCase(sl()));

  sl.registerLazySingleton(() => UpdateBookingUseCase(sl()));

  sl.registerLazySingleton(() => GetMyBooking(sl()));

  sl.registerLazySingleton<GetReviewsUseCase>(() => GetReviewsUseCase(sl()));

  sl.registerLazySingleton<ReviewsRepository>(() => ReviewsRepositoryImpl(networkInfo: sl(), remoteDataSource:  sl()));

  sl.registerLazySingleton<ReviewsRemoteDataSource>(() => ReviewsRemoteDataSourceImpl(networkService: sl()));

  sl.registerLazySingleton<ApartmentRepository>(() => ApartmentRepositoryImpl(remoteDataSource: sl()));
  sl.registerLazySingleton<FavoritesRepository>(() => FavoritesRepositoryImpl(sl()));
  sl.registerLazySingleton<BookingRepository>(() => BookingRepositoryImpl(sl()));

  sl.registerFactory(() => AddApartmentCubit(addApartmentUseCase: sl()));

  sl.registerFactory(() => MyApartmentsCubit(getMyApartmentsUseCase: sl()));

  sl.registerLazySingleton<ApartmentRemoteDataSource>(() => ApartmentRemoteDataSourceImpl(networkService: sl()));

  sl.registerLazySingleton<AuthLocalDatasource>(() => AuthLocalDatasourceImpl(sl<SharedPreferences>()),);
  sl.registerLazySingleton<AuthRemoteDatasource>(() => AuthRemoteDatasourceImpl(networkService: sl()));

  sl.registerLazySingleton<AuthRepository>(() => AuthRepositoryImpl(
    authRemoteDatasource: sl(),
    authLocalDatasource: sl(),
  ));

  sl.registerLazySingleton<FavoritesRemoteDataSource>(() => FavoritesRemoteDataSourceImpl(sl()));
  sl.registerLazySingleton<BookingRemoteDataSource>(() => BookingRemoteDataSourceImpl(networkService: sl()));

  sl.registerLazySingleton(() => RegisterUsecase(repository: sl()));
  sl.registerLazySingleton(() => LoginUsecase(repository: sl()));
  sl.registerLazySingleton(() => LogoutUsecase(repository: sl()));
  sl.registerLazySingleton(() => GetCurrentUserUsecase(repository: sl()));
  sl.registerLazySingleton(() => CheckAuthUsecase(repository: sl()));
  sl.registerLazySingleton(() => SendOtpUsecase(sl()));
  sl.registerLazySingleton(() => VerifyOtpUsecase(sl()));
  sl.registerLazySingleton(() => GetFavoritesUseCase(sl()));
  sl.registerLazySingleton(() => AddFavoriteUseCase(sl()));
  sl.registerLazySingleton(() => DeleteFavoriteUseCase(sl()));
  sl.registerLazySingleton(() => GetBookedDatesUseCase(sl()));
  sl.registerLazySingleton(() => MakeBookUseCase(sl()));
  sl.registerLazySingleton(() => GetUserBooking(sl()));
  sl.registerLazySingleton(() => UpdateStatus(sl()));
  sl.registerLazySingleton(() => AuthInterceptor(localDatasource: sl()));
  sl.registerLazySingleton<AddReviewsUseCase>(() => AddReviewsUseCase(sl()));
  sl.registerLazySingleton<AuthCubit>(() => AuthCubit(
    repository: sl<AuthRepository>(),
    loginUsecase: sl(),
    logoutUsecase: sl(),
    getCurrentUserUsecase: sl(),
    checkAuthUsecase: sl(),
    registerUsecase: sl(),
    sendOtpUsecase: sl(),
    verifyOtpUsecase: sl(),
  ));


  sl.registerLazySingleton<ChatRemoteDataSource>(() => ChatRemoteDataSourceImpl(networkService: sl()),);
  sl.registerLazySingleton<ChatRepository>(() => ChatRepositoryImpl(remoteDataSource: sl()),);
  sl.registerFactory(() => ChatCubit(repository: sl()));

  sl.registerLazySingleton<LocationLocalDataSource>(() => LocationLocalDataSourceImpl(sharedPreferences: sl()));
  sl.registerLazySingleton<LocationRemoteDataSource>(
        () => LocationRemoteDataSourceImpl(
      location: sl<Location>(),
      client: sl<http.Client>(),
    ),
  );
  sl.registerLazySingleton<LocationRepository>(() => LocationRepositoryImpl(
    remoteDataSource: sl(),
    localDataSource: sl(),
  ));

  sl.registerLazySingleton(() => GetCurrentLocationUseCase(sl()));
  sl.registerLazySingleton(() => LoadSavedLocationUseCase(sl()));
  sl.registerLazySingleton(() => UpdateManualLocationUseCase(sl()));
  sl.registerFactory(() => LocationCubit(
    getCurrentLocationUseCase: sl(),
    loadSavedLocationUseCase: sl(),
    updateManualLocationUseCase: sl(),
  ));
}
// =======================================================
// FILE PATH: lib\core\usecases\usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';

import '../errors/failures.dart';

abstract class UseCase<Type,Params>{
  Future<Either<Failure, Type>> call(Params params);
}

class  NoParams {}
// =======================================================
// FILE PATH: lib\data\datasources\local\auth\auth_local_data_source.dart
// =======================================================

import 'dart:convert';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:malaz/data/models/user/user_model.dart';
import 'package:shared_preferences/shared_preferences.dart';

import '../../../../domain/entities/user/user_entity.dart';

abstract class AuthLocalDatasource {
  Future<void> cacheToken(String token);
  Future<String?> getCachedToken();
  Future<void> clearToken();

  Future<void> cacheUser(UserEntity user);
  Future<UserEntity?> getCachedUser();
  Future<void> clearUser();

  Future<void> setPending(bool value);
  Future<bool> isPending();

  Future<void> clearAll();
}

class AuthLocalDatasourceImpl implements AuthLocalDatasource {
  final SharedPreferences _prefs;

  AuthLocalDatasourceImpl(this._prefs);

  // -------- TOKEN --------

  @override
  Future<void> cacheToken(String token) async {
    await _prefs.setString(AppConstants.tokenKey, token);
  }

  @override
  Future<String?> getCachedToken() async {
    return _prefs.getString(AppConstants.tokenKey);
  }

  @override
  Future<void> clearToken() async {
    await _prefs.remove(AppConstants.tokenKey);
  }

  // -------- USER --------

  @override
  Future<void> cacheUser(UserEntity user) async {
    final userModel = UserModel.fromEntity(user);
    await _prefs.setString(AppConstants.userKey, jsonEncode(userModel.toJson()));
  }

  @override
  Future<UserEntity?> getCachedUser() async {
    final jsonString = _prefs.getString(AppConstants.userKey);
    if (jsonString == null || jsonString.isEmpty) return null;

    try {
      final Map<String, dynamic> userMap = jsonDecode(jsonString);
      return UserModel.fromJson(userMap);
    } catch (e) {
      await clearUser();
      return null;
    }
  }

  @override
  Future<void> clearUser() async {
    await _prefs.remove(AppConstants.userKey);
  }

  // -------- PENDING --------

  @override
  Future<void> setPending(bool value) async {
    await _prefs.setBool(AppConstants.pendingKey, value);
  }

  @override
  Future<bool> isPending() async {
    return _prefs.getBool(AppConstants.pendingKey) ?? false;
  }

  // -------- CLEAR ALL --------

  @override
  Future<void> clearAll() async {
    await Future.wait([
      _prefs.remove(AppConstants.tokenKey),
      _prefs.remove(AppConstants.userKey),
      _prefs.remove(AppConstants.locationKey),
      _prefs.setBool(AppConstants.pendingKey, false),
    ]);
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\local\location\location_local_data_source.dart
// =======================================================

import 'dart:convert';
import 'package:shared_preferences/shared_preferences.dart';
import '../../../../../core/constants/app_constants.dart';
import '../../../../domain/entities/location/location_entity.dart';
import '../../../models/location/location_model.dart';

abstract class LocationLocalDataSource {
  Future<void> cacheLocation(LocationModel location);

  Future<LocationEntity?> getCachedLocation();
}

class LocationLocalDataSourceImpl implements LocationLocalDataSource {
  final SharedPreferences sharedPreferences;

  LocationLocalDataSourceImpl({required this.sharedPreferences});

  @override
  Future<void> cacheLocation(LocationModel location) async {
    final jsonString = json.encode(location.toJson());
    await sharedPreferences.setString(AppConstants.locationKey, jsonString);
  }

  @override
  Future<LocationEntity?> getCachedLocation() async {
    final jsonString = sharedPreferences.getString(AppConstants.locationKey);

    print('>>>>>>>>>>${jsonString}');
    if (jsonString != null) {
      try {
        final Map<String, dynamic> jsonMap = json.decode(jsonString);

        return LocationModel.fromJson(jsonMap);
      } catch (e) {
        return null;
      }
    }
    return null;
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\remote\apartment\apartment_remote_data_source.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:dio/dio.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/domain/entities/filters/filters.dart';
import 'package:path/path.dart';
import '../../../../core/constants/app_constants.dart';
import '../../../../core/errors/exceptions.dart';
import '../../../../core/network/network_service.dart';
import '../../../../domain/entities/apartment/apartments_list.dart';
import '../../../models/apartment/apartment_model.dart';

abstract class ApartmentRemoteDataSource {
  Future<ApartmentsList> getApartments({String? cursor, Filter? filter});
  Future<Unit> addApartment({
    required String title,
    required int price,
    required String city,
    required String governorate,
    required String address,
    required String description,
    required String type,
    required int rooms,
    required int bathrooms,
    required int bedrooms,
    required int area,
    required List <XFile> mainImageUrl,
    required XFile main_pic,
    required double latitude,
    required double longitude,
  });
  Future<ApartmentsList> getMyApartments({String? cursor});
}
class ApartmentRemoteDataSourceImpl implements ApartmentRemoteDataSource {
  final NetworkService networkService;
  ApartmentRemoteDataSourceImpl({required this.networkService});

  @override
  Future<ApartmentsList> getApartments({String? cursor, Filter? filter}) async {
    Map<String, dynamic> queryParams = {
      'per_page': AppConstants.numberOfApartmentsEachRequest,
      'cursor': cursor,
    };

    if (filter != null) {
      queryParams.addAll(filter.toMap());
    }

    final response = await networkService.get(
      '/properties/all',
      queryParameters: queryParams,
    );

    List<ApartmentModel> apartments = [];
    if (response.data['data'] != null) {
      print('data : ${response.data['data']}');
      apartments = List<ApartmentModel>.from(
        (response.data['data'] as List).map((e) => ApartmentModel.fromJson(e)),
      );
    } else {
      print('what happened ? ${response.data['message']}');
    }

    String? nextCursor;
    String? prevCursor;


    if (response.data['meta'] != null) {
      nextCursor = response.data['meta']['next_cursor'];
      prevCursor = response.data['meta']['prev_cursor'];
      print('in datasource nextCursor : $nextCursor');
    } else {
      print('what happened ? meta is null and ${response.data['message']}');
    }

    print('apartments : $apartments');
    return ApartmentsList(
      apartments: apartments,
      nextCursor: nextCursor,
      prevCursor: prevCursor,
    );
  }

  @override
  Future<ApartmentsList> getMyApartments({String? cursor}) async {
    print('cursor sent $cursor');
    final response = await networkService.get(
      '/properties/all/my',
      queryParameters: {
        'per_page': AppConstants.numberOfApartmentsEachRequest,
        'cursor': cursor,
      },
    );
    List<ApartmentModel> apartments = [];
    if (response.data['data'] != null) {
      print('data : ${response.data['data']}');
      apartments = List<ApartmentModel>.from(
        (response.data['data'] as List).map((e) => ApartmentModel.fromJson(e)),
      );
    } else {
      print('what happened ? ${response.data['message']}');
    }

    String? nextCursor;
    String? prevCursor;


    if (response.data['meta'] != null) {
      nextCursor = response.data['meta']['next_cursor'];
      prevCursor = response.data['meta']['prev_cursor'];
      print('in datasource nextCursor : $nextCursor');
    } else {
      print('what happened ? meta is null and ${response.data['message']}');
    }


    print('apartments : $apartments');
    return ApartmentsList(
      apartments: apartments,
      nextCursor: nextCursor,
      prevCursor: prevCursor,
    );
  }


  @override
  Future<Unit> addApartment({
    required String title,
    required int price,
    required String city,
    required String governorate,
    required String address,
    required String description,
    required String type,
    required int rooms,
    required int bathrooms,
    required int bedrooms,
    required int area,
    required List<XFile> mainImageUrl,
    required XFile main_pic,
    required double latitude,
    required double longitude
  })async {
    final endpoint='/properties';

    try{
      final formData=FormData.fromMap({
        'title': title,
        'price': price,
        'city': city,
        'governorate': governorate,
        'address': address,
        'description': description,
        'type': type,
        'number_of_rooms': rooms,
        'number_of_baths': bathrooms,
        'number_of_bedrooms': bedrooms,
        'area': area,
        'images[]': await Future.wait(
          mainImageUrl.map((image) async {
            return await MultipartFile.fromFile(
              image.path,
              filename: basename(image.path),
            );
          }).toList(),
        ),
        "main_pic": await MultipartFile.fromFile(
          main_pic.path,
          filename:main_pic.path,
        ),
        'latitude': latitude.toString(),
        'longitude': longitude.toString(),
      });
      final response = await networkService.post(
        endpoint,
        data: formData,
      );

      if (response.data['status'] == 200 || response.data['status'] == "success") {
        return unit;
      } else {
        throw ServerException(message: response.data['message']);
      }
    }
    catch (e, stack) {
      print('ADD PROPERTY ERROR: $e');
      print(stack);
      rethrow;}
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\remote\auth\auth_remote_datasource.dart
// =======================================================

import 'package:dio/dio.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:malaz/core/errors/exceptions.dart';
import 'package:path/path.dart';

import '../../../../core/network/network_service.dart';
import '../../../models/user/user_model.dart';

abstract class AuthRemoteDatasource {
  Future<Map<String, dynamic>> login({
    required String phone,
    required String password,
  });
  Future<Map<String, dynamic>> registerUser({
    required String phone,
    required String role,
    required String firstName,
    required String lastName,
    required String password,
    required String passwordConfirmation,
    required String dateOfBirth,
    required XFile profileImage,
    required XFile identityImage,
  });
  Future<void> logout();
  Future<void> sendOtp({required String phone});
  Future<Map<String, dynamic>> verifyOtp({required String phone, required String otp});
  Future<UserModel> updateProfile(FormData formData);
  Future<Map<String, dynamic>> sendPasswordResetOtp(String phone);
  Future<Map<String, dynamic>> updatePassword({
    required String phone,
    required String otp,
    required String newPassword,
  });
}

class AuthRemoteDatasourceImpl implements AuthRemoteDatasource {
  final NetworkService networkService;

  AuthRemoteDatasourceImpl({required this.networkService});

  @override
  Future<Map<String, dynamic>> registerUser({
    required String phone,
    required String role,
    required String firstName,
    required String lastName,
    required String password,
    required String passwordConfirmation,
    required String dateOfBirth,
    required XFile profileImage,
    required XFile identityImage,
  }) async {
    final endpoint = '/users/register';

    try {
      final formData = FormData.fromMap({
        'phone': phone,
        'role': role,
        'first_name': firstName,
        'last_name': lastName,
        'password': password,
        'password_confirmation': passwordConfirmation,
        'date_of_birth': dateOfBirth,
        'profile_image': await MultipartFile.fromFile(
          profileImage.path,
          filename: basename(profileImage.path),
        ),
        'identity_card_image': await MultipartFile.fromFile(
          identityImage.path,
          filename: basename(identityImage.path),
        ),
      });

      final response = await networkService.post(
        endpoint,
        data: formData,
      );
      return response.data as Map<String, dynamic>;
    } catch (e, stack) {
      print('REGISTER ERROR: $e');
      print(stack);
      rethrow;
    }
  }

  @override
  Future<Map<String, dynamic>> login({
    required String phone,
    required String password,
  }) async {
    final endpoint = '/users/login';

    final response = await networkService.post(
      endpoint,
      data: {'phone': phone, 'password': password},
    );

    print('phone number : ${response.data['user']['phone']}');

    final data = response.data;
    if(data == null) {
      print('null data found');
    } else {
      print('tokem from data source ${data['access_token']}');
      print('status code ${response.statusCode}');
    }
    String? message = data is Map<String, dynamic> ? data['message']?.toString() : null;

    if (response.statusCode == 200 && data['data'] != null) {
      return data;
    }

    /// TODO: merge to error handler
    if (message != null && message.toLowerCase().contains('wait until')) {
      throw PendingApprovalException(message);
    }

    if (data['access_token'] != null) {
      print('i am in');
      if(data == null) {
        print('i am out');
      } else {
        print('not null');
      }
      return data;
    }

    if (message != null && message.toLowerCase().contains('does not exist')) {
      throw PhoneNotFoundException(message);
    }

    if (message != null && message.toLowerCase().contains('invalid credentials')) {
      throw WrongPasswordException(message);
    }

    return data;
  }

  @override
  Future<void> logout() async {
    await networkService.post('/users/logout');
  }

  @override
  Future<void> sendOtp({required String phone}) async {
    try {
      final url = '${AppConstants.baseurl}/users/send-otp';
      final response = await networkService.post(url, queryParameters: {'phone': phone});
      if (response.statusCode == 200 || response.statusCode == 201) {
        return;
      } else {
        throw ServerException(message: 'sendOtp failed: ${response.statusCode}');
      }
    } catch (e) {
      print(e.toString());
      rethrow;
    }
  }

  @override
  Future<Map<String, dynamic>> verifyOtp({required String phone, required String otp}) async {
    try {
      final url = '${AppConstants.baseurl}/users/verify-otp';
      final response = await networkService.post(url, queryParameters: {'phone': phone, 'otp': otp});
      return response.data as Map<String, dynamic>;
    } catch (e) {
      rethrow;
    }
  }

  @override
  Future<UserModel> updateProfile(FormData formData) async {
    try {
      final response = await networkService.post(
        '/users/request-update',
        data: formData,
      );

      if (response.data != null) {
        return UserModel.fromJson(response.data['data'] ?? response.data);
      } else {
        throw ServerException(message: 'No Data');
      }
    } on DioException catch (e) {
      final errorMessage = e.response?.data['message'];
      throw ServerException(message: errorMessage);
    } catch (e) {
      throw ServerException(message: e.toString());
    }
  }

  @override
  Future<Map<String, dynamic>> sendPasswordResetOtp(String phone) async {
    try {
      final response = await networkService.post(
        '/users/send-otppassword',
        data: {'phone': phone},
      );
      return response.data;
    } catch (e) {
      rethrow;
    }
  }

  @override
  Future<Map<String, dynamic>> updatePassword({
    required String phone,
    required String otp,
    required String newPassword,
  }) async {
    try {
      final response = await networkService.post(
        '/users/change-password',
        data: {
          'phone': phone,
          'otp': otp,
          'new_password': newPassword,
          'new_password_confirmation': newPassword,
        },
      );
      return response.data;
    } catch (e) {
      rethrow;
    }
  }
}

// =======================================================
// FILE PATH: lib\data\datasources\remote\booking\booking_remote_data_source.dart
// =======================================================

import '../../../../core/network/network_service.dart';
import '../../../../domain/entities/booking/booking.dart';
import '../../../../domain/entities/booking/booking_list.dart';
import '../../../models/booking/booking_model.dart';

abstract class BookingRemoteDataSource {
  Future<void> makeBooking(Booking booking);
  Future<List<BookingModel>> getBookedDates(int propertyId);
  Future<BookingList> fetchAllBookings(int userId);
  Future<void> UpdateStatus(int propertyId,String status);
  Future<BookingList> fetchMyBookings(int userId);
  Future<void> updateBookingDate(int bookingId, String checkIn, String checkOut);


}

class BookingRemoteDataSourceImpl implements BookingRemoteDataSource {
  final NetworkService networkService;

  BookingRemoteDataSourceImpl({required this.networkService});

  @override
  Future<void> makeBooking(Booking booking) async {
    final response = await networkService.post(
      '/bookings/store',
      queryParameters: {
        'property_id': booking.propertyId,
        'check_in': booking.checkIn.toString().split(' ')[0],
        'check_out': booking.checkOut.toString().split(' ')[0],
        'total_price': booking.totalPrice
      },
    );
  }

  @override
  Future<List<BookingModel>> getBookedDates(int propertyId) async {
    final response = await networkService.get(
      '/properties/all_booked/$propertyId',
    );

    final List data = response.data['data'];
    return data.map((e) => BookingModel.fromJson(e)).toList();
  }

  @override
  Future<BookingList> fetchAllBookings(int userId) async {
    final response = await networkService.get(
      "/bookings/owner/$userId",
    );

    List<BookingModel> bookings = [];
    if (response.data != null) {
      print('Server Response Data: ${response.data}');
      final List? rawData = response.data['bookings'];

      if (rawData != null) {
        bookings = rawData.map((e) => BookingModel.fromJson(e)).toList();
      }
    } else {
      print('No data found in response');
    }

    return BookingList(booking: bookings);
  }

  @override
  Future<void> UpdateStatus(int propertyId, String status) async {
    final response = await networkService.patch(
        '/bookings/update/$propertyId',
        queryParameters: {
          'status': status
        }
    );
    if (response.statusCode != 200 && response.statusCode != 201) {
      throw Exception(response.data['message'] ?? 'Failed to update status');
    }
    print('Update Status Success: ${response.data}');
  }

  Future<BookingList> fetchMyBookings(int userId) async {
    final response = await networkService.get(
      "/bookings/user/$userId",
    );
    List<BookingModel> bookings = [];

    if (response.data != null) {
      print('Server Response Data: ${response.data}');

      dynamic rawData = response.data;
      List<dynamic> listData = [];

      if (rawData is List) {
        listData = rawData;
      } else if (rawData is Map) {
        listData = rawData.values.toList();
      }

      bookings = listData.map((e) => BookingModel.fromJson(e)).toList();

    } else {
      print('No data found in response');
    }

    return BookingList(booking: bookings);
  }

  Future<void> updateBookingDate(int bookingId, String checkIn, String checkOut) async {
    final response = await networkService.patch(
      '/bookings/update/$bookingId',
      queryParameters: {
        'check_in': checkIn,
        'check_out': checkOut,
      },
    );

    if (response.statusCode != 200 && response.statusCode != 201) {
      throw Exception(response.data['message'] ?? 'Failed to update booking date');
    }
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\remote\chat\chat_remote_datasource.dart
// =======================================================

import 'dart:convert';
import 'dart:developer';

import '../../../../../core/network/network_service.dart';

abstract class ChatRemoteDataSource {
  Future<Map<String, dynamic>> getConversations();
  Future<Map<String, dynamic>> getMessages(int conversationId);
  Future<Map<String, dynamic>> sendMessage(int conversationId, String body);
  Future<Map<String, dynamic>> deleteMessage(int messageId);
  Future<Map<String, dynamic>> editMessage(int messageId, String newBody);
  Future<Map<String, dynamic>> saveNewConversation(int ownerId);
  Future<Map<String, dynamic>> deleteConversation(int conversationId);
  Future<Map<String, dynamic>> markAsRead(int messageId);
}

class ChatRemoteDataSourceImpl implements ChatRemoteDataSource {
  final NetworkService networkService;

  ChatRemoteDataSourceImpl({required this.networkService});

  @override
  Future<Map<String, dynamic>> getConversations() async {
    final response = await networkService.get('/conversations');
    return response.data;
  }

  @override
  Future<Map<String, dynamic>> getMessages(int conversationId) async {
    final response = await networkService.get('/conversations/$conversationId/messages');
    return response.data;
  }

  @override
  Future<Map<String, dynamic>> sendMessage(int conversationId, String body) async {
    try {
      final response = await networkService.post(
        '/conversations/$conversationId/messages',
        data: {'body': body},
      );

      log(">>>> Server Raw Response: ${response.data}");

      if (response.statusCode == 200 || response.statusCode == 201) {
        if (response.data is Map<String, dynamic>) {
          return response.data;
        } else if (response.data is String) {
          return jsonDecode(response.data);
        }
        return response.data;
      } else {
        throw Exception("Failed to send message: ${response.statusCode}");
      }
    } catch (e) {
      log(">>>> Error in RemoteDataSource: $e");
      rethrow;
    }
  }

  @override
  Future<Map<String, dynamic>> deleteMessage(int messageId) async {
    final response = await networkService.delete(
      '/messages/$messageId',
    );
    return response.data;
  }

  @override
  Future<Map<String, dynamic>> editMessage(int messageId, String newBody) async {
    final response = await networkService.put(
      '/messages/$messageId',
      queryParameters: {
        'body': newBody,
      },
    );
    return response.data;
  }

  @override
  Future<Map<String, dynamic>> saveNewConversation(int ownerId) async {
    final response = await networkService.post(
      '/conversations/$ownerId',
    );
    return response.data;
  }

  @override
  Future<Map<String, dynamic>> deleteConversation(int conversationId) async {
    final response = await networkService.delete(
      '/conversations/$conversationId',
    );
    return response.data;
  }

  @override
  Future<Map<String, dynamic>> markAsRead(int messageId) async {
    final response = await networkService.post(
      '/messages/$messageId/read',
    );
    return response.data;
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\remote\favorites\favorites_remote_datasource.dart
// =======================================================

import 'package:malaz/core/network/network_service.dart';

import '../../../models/apartment/apartment_model.dart';

abstract class FavoritesRemoteDataSource {
  Future<List<ApartmentModel>> getFavorites();
  Future<void> addFavorite(int apartmentId);
  Future<void> delFavorite(int apartmentId);
}

class FavoritesRemoteDataSourceImpl implements FavoritesRemoteDataSource {
  final NetworkService networkService;

  FavoritesRemoteDataSourceImpl(this.networkService);

  @override
  Future<List<ApartmentModel>> getFavorites() async {
    final response = await networkService.get('/users/favorites');
    if(response.data['favorite'] == null) {
      return [];
    }
    return (response.data['favorite'] as List)
        .map((e) => ApartmentModel.fromJson(e))
        .toList();
  }

  @override
  Future<void> addFavorite(int apartmentId) async {
    await networkService.post('/users/favorites/$apartmentId');
  }

  @override
  Future<void> delFavorite(int apartmentId) async {
    await networkService.delete('/users/favorites/$apartmentId');
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\remote\location\location_remote_data_source.dart
// =======================================================

import 'dart:convert';
import 'package:location/location.dart';
import 'package:http/http.dart' as http;

abstract class LocationRemoteDataSource {
  Future<LocationData?> getRawLocation();
  Future<String> getAddressFromCoords(double lat, double lng, String lang);
}

class LocationRemoteDataSourceImpl implements LocationRemoteDataSource {
  final Location location;
  final http.Client client;
  LocationRemoteDataSourceImpl({required this.location, required this.client});

  @override
  Future<LocationData?> getRawLocation() async {
    bool s = await location.serviceEnabled();
    if (!s) s = await location.requestService();
    if (!s) return null;
    PermissionStatus p = await location.hasPermission();
    if (p == PermissionStatus.denied) p = await location.requestPermission();
    if (p != PermissionStatus.granted) return null;
    return await location.getLocation();
  }

  @override
  Future<String> getAddressFromCoords(double lat, double lng, String lang) async {
    final url = Uri.parse('https://nominatim.openstreetmap.org/reverse?format=json&lat=$lat&lon=$lng');

    try {
      final response = await client.get(
        url,
        headers: {
          'Accept-Language': lang,
          'User-Agent': 'Malaz_App',
        },
      );

      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        final addr = data['address'];

        if (addr == null) return "Unknown Address";

        final city = addr['city'] ?? addr['town'] ?? addr['village'] ?? addr['suburb'] ?? '';
        final country = addr['country'] ?? '';

        if (city.isEmpty && country.isEmpty) return "Location found, Address not resolved";

        return city.isNotEmpty ? "$city, $country" : country;
      }
      return "API Error (${response.statusCode})";
    } catch (e) {
      return "Connection Error";
    }
  }
}
// =======================================================
// FILE PATH: lib\data\datasources\remote\review\review_remote_data_source.dart
// =======================================================

import 'package:dartz/dartz.dart';

import '../../../../core/constants/app_constants.dart';
import '../../../../core/network/network_service.dart';
import '../../../../domain/entities/review/review.dart';
import '../../../models/review/review_model.dart';

abstract class ReviewsRemoteDataSource {
  Future<ReviewsList> getReviews({required int propertyId, String? cursor});
  Future<Unit> AddReview({required int idProperty, required String rating, required String body});
}

class ReviewsRemoteDataSourceImpl implements ReviewsRemoteDataSource {
  final NetworkService networkService;

  ReviewsRemoteDataSourceImpl({required this.networkService});

  @override
  Future<ReviewsList> getReviews(
      {required int propertyId, String? cursor}) async {
    final Map<String, dynamic> queryParams = {
      'per_page': AppConstants.numberOfReviewsEachRequest,
    };

    if (cursor != null) {
      queryParams['cursor'] = cursor;
    }

    final response = await networkService.get(
      '/reviews/properties/$propertyId/reviews',
      queryParameters: queryParams,
    );

    final List<dynamic> dataList = response.data['data'];
    final meta = response.data['meta'];

    final List<ReviewModel> reviews =
        dataList.map((json) => ReviewModel.fromJson(json)).toList();

    final String? nextCursor = meta != null ? meta['next_cursor'] : null;

    return ReviewsList(
      reviews: reviews,
      nextCursor: nextCursor,
    );
  }

  @override
  Future<Unit> AddReview({required int idProperty, required String rating, required String body}) async{
    await networkService.post(
      '/reviews/properties/$idProperty',
      data: {
        'rating': rating,
        'body': body,
      },
    );

    return unit;
  }
}

// =======================================================
// FILE PATH: lib\data\models\apartment\apartment_model.dart
// =======================================================

import 'package:malaz/data/models/user/user_model.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';

import '../../../domain/entities/apartment/apartment.dart';

class ApartmentModel extends Apartment {
  ApartmentModel({
    required super.id,
    required super.ownerId,
    required super.owner,
    required super.status,
    required super.title,
    required super.price,
    required super.city,
    required super.governorate,
    required super.address,
    required super.description,
    required super.type,
    required super.rooms,
    required super.bathrooms,
    required super.bedrooms,
    required super.area,
    required super.rating,
    required super.numberOfReviews,
    required super.mainImageUrl,
    super.isFav,
    super.latitude,
    super.longitude,
  });

  factory ApartmentModel.fromJson(Map<String, dynamic> json) {
    return ApartmentModel(
      id: json['id'] as int,
      ownerId: json['owner_id'] as int? ?? 0,
      owner: json['user'] != null
          ? UserModel.fromJson(json['user'])
          : UserEntity(id: 0, first_name: '', last_name: '', phone: '', role: '', date_of_birth: '', profile_image_url: '', identity_card_image_url: '', phone_verified_at: '', created_at: '', updated_at: ''),      status: json['status'] ?? '',
      title: json['title'] ?? '',
      price: (json['price'] as num?)?.toInt() ?? 0,
      city: json['city'] ?? '',
      governorate: json['governorate'] ?? '',
      address: json['address'] ?? '',
      description: json['description'] ?? '',
      type: json['type'] ?? '',

      rooms: (json['number_of_rooms'] as num?)?.toInt() ?? 0,
      bathrooms: (json['number_of_baths'] as num?)?.toInt() ?? 0,
      bedrooms: (json['number_of_bedrooms'] as num?)?.toInt() ?? 0,

      area: (json['area'] as num?)?.toInt() ?? 0,
      rating: json['rating'] as num? ?? 0,
      numberOfReviews: (json['number_of_reviews'] as num?)?.toInt() ?? 0,

      mainImageUrl: json['main_image_url'] ?? '',

      isFav: json['is_favorite'] ?? false,
      latitude: json['latitude'] != null
          ? double.tryParse(json['latitude'].toString())
          : null,
      longitude: json['longitude'] != null
          ? double.tryParse(json['longitude'].toString())
          : null,
    );
  }
  Map<String, dynamic> toJson(){
    return {
      'id': id,
      'owner_id': ownerId,
      'status': status,
      'title': title,
      'price': price,
      'city': city,
      'governorate': governorate,
      'address': address,
      'description': description,
      'type': type,
      'number_of_rooms': rooms,
      'number_of_baths': bathrooms,
      'number_of_bedrooms': bedrooms,
      'area': area,
      'rating': rating,
      'number_of_reviews': numberOfReviews,
      'main_image_url': mainImageUrl,
      'is_favorite': isFav,
      'latitude': latitude,
      'longitude': longitude,
    };
  }
}
// =======================================================
// FILE PATH: lib\data\models\auth\auth_result.dart
// =======================================================

import '../../../domain/entities/user/user_entity.dart';

class AuthResult {
  final UserEntity user;
  final bool isPending;

  AuthResult({required this.user, required this.isPending});
}

// =======================================================
// FILE PATH: lib\data\models\booking\booking_model.dart
// =======================================================

import 'package:malaz/data/models/apartment/apartment_model.dart';
import 'package:malaz/data/models/user/user_model.dart';
import 'package:malaz/domain/entities/booking/booking.dart';

class BookingModel extends Booking {
  BookingModel({
    super.id,
    required super.propertyId,
    required super.checkIn,
    required super.checkOut,
    required super.price,
    super.userId,
    super.user,
    super.status,
    super.totalPrice,
    super.apartment,
  });

  factory BookingModel.fromJson(Map<String, dynamic> json) {
    try {
      return BookingModel(
        id: json['id'],
        propertyId: json['property_id'],
        checkIn: DateTime.parse(json['check_in']),
        checkOut: DateTime.parse(json['check_out']),
        price: json['property'] != null ? (json['property']['price'] as num).toInt() : 0,
        userId: json['user_id'],
        status: json['status'],
        totalPrice: json['total_price']?.toString(),
        user: json['user'] != null ? UserModel.fromJson(json['user']) : null,
        apartment: json['property'] != null ? ApartmentModel.fromJson(json['property']) : null,
      );
    } catch (e, stackTrace) {
      // هذا الجزء سيخبرنا بالضبط أين المشكلة
      print("❌ Error parsing BookingModel: $e");
      print("❌ StackTrace: $stackTrace");
      rethrow;
    }
  }
}
// =======================================================
// FILE PATH: lib\data\models\chat\chat_message_model.dart
// =======================================================

import 'package:malaz/core/constants/app_constants.dart';

import '../user/user_model.dart';

class ChatMessageModel {
  final int id;
  final int conversationId;
  final int senderId;
  final String body;
  final DateTime? readAt;
  final DateTime createdAt;
  final DateTime? updatedAt;
  final UserModel? sender;

  String get senderImageUrl => AppConstants.userProfileImage(senderId);

  ChatMessageModel({
    required this.id,
    required this.conversationId,
    required this.senderId,
    required this.body,
    required this.readAt,
    required this.createdAt,
    required this.updatedAt,
    this.sender,
  });

  factory ChatMessageModel.fromJson(Map<String, dynamic> json) {
    int safeInt(dynamic value) {
      if (value == null) return 0;
      if (value is int) return value;
      return int.tryParse(value.toString()) ?? 0;
    }

    return ChatMessageModel(
      id: safeInt(json['id']),
      senderId: safeInt(json['sender_id']),
      conversationId: safeInt(json['conversation_id']),
      body: json['body'] ?? '',
      createdAt: json['created_at'] != null ? DateTime.parse(json['created_at']) : DateTime.now(),
      updatedAt: json['updated_at'] != null ? DateTime.parse(json['updated_at']) : null,
      readAt: json['read_at'] != null ? DateTime.parse(json['read_at']) : null,
    );
  }

  ChatMessageModel copyWith({
    int? id,
    int? senderId,
    String? body,
    DateTime? createdAt,
    int? conversationId,
    DateTime? readAt,
    DateTime? updatedAt,
    UserModel? sender,
  }) {
    return ChatMessageModel(
      id: id ?? this.id,
      senderId: senderId ?? this.senderId,
      body: body ?? this.body,
      createdAt: createdAt ?? this.createdAt,
      conversationId: conversationId ?? this.conversationId,
      readAt: readAt ?? this.readAt,
      updatedAt: updatedAt ?? this.updatedAt,
      sender: sender ?? this.sender,
    );
  }

  bool get isEdited {
    if (updatedAt == null) return false;
    return updatedAt!.isAfter(createdAt.add(const Duration(seconds: 1)));
  }
}
// =======================================================
// FILE PATH: lib\data\models\chat\conversation_model.dart
// =======================================================


import '../user/user_model.dart';

class ConversationModel {
  final int id;
  final int userOneId;
  final int userTwoId;
  final DateTime createdAt;
  final DateTime updatedAt;
  final int unreadCount;
  final UserModel? userOne;
  final UserModel? userTwo;

  ConversationModel({
    required this.id,
    required this.userOneId,
    required this.userTwoId,
    required this.createdAt,
    required this.updatedAt,
    required this.unreadCount,
    this.userOne,
    this.userTwo,
  });

  factory ConversationModel.fromJson(Map<String, dynamic> json) {
    int safeInt(dynamic value) {
      if (value == null) return 0;
      if (value is int) return value;
      return int.tryParse(value.toString()) ?? 0;
    }

    return ConversationModel(
      id: safeInt(json['id']),
      userOneId: safeInt(json['user_one_id']),
      userTwoId: safeInt(json['user_two_id']),
      createdAt: json['created_at'] != null
          ? DateTime.parse(json['created_at'])
          : DateTime.now(),
      updatedAt: json['updated_at'] != null
          ? DateTime.parse(json['updated_at'])
          : DateTime.now(),
      unreadCount: safeInt(json['unread_count']),
      userOne: json['user_one'] != null
          ? UserModel.fromJson(json['user_one'] as Map<String, dynamic>)
          : null,
      userTwo: json['user_two'] != null
          ? UserModel.fromJson(json['user_two'] as Map<String, dynamic>)
          : null,
    );
  }

  ConversationModel copyWith({
    int? id,
    int? userOneId,
    int? userTwoId,
    DateTime? createdAt,
    DateTime? updatedAt,
    int? unreadCount,
    UserModel? userOne,
    UserModel? userTwo,
  }) {
    return ConversationModel(
      id: id ?? this.id,
      userOneId: userOneId ?? this.userOneId,
      userTwoId: userTwoId ?? this.userTwoId,
      createdAt: createdAt ?? this.createdAt,
      updatedAt: updatedAt ?? this.updatedAt,
      unreadCount: unreadCount ?? this.unreadCount,
      userOne: userOne ?? this.userOne,
      userTwo: userTwo ?? this.userTwo,
    );
  }
}
// =======================================================
// FILE PATH: lib\data\models\location\location_model.dart
// =======================================================

import '../../../domain/entities/location/location_entity.dart';

class LocationModel extends LocationEntity {
  const LocationModel({required super.lat, required super.lng, required super.address});

  Map<String, dynamic> toJson() => {'lat': lat, 'lng': lng, 'address': address};

  factory LocationModel.fromJson(Map<String, dynamic> json) {
    return LocationModel(
      lat: json['lat'],
      lng: json['lng'],
      address: json['address'],
    );
  }
}
// =======================================================
// FILE PATH: lib\data\models\review\review_model.dart
// =======================================================

import '../../../domain/entities/review/review.dart';

class ReviewModel extends Review {
  ReviewModel({
    required super.id,
    required super.body,
    required super.rating,
    required super.createdAt,
    required super.userId,
    required super.userName,
    required super.userImage,
  });

  factory ReviewModel.fromJson(Map<String, dynamic> json) {
    final userJson = json['user'] ?? {};

    return ReviewModel(
      id: json['id'],
      body: json['body'] ?? "",
      rating: json['rating'] ?? 0,
      createdAt: json['created_at'] ?? "",
      userId: userJson['id'] ?? 0,
      userName: "${userJson['first_name'] ?? ''} ${userJson['last_name'] ?? ''}".trim(),
      userImage: userJson['profile_image_url'] ?? "",
    );
  }
}
// =======================================================
// FILE PATH: lib\data\models\user\user_model.dart
// =======================================================

import 'package:malaz/domain/entities/user/user_entity.dart';

class UserModel extends UserEntity{
  UserModel({
    required super.id,
    required super.first_name,
    required super.last_name,
    required super.phone,
    required super.role,
    required super.date_of_birth,
    required super.profile_image_url,
    required super.identity_card_image_url,
    required super.phone_verified_at,
    required super.created_at,
    required super.updated_at,
  });

  factory UserModel.pending({required String phone}) {
    return UserModel(
      id: 0,
      first_name: '',
      last_name: '',
      phone: phone,
      role: 'PENDING',
      date_of_birth: '',
      profile_image_url: '',
      identity_card_image_url: '',
      phone_verified_at: '',
      created_at: '',
      updated_at: '',
    );
  }

  factory UserModel.fromEntity(UserEntity user) {
    return UserModel(
      id: user.id,
      first_name: user.first_name,
      last_name: user.last_name,
      phone: user.phone,
      role: user.role,
      date_of_birth: user.date_of_birth,
      profile_image_url: user.profile_image_url,
      identity_card_image_url: user.identity_card_image_url,
      phone_verified_at: user.phone_verified_at,
      created_at: user.created_at,
      updated_at: user.updated_at,
    );
  }

  factory UserModel.fromJson(Map<String, dynamic> json){
    return UserModel(
      id: json['id'] is int ? json['id'] : int.parse(json['id'].toString()),
      first_name: json['first_name'] ?? '',
      last_name: json['last_name'] ?? '',
      phone: json['phone'] ?? '',
      role: json['role'] ?? '',
      date_of_birth: json['date_of_birth'] ?? '',
      profile_image_url: json['profile_image_url'] ?? "https://placeholder.com/user.png",
      identity_card_image_url: json['identity_card_image_url'] ?? '',
      phone_verified_at: json['phone_verified_at'] ?? '',
      created_at: json['created_at'] ?? '',
      updated_at: json['updated_at'] ?? '',
    );
  }

  Map<String, dynamic> toJson(){
    return {
      'id': id,
      'first_name': first_name,
      'last_name': last_name,
      'phone': phone,
      'role': role,
      'date_of_birth': date_of_birth,
      'profile_image_url': profile_image_url,
      'identity_card_image_url': identity_card_image_url,
      'phone_verified_at': phone_verified_at,
      'created_at': created_at,
      'updated_at': updated_at,
    };
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\apartment\apartment_repository_impl.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/errors/failures.dart';

import '../../../core/errors/exceptions.dart';
import '../../../domain/entities/apartment/apartments_list.dart';
import '../../../domain/entities/filters/filters.dart';
import '../../../domain/repositories/apartment/apartment_repository.dart';
import '../../datasources/remote/apartment/apartment_remote_data_source.dart';

class ApartmentRepositoryImpl implements ApartmentRepository {
  final ApartmentRemoteDataSource remoteDataSource;

  ApartmentRepositoryImpl({required this.remoteDataSource});

  @override
  Future<ApartmentsList> getApartments(
      {required String? cursor, Filter? filter}) async {
    try {
      final remoteApartments =
      await remoteDataSource.getApartments(cursor: cursor, filter: filter);
      return remoteApartments;
    } catch (e) {
      rethrow;
    }
  }

  @override
  Future<ApartmentsList> getMyApartments({required String? cursor}) async {
    try {
      final remoteApartments =
      await remoteDataSource.getMyApartments(cursor: cursor);
      return remoteApartments;
    } catch (e) {
      rethrow;
    }
  }

  @override
  Future<Either<Failure, Unit>> addApartment(
      {required String title,
        required int price,
        required String city,
        required String governorate,
        required String address,
        required String description,
        required String type,
        required int rooms,
        required int bathrooms,
        required int bedrooms,
        required int area,
        required List<XFile> mainImageUrl,
        required XFile main_pic,
        required double latitude,
        required double longitude
      }) async {
    try {
      final resault = await remoteDataSource.addApartment(
          title: title,
          price: price,
          city: city,
          governorate: governorate,
          address: address,
          description: description,
          type: type,
          rooms: rooms,
          bathrooms: bathrooms,
          bedrooms: bedrooms,
          area: area,
          mainImageUrl: mainImageUrl,
          main_pic: main_pic,
          longitude: longitude,
          latitude: latitude
      );
      return const Right(unit);
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message));
    } catch (e) {
      return Left(GeneralFailure());
    }
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\auth\auth_repository_impl.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:dio/dio.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/errors/exceptions.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/data/datasources/local/auth/auth_local_data_source.dart';
import 'package:malaz/data/datasources/remote/auth/auth_remote_datasource.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';

import '../../../domain/entities/auth/auth_state.dart';
import '../../models/user/user_model.dart';
import '../../utils/response_parser.dart';

class AuthRepositoryImpl extends AuthRepository {
  final AuthRemoteDatasource authRemoteDatasource;
  final AuthLocalDatasource authLocalDatasource;

  AuthRepositoryImpl({
    required this.authRemoteDatasource,
    required this.authLocalDatasource,
  });

  @override
  Future<Either<Failure, AuthStatus>> checkAuth() async {
    try {
      final token = await authLocalDatasource.getCachedToken();
      final isPending = await authLocalDatasource.isPending();
      final user = await authLocalDatasource.getCachedUser();

      // PENDING USER (no token)
      if (isPending && user != null) {
        return Right(AuthStatus(
          isAuthenticated: false,
          isPending: true,
          user: user,
        ));
      }

      // AUTHENTICATED USER
      if (token != null && token.isNotEmpty && user != null) {
        return Right(AuthStatus(
          isAuthenticated: true,
          isPending: false,
          user: user,
        ));
      }

      // NOT AUTHENTICATED
      return Right(AuthStatus(
        isAuthenticated: false,
        isPending: false,
        user: null,
      ));
    } catch (e) {
      return Left(CacheFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, UserEntity?>> getCurrentUser() async {
    try {
      final user = await authLocalDatasource.getCachedUser();
      return Right(user);
    } catch (e) {
      return Left(CacheFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, bool>> isAuthentication() async {
    try {
      final token = await authLocalDatasource.getCachedToken();
      if (token != null && token.isNotEmpty) {
        return Right(true);
      }
      final user = await authLocalDatasource.getCachedUser();
      return Right(user != null);
    } catch (e) {
      return Left(CacheFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, UserEntity>> login({
    required String phoneNumber,
    required String password,
  }) async {
    try {
      final result = await authRemoteDatasource.login(
        phone: phoneNumber,
        password: password,
      );

      if (result['message'] == 'Wait until is approved by the officials') {
        final us = await authLocalDatasource.getCachedUser();
        final pendingUser = UserModel.pending(phone: phoneNumber);
        await authLocalDatasource.cacheUser(pendingUser);
        await authLocalDatasource.setPending(true);
        return Right(pendingUser);
      }

      final user = UserModel.fromJson(result['user']);
      final token = result['access_token'];

      await authLocalDatasource.cacheUser(user);
      await authLocalDatasource.cacheToken(token);
      await authLocalDatasource.setPending(false);

      return Right(user);

      /// TODO: need to clean up
    } on PendingApprovalException{
      print('pending');
      return Left(const PendingApprovalFailure());
    } on PhoneNotFoundException catch (e) {
      print('phone exception');
      return Left(PhoneNotFoundFailure(e.message ?? 'This phone number does not exist.'));
    } on WrongPasswordException catch (e) {
      print('pass');
      return Left(WrongPasswordFailure(e.message ?? 'Invalid credentials'));
    } on InvalidCredentialsException catch(e) {
      print('invalid');
      if(e.message!.toLowerCase().contains('wait until')) {
        return Left(InvalidCredentialsFailure(e.message));
      }
      return Left(InvalidCredentialsFailure('Invalid credentials'));
    } on ServerException catch (e) {
      print('server');
      return Left(ServerFailure(e.message ?? 'Server error'));
    } catch (e) {
      print(e);
      print('exception ${e.toString()}');
      return Left(GeneralFailure());
    }
  }

  @override
  Future<Either<Failure, void>> logout() async {
    try {
      await authRemoteDatasource.logout();
      await authLocalDatasource.clearAll();
      return const Right(null);
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message));
    } catch (e) {
      return Left(GeneralFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, UserEntity>> register({
    required String phone,
    required String role,
    required String firstName,
    required String lastName,
    required String password,
    required String passwordConfirmation,
    required String dateOfBirth,
    required XFile profileImage,
    required XFile identityImage,
  }) async {
    try {
      final result = await authRemoteDatasource.registerUser(
        phone: phone,
        role: role,
        firstName: firstName,
        lastName: lastName,
        password: password,
        passwordConfirmation: passwordConfirmation,
        dateOfBirth: dateOfBirth,
        profileImage: profileImage,
        identityImage: identityImage,
      );
      print('SERVER RESPONSE: $result');
      final userMap = result['data'];

      if (userMap == null) {
        return Left(ServerFailure('No user data returned from server'));
      }

      final user = UserModel.fromJson(userMap);
      await authLocalDatasource.cacheUser(user);

      return Right(user);
    } on ServerException catch (e) {
      return Left(ServerFailure(e.toString()));
    } on NetworkException {
      return Left(NetworkFailure());
    } on CacheException catch(e) {
      return Left(CacheFailure(e.toString()));
    } catch (e) {
      return Left(const GeneralFailure());
    }
  }

  @override
  Future<Either<Failure, void>> sendOtp({required String phone}) async {
    try {
      await authRemoteDatasource.sendOtp(phone: phone);
      return const Right(null);
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message));
    } catch (e) {
      return Left(const GeneralFailure());
    }
  }

  @override
  Future<Either<Failure, bool>> verifyOtp(
      {required String phone, required String otp}) async {
    try {
      final res = await authRemoteDatasource.verifyOtp(phone: phone, otp: otp);
      final success = extractSuccess(res);
      if (success) return Right(true);

      final message = extractMessage(res) ?? 'Invalid code';
      return Left(ServerFailure(message));
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message ?? 'Server error'));
    } catch (e) {
      return Left(const GeneralFailure());
    }
  }

  @override
  Future<Either<Failure, String>> sendPasswordResetOtp(String phone) async {
    try {
      final data = await authRemoteDatasource.sendPasswordResetOtp(phone);

      return Right(data['message'] ?? "Success");
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message));
    } catch (e) {
      return Left(ServerFailure("Unexpected error occurred"));
    }
  }

  @override
  Future<Either<Failure, String>> updatePassword({
    required String phone,
    required String otp,
    required String newPassword,
  }) async {
    try {
      final data = await authRemoteDatasource.updatePassword(
        phone: phone,
        otp: otp,
        newPassword: newPassword,
      );
      return Right(data['message'] ?? "Password updated successfully");
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message));
    } catch (e) {
      return Left(ServerFailure("حدث خطأ غير متوقع"));
    }
  }

  @override
  Future<Either<Failure, UserEntity>> updateProfile(FormData formData) async {
    try {
      final response = await authRemoteDatasource.updateProfile(formData);
      return Right(response);
    } on ServerException catch (e) {
      return Left(ServerFailure(e.message));
    }
  }

  @override
  Future<void> updateCachedUser(UserEntity user) async {
    await authLocalDatasource.cacheUser(user);
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\booking\booking_repository_impl.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/data/datasources/remote/booking/booking_remote_data_source.dart';
import 'package:malaz/data/models/booking/booking_model.dart';
import 'package:malaz/domain/entities/booking/booking.dart';
import 'package:malaz/domain/entities/booking/booking_list.dart';
import '../../../domain/repositories/booking/booking_repository.dart';
import '../../utils/failure_mapper.dart';

class BookingRepositoryImpl implements BookingRepository {
  final BookingRemoteDataSource remoteDataSource;

  BookingRepositoryImpl(this.remoteDataSource);

  @override
  Future<Either<Failure, List<BookingModel>>> getBookedDates(
      int propertyId) async {
    try {
      final response = await remoteDataSource.getBookedDates(propertyId);
      return Right(response);
    } catch (e) {
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }

  @override
  Future<Either<Failure, void>> makeBooking(Booking booking) async {
    try {
      final response = await remoteDataSource.makeBooking(booking);
      return Right(response);
    } catch (e) {
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }

  @override
  Future<Either<Failure, BookingList>> getUserBookings(int userId) async {
    try {
      final response = await remoteDataSource.fetchAllBookings(userId);
      return Right(response);
    } catch (e) {
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }

  @override
  Future<Either<Failure, void>> updateStatus(int propertyID,
      String status) async {
    try {
      final response = await remoteDataSource.UpdateStatus(propertyID, status);
      return Right(response);
    } catch (e) {
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }


  @override
  Future<Either<Failure, BookingList>> getMyBookings(int userId) async {
    try {
      final response = await remoteDataSource.fetchMyBookings(userId);
      return Right(response);

    } catch (e) {
      print("Error in Repository: $e");
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }

  @override
  Future<Either<Failure, void>> updateBookingDates({
    required int bookingId,
    required String checkIn,
    required String checkOut,
  }) async {
    try {
      await remoteDataSource.updateBookingDate(bookingId, checkIn, checkOut);
      return const Right(null);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\chat\chat_repository_impl.dart
// =======================================================

import 'dart:developer';

import 'package:dartz/dartz.dart';
import '../../../domain/repositories/chat/chat_repository.dart';
import '../../../core/errors/failures.dart';
import '../../datasources/remote/chat/chat_remote_datasource.dart';
import '../../models/chat/conversation_model.dart';
import '../../models/chat/chat_message_model.dart';

class ChatRepositoryImpl implements ChatRepository {
  final ChatRemoteDataSource remoteDataSource;

  ChatRepositoryImpl({required this.remoteDataSource});

  @override
  Future<Either<Failure, List<ConversationModel>>> getConversations() async {
    try {
      final result = await remoteDataSource.getConversations();
      final List data = result['conversations'];
      return Right(data.map((e) => ConversationModel.fromJson(e)).toList());
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, List<ChatMessageModel>>> getMessages(int conversationId) async {
    try {
      final result = await remoteDataSource.getMessages(conversationId);
      final List data = result['messages'];
      return Right(data.map((e) => ChatMessageModel.fromJson(e)).toList());
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, ChatMessageModel>> sendMessage(int conversationId, String body) async {
    try {
      final result = await remoteDataSource.sendMessage(conversationId, body);

      if (result != null && result['data'] != null) {
        final Map<String, dynamic> msgData = Map<String, dynamic>.from(result['data']);

        final chatMessage = ChatMessageModel.fromJson(msgData);
        return Right(chatMessage);
      }

      return Left(ServerFailure("بيانات الرسالة غير موجودة في رد السيرفر"));
    } catch (e) {
      log("Mapping Error in Repo: $e");
      return Left(ServerFailure("حدث خطأ أثناء معالجة الرسالة: $e"));
    }
  }

  @override
  Future<Either<Failure, Unit>> deleteMessage(int messageId) async {
    try {
      await remoteDataSource.deleteMessage(messageId);
      return const Right(unit);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, Unit>> editMessage(int messageId, String newBody) async {
    try {
      await remoteDataSource.editMessage(messageId, newBody);
      return const Right(unit);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, ConversationModel>> saveNewConversation(int otherUserId) async {
    try {
      final result = await remoteDataSource.saveNewConversation(otherUserId);
      log("Server Response: $result");
      if (result != null && result['conversation'] != null) {
        final Map<String, dynamic> conversationData = Map<String, dynamic>.from(result['conversation']);

        final conversationModel = ConversationModel.fromJson(conversationData);

        return Right(conversationModel);
      }
      /// TODO : translate it
      return Left(ServerFailure("بيانات المحادثة غير موجودة في رد السيرفر"));
    } catch (e) {
      print("Mapping Error: $e");
      return Left(ServerFailure("خطأ في معالجة البيانات: $e"));
    }
  }

  @override
  Future<Either<Failure, Unit>> deleteConversation(int conversationId) async {
    try {
      await remoteDataSource.deleteConversation(conversationId);
      return const Right(unit);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, void>> markAsRead(int messageId) async {
    try {
      await remoteDataSource.markAsRead(messageId);
      return const Right(null);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\favorites\favorites_repository_impl.dart
// =======================================================

import 'package:dartz/dartz.dart';
import '../../../../core/errors/failures.dart';
import '../../../domain/entities/apartment/apartment.dart';
import '../../../domain/repositories/favorites/favorites_repository.dart';
import '../../datasources/remote/favorites/favorites_remote_datasource.dart';
import '../../utils/failure_mapper.dart';

class FavoritesRepositoryImpl implements FavoritesRepository {
  final FavoritesRemoteDataSource remoteDataSource;

  FavoritesRepositoryImpl(this.remoteDataSource);

  @override
  Future<Either<Failure, List<Apartment>>> getFavorites() async {
    try {
      final result = await remoteDataSource.getFavorites();
      return Right(result);
    } catch (e) {
      return Left(ServerFailure(e.toString()));
    }
  }

  @override
  Future<Either<Failure, void>> addFavorite(int apartmentId) async {
    try {
      await remoteDataSource.addFavorite(apartmentId);
      return const Right(null);
    } catch(e) {
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }

  @override
  Future<Either<Failure, void>> delFavorite(int apartmentId) async {
    try {
      await remoteDataSource.delFavorite(apartmentId);
      return Right(null);
    } catch(e) {
      final failure = FailureMapper.map(e);
      return Left(failure);
    }
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\location\location_repository_impl.dart
// =======================================================

import '../../../domain/entities/location/location_entity.dart';
import '../../../domain/repositories/location/location_repository.dart';
import '../../datasources/local/location/location_local_data_source.dart';
import '../../datasources/remote/location/location_remote_data_source.dart';
import '../../models/location/location_model.dart';

class LocationRepositoryImpl implements LocationRepository {
  final LocationRemoteDataSource remoteDataSource;
  final LocationLocalDataSource localDataSource;

  LocationRepositoryImpl({
    required this.remoteDataSource,
    required this.localDataSource
  });

  @override
  Future<LocationEntity> getCurrentLocation(String lang) async {
    final raw = await remoteDataSource.getRawLocation();
    if (raw == null) throw Exception("Location access denied");

    final address = await remoteDataSource.getAddressFromCoords(
        raw.latitude!,
        raw.longitude!,
        lang
    );

    final model = LocationModel(
        lat: raw.latitude!,
        lng: raw.longitude!,
        address: address
    );

    await localDataSource.cacheLocation(model);
    return model;
  }

  @override
  Future<LocationEntity?> getSavedLocation() async {
    return await localDataSource.getCachedLocation();
  }

  @override
  Future<LocationEntity> updateManualLocation(double lat, double lng, String lang) async {
    final address = await remoteDataSource.getAddressFromCoords(lat, lng, lang);

    final model = LocationModel(
        lat: lat,
        lng: lng,
        address: address
    );

    await localDataSource.cacheLocation(model);
    return model;
  }
}
// =======================================================
// FILE PATH: lib\data\repositories\review\review_repository_impl.dart
// =======================================================

import 'package:dartz/dartz.dart';
import '../../../core/errors/exceptions.dart';
import '../../../core/errors/failures.dart';
import '../../../core/network/network_info.dart';
import '../../../domain/entities/review/review.dart';
import '../../../domain/repositories/review/review_repository.dart';
import '../../datasources/remote/review/review_remote_data_source.dart';

class ReviewsRepositoryImpl implements ReviewsRepository {
  final ReviewsRemoteDataSource remoteDataSource;
  final NetworkInfo networkInfo; // اختياري ولكنه مفضل في المشاريع الكبيرة

  ReviewsRepositoryImpl({
    required this.remoteDataSource,
    required this.networkInfo,
  });

  @override
  Future<Either<Failure, ReviewsList>> getReviews({
    required int propertyId,
    String? cursor,
  }) async {
    if (await networkInfo.isConnected) {
      try {
        final remoteReviews = await remoteDataSource.getReviews(
          propertyId: propertyId,
          cursor: cursor,
        );
        return Right(remoteReviews);
      } on ServerException catch (e) {
        return Left(ServerFailure(e.message));
      } catch (e) {
        return Left(ServerFailure(e.toString()));
      }
    } else {
      return const Left(NetworkFailure());
    }
  }
  @override
  Future<Either<Failure, Unit>> addReview({
    required String rating,
    required String body,
    required int idProperty,
  }) async {
    if (await networkInfo.isConnected) {
      try {
        await remoteDataSource.AddReview(
          idProperty: idProperty,
          rating: rating,
          body: body,
        );
        return const Right(unit);
      } on ServerException catch (e) {
        return Left(ServerFailure(e.message));
      } catch (e) {
        return Left(ServerFailure(e.toString()));
      }
    } else {
      return const Left(NetworkFailure());
    }
  }
}
// =======================================================
// FILE PATH: lib\data\utils\dialog.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:lottie/lottie.dart';

import '../../l10n/app_localizations.dart';

void showLoadingDialog(BuildContext context) {
  final l10n = AppLocalizations.of(context);

  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (ctx) => Center(
      child: Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          borderRadius: BorderRadius.circular(20),
          boxShadow: const [
            BoxShadow(color: Colors.black26, blurRadius: 15, offset: Offset(0, 5))
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Lottie.asset('assets/lottie/sending_booking.json', width: 100),
            const SizedBox(height: 20),
            Text(
              l10n.booking_in_progress,
              style: Theme.of(context).textTheme.bodyLarge,
              textAlign: TextAlign.center,
            ),
          ],
        ),
      ),
    ),
  );
}

void showSuccessDialog(BuildContext context, VoidCallback onClosed) {
  final theme = Theme.of(context).colorScheme;
  final l10n = AppLocalizations.of(context);

  showDialog(
    context: context,
    barrierDismissible: false,
    builder: (ctx) => Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(Icons.check_circle_outline, color: Colors.green, size: 80),
            const SizedBox(height: 16),
             Text(
              l10n.booking_success_title,
              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
            ),
            const SizedBox(height: 8),
             Text(
              l10n.booking_success_message,
              textAlign: TextAlign.center,
              style: TextStyle(color: Colors.grey),
            ),
            const SizedBox(height: 24),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: () {
                  context.pop(ctx);
                  onClosed();
                },
                style: ElevatedButton.styleFrom(backgroundColor: theme.primary,foregroundColor: theme.onPrimary),
                child: Text(l10n.action_okay),
              ),
            )
          ],
        ),
      ),
    ),
  );
}
// =======================================================
// FILE PATH: lib\data\utils\failure_mapper.dart
// =======================================================

import 'package:path/path.dart';

import '../../core/errors/exceptions.dart';
import '../../core/errors/failures.dart';
import '../../l10n/app_localizations.dart';

class FailureMapper {
  static Failure map(dynamic exception) {
    if (exception is NetworkException) {
      return NetworkFailure();
    }
    else if (exception is ServerException) {
      return ServerFailure(exception.message);
    }
    else if (exception is UnauthenticatedException) {
      return UnauthenticatedFailure(exception.message);
    } else {
      return UnexpectedFailure('Something went wrong');
    }
  }
}
// =======================================================
// FILE PATH: lib\data\utils\response_parser.dart
// =======================================================

// lib/data/utils/response_parser.dart
import 'dart:convert';

bool extractSuccess(dynamic data, {int? statusCode}) {
  try {
    if (statusCode != null) {
      if (statusCode >= 400) return false;
    }

    if (data == null) return false;

    dynamic parsed = data;
    if (data is String) {
      try {
        parsed = jsonDecode(data);
      } catch (_) { parsed = data; }
    }

    dynamic rawSuccess;
    if (parsed is Map) {
      rawSuccess = parsed['success'] ??
          parsed['status'] ??
          parsed['ok'] ??
          parsed['result'] ??
          (parsed['data'] is Map ? parsed['data']['success'] ?? parsed['data']['status'] : null);
    } else {
      rawSuccess = parsed;
    }

    if (rawSuccess is bool) return rawSuccess;
    if (rawSuccess is int) return rawSuccess == 1;
    if (rawSuccess is String) {
      final s = rawSuccess.toLowerCase().trim();
      return (s == 'true' || s == '1' || s == 'success' || s == 'ok' || s == 'verified');
    }

    final msg = extractMessage(parsed);
    if (msg != null) {
      final low = msg.toLowerCase();
      if (low.contains('success') || low.contains('verified') || low.contains('created')) return true;
      if (low.contains('error') || low.contains('invalid') || low.contains('failed')) return false;
    }

    if (statusCode != null && statusCode >= 200 && statusCode < 300) return true;
    return false;
  } catch (e) {
    return false;
  }
}

String? extractMessage(dynamic data) {
  try {
    if (data == null) return null;
    dynamic parsed = data;
    if (data is String) {
      try { parsed = jsonDecode(data); } catch (_) { parsed = data; }
    }
    if (parsed is Map) {
      final m = parsed['message'] ?? parsed['msg'] ?? parsed['error'] ?? parsed['errors'];
      if (m == null) return null;
      if (m is String) return m;
      try { return jsonEncode(m); } catch (_) { return m.toString(); }
    }
    if (parsed is String) return parsed;
    return parsed.toString();
  } catch (e) {
    return null;
  }
}

// =======================================================
// FILE PATH: lib\domain\entities\apartment\apartment.dart
// =======================================================

import 'package:malaz/domain/entities/user/user_entity.dart';

class Apartment {
  final int id;
  final int ownerId;
  final UserEntity owner;
  final String status;
  final String title;
  final int price;
  final String city;
  final String governorate;
  final String address;
  final String description;
  final String type;
  final int rooms;
  final int bathrooms;
  final int bedrooms;
  final int area;
  final num rating;
  final int numberOfReviews;
  final String mainImageUrl;
  final bool isFav;
  final double? latitude;
  final double? longitude;

  Apartment({
    required this.id,
    required this.ownerId,
    required this.owner,
    required this.status,
    required this.title,
    required this.price,
    required this.city,
    required this.governorate,
    required this.address,
    required this.description,
    required this.type,
    required this.rooms,
    required this.bathrooms,
    required this.bedrooms,
    required this.area,
    required this.rating,
    required this.numberOfReviews,
    required this.mainImageUrl,
    this.isFav = false,
    this.latitude,
    this.longitude
  });

  @override
  List<Object?> get props => [id,ownerId,status,title,price,city,governorate,address,description,type,rooms,bathrooms,bedrooms,area,rating,numberOfReviews,mainImageUrl,isFav];
}
// =======================================================
// FILE PATH: lib\domain\entities\apartment\apartments_list.dart
// =======================================================

import 'apartment.dart';

class ApartmentsList {
  final List<Apartment> apartments;
  final String? nextCursor;
  final String? prevCursor;

  ApartmentsList({
    required this.apartments,
    this.nextCursor,
    this.prevCursor,
  });
}
// =======================================================
// FILE PATH: lib\domain\entities\auth\auth_state.dart
// =======================================================

import '../user/user_entity.dart';

class AuthStatus {
  final bool isAuthenticated;
  final bool isPending;
  final UserEntity? user;

  AuthStatus({
    required this.isAuthenticated,
    required this.isPending,
    required this.user,
  });
}

// =======================================================
// FILE PATH: lib\domain\entities\booking\booking.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import '../apartment/apartment.dart';

class Booking extends Equatable {
  final int? id;
  final int? propertyId;
  final DateTime? checkIn;
  final DateTime? checkOut;
  final num? price;
  final int? userId;
  final UserEntity? user;
  final String? status;
  final String? totalPrice;
  final Apartment? apartment;

  const Booking({
    this.id,
    this.propertyId,
    this.checkIn,
    this.checkOut,
    this.price,
    this.userId,
    this.user,
    this.status,
    this.totalPrice,
    this.apartment,
  });

  @override
  List<Object?> get props => [
    id,
    propertyId,
    checkIn,
    checkOut,
    price,
    userId,
    user,
    status,
    totalPrice,
    apartment,
  ];
}
// =======================================================
// FILE PATH: lib\domain\entities\booking\booking_list.dart
// =======================================================

import 'package:malaz/domain/entities/booking/booking.dart';

import '../apartment/apartment.dart';

class BookingList {
  final List<Booking> booking;

  BookingList({
    required this.booking,
  });
}
// =======================================================
// FILE PATH: lib\domain\entities\chat\chat_message_entity.dart
// =======================================================

class ChatMessageEntity {
  final int id;
  final int conversationId;
  final int senderId;
  final String body;
  final DateTime? readAt;
  final DateTime createdAt;
  final DateTime updatedAt;

  ChatMessageEntity({
    required this.id,
    required this.conversationId,
    required this.senderId,
    required this.body,
    this.readAt,
    required this.createdAt,
    required this.updatedAt,
  });

  bool get isRead => readAt != null;

  bool get isEdited => updatedAt.isAfter(createdAt.add(const Duration(seconds: 1)));
}
// =======================================================
// FILE PATH: lib\domain\entities\filters\filters.dart
// =======================================================

class Filter {
  final double? minPrice;
  final double? maxPrice;
  final double? minArea;
  final double? maxArea;
  final String? type;

  final int? minRooms;
  final int? maxRooms;
  final int? minBedrooms;
  final int? maxBedrooms;
  final int? minBathrooms;
  final int? maxBathrooms;

  final double? lat;
  final double? lng;
  final double? radiusInKm;

  Filter({
    this.minPrice,
    this.maxPrice,
    this.minArea,
    this.maxArea,
    this.type,
    this.minRooms,
    this.maxRooms,
    this.minBedrooms,
    this.maxBedrooms,
    this.minBathrooms,
    this.maxBathrooms,
    this.lat,
    this.lng,
    this.radiusInKm,
  });

  Map<String, dynamic> toMap() {
    final map = <String, dynamic>{};
    if (minPrice != null) map['min_price'] = minPrice;
    if (maxPrice != null) map['max_price'] = maxPrice;
    if (minArea != null) map['min_area'] = minArea;
    if (maxArea != null) map['max_area'] = maxArea;
    if (type != null) map['type'] = type;

    if (minRooms != null) map['rooms_min'] = minRooms;
    if (maxRooms != null) map['rooms_max'] = maxRooms;

    if (minBedrooms != null) map['bedrooms_min'] = minBedrooms;
    if (maxBedrooms != null) map['bedrooms_max'] = maxBedrooms;

    if (minBathrooms != null) map['baths_min'] = minBathrooms;
    if (maxBathrooms != null) map['baths_max'] = maxBathrooms;

    if (lat != null && lng != null) {
      map['lat'] = lat;
      map['lng'] = lng;
      map['radius'] = radiusInKm ?? 10;
    }
    return map;
  }
}
// =======================================================
// FILE PATH: lib\domain\entities\location\location_entity.dart
// =======================================================

import 'package:equatable/equatable.dart';

class LocationEntity extends Equatable {
  final double lat;
  final double lng;
  final String address;

  const LocationEntity({
    required this.lat,
    required this.lng,
    required this.address,
  });

  @override
  List<Object?> get props => [lat, lng, address];
}
// =======================================================
// FILE PATH: lib\domain\entities\review\review.dart
// =======================================================

class Review {
  final int id;
  final String body;
  final int rating;
  final String createdAt;
  final int userId;
  final String userName;
  final String userImage;

  Review({
    required this.id,
    required this.body,
    required this.rating,
    required this.createdAt,
    required this.userId,
    required this.userName,
    required this.userImage,
  });
}

class ReviewsList {
  final List<Review> reviews;
  final String? nextCursor;

  ReviewsList({required this.reviews, this.nextCursor});
}
// =======================================================
// FILE PATH: lib\domain\entities\review\review_list.dart
// =======================================================

import 'package:malaz/domain/entities/review/review.dart';

class ReviewsList {
  final List<Review> reviews;
  final String? nextCursor;

  ReviewsList({required this.reviews, this.nextCursor});
}
// =======================================================
// FILE PATH: lib\domain\entities\user\user_entity.dart
// =======================================================

import 'package:equatable/equatable.dart';

class UserEntity extends Equatable{
  final int id;
  final String first_name;
  final String last_name;
  final String phone;
  final String role;
  final String date_of_birth;
  final String profile_image_url;
  final String identity_card_image_url;
  final String phone_verified_at;
  final String created_at;
  final String updated_at;

  UserEntity({
    required this.id,
    required this.first_name,
    required this.last_name,
    required this.phone,
    required this.role,
    required this.date_of_birth,
    required this.profile_image_url,
    required this.identity_card_image_url,
    required this.phone_verified_at,
    required this.created_at,
    required this.updated_at,
  });

  factory UserEntity.emptyPending() {
    return UserEntity(
      id: 0,
      role: 'PENDING',
      first_name: '',
      last_name: '',
      phone: '',
      date_of_birth: '',
      profile_image_url: '',
      identity_card_image_url: '',
      phone_verified_at: '',
      created_at: '',
      updated_at: '',
    );
  }
  @override
  // TODO: implement props
  List<Object?> get props => [
    id,
    first_name,
    last_name,
    phone,role,
    date_of_birth,
    profile_image_url,
    identity_card_image_url,
    phone_verified_at,
    created_at,
    updated_at
  ];

}
// =======================================================
// FILE PATH: lib\domain\repositories\apartment\apartment_repository.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/entities/apartment/apartments_list.dart';

import '../../entities/filters/filters.dart';

abstract class ApartmentRepository {
  Future<ApartmentsList> getApartments({required String? cursor, Filter? filter});
  Future<Either<Failure,Unit>> addApartment({
    required String title,
    required int price,
    required String city,
    required String governorate,
    required String address,
    required String description,
    required String type,
    required int rooms,
    required int bathrooms,
    required int bedrooms,
    required int area,
    required List <XFile> mainImageUrl,
    required XFile main_pic,
    required double latitude,
    required double longitude,
  });
  Future<ApartmentsList> getMyApartments({required String? cursor});


}

// =======================================================
// FILE PATH: lib\domain\repositories\auth\auth_repository.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:dio/dio.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';

import '../../entities/auth/auth_state.dart';

abstract class AuthRepository {

  Future<Either<Failure,UserEntity>> login({
    required String phoneNumber,
    required String password,
  });

  Future<Either<Failure, UserEntity>> register({
    required String phone,
    required String role,
    required String firstName,
    required String lastName,
    required String password,
    required String passwordConfirmation,
    required String dateOfBirth,
    required XFile profileImage,
    required XFile identityImage,
  });

  Future<Either<Failure,void>> logout();

  Future<Either<Failure,UserEntity?>> getCurrentUser();

  Future<Either<Failure,bool>> isAuthentication();

  Future<Either<Failure, void>> sendOtp({ required String phone });

  Future<Either<Failure, AuthStatus>> checkAuth();

  Future<Either<Failure, bool>> verifyOtp({ required String phone, required String otp });

  Future<Either<Failure, UserEntity>> updateProfile(FormData formData);

  Future<void> updateCachedUser(UserEntity user);

  Future<Either<Failure, String>> sendPasswordResetOtp(String phone);

  Future<Either<Failure, String>> updatePassword({
    required String phone,
    required String otp,
    required String newPassword,
  });
}
// =======================================================
// FILE PATH: lib\domain\repositories\booking\booking_repository.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/data/models/booking/booking_model.dart';
import '../../../core/errors/failures.dart';
import '../../entities/booking/booking.dart';
import '../../entities/booking/booking_list.dart';

abstract class BookingRepository {
  Future<Either<Failure, void>> makeBooking(Booking booking);
  Future<Either<Failure, List<BookingModel>>> getBookedDates(int propertyId);
  Future<Either<Failure, BookingList>> getUserBookings(int userId);
  Future<Either<Failure,void>> updateStatus(int propertyID,String status);
  Future<Either<Failure, BookingList>> getMyBookings(int userId);
  Future<Either<Failure, void>> updateBookingDates({required int bookingId, required String checkIn, required String checkOut,});

}
// =======================================================
// FILE PATH: lib\domain\repositories\chat\chat_repository.dart
// =======================================================

import 'package:dartz/dartz.dart';
import '../../../core/errors/failures.dart';
import '../../../data/models/chat/conversation_model.dart';
import '../../../data/models/chat/chat_message_model.dart';

abstract class ChatRepository {
  Future<Either<Failure, List<ConversationModel>>> getConversations();
  Future<Either<Failure, List<ChatMessageModel>>> getMessages(int conversationId);
  Future<Either<Failure, ChatMessageModel>> sendMessage(int conversationId, String body);
  Future<Either<Failure, Unit>> deleteMessage(int messageId);
  Future<Either<Failure, Unit>> editMessage(int messageId, String newBody);
  Future<Either<Failure, ConversationModel>> saveNewConversation(int partnerId);
  Future<Either<Failure, Unit>> deleteConversation(int conversationId);
  Future<Either<Failure, void>> markAsRead(int messageId);
}
// =======================================================
// FILE PATH: lib\domain\repositories\favorites\favorites_repository.dart
// =======================================================

import 'package:dartz/dartz.dart';
import '../../../../core/errors/failures.dart';
import '../../entities/apartment/apartment.dart';

abstract class FavoritesRepository {
  Future<Either<Failure, List<Apartment>>> getFavorites();
  Future<Either<Failure, void>> addFavorite(int apartmentId);
  Future<Either<Failure, void>> delFavorite(int apartmentId);
}


// =======================================================
// FILE PATH: lib\domain\repositories\location\location_repository.dart
// =======================================================

import '../../entities/location/location_entity.dart';

abstract class LocationRepository {
  Future<LocationEntity> getCurrentLocation(String lang);
  Future<LocationEntity?> getSavedLocation();
  Future<LocationEntity> updateManualLocation(double lat, double lng, String lang);
}
// =======================================================
// FILE PATH: lib\domain\repositories\review\review_repository.dart
// =======================================================

import 'package:dartz/dartz.dart';

import '../../../core/errors/failures.dart';
import '../../entities/review/review.dart';

abstract class ReviewsRepository {
  Future<Either<Failure, ReviewsList>> getReviews({
    required int propertyId,
    String? cursor,
  });

  Future<Either<Failure,Unit>> addReview({
    required String rating,
    required String body,
    required int idProperty
  });
}
// =======================================================
// FILE PATH: lib\domain\usecases\apartment\add_apartment_use_case.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/errors/failures.dart';

import '../../entities/apartment/apartment.dart';
import '../../repositories/apartment/apartment_repository.dart';

class AddApartmentUseCase {
  final ApartmentRepository repository;

  AddApartmentUseCase(this.repository);

  Future<Either<Failure,Unit>> call(ApartmentParams apartment) async{
    return await repository.addApartment(
        title: apartment.title,
        price: apartment.price,
        city: apartment.city,
        governorate: apartment.governorate,
        address: apartment.address,
        description: apartment.description,
        type: apartment.type,
        rooms: apartment.rooms,
        bathrooms: apartment.bathrooms,
        bedrooms: apartment.bedrooms,
        area: apartment.area,
        mainImageUrl: apartment.mainImageUrl,
        main_pic: apartment.main_pic,
        latitude: apartment.latitude,
        longitude:apartment.longitude

    );
  }
}

class ApartmentParams {
  final String title;
  final int price;
  final String city;
  final String governorate;
  final String address;
  final String description;
  final String type;
  final int rooms;
  final int bathrooms;
  final int bedrooms;
  final int area;
  final List <XFile> mainImageUrl;
  final XFile main_pic;
  final double latitude;
  final double longitude;

  ApartmentParams( {
    required this.title,
    required this.price,
    required this.city,
    required this.governorate,
    required this.address,
    required this.description,
    required this.type,
    required this.rooms,
    required this.bathrooms,
    required this.bedrooms,
    required this.area,
    required this.mainImageUrl,
    required this.main_pic,
    required this.latitude,
    required this.longitude,
  });
}

// =======================================================
// FILE PATH: lib\domain\usecases\apartment\my_apartment_use_case.dart
// =======================================================

import '../../entities/apartment/apartments_list.dart';
import '../../repositories/apartment/apartment_repository.dart';

class GetMyApartmentsUseCase {
  final ApartmentRepository repository;

  GetMyApartmentsUseCase(this.repository);

  Future<ApartmentsList> call({required String? cursor}) async {
    return await repository.getMyApartments(cursor: cursor);
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\auth\check_auth_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/core/usecases/usecase.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';

import '../../entities/auth/auth_state.dart';

class CheckAuthUsecase implements UseCase<AuthStatus, NoParams> {
  final AuthRepository repository;

  CheckAuthUsecase({required this.repository});

  @override
  Future<Either<Failure, AuthStatus>> call(NoParams params) async {
    return await repository.checkAuth();
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\auth\get_current_user_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/core/usecases/usecase.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';

class  GetCurrentUserUsecase implements UseCase<UserEntity?,NoParams>{
  final AuthRepository repository;

  GetCurrentUserUsecase({required this.repository});

  @override
  Future<Either<Failure, UserEntity?>> call(NoParams params) async {
    return await repository.getCurrentUser();
  }


}
// =======================================================
// FILE PATH: lib\domain\usecases\auth\login_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/core/usecases/usecase.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';

import '../../entities/user/user_entity.dart';

class LoginUsecase implements UseCase<UserEntity,LoginParams>{
  final AuthRepository repository;
  
  LoginUsecase({required this.repository});

  @override
  Future<Either<Failure, UserEntity>> call(LoginParams params) async {
    final res = await repository.login(phoneNumber: params.phoneNumber, password: params.password);
    print('is right : ${res.isRight()}');
    return res;
  }
}

class LoginParams{
  final String phoneNumber;
  final String password;

  LoginParams({required this.phoneNumber, required this.password});

}
// =======================================================
// FILE PATH: lib\domain\usecases\auth\logout_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/core/usecases/usecase.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';

class LogoutUsecase implements UseCase<void,NoParams>{
  final AuthRepository repository;

  LogoutUsecase({required this.repository});

  @override
  Future<Either<Failure, void>> call(NoParams params) async {
    return await repository.logout();
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\auth\register_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/core/usecases/usecase.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import 'package:malaz/domain/repositories/auth/auth_repository.dart';

class RegisterUsecase implements UseCase<UserEntity, RegisterParams> {
  final AuthRepository repository;

  RegisterUsecase({required this.repository});

  @override
  Future<Either<Failure, UserEntity>> call(RegisterParams params) async {
    return await repository.register(
      phone: params.phone,
      role: params.role,
      firstName: params.firstName,
      lastName: params.lastName,
      password: params.password,
      passwordConfirmation: params.passwordConfirmation,
      dateOfBirth: params.dateOfBirth,
      profileImage: params.profileImage,
      identityImage: params.identityCardImage,
    );
  }
}

class RegisterParams {
  final String phone;
  final String role;
  final String firstName;
  final String lastName;
  final String password;
  final String passwordConfirmation;
  final String dateOfBirth;
  final XFile profileImage;
  final XFile identityCardImage;

  RegisterParams({
    required this.phone,
    required this.role,
    required this.firstName,
    required this.lastName,
    required this.password,
    required this.passwordConfirmation,
    required this.dateOfBirth,
    required this.profileImage,
    required this.identityCardImage,
  });
}

// =======================================================
// FILE PATH: lib\domain\usecases\auth\send_otp_usecase.dart
// =======================================================

// domain/usecases/send_otp_usecase.dart
import 'package:dartz/dartz.dart';
import '../../../core/errors/failures.dart';
import '../../../core/usecases/usecase.dart';
import '../../repositories/auth/auth_repository.dart';

class SendOtpParams {
  final String phone;
  SendOtpParams(this.phone);
}

class SendOtpUsecase implements UseCase<void, SendOtpParams> {
  final AuthRepository repository;
  SendOtpUsecase(this.repository);
  @override
  Future<Either<Failure, void>> call(SendOtpParams params) {
    return repository.sendOtp(phone: params.phone);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\auth\verify_otp_usecase.dart
// =======================================================

// domain/usecases/verify_otp_usecase.dart
import 'package:dartz/dartz.dart';

import '../../../core/errors/failures.dart';
import '../../../core/usecases/usecase.dart';
import '../../repositories/auth/auth_repository.dart';

class VerifyOtpParams {
  final String phone;
  final String otp;
  VerifyOtpParams({required this.phone, required this.otp});
}

class VerifyOtpUsecase implements UseCase<bool, VerifyOtpParams> {
  final AuthRepository repository;
  VerifyOtpUsecase(this.repository);
  @override
  Future<Either<Failure, bool>> call(VerifyOtpParams params) {
    return repository.verifyOtp(phone: params.phone, otp: params.otp);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\booking\all_booking_use_case.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/domain/entities/booking/booking_list.dart';
import 'package:malaz/domain/repositories/booking/booking_repository.dart';
import '../../../core/errors/failures.dart';

class GetUserBooking {
  BookingRepository repository;
  GetUserBooking(this.repository);

  Future<Either<Failure,BookingList>> call({required int userId}) async {
    return await repository.getUserBookings(userId);
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\booking\Get_Booked_Dates_Use_Case.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/domain/repositories/booking/booking_repository.dart';

import '../../../core/errors/failures.dart';
import '../../../data/models/booking/booking_model.dart';

class GetBookedDatesUseCase {
  BookingRepository repository;
  GetBookedDatesUseCase(this.repository);

  Future<Either<Failure, List<BookingModel>>> call({required int propertyId}) async {
    return await repository.getBookedDates(propertyId);
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\booking\make_book_use_case.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/repositories/booking/booking_repository.dart';

import '../../entities/booking/booking.dart';

class MakeBookUseCase {
  final BookingRepository repository;
  MakeBookUseCase(this.repository);

  Future<Either<Failure, void>> call({required Booking booking}) async {
    return await repository.makeBooking(booking);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\booking\My_booking_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/domain/entities/booking/booking_list.dart';
import 'package:malaz/domain/repositories/booking/booking_repository.dart';
import '../../../core/errors/failures.dart';

class GetMyBooking {
  BookingRepository repository;
  GetMyBooking(this.repository);

  Future<Either<Failure,BookingList>> call({required int userId}) async {
    return await repository.getMyBookings(userId);
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\booking\update_Booking_Date.dart
// =======================================================

import 'package:dartz/dartz.dart';
import '../../../../core/errors/failures.dart';
import '../../repositories/booking/booking_repository.dart';

class UpdateBookingUseCase {
  final BookingRepository repository;

  UpdateBookingUseCase(this.repository);
  Future<Either<Failure, void>> call({required int bookingId, required String checkIn, required String checkOut,}) async {
    return await repository.updateBookingDates(bookingId: bookingId, checkIn: checkIn, checkOut: checkOut,);
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\booking\update_status_use_case.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/repositories/booking/booking_repository.dart';

import '../../entities/booking/booking.dart';

class UpdateStatus {
  final BookingRepository repository;
  UpdateStatus(this.repository);

  Future<Either<Failure, void>> call({required int propertyId,required String status}) async {
    return await repository.updateStatus(propertyId,status);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\favorites\add_favorites_use_case.dart
// =======================================================


import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/repositories/favorites/favorites_repository.dart';

class AddFavoriteUseCase {
  final FavoritesRepository repository;

  AddFavoriteUseCase(this.repository);

  Future<Either<Failure, void>> call(int apartmentId) async {
    return await repository.addFavorite(apartmentId);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\favorites\delete_favorites_use_case.dart
// =======================================================


import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/repositories/favorites/favorites_repository.dart';

class DeleteFavoriteUseCase {
  final FavoritesRepository repository;

  DeleteFavoriteUseCase(this.repository);

  Future<Either<Failure, void>> call(int apartmentId) async {
    return await repository.delFavorite(apartmentId);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\favorites\get_favorites_use_case.dart
// =======================================================


import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/repositories/favorites/favorites_repository.dart';

import '../../entities/apartment/apartment.dart';

class GetFavoritesUseCase {
  final FavoritesRepository repository;

  GetFavoritesUseCase(this.repository);

  Future<Either<Failure, List<Apartment>>> call() async {
    return await repository.getFavorites();
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\home\apartments_use_case.dart
// =======================================================


import 'package:malaz/domain/repositories/apartment/apartment_repository.dart';

import '../../entities/apartment/apartments_list.dart';
import '../../entities/filters/filters.dart';

class GetApartmentsUseCase {
  final ApartmentRepository repository;

  GetApartmentsUseCase(this.repository);

  Future<ApartmentsList> call({required String? cursor, Filter? filter}) async {
    return await repository.getApartments(cursor: cursor, filter: filter);
  }
}

// =======================================================
// FILE PATH: lib\domain\usecases\location\get_current_location_usecase.dart
// =======================================================

import '../../entities/location/location_entity.dart';
import '../../repositories/location/location_repository.dart';

class GetCurrentLocationUseCase {
  final LocationRepository repository;
  GetCurrentLocationUseCase(this.repository);

  Future<LocationEntity> call(String lang) async => await repository.getCurrentLocation(lang);
}
// =======================================================
// FILE PATH: lib\domain\usecases\location\load_saved_location_usecase.dart
// =======================================================

import '../../entities/location/location_entity.dart';
import '../../repositories/location/location_repository.dart';

class LoadSavedLocationUseCase {
  final LocationRepository repository;
  LoadSavedLocationUseCase(this.repository);

  Future<LocationEntity?> call() async => await repository.getSavedLocation();
}
// =======================================================
// FILE PATH: lib\domain\usecases\location\update_manual_location_usecase.dart
// =======================================================

import '../../entities/location/location_entity.dart';
import '../../repositories/location/location_repository.dart' show LocationRepository;

class UpdateManualLocationUseCase {
  final LocationRepository repository;
  UpdateManualLocationUseCase(this.repository);

  Future<LocationEntity> call(double lat, double lng, String lang) async =>
      await repository.updateManualLocation(lat, lng, lang);
}
// =======================================================
// FILE PATH: lib\domain\usecases\review\add_review_usecase.dart
// =======================================================

import 'package:dartz/dartz.dart';
import 'package:malaz/core/errors/failures.dart';

import '../../repositories/review/review_repository.dart';

class AddReviewsUseCase {
  final ReviewsRepository repository;

  AddReviewsUseCase(this.repository);

  Future<Either<Failure, Unit>> call({
    required String rating,
    required String body,
    required int idProperty
  }) async {
    return await repository.addReview(rating: rating, body: body,idProperty: idProperty);
  }
}
// =======================================================
// FILE PATH: lib\domain\usecases\review\get_review_use_case.dart
// =======================================================

import 'package:dartz/dartz.dart';

import '../../../core/errors/failures.dart';
import '../../entities/review/review.dart';
import '../../repositories/review/review_repository.dart';

class GetReviewsUseCase {
  final ReviewsRepository repository;

  GetReviewsUseCase(this.repository);

    Future<Either<Failure, ReviewsList>> call({
    required int propertyId,
    String? cursor
  }) async {
    return await repository.getReviews(propertyId: propertyId, cursor: cursor);
  }
}
// =======================================================
// FILE PATH: lib\l10n\app_localizations.dart
// =======================================================

import 'dart:async';

import 'package:flutter/foundation.dart';
import 'package:flutter/widgets.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:intl/intl.dart' as intl;

import 'app_localizations_ar.dart';
import 'app_localizations_en.dart';
import 'app_localizations_fr.dart';
import 'app_localizations_ru.dart';
import 'app_localizations_tr.dart';

// ignore_for_file: type=lint

/// Callers can lookup localized strings with an instance of AppLocalizations
/// returned by `AppLocalizations.of(context)`.
///
/// Applications need to include `AppLocalizations.delegate()` in their app's
/// `localizationDelegates` list, and the locales they support in the app's
/// `supportedLocales` list. For example:
///
/// ```dart
/// import 'l10n/app_localizations.dart';
///
/// return MaterialApp(
///   localizationsDelegates: AppLocalizations.localizationsDelegates,
///   supportedLocales: AppLocalizations.supportedLocales,
///   home: MyApplicationHome(),
/// );
/// ```
///
/// ## Update pubspec.yaml
///
/// Please make sure to update your pubspec.yaml to include the following
/// packages:
///
/// ```yaml
/// dependencies:
///   # Internationalization support.
///   flutter_localizations:
///     sdk: flutter
///   intl: any # Use the pinned version from flutter_localizations
///
///   # Rest of dependencies
/// ```
///
/// ## iOS Applications
///
/// iOS applications define key application metadata, including supported
/// locales, in an Info.plist file that is built into the application bundle.
/// To configure the locales supported by your app, you’ll need to edit this
/// file.
///
/// First, open your project’s ios/Runner.xcworkspace Xcode workspace file.
/// Then, in the Project Navigator, open the Info.plist file under the Runner
/// project’s Runner folder.
///
/// Next, select the Information Property List item, select Add Item from the
/// Editor menu, then select Localizations from the pop-up menu.
///
/// Select and expand the newly-created Localizations item then, for each
/// locale your application supports, add a new item and select the locale
/// you wish to add from the pop-up menu in the Value field. This list should
/// be consistent with the languages listed in the AppLocalizations.supportedLocales
/// property.
abstract class AppLocalizations {
  AppLocalizations(String locale)
      : localeName = intl.Intl.canonicalizedLocale(locale.toString());

  final String localeName;

  static AppLocalizations of(BuildContext context) {
    return Localizations.of<AppLocalizations>(context, AppLocalizations)!;
  }

  static const LocalizationsDelegate<AppLocalizations> delegate =
      _AppLocalizationsDelegate();

  /// A list of this localizations delegate along with the default localizations
  /// delegates.
  ///
  /// Returns a list of localizations delegates containing this delegate along with
  /// GlobalMaterialLocalizations.delegate, GlobalCupertinoLocalizations.delegate,
  /// and GlobalWidgetsLocalizations.delegate.
  ///
  /// Additional delegates can be added by appending to this list in
  /// MaterialApp. This list does not have to be used at all if a custom list
  /// of delegates is preferred or required.
  static const List<LocalizationsDelegate<dynamic>> localizationsDelegates =
      <LocalizationsDelegate<dynamic>>[
    delegate,
    GlobalMaterialLocalizations.delegate,
    GlobalCupertinoLocalizations.delegate,
    GlobalWidgetsLocalizations.delegate,
  ];

  /// A list of this localizations delegate's supported locales.
  static const List<Locale> supportedLocales = <Locale>[
    Locale('ar'),
    Locale('en'),
    Locale('fr'),
    Locale('ru'),
    Locale('tr')
  ];

  /// No description provided for @welcome_back.
  ///
  /// In en, this message translates to:
  /// **'Welcome Back'**
  String get welcome_back;

  /// No description provided for @login_to_continue.
  ///
  /// In en, this message translates to:
  /// **'Login to continue your search'**
  String get login_to_continue;

  /// No description provided for @mobile_number.
  ///
  /// In en, this message translates to:
  /// **'Mobile Number'**
  String get mobile_number;

  /// No description provided for @send_verification_code.
  ///
  /// In en, this message translates to:
  /// **'Send verification code'**
  String get send_verification_code;

  /// No description provided for @login.
  ///
  /// In en, this message translates to:
  /// **'Login'**
  String get login;

  /// No description provided for @logout.
  ///
  /// In en, this message translates to:
  /// **'Logout'**
  String get logout;

  /// No description provided for @dont_have_account.
  ///
  /// In en, this message translates to:
  /// **'Don\'t have an account?'**
  String get dont_have_account;

  /// No description provided for @my_bookings.
  ///
  /// In en, this message translates to:
  /// **'My Bookings'**
  String get my_bookings;

  /// No description provided for @bookings.
  ///
  /// In en, this message translates to:
  /// **'bookings'**
  String get bookings;

  /// No description provided for @my_favorites.
  ///
  /// In en, this message translates to:
  /// **'My Favorites'**
  String get my_favorites;

  /// No description provided for @favorites.
  ///
  /// In en, this message translates to:
  /// **'favorites'**
  String get favorites;

  /// No description provided for @chats.
  ///
  /// In en, this message translates to:
  /// **'chats'**
  String get chats;

  /// No description provided for @select_theme.
  ///
  /// In en, this message translates to:
  /// **'select theme'**
  String get select_theme;

  /// No description provided for @select_language.
  ///
  /// In en, this message translates to:
  /// **'select language'**
  String get select_language;

  /// No description provided for @messages.
  ///
  /// In en, this message translates to:
  /// **'Messages'**
  String get messages;

  /// No description provided for @register.
  ///
  /// In en, this message translates to:
  /// **'Register'**
  String get register;

  /// No description provided for @home.
  ///
  /// In en, this message translates to:
  /// **'Home'**
  String get home;

  /// No description provided for @settings.
  ///
  /// In en, this message translates to:
  /// **'Settings'**
  String get settings;

  /// No description provided for @theme.
  ///
  /// In en, this message translates to:
  /// **'Theme'**
  String get theme;

  /// No description provided for @my_profile.
  ///
  /// In en, this message translates to:
  /// **'My Profile'**
  String get my_profile;

  /// No description provided for @become_a_renter.
  ///
  /// In en, this message translates to:
  /// **'Become a Renter'**
  String get become_a_renter;

  /// No description provided for @language.
  ///
  /// In en, this message translates to:
  /// **'Language'**
  String get language;

  /// No description provided for @first_name.
  ///
  /// In en, this message translates to:
  /// **'First Name'**
  String get first_name;

  /// No description provided for @last_name.
  ///
  /// In en, this message translates to:
  /// **'Last Name'**
  String get last_name;

  /// No description provided for @have_account.
  ///
  /// In en, this message translates to:
  /// **'Do you already have an account ? '**
  String get have_account;

  /// No description provided for @create_account.
  ///
  /// In en, this message translates to:
  /// **'Create Account'**
  String get create_account;

  /// No description provided for @join_to_find.
  ///
  /// In en, this message translates to:
  /// **'Join us to find your perfect apartment !'**
  String get join_to_find;

  /// No description provided for @password.
  ///
  /// In en, this message translates to:
  /// **'Password'**
  String get password;

  /// No description provided for @confirm_password.
  ///
  /// In en, this message translates to:
  /// **'Confirm Password'**
  String get confirm_password;

  /// No description provided for @id_document_message.
  ///
  /// In en, this message translates to:
  /// **'Please upload a photo of your ID document for security purposes:'**
  String get id_document_message;

  /// No description provided for @upload_id_message.
  ///
  /// In en, this message translates to:
  /// **'Click to upload ID document'**
  String get upload_id_message;

  /// No description provided for @png_jpg.
  ///
  /// In en, this message translates to:
  /// **'PNG, JPG, PDF up to 10MB'**
  String get png_jpg;

  /// No description provided for @profile_image_message.
  ///
  /// In en, this message translates to:
  /// **'Choose a picture that suits you!\nIf you need that..\n\nyour profile picture will appear when you message your future apartment owner!'**
  String get profile_image_message;

  /// No description provided for @next.
  ///
  /// In en, this message translates to:
  /// **'Next'**
  String get next;

  /// No description provided for @previous.
  ///
  /// In en, this message translates to:
  /// **'Previous'**
  String get previous;

  /// No description provided for @send_code.
  ///
  /// In en, this message translates to:
  /// **'Send verification code'**
  String get send_code;

  /// No description provided for @date_of_birth.
  ///
  /// In en, this message translates to:
  /// **'Date Of Birth'**
  String get date_of_birth;

  /// No description provided for @six_digits.
  ///
  /// In en, this message translates to:
  /// **'Please enter a 6-digit PIN code'**
  String get six_digits;

  /// No description provided for @field_required.
  ///
  /// In en, this message translates to:
  /// **'This field is required'**
  String get field_required;

  /// No description provided for @image_required.
  ///
  /// In en, this message translates to:
  /// **'This image is required'**
  String get image_required;

  /// No description provided for @malaz.
  ///
  /// In en, this message translates to:
  /// **'MALAZ'**
  String get malaz;

  /// No description provided for @share_your_property.
  ///
  /// In en, this message translates to:
  /// **'Share your property details with us'**
  String get share_your_property;

  /// No description provided for @add_property.
  ///
  /// In en, this message translates to:
  /// **'Add property'**
  String get add_property;

  /// No description provided for @uploud_photo_property.
  ///
  /// In en, this message translates to:
  /// **'Click to upload photos of your property'**
  String get uploud_photo_property;

  /// No description provided for @essential_details.
  ///
  /// In en, this message translates to:
  /// **'Essential Details'**
  String get essential_details;

  /// No description provided for @bedrooms.
  ///
  /// In en, this message translates to:
  /// **'Bedrooms:'**
  String get bedrooms;

  /// No description provided for @bathrooms.
  ///
  /// In en, this message translates to:
  /// **'Bathrooms:'**
  String get bathrooms;

  /// No description provided for @bathrooms_no_dots.
  ///
  /// In en, this message translates to:
  /// **'Bathrooms'**
  String get bathrooms_no_dots;

  /// No description provided for @area.
  ///
  /// In en, this message translates to:
  /// **'Area:'**
  String get area;

  /// No description provided for @price.
  ///
  /// In en, this message translates to:
  /// **'Price'**
  String get price;

  /// No description provided for @property_type.
  ///
  /// In en, this message translates to:
  /// **'Property Type'**
  String get property_type;

  /// No description provided for @apartment.
  ///
  /// In en, this message translates to:
  /// **'Apartment'**
  String get apartment;

  /// No description provided for @villa.
  ///
  /// In en, this message translates to:
  /// **'Villa'**
  String get villa;

  /// No description provided for @house.
  ///
  /// In en, this message translates to:
  /// **'House'**
  String get house;

  /// No description provided for @farm.
  ///
  /// In en, this message translates to:
  /// **'Farm'**
  String get farm;

  /// No description provided for @country_house.
  ///
  /// In en, this message translates to:
  /// **'Country House'**
  String get country_house;

  /// No description provided for @location_details.
  ///
  /// In en, this message translates to:
  /// **'Location Details'**
  String get location_details;

  /// No description provided for @city.
  ///
  /// In en, this message translates to:
  /// **'City:'**
  String get city;

  /// No description provided for @syria.
  ///
  /// In en, this message translates to:
  /// **'Syria'**
  String get syria;

  /// No description provided for @governorate.
  ///
  /// In en, this message translates to:
  /// **'Governorate:'**
  String get governorate;

  /// No description provided for @damascus.
  ///
  /// In en, this message translates to:
  /// **'Damascus'**
  String get damascus;

  /// No description provided for @address.
  ///
  /// In en, this message translates to:
  /// **'Address:'**
  String get address;

  /// No description provided for @address_loc.
  ///
  /// In en, this message translates to:
  /// **'Alhamak,bostan Aldoor'**
  String get address_loc;

  /// No description provided for @description.
  ///
  /// In en, this message translates to:
  /// **'Description'**
  String get description;

  /// No description provided for @describe_property.
  ///
  /// In en, this message translates to:
  /// **'Describe your property details...'**
  String get describe_property;

  /// No description provided for @save.
  ///
  /// In en, this message translates to:
  /// **'Save'**
  String get save;

  /// No description provided for @verified_host.
  ///
  /// In en, this message translates to:
  /// **'Verified Host'**
  String get verified_host;

  /// No description provided for @owner.
  ///
  /// In en, this message translates to:
  /// **'Owner'**
  String get owner;

  /// No description provided for @rooms.
  ///
  /// In en, this message translates to:
  /// **'Rooms'**
  String get rooms;

  /// No description provided for @title.
  ///
  /// In en, this message translates to:
  /// **'Title'**
  String get title;

  /// No description provided for @reviews.
  ///
  /// In en, this message translates to:
  /// **'Reviews'**
  String get reviews;

  /// No description provided for @review.
  ///
  /// In en, this message translates to:
  /// **'Review'**
  String get review;

  /// No description provided for @view_all.
  ///
  /// In en, this message translates to:
  /// **'View All'**
  String get view_all;

  /// No description provided for @per_month.
  ///
  /// In en, this message translates to:
  /// **'per month'**
  String get per_month;

  /// No description provided for @book_now.
  ///
  /// In en, this message translates to:
  /// **'Book Now'**
  String get book_now;

  /// No description provided for @month.
  ///
  /// In en, this message translates to:
  /// **'month'**
  String get month;

  /// No description provided for @new_.
  ///
  /// In en, this message translates to:
  /// **'New'**
  String get new_;

  /// No description provided for @network_error_message.
  ///
  /// In en, this message translates to:
  /// **'Network error occurred. Please check your internet connection and try again.'**
  String get network_error_message;

  /// No description provided for @request_cancelled_error_message.
  ///
  /// In en, this message translates to:
  /// **'Request was cancelled'**
  String get request_cancelled_error_message;

  /// No description provided for @unexpected_error_message.
  ///
  /// In en, this message translates to:
  /// **'Unexpected error occurred'**
  String get unexpected_error_message;

  /// No description provided for @retry.
  ///
  /// In en, this message translates to:
  /// **'Retry'**
  String get retry;

  /// No description provided for @warring.
  ///
  /// In en, this message translates to:
  /// **'warring'**
  String get warring;

  /// No description provided for @edit_profile.
  ///
  /// In en, this message translates to:
  /// **'Edit Profile'**
  String get edit_profile;

  /// No description provided for @identity_verification.
  ///
  /// In en, this message translates to:
  /// **'Identity verification'**
  String get identity_verification;

  /// No description provided for @identity_verification_input.
  ///
  /// In en, this message translates to:
  /// **'Please enter your password to confirm identity'**
  String get identity_verification_input;

  /// No description provided for @current_password.
  ///
  /// In en, this message translates to:
  /// **'Current password'**
  String get current_password;

  /// No description provided for @cancel.
  ///
  /// In en, this message translates to:
  /// **'Cancel'**
  String get cancel;

  /// No description provided for @incorrect_password.
  ///
  /// In en, this message translates to:
  /// **'Incorrect Password'**
  String get incorrect_password;

  /// No description provided for @verify.
  ///
  /// In en, this message translates to:
  /// **'verification'**
  String get verify;

  /// No description provided for @profile_updated_success.
  ///
  /// In en, this message translates to:
  /// **'Profile Updated & Cached Successfully'**
  String get profile_updated_success;

  /// No description provided for @change_password.
  ///
  /// In en, this message translates to:
  /// **'Change Password'**
  String get change_password;

  /// No description provided for @otp_sent_success.
  ///
  /// In en, this message translates to:
  /// **'Verification code sent to your phone'**
  String get otp_sent_success;

  /// No description provided for @enter_otp_hint.
  ///
  /// In en, this message translates to:
  /// **'Enter the 6-digit code sent to you'**
  String get enter_otp_hint;

  /// No description provided for @new_password.
  ///
  /// In en, this message translates to:
  /// **'New Password'**
  String get new_password;

  /// No description provided for @confirm_new_password.
  ///
  /// In en, this message translates to:
  /// **'Confirm New Password'**
  String get confirm_new_password;

  /// No description provided for @password_mismatch.
  ///
  /// In en, this message translates to:
  /// **'Passwords do not match'**
  String get password_mismatch;

  /// No description provided for @password_changed_success.
  ///
  /// In en, this message translates to:
  /// **'Password changed successfully'**
  String get password_changed_success;

  /// No description provided for @resend_code.
  ///
  /// In en, this message translates to:
  /// **'Resend Code'**
  String get resend_code;

  /// No description provided for @done.
  ///
  /// In en, this message translates to:
  /// **'Done'**
  String get done;

  /// No description provided for @please_enter_password.
  ///
  /// In en, this message translates to:
  /// **'Please enter your password'**
  String get please_enter_password;

  /// No description provided for @passwords_do_not_match.
  ///
  /// In en, this message translates to:
  /// **'Passwords do not match'**
  String get passwords_do_not_match;

  /// No description provided for @wronge_otp.
  ///
  /// In en, this message translates to:
  /// **'The entered code is incorrect, please try again'**
  String get wronge_otp;

  /// No description provided for @otp_verified_success.
  ///
  /// In en, this message translates to:
  /// **'OTP verified successfully'**
  String get otp_verified_success;

  /// No description provided for @booking_request_sent.
  ///
  /// In en, this message translates to:
  /// **'Booking Request Sent To The Owner'**
  String get booking_request_sent;

  /// No description provided for @nights.
  ///
  /// In en, this message translates to:
  /// **'nights'**
  String get nights;

  /// No description provided for @confirm_booking.
  ///
  /// In en, this message translates to:
  /// **'Confirm Booking'**
  String get confirm_booking;

  /// No description provided for @reviews_count.
  ///
  /// In en, this message translates to:
  /// **'({count} reviews)'**
  String reviews_count(int count);

  /// No description provided for @no_description.
  ///
  /// In en, this message translates to:
  /// **'No description provided.'**
  String get no_description;

  /// No description provided for @baths.
  ///
  /// In en, this message translates to:
  /// **'Baths'**
  String get baths;

  /// No description provided for @click_to_view.
  ///
  /// In en, this message translates to:
  /// **'Click to view messages'**
  String get click_to_view;

  /// No description provided for @active_partners.
  ///
  /// In en, this message translates to:
  /// **'Active Partners'**
  String get active_partners;

  /// No description provided for @recent_messages.
  ///
  /// In en, this message translates to:
  /// **'Recent Messages'**
  String get recent_messages;

  /// No description provided for @malaz_chat.
  ///
  /// In en, this message translates to:
  /// **'Malaz Chat'**
  String get malaz_chat;

  /// No description provided for @no_conversations.
  ///
  /// In en, this message translates to:
  /// **'No conversations yet'**
  String get no_conversations;

  /// No description provided for @active.
  ///
  /// In en, this message translates to:
  /// **'Active'**
  String get active;

  /// No description provided for @delete_chat_title.
  ///
  /// In en, this message translates to:
  /// **'Delete Chat?'**
  String get delete_chat_title;

  /// No description provided for @delete_chat_confirm.
  ///
  /// In en, this message translates to:
  /// **'This will permanently remove the conversation.'**
  String get delete_chat_confirm;

  /// No description provided for @delete.
  ///
  /// In en, this message translates to:
  /// **'Delete'**
  String get delete;

  /// No description provided for @online_now.
  ///
  /// In en, this message translates to:
  /// **'Online now'**
  String get online_now;

  /// No description provided for @editing_message_hint.
  ///
  /// In en, this message translates to:
  /// **'Editing message...'**
  String get editing_message_hint;

  /// No description provided for @type_message_hint.
  ///
  /// In en, this message translates to:
  /// **'Type a message...'**
  String get type_message_hint;

  /// No description provided for @edit_message.
  ///
  /// In en, this message translates to:
  /// **'Edit Message'**
  String get edit_message;

  /// No description provided for @copy_text.
  ///
  /// In en, this message translates to:
  /// **'Copy Text'**
  String get copy_text;

  /// No description provided for @text_copied.
  ///
  /// In en, this message translates to:
  /// **'Text copied'**
  String get text_copied;

  /// No description provided for @delete_message.
  ///
  /// In en, this message translates to:
  /// **'Delete Message'**
  String get delete_message;

  /// No description provided for @edited.
  ///
  /// In en, this message translates to:
  /// **'Edited'**
  String get edited;

  /// No description provided for @no_favorites_yet.
  ///
  /// In en, this message translates to:
  /// **'No Favorites Yet'**
  String get no_favorites_yet;

  /// No description provided for @explore_and_save.
  ///
  /// In en, this message translates to:
  /// **'Start exploring and save your apartments here.'**
  String get explore_and_save;

  /// No description provided for @damascus_countryside.
  ///
  /// In en, this message translates to:
  /// **'Damascus Countryside'**
  String get damascus_countryside;

  /// No description provided for @jaramana.
  ///
  /// In en, this message translates to:
  /// **'Jaramana'**
  String get jaramana;

  /// No description provided for @aleppo.
  ///
  /// In en, this message translates to:
  /// **'Aleppo'**
  String get aleppo;

  /// No description provided for @homs.
  ///
  /// In en, this message translates to:
  /// **'Homs'**
  String get homs;

  /// No description provided for @hama.
  ///
  /// In en, this message translates to:
  /// **'Hama'**
  String get hama;

  /// No description provided for @latakia.
  ///
  /// In en, this message translates to:
  /// **'Latakia'**
  String get latakia;

  /// No description provided for @tartous.
  ///
  /// In en, this message translates to:
  /// **'Tartous'**
  String get tartous;

  /// No description provided for @idlib.
  ///
  /// In en, this message translates to:
  /// **'Idlib'**
  String get idlib;

  /// No description provided for @deir_alZor.
  ///
  /// In en, this message translates to:
  /// **'Deir ez-Zor'**
  String get deir_alZor;

  /// No description provided for @raqa.
  ///
  /// In en, this message translates to:
  /// **'Alraqa'**
  String get raqa;

  /// No description provided for @al_hasakah.
  ///
  /// In en, this message translates to:
  /// **'AL_Hasaka'**
  String get al_hasakah;

  /// No description provided for @daraa.
  ///
  /// In en, this message translates to:
  /// **'Daraa'**
  String get daraa;

  /// No description provided for @sweida.
  ///
  /// In en, this message translates to:
  /// **'Aweida'**
  String get sweida;

  /// No description provided for @quneitra.
  ///
  /// In en, this message translates to:
  /// **'Quneitra'**
  String get quneitra;

  /// No description provided for @property_manager.
  ///
  /// In en, this message translates to:
  /// **'Property Manager'**
  String get property_manager;

  /// No description provided for @add_new.
  ///
  /// In en, this message translates to:
  /// **'Add New'**
  String get add_new;

  /// No description provided for @my_properties.
  ///
  /// In en, this message translates to:
  /// **'My Properties'**
  String get my_properties;

  /// No description provided for @properties.
  ///
  /// In en, this message translates to:
  /// **'Properties'**
  String get properties;

  /// No description provided for @inbound.
  ///
  /// In en, this message translates to:
  /// **'Inbound'**
  String get inbound;

  /// No description provided for @history.
  ///
  /// In en, this message translates to:
  /// **'History'**
  String get history;

  /// No description provided for @no_properties_found.
  ///
  /// In en, this message translates to:
  /// **'No properties added yet.'**
  String get no_properties_found;

  /// No description provided for @guests.
  ///
  /// In en, this message translates to:
  /// **'Guests'**
  String get guests;

  /// No description provided for @saved.
  ///
  /// In en, this message translates to:
  /// **'Saved'**
  String get saved;

  /// No description provided for @title_hint.
  ///
  /// In en, this message translates to:
  /// **'Jasmine Apartment'**
  String get title_hint;

  /// No description provided for @booking_in_progress.
  ///
  /// In en, this message translates to:
  /// **'Confirming your booking...'**
  String get booking_in_progress;

  /// No description provided for @booking_success_title.
  ///
  /// In en, this message translates to:
  /// **'Booking Successful!'**
  String get booking_success_title;

  /// No description provided for @booking_success_message.
  ///
  /// In en, this message translates to:
  /// **'We will contact you soon to confirm the details.'**
  String get booking_success_message;

  /// No description provided for @action_okay.
  ///
  /// In en, this message translates to:
  /// **'Okay'**
  String get action_okay;

  /// No description provided for @location.
  ///
  /// In en, this message translates to:
  /// **'Location'**
  String get location;

  /// No description provided for @verified_account.
  ///
  /// In en, this message translates to:
  /// **'VERIFIED ACCOUNT'**
  String get verified_account;

  /// No description provided for @unknown_location.
  ///
  /// In en, this message translates to:
  /// **'Unknown Location'**
  String get unknown_location;

  /// No description provided for @back_to_top.
  ///
  /// In en, this message translates to:
  /// **'back to up'**
  String get back_to_top;

  /// No description provided for @filter_title.
  ///
  /// In en, this message translates to:
  /// **'Filter Results'**
  String get filter_title;

  /// No description provided for @filter_reset.
  ///
  /// In en, this message translates to:
  /// **'Reset'**
  String get filter_reset;

  /// No description provided for @filter_location_section.
  ///
  /// In en, this message translates to:
  /// **'Location'**
  String get filter_location_section;

  /// No description provided for @filter_current_location.
  ///
  /// In en, this message translates to:
  /// **'Current Location'**
  String get filter_current_location;

  /// No description provided for @filter_map_location.
  ///
  /// In en, this message translates to:
  /// **'On Map'**
  String get filter_map_location;

  /// No description provided for @filter_price_section.
  ///
  /// In en, this message translates to:
  /// **'Price Range (Dollar \$)'**
  String get filter_price_section;

  /// No description provided for @filter_type_section.
  ///
  /// In en, this message translates to:
  /// **'Property Type'**
  String get filter_type_section;

  /// No description provided for @filter_area_section.
  ///
  /// In en, this message translates to:
  /// **'Area (sqm)'**
  String get filter_area_section;

  /// No description provided for @filter_details_section.
  ///
  /// In en, this message translates to:
  /// **'Property Details'**
  String get filter_details_section;

  /// No description provided for @filter_total_rooms.
  ///
  /// In en, this message translates to:
  /// **'Total Rooms'**
  String get filter_total_rooms;

  /// No description provided for @filter_bedrooms.
  ///
  /// In en, this message translates to:
  /// **'Bedrooms'**
  String get filter_bedrooms;

  /// No description provided for @filter_bathrooms.
  ///
  /// In en, this message translates to:
  /// **'Bathrooms'**
  String get filter_bathrooms;

  /// No description provided for @filter_any.
  ///
  /// In en, this message translates to:
  /// **'Any'**
  String get filter_any;

  /// No description provided for @filter_apply_button.
  ///
  /// In en, this message translates to:
  /// **'Show Matching Results'**
  String get filter_apply_button;

  /// No description provided for @type_apartment.
  ///
  /// In en, this message translates to:
  /// **'Apartment'**
  String get type_apartment;

  /// No description provided for @type_villa.
  ///
  /// In en, this message translates to:
  /// **'Villa'**
  String get type_villa;

  /// No description provided for @type_farm.
  ///
  /// In en, this message translates to:
  /// **'Farm'**
  String get type_farm;

  /// No description provided for @type_country_house.
  ///
  /// In en, this message translates to:
  /// **'Country House'**
  String get type_country_house;

  /// No description provided for @type_studio.
  ///
  /// In en, this message translates to:
  /// **'Studio'**
  String get type_studio;

  /// No description provided for @phone_number_hint.
  ///
  /// In en, this message translates to:
  /// **'(963) 999 999 999'**
  String get phone_number_hint;

  /// No description provided for @enter_hint.
  ///
  /// In en, this message translates to:
  /// **'Enter'**
  String get enter_hint;

  /// No description provided for @new_messages.
  ///
  /// In en, this message translates to:
  /// **'New Messages'**
  String get new_messages;

  /// No description provided for @modify_reservation.
  ///
  /// In en, this message translates to:
  /// **'Modify Reservation'**
  String get modify_reservation;

  /// No description provided for @changing_dates_for.
  ///
  /// In en, this message translates to:
  /// **'Changing dates for {propertyTitle}'**
  String changing_dates_for(Object propertyTitle);

  /// No description provided for @confirm_new_dates.
  ///
  /// In en, this message translates to:
  /// **'Confirm New Dates'**
  String get confirm_new_dates;

  /// No description provided for @cancel_booking_title.
  ///
  /// In en, this message translates to:
  /// **'Cancel Booking?'**
  String get cancel_booking_title;

  /// No description provided for @cancel_booking_msg.
  ///
  /// In en, this message translates to:
  /// **'Are you sure you want to cancel your stay at {propertyTitle}? This action cannot be reversed.'**
  String cancel_booking_msg(Object propertyTitle);

  /// No description provided for @keep_stay.
  ///
  /// In en, this message translates to:
  /// **'Keep Stay'**
  String get keep_stay;

  /// No description provided for @yes_cancel.
  ///
  /// In en, this message translates to:
  /// **'Yes, Cancel'**
  String get yes_cancel;

  /// No description provided for @view_receipt.
  ///
  /// In en, this message translates to:
  /// **'View Receipt'**
  String get view_receipt;

  /// No description provided for @check_in.
  ///
  /// In en, this message translates to:
  /// **'CHECK-IN'**
  String get check_in;

  /// No description provided for @check_out.
  ///
  /// In en, this message translates to:
  /// **'CHECK-OUT'**
  String get check_out;

  /// No description provided for @edit.
  ///
  /// In en, this message translates to:
  /// **'Edit'**
  String get edit;

  /// No description provided for @status_pending.
  ///
  /// In en, this message translates to:
  /// **'PENDING'**
  String get status_pending;

  /// No description provided for @status_confirmed.
  ///
  /// In en, this message translates to:
  /// **'CONFIRMED'**
  String get status_confirmed;

  /// No description provided for @status_completed.
  ///
  /// In en, this message translates to:
  /// **'COMPLETED'**
  String get status_completed;

  /// No description provided for @status_canceled.
  ///
  /// In en, this message translates to:
  /// **'CANCELED'**
  String get status_canceled;

  /// No description provided for @status_conflicted.
  ///
  /// In en, this message translates to:
  /// **'CONFLICT'**
  String get status_conflicted;

  /// No description provided for @rate_the_apartment.
  ///
  /// In en, this message translates to:
  /// **'Rate the Apartment'**
  String get rate_the_apartment;

  /// No description provided for @view_details.
  ///
  /// In en, this message translates to:
  /// **'View Details'**
  String get view_details;

  /// No description provided for @password_length_message.
  ///
  /// In en, this message translates to:
  /// **'The Password must contain at least 6 characters'**
  String get password_length_message;

  /// No description provided for @not_chat_yourself.
  ///
  /// In en, this message translates to:
  /// **'You can\'t chat with yourself'**
  String get not_chat_yourself;

  /// No description provided for @reviews_title.
  ///
  /// In en, this message translates to:
  /// **'Ratings & Reviews'**
  String get reviews_title;

  /// No description provided for @reviews_empty_title.
  ///
  /// In en, this message translates to:
  /// **'No reviews yet'**
  String get reviews_empty_title;

  /// No description provided for @reviews_empty_subtitle.
  ///
  /// In en, this message translates to:
  /// **'Be the first to review this property!'**
  String get reviews_empty_subtitle;

  /// No description provided for @error_generic_title.
  ///
  /// In en, this message translates to:
  /// **'Oops, something went wrong'**
  String get error_generic_title;

  /// No description provided for @action_retry.
  ///
  /// In en, this message translates to:
  /// **'Retry'**
  String get action_retry;

  /// No description provided for @added_successfully.
  ///
  /// In en, this message translates to:
  /// **'Added successfully'**
  String get added_successfully;

  /// No description provided for @property_added_message.
  ///
  /// In en, this message translates to:
  /// **'Your property is now being processed and will be visible to everyone as soon as it is approved.'**
  String get property_added_message;

  /// No description provided for @complete_all_fields.
  ///
  /// In en, this message translates to:
  /// **'Please complete all required information.'**
  String get complete_all_fields;

  /// No description provided for @at_least_one_img.
  ///
  /// In en, this message translates to:
  /// **'At least one image is required'**
  String get at_least_one_img;

  /// No description provided for @click_to_select_location.
  ///
  /// In en, this message translates to:
  /// **'Click to select location'**
  String get click_to_select_location;

  /// No description provided for @search.
  ///
  /// In en, this message translates to:
  /// **'Search...'**
  String get search;

  /// No description provided for @confirm_location.
  ///
  /// In en, this message translates to:
  /// **'Confirm Location'**
  String get confirm_location;

  /// No description provided for @confirm_post_property.
  ///
  /// In en, this message translates to:
  /// **'Property listing confirmation'**
  String get confirm_post_property;

  /// No description provided for @confirm_post_property_message.
  ///
  /// In en, this message translates to:
  /// **'The property details will be sent for review. Are you sure the information is correct?'**
  String get confirm_post_property_message;

  /// No description provided for @yes_post_it.
  ///
  /// In en, this message translates to:
  /// **'Yes, publish it.'**
  String get yes_post_it;
}

class _AppLocalizationsDelegate
    extends LocalizationsDelegate<AppLocalizations> {
  const _AppLocalizationsDelegate();

  @override
  Future<AppLocalizations> load(Locale locale) {
    return SynchronousFuture<AppLocalizations>(lookupAppLocalizations(locale));
  }

  @override
  bool isSupported(Locale locale) =>
      <String>['ar', 'en', 'fr', 'ru', 'tr'].contains(locale.languageCode);

  @override
  bool shouldReload(_AppLocalizationsDelegate old) => false;
}

AppLocalizations lookupAppLocalizations(Locale locale) {
  // Lookup logic when only language code is specified.
  switch (locale.languageCode) {
    case 'ar':
      return AppLocalizationsAr();
    case 'en':
      return AppLocalizationsEn();
    case 'fr':
      return AppLocalizationsFr();
    case 'ru':
      return AppLocalizationsRu();
    case 'tr':
      return AppLocalizationsTr();
  }

  throw FlutterError(
      'AppLocalizations.delegate failed to load unsupported locale "$locale". This is likely '
      'an issue with the localizations generation tool. Please file an issue '
      'on GitHub with a reproducible sample app and the gen-l10n configuration '
      'that was used.');
}

// =======================================================
// FILE PATH: lib\l10n\app_localizations_ar.dart
// =======================================================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for Arabic (`ar`).
class AppLocalizationsAr extends AppLocalizations {
  AppLocalizationsAr([String locale = 'ar']) : super(locale);

  @override
  String get welcome_back => 'مرحباً بعودتك';

  @override
  String get login_to_continue => 'سجل الدخول للمتابعة في البحث';

  @override
  String get mobile_number => 'رقم الهاتف';

  @override
  String get send_verification_code => 'إرسال رمز التحقق';

  @override
  String get login => 'تسجيل الدخول';

  @override
  String get logout => 'تسجيل الخروج';

  @override
  String get dont_have_account => 'ليس لديك حساب؟';

  @override
  String get my_bookings => 'حجوزاتي';

  @override
  String get bookings => 'الحجوزات';

  @override
  String get my_favorites => 'مفضلاتي';

  @override
  String get favorites => 'المفضلة';

  @override
  String get chats => 'المحادثات';

  @override
  String get select_theme => 'اختر المظهر';

  @override
  String get select_language => 'اختر اللغة';

  @override
  String get messages => 'الرسائل';

  @override
  String get register => 'تسجيل';

  @override
  String get home => 'الرئيسية';

  @override
  String get settings => 'الإعدادات';

  @override
  String get theme => 'المظهر';

  @override
  String get my_profile => 'ملفي الشخصي';

  @override
  String get become_a_renter => 'كن مؤجراً';

  @override
  String get language => 'اللغة';

  @override
  String get first_name => 'الاسم الأول';

  @override
  String get last_name => 'الاسم الأخير';

  @override
  String get have_account => 'هل لديك حساب بالفعل؟';

  @override
  String get create_account => 'إنشاء حساب';

  @override
  String get join_to_find => 'انضم إلينا للعثور على شقتك المثالية!';

  @override
  String get password => 'كلمة المرور';

  @override
  String get confirm_password => 'تأكيد كلمة المرور';

  @override
  String get id_document_message => 'يرجى رفع صورة لبطاقة هويتك لأغراض أمنية:';

  @override
  String get upload_id_message => 'اضغط لرفع وثيقة الهوية';

  @override
  String get png_jpg => 'PNG, JPG, PDF بحد أقصى 10 ميجابايت';

  @override
  String get profile_image_message =>
      'اختر صورة تناسبك!\nإذا كنت بحاجة لذلك..\n\nستظهر صورة ملفك الشخصي عندما تراسل مالك شقتك المستقبلي!';

  @override
  String get next => 'التالي';

  @override
  String get previous => 'السابق';

  @override
  String get send_code => 'إرسال رمز التحقق';

  @override
  String get date_of_birth => 'تاريخ الميلاد';

  @override
  String get six_digits => 'يرجى إداخل رمز PIN المكون من 6 أرقام';

  @override
  String get field_required => 'هذا الحقل مطلوب';

  @override
  String get image_required => 'هذه الصورة مطلوبة';

  @override
  String get malaz => 'ملاذ';

  @override
  String get share_your_property => 'شارك تفاصيل عقارك معنا';

  @override
  String get add_property => 'إضافة عقار';

  @override
  String get uploud_photo_property => 'اضغط لرفع صور عقارك';

  @override
  String get essential_details => 'التفاصيل الأساسية';

  @override
  String get bedrooms => 'غرف النوم:';

  @override
  String get bathrooms => 'الحمامات:';

  @override
  String get bathrooms_no_dots => 'الحمامات';

  @override
  String get area => 'المساحة:';

  @override
  String get price => 'السعر';

  @override
  String get property_type => 'نوع العقار';

  @override
  String get apartment => 'شقة';

  @override
  String get villa => 'فيلا';

  @override
  String get house => 'منزل';

  @override
  String get farm => 'مزرعة';

  @override
  String get country_house => 'بيت ريفي';

  @override
  String get location_details => 'تفاصيل الموقع';

  @override
  String get city => 'المدينة';

  @override
  String get syria => 'سوريا';

  @override
  String get governorate => 'المحافظة';

  @override
  String get damascus => 'دمشق';

  @override
  String get address => 'العنوان';

  @override
  String get address_loc => 'الهمك، بستان الدور';

  @override
  String get description => 'الوصف';

  @override
  String get describe_property => 'صف تفاصيل عقارك...';

  @override
  String get save => 'حفظ';

  @override
  String get verified_host => 'مضيف موثق';

  @override
  String get owner => 'المالك';

  @override
  String get rooms => 'الغرف';

  @override
  String get title => 'العنوان';

  @override
  String get reviews => 'التقييمات';

  @override
  String get review => 'تقييم';

  @override
  String get view_all => 'عرض الكل';

  @override
  String get per_month => 'شهرياً';

  @override
  String get book_now => 'احجز الآن';

  @override
  String get month => 'شهر';

  @override
  String get new_ => 'جديد';

  @override
  String get network_error_message =>
      'حدث خطأ في الشبكة. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.';

  @override
  String get request_cancelled_error_message => 'تم إلغاء الطلب';

  @override
  String get unexpected_error_message => 'حدث خطأ غير متوقع';

  @override
  String get retry => 'إعادة المحاولة';

  @override
  String get warring => 'تنبيه';

  @override
  String get edit_profile => 'تعديل الحساب';

  @override
  String get identity_verification => 'التحقق من الهوية';

  @override
  String get identity_verification_input =>
      'يرجى إدخال كلمة المرور الخاصة بك لتأكيد هويتك';

  @override
  String get current_password => 'كلمة المرور الحالية';

  @override
  String get cancel => 'إلغاء';

  @override
  String get incorrect_password => 'كلمة المرور غير صحيحة';

  @override
  String get verify => 'تحقق';

  @override
  String get profile_updated_success => 'تم تحديث الملف الشخصي وحفظه بنجاح';

  @override
  String get change_password => 'تغيير كلمة المرور';

  @override
  String get otp_sent_success => 'تم إرسال رمز التأكيد إلى هاتفك';

  @override
  String get enter_otp_hint => 'أدخل الرمز المكون من 6 أرقام المرسل إليك';

  @override
  String get new_password => 'كلمة المرور الجديدة';

  @override
  String get confirm_new_password => 'تأكيد كلمة المرور الجديدة';

  @override
  String get password_mismatch => 'كلمتا المرور غير متطابقتين';

  @override
  String get password_changed_success => 'تم تغيير كلمة المرور بنجاح';

  @override
  String get resend_code => 'إعادة إرسال الرمز';

  @override
  String get done => 'تم';

  @override
  String get please_enter_password => 'الرجاء إدخال كلمة المرور';

  @override
  String get passwords_do_not_match => 'كلمتا السر غير متطابقتين';

  @override
  String get wronge_otp => 'الرمز المدخل غير صحيح، يرجى المحاولة مرة أخرى';

  @override
  String get otp_verified_success => 'تم التحقق من الرمز بنجاح';

  @override
  String get booking_request_sent => 'تم إرسال طلب الحجز إلى المالك';

  @override
  String get nights => 'ليالي';

  @override
  String get confirm_booking => 'تأكيد الحجز';

  @override
  String reviews_count(int count) {
    return '($count تقييم)';
  }

  @override
  String get no_description => 'لا يوجد وصف متوفر.';

  @override
  String get baths => 'الحمامات';

  @override
  String get click_to_view => 'انقر لعرض الرسائل';

  @override
  String get active_partners => 'الشركاء النشطون';

  @override
  String get recent_messages => 'الرسائل الأخيرة';

  @override
  String get malaz_chat => 'دردشة ملاذ';

  @override
  String get no_conversations => 'لا توجد محادثات بعد';

  @override
  String get active => 'نشط';

  @override
  String get delete_chat_title => 'حذف الدردشة؟';

  @override
  String get delete_chat_confirm => 'سيؤدي هذا إلى إزالة المحادثة نهائيًا.';

  @override
  String get delete => 'حذف';

  @override
  String get online_now => 'متصل الآن';

  @override
  String get editing_message_hint => 'تعديل الرسالة...';

  @override
  String get type_message_hint => 'اكتب رسالتك...';

  @override
  String get edit_message => 'تعديل الرسالة';

  @override
  String get copy_text => 'نسخ النص';

  @override
  String get text_copied => 'تم نسخ النص';

  @override
  String get delete_message => 'حذف الرسالة';

  @override
  String get edited => 'معدلة';

  @override
  String get no_favorites_yet => 'لا توجد مفضلات بعد';

  @override
  String get explore_and_save => 'ابدأ في الاستكشاف واحفظ شقق هنا.';

  @override
  String get damascus_countryside => 'ريف دمشق';

  @override
  String get jaramana => 'جرمانا';

  @override
  String get aleppo => 'حلب';

  @override
  String get homs => 'حمص';

  @override
  String get hama => 'حماة';

  @override
  String get latakia => 'اللاذقية';

  @override
  String get tartous => 'طرطوس';

  @override
  String get idlib => 'ادلب';

  @override
  String get deir_alZor => 'دير الزور';

  @override
  String get raqa => 'الرقة';

  @override
  String get al_hasakah => 'الحسكة';

  @override
  String get daraa => 'درعا';

  @override
  String get sweida => 'السويداء';

  @override
  String get quneitra => 'القنيطرة';

  @override
  String get property_manager => 'إدارة العقارات';

  @override
  String get add_new => 'إضافة جديد';

  @override
  String get my_properties => 'عقاراتي';

  @override
  String get properties => 'العقارات';

  @override
  String get inbound => 'الواردة';

  @override
  String get history => 'الأرشيف';

  @override
  String get no_properties_found => 'لم يتم إضافة عقارات بعد.';

  @override
  String get guests => 'ضيوف';

  @override
  String get saved => 'المفضلة';

  @override
  String get title_hint => 'شقة الياسمين';

  @override
  String get booking_in_progress => 'جاري تأكيد حجزك...';

  @override
  String get booking_success_title => 'تم الحجز بنجاح!';

  @override
  String get booking_success_message =>
      'سيتم التواصل معك قريباً لتأكيد التفاصيل.';

  @override
  String get action_okay => 'حسناً';

  @override
  String get location => 'الموقع';

  @override
  String get verified_account => 'حساب موثق';

  @override
  String get unknown_location => 'موقع غير معروف';

  @override
  String get back_to_top => 'العودة للأعلى';

  @override
  String get filter_title => 'تصفية النتائج';

  @override
  String get filter_reset => 'إعادة تعيين';

  @override
  String get filter_location_section => 'الموقع الجغرافي';

  @override
  String get filter_current_location => 'موقعي الحالي';

  @override
  String get filter_map_location => 'على الخريطة';

  @override
  String get filter_price_section => 'نطاق السعر (دولار \$)';

  @override
  String get filter_type_section => 'نوع العقار';

  @override
  String get filter_area_section => 'المساحة (متر مربع)';

  @override
  String get filter_details_section => 'تفاصيل العقار';

  @override
  String get filter_total_rooms => 'عدد الغرف (الكلي)';

  @override
  String get filter_bedrooms => 'غرف النوم';

  @override
  String get filter_bathrooms => 'عدد الحمامات';

  @override
  String get filter_any => 'الكل';

  @override
  String get filter_apply_button => 'عرض النتائج المطابقة';

  @override
  String get type_apartment => 'شقة';

  @override
  String get type_villa => 'فيلا';

  @override
  String get type_farm => 'مزرعة';

  @override
  String get type_country_house => 'منزل ريفي';

  @override
  String get type_studio => 'استديو';

  @override
  String get phone_number_hint => '(٩٦٣) ٩٩٩ ٩٩٩ ٩٩٩';

  @override
  String get enter_hint => 'أدخل';

  @override
  String get new_messages => 'رسائل جديدة';

  @override
  String get modify_reservation => 'تعديل الحجز';

  @override
  String changing_dates_for(Object propertyTitle) {
    return 'تغيير المواعيد لـ $propertyTitle';
  }

  @override
  String get confirm_new_dates => 'تأكيد المواعيد الجديدة';

  @override
  String get cancel_booking_title => 'إلغاء الحجز؟';

  @override
  String cancel_booking_msg(Object propertyTitle) {
    return 'هل أنت متأكد من رغبتك في إلغاء إقامتك في $propertyTitle؟ لا يمكن التراجع عن هذا الإجراء.';
  }

  @override
  String get keep_stay => 'البقاء على الحجز';

  @override
  String get yes_cancel => 'نعم، إلغاء';

  @override
  String get view_receipt => 'عرض الإيصال';

  @override
  String get check_in => 'تسجيل الوصول';

  @override
  String get check_out => 'تسجيل المغادرة';

  @override
  String get edit => 'تعديل';

  @override
  String get status_pending => 'قيد الانتظار';

  @override
  String get status_confirmed => 'مؤكد';

  @override
  String get status_completed => 'مكتمل';

  @override
  String get status_canceled => 'ملغي';

  @override
  String get status_conflicted => 'تعارض';

  @override
  String get rate_the_apartment => 'تقييم الشقة';

  @override
  String get view_details => 'عرض التفاصيل';

  @override
  String get password_length_message =>
      'يجب أن تحتوي كلمة المرور على 6 أحرف على الأقل';

  @override
  String get not_chat_yourself => '! لا يمكنك التحدث مع نفسك';

  @override
  String get reviews_title => 'التقييمات والآراء';

  @override
  String get reviews_empty_title => 'لا توجد تقييمات بعد';

  @override
  String get reviews_empty_subtitle => 'كن أول من يقيم هذا العقار!';

  @override
  String get error_generic_title => 'عذراً، حدث خطأ ما';

  @override
  String get action_retry => 'إعادة المحاولة';

  @override
  String get added_successfully => 'تمت الإضافة بنجاح';

  @override
  String get property_added_message =>
      'عقارك الآن تحت المعالجة وسيظهر للجميع فور الموافقة عليه';

  @override
  String get complete_all_fields => 'يرجى إكمال جميع البيانات المطلوبة';

  @override
  String get at_least_one_img => 'يلزم وجود صورة واحدة على الأقل';

  @override
  String get click_to_select_location => 'انقر لتحديد الموقع';

  @override
  String get search => '...بحث';

  @override
  String get confirm_location => 'تأكيد الموقع';

  @override
  String get confirm_post_property => 'تأكيد نشر العقار';

  @override
  String get confirm_post_property_message =>
      'سيتم إرسال بيانات العقار للمراجعة، هل أنت متأكد من صحة المعلومات؟';

  @override
  String get yes_post_it => 'نعم، أنشر';
}

// =======================================================
// FILE PATH: lib\l10n\app_localizations_en.dart
// =======================================================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for English (`en`).
class AppLocalizationsEn extends AppLocalizations {
  AppLocalizationsEn([String locale = 'en']) : super(locale);

  @override
  String get welcome_back => 'Welcome Back';

  @override
  String get login_to_continue => 'Login to continue your search';

  @override
  String get mobile_number => 'Mobile Number';

  @override
  String get send_verification_code => 'Send verification code';

  @override
  String get login => 'Login';

  @override
  String get logout => 'Logout';

  @override
  String get dont_have_account => 'Don\'t have an account?';

  @override
  String get my_bookings => 'My Bookings';

  @override
  String get bookings => 'bookings';

  @override
  String get my_favorites => 'My Favorites';

  @override
  String get favorites => 'favorites';

  @override
  String get chats => 'chats';

  @override
  String get select_theme => 'select theme';

  @override
  String get select_language => 'select language';

  @override
  String get messages => 'Messages';

  @override
  String get register => 'Register';

  @override
  String get home => 'Home';

  @override
  String get settings => 'Settings';

  @override
  String get theme => 'Theme';

  @override
  String get my_profile => 'My Profile';

  @override
  String get become_a_renter => 'Become a Renter';

  @override
  String get language => 'Language';

  @override
  String get first_name => 'First Name';

  @override
  String get last_name => 'Last Name';

  @override
  String get have_account => 'Do you already have an account ? ';

  @override
  String get create_account => 'Create Account';

  @override
  String get join_to_find => 'Join us to find your perfect apartment !';

  @override
  String get password => 'Password';

  @override
  String get confirm_password => 'Confirm Password';

  @override
  String get id_document_message =>
      'Please upload a photo of your ID document for security purposes:';

  @override
  String get upload_id_message => 'Click to upload ID document';

  @override
  String get png_jpg => 'PNG, JPG, PDF up to 10MB';

  @override
  String get profile_image_message =>
      'Choose a picture that suits you!\nIf you need that..\n\nyour profile picture will appear when you message your future apartment owner!';

  @override
  String get next => 'Next';

  @override
  String get previous => 'Previous';

  @override
  String get send_code => 'Send verification code';

  @override
  String get date_of_birth => 'Date Of Birth';

  @override
  String get six_digits => 'Please enter a 6-digit PIN code';

  @override
  String get field_required => 'This field is required';

  @override
  String get image_required => 'This image is required';

  @override
  String get malaz => 'MALAZ';

  @override
  String get share_your_property => 'Share your property details with us';

  @override
  String get add_property => 'Add property';

  @override
  String get uploud_photo_property => 'Click to upload photos of your property';

  @override
  String get essential_details => 'Essential Details';

  @override
  String get bedrooms => 'Bedrooms:';

  @override
  String get bathrooms => 'Bathrooms:';

  @override
  String get bathrooms_no_dots => 'Bathrooms';

  @override
  String get area => 'Area:';

  @override
  String get price => 'Price';

  @override
  String get property_type => 'Property Type';

  @override
  String get apartment => 'Apartment';

  @override
  String get villa => 'Villa';

  @override
  String get house => 'House';

  @override
  String get farm => 'Farm';

  @override
  String get country_house => 'Country House';

  @override
  String get location_details => 'Location Details';

  @override
  String get city => 'City:';

  @override
  String get syria => 'Syria';

  @override
  String get governorate => 'Governorate:';

  @override
  String get damascus => 'Damascus';

  @override
  String get address => 'Address:';

  @override
  String get address_loc => 'Alhamak,bostan Aldoor';

  @override
  String get description => 'Description';

  @override
  String get describe_property => 'Describe your property details...';

  @override
  String get save => 'Save';

  @override
  String get verified_host => 'Verified Host';

  @override
  String get owner => 'Owner';

  @override
  String get rooms => 'Rooms';

  @override
  String get title => 'Title';

  @override
  String get reviews => 'Reviews';

  @override
  String get review => 'Review';

  @override
  String get view_all => 'View All';

  @override
  String get per_month => 'per month';

  @override
  String get book_now => 'Book Now';

  @override
  String get month => 'month';

  @override
  String get new_ => 'New';

  @override
  String get network_error_message =>
      'Network error occurred. Please check your internet connection and try again.';

  @override
  String get request_cancelled_error_message => 'Request was cancelled';

  @override
  String get unexpected_error_message => 'Unexpected error occurred';

  @override
  String get retry => 'Retry';

  @override
  String get warring => 'warring';

  @override
  String get edit_profile => 'Edit Profile';

  @override
  String get identity_verification => 'Identity verification';

  @override
  String get identity_verification_input =>
      'Please enter your password to confirm identity';

  @override
  String get current_password => 'Current password';

  @override
  String get cancel => 'Cancel';

  @override
  String get incorrect_password => 'Incorrect Password';

  @override
  String get verify => 'verification';

  @override
  String get profile_updated_success => 'Profile Updated & Cached Successfully';

  @override
  String get change_password => 'Change Password';

  @override
  String get otp_sent_success => 'Verification code sent to your phone';

  @override
  String get enter_otp_hint => 'Enter the 6-digit code sent to you';

  @override
  String get new_password => 'New Password';

  @override
  String get confirm_new_password => 'Confirm New Password';

  @override
  String get password_mismatch => 'Passwords do not match';

  @override
  String get password_changed_success => 'Password changed successfully';

  @override
  String get resend_code => 'Resend Code';

  @override
  String get done => 'Done';

  @override
  String get please_enter_password => 'Please enter your password';

  @override
  String get passwords_do_not_match => 'Passwords do not match';

  @override
  String get wronge_otp => 'The entered code is incorrect, please try again';

  @override
  String get otp_verified_success => 'OTP verified successfully';

  @override
  String get booking_request_sent => 'Booking Request Sent To The Owner';

  @override
  String get nights => 'nights';

  @override
  String get confirm_booking => 'Confirm Booking';

  @override
  String reviews_count(int count) {
    return '($count reviews)';
  }

  @override
  String get no_description => 'No description provided.';

  @override
  String get baths => 'Baths';

  @override
  String get click_to_view => 'Click to view messages';

  @override
  String get active_partners => 'Active Partners';

  @override
  String get recent_messages => 'Recent Messages';

  @override
  String get malaz_chat => 'Malaz Chat';

  @override
  String get no_conversations => 'No conversations yet';

  @override
  String get active => 'Active';

  @override
  String get delete_chat_title => 'Delete Chat?';

  @override
  String get delete_chat_confirm =>
      'This will permanently remove the conversation.';

  @override
  String get delete => 'Delete';

  @override
  String get online_now => 'Online now';

  @override
  String get editing_message_hint => 'Editing message...';

  @override
  String get type_message_hint => 'Type a message...';

  @override
  String get edit_message => 'Edit Message';

  @override
  String get copy_text => 'Copy Text';

  @override
  String get text_copied => 'Text copied';

  @override
  String get delete_message => 'Delete Message';

  @override
  String get edited => 'Edited';

  @override
  String get no_favorites_yet => 'No Favorites Yet';

  @override
  String get explore_and_save =>
      'Start exploring and save your apartments here.';

  @override
  String get damascus_countryside => 'Damascus Countryside';

  @override
  String get jaramana => 'Jaramana';

  @override
  String get aleppo => 'Aleppo';

  @override
  String get homs => 'Homs';

  @override
  String get hama => 'Hama';

  @override
  String get latakia => 'Latakia';

  @override
  String get tartous => 'Tartous';

  @override
  String get idlib => 'Idlib';

  @override
  String get deir_alZor => 'Deir ez-Zor';

  @override
  String get raqa => 'Alraqa';

  @override
  String get al_hasakah => 'AL_Hasaka';

  @override
  String get daraa => 'Daraa';

  @override
  String get sweida => 'Aweida';

  @override
  String get quneitra => 'Quneitra';

  @override
  String get property_manager => 'Property Manager';

  @override
  String get add_new => 'Add New';

  @override
  String get my_properties => 'My Properties';

  @override
  String get properties => 'Properties';

  @override
  String get inbound => 'Inbound';

  @override
  String get history => 'History';

  @override
  String get no_properties_found => 'No properties added yet.';

  @override
  String get guests => 'Guests';

  @override
  String get saved => 'Saved';

  @override
  String get title_hint => 'Jasmine Apartment';

  @override
  String get booking_in_progress => 'Confirming your booking...';

  @override
  String get booking_success_title => 'Booking Successful!';

  @override
  String get booking_success_message =>
      'We will contact you soon to confirm the details.';

  @override
  String get action_okay => 'Okay';

  @override
  String get location => 'Location';

  @override
  String get verified_account => 'VERIFIED ACCOUNT';

  @override
  String get unknown_location => 'Unknown Location';

  @override
  String get back_to_top => 'back to up';

  @override
  String get filter_title => 'Filter Results';

  @override
  String get filter_reset => 'Reset';

  @override
  String get filter_location_section => 'Location';

  @override
  String get filter_current_location => 'Current Location';

  @override
  String get filter_map_location => 'On Map';

  @override
  String get filter_price_section => 'Price Range (Dollar \$)';

  @override
  String get filter_type_section => 'Property Type';

  @override
  String get filter_area_section => 'Area (sqm)';

  @override
  String get filter_details_section => 'Property Details';

  @override
  String get filter_total_rooms => 'Total Rooms';

  @override
  String get filter_bedrooms => 'Bedrooms';

  @override
  String get filter_bathrooms => 'Bathrooms';

  @override
  String get filter_any => 'Any';

  @override
  String get filter_apply_button => 'Show Matching Results';

  @override
  String get type_apartment => 'Apartment';

  @override
  String get type_villa => 'Villa';

  @override
  String get type_farm => 'Farm';

  @override
  String get type_country_house => 'Country House';

  @override
  String get type_studio => 'Studio';

  @override
  String get phone_number_hint => '(963) 999 999 999';

  @override
  String get enter_hint => 'Enter';

  @override
  String get new_messages => 'New Messages';

  @override
  String get modify_reservation => 'Modify Reservation';

  @override
  String changing_dates_for(Object propertyTitle) {
    return 'Changing dates for $propertyTitle';
  }

  @override
  String get confirm_new_dates => 'Confirm New Dates';

  @override
  String get cancel_booking_title => 'Cancel Booking?';

  @override
  String cancel_booking_msg(Object propertyTitle) {
    return 'Are you sure you want to cancel your stay at $propertyTitle? This action cannot be reversed.';
  }

  @override
  String get keep_stay => 'Keep Stay';

  @override
  String get yes_cancel => 'Yes, Cancel';

  @override
  String get view_receipt => 'View Receipt';

  @override
  String get check_in => 'CHECK-IN';

  @override
  String get check_out => 'CHECK-OUT';

  @override
  String get edit => 'Edit';

  @override
  String get status_pending => 'PENDING';

  @override
  String get status_confirmed => 'CONFIRMED';

  @override
  String get status_completed => 'COMPLETED';

  @override
  String get status_canceled => 'CANCELED';

  @override
  String get status_conflicted => 'CONFLICT';

  @override
  String get rate_the_apartment => 'Rate the Apartment';

  @override
  String get view_details => 'View Details';

  @override
  String get password_length_message =>
      'The Password must contain at least 6 characters';

  @override
  String get not_chat_yourself => 'You can\'t chat with yourself';

  @override
  String get reviews_title => 'Ratings & Reviews';

  @override
  String get reviews_empty_title => 'No reviews yet';

  @override
  String get reviews_empty_subtitle => 'Be the first to review this property!';

  @override
  String get error_generic_title => 'Oops, something went wrong';

  @override
  String get action_retry => 'Retry';

  @override
  String get added_successfully => 'Added successfully';

  @override
  String get property_added_message =>
      'Your property is now being processed and will be visible to everyone as soon as it is approved.';

  @override
  String get complete_all_fields => 'Please complete all required information.';

  @override
  String get at_least_one_img => 'At least one image is required';

  @override
  String get click_to_select_location => 'Click to select location';

  @override
  String get search => 'Search...';

  @override
  String get confirm_location => 'Confirm Location';

  @override
  String get confirm_post_property => 'Property listing confirmation';

  @override
  String get confirm_post_property_message =>
      'The property details will be sent for review. Are you sure the information is correct?';

  @override
  String get yes_post_it => 'Yes, publish it.';
}

// =======================================================
// FILE PATH: lib\l10n\app_localizations_fr.dart
// =======================================================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for French (`fr`).
class AppLocalizationsFr extends AppLocalizations {
  AppLocalizationsFr([String locale = 'fr']) : super(locale);

  @override
  String get welcome_back => 'Bon retour';

  @override
  String get login_to_continue =>
      'Connectez-vous pour continuer votre recherche';

  @override
  String get mobile_number => 'Numéro de mobile';

  @override
  String get send_verification_code => 'Envoyer le code de vérification';

  @override
  String get login => 'Connexion';

  @override
  String get logout => 'Déconnexion';

  @override
  String get dont_have_account => 'Vous n\'avez pas de compte ?';

  @override
  String get my_bookings => 'Mes réservations';

  @override
  String get bookings => 'réservations';

  @override
  String get my_favorites => 'Mes favoris';

  @override
  String get favorites => 'favoris';

  @override
  String get chats => 'discussions';

  @override
  String get select_theme => 'choisir le thème';

  @override
  String get select_language => 'choisir la langue';

  @override
  String get messages => 'Messages';

  @override
  String get register => 'S\'inscrire';

  @override
  String get home => 'Accueil';

  @override
  String get settings => 'Paramètres';

  @override
  String get theme => 'Thème';

  @override
  String get my_profile => 'Mon profil';

  @override
  String get become_a_renter => 'Devenir hôte';

  @override
  String get language => 'Langue';

  @override
  String get first_name => 'Prénom';

  @override
  String get last_name => 'Nom';

  @override
  String get have_account => 'Avez-vous déjà un compte ?';

  @override
  String get create_account => 'Créer un compte';

  @override
  String get join_to_find =>
      'Rejoignez-nous pour trouver l\'appartement idéal !';

  @override
  String get password => 'Mot de passe';

  @override
  String get confirm_password => 'Confirmer le mot de passe';

  @override
  String get id_document_message =>
      'Veuillez télécharger une photo de votre pièce d\'identité pour des raisons de sécurité :';

  @override
  String get upload_id_message =>
      'Cliquez pour télécharger la pièce d\'identité';

  @override
  String get png_jpg => 'PNG, JPG, PDF jusqu\'à 10 Mo';

  @override
  String get profile_image_message =>
      'Choisissez une photo qui vous correspond !\nSi besoin..\n\nvotre photo de profil apparaîtra lorsque vous enverrez un message au futur propriétaire !';

  @override
  String get next => 'Suivant';

  @override
  String get previous => 'Précédent';

  @override
  String get send_code => 'Envoyer le code de vérification';

  @override
  String get date_of_birth => 'Date de naissance';

  @override
  String get six_digits => 'Veuillez saisir un code PIN à 6 chiffres';

  @override
  String get field_required => 'Ce champ est obligatoire';

  @override
  String get image_required => 'Cette image est obligatoire';

  @override
  String get malaz => 'MALAZ';

  @override
  String get share_your_property =>
      'Partagez les détails de votre bien avec nous';

  @override
  String get add_property => 'Ajouter un bien';

  @override
  String get uploud_photo_property =>
      'Cliquez pour télécharger des photos de votre bien';

  @override
  String get essential_details => 'Détails essentiels';

  @override
  String get bedrooms => 'Chambres :';

  @override
  String get bathrooms => 'Salles de bain :';

  @override
  String get bathrooms_no_dots => 'Salles de bain';

  @override
  String get area => 'Surface :';

  @override
  String get price => 'Prix';

  @override
  String get property_type => 'Type de bien';

  @override
  String get apartment => 'Appartement';

  @override
  String get villa => 'Villa';

  @override
  String get house => 'Maison';

  @override
  String get farm => 'Ferme';

  @override
  String get country_house => 'Maison de campagne';

  @override
  String get location_details => 'Détails de l\'emplacement';

  @override
  String get city => 'Ville :';

  @override
  String get syria => 'Syrie';

  @override
  String get governorate => 'Gouvernorat :';

  @override
  String get damascus => 'Damas';

  @override
  String get address => 'Adresse :';

  @override
  String get address_loc => 'Alhamak, Bostan Aldoor';

  @override
  String get description => 'Description';

  @override
  String get describe_property => 'Décrivez les détails de votre bien...';

  @override
  String get save => 'Enregistrer';

  @override
  String get verified_host => 'Hôte vérifié';

  @override
  String get owner => 'Propriétaire';

  @override
  String get rooms => 'Pièces';

  @override
  String get title => 'Titre';

  @override
  String get reviews => 'Avis';

  @override
  String get review => 'Avis';

  @override
  String get view_all => 'Tout voir';

  @override
  String get per_month => 'par mois';

  @override
  String get book_now => 'Réserver';

  @override
  String get month => 'mois';

  @override
  String get new_ => 'Nouveau';

  @override
  String get network_error_message =>
      'Une erreur réseau est survenue. Veuillez vérifier votre connexion internet et réessayer.';

  @override
  String get request_cancelled_error_message => 'La demande a été annulée';

  @override
  String get unexpected_error_message =>
      'Une erreur inattendue s\'est produite';

  @override
  String get retry => 'Réessayer';

  @override
  String get warring => 'Avertissement';

  @override
  String get edit_profile => 'Modifier le profil';

  @override
  String get identity_verification => 'Vérification d\'identité';

  @override
  String get identity_verification_input =>
      'Veuillez saisir votre mot de passe pour confirmer votre identité';

  @override
  String get current_password => 'Mot de passe actuel';

  @override
  String get cancel => 'Annuler';

  @override
  String get incorrect_password => 'Mot de passe incorrect';

  @override
  String get verify => 'vérification';

  @override
  String get profile_updated_success =>
      'Profil mis à jour et en cache avec succès';

  @override
  String get change_password => 'Changer le mot de passe';

  @override
  String get otp_sent_success =>
      'Code de vérification envoyé sur votre téléphone';

  @override
  String get enter_otp_hint =>
      'Entrez le code à 6 chiffres qui vous a été envoyé';

  @override
  String get new_password => 'Nouveau mot de passe';

  @override
  String get confirm_new_password => 'Confirmer le nouveau mot de passe';

  @override
  String get password_mismatch => 'Les mots de passe ne correspondent pas';

  @override
  String get password_changed_success => 'Mot de passe changé avec succès';

  @override
  String get resend_code => 'Renvoyer le code';

  @override
  String get done => 'faite';

  @override
  String get please_enter_password => 'Veuillez saisir votre mot de passe';

  @override
  String get passwords_do_not_match => 'Les mots de passe ne correspondent pas';

  @override
  String get wronge_otp => 'Le code saisi est incorrect, veuillez réessayer';

  @override
  String get otp_verified_success => 'Code OTP vérifié avec succès';

  @override
  String get booking_request_sent =>
      'La demande de réservation a été envoyée au propriétaire';

  @override
  String get nights => 'nuits';

  @override
  String get confirm_booking => 'Confirmer la réservation';

  @override
  String reviews_count(int count) {
    return '($count avis)';
  }

  @override
  String get no_description => 'Aucune description fournie.';

  @override
  String get baths => 'Bains';

  @override
  String get click_to_view => 'Cliquez pour voir les messages';

  @override
  String get active_partners => 'Partenaires actifs';

  @override
  String get recent_messages => 'Messages récents';

  @override
  String get malaz_chat => 'Chat Malaz';

  @override
  String get no_conversations => 'Aucune conversation pour le moment';

  @override
  String get active => 'Actif';

  @override
  String get delete_chat_title => 'Supprimer le chat ?';

  @override
  String get delete_chat_confirm =>
      'Cela supprimera définitivement la conversation.';

  @override
  String get delete => 'Supprimer';

  @override
  String get online_now => 'En ligne';

  @override
  String get editing_message_hint => 'Modifier le message...';

  @override
  String get type_message_hint => 'Écrivez votre message...';

  @override
  String get edit_message => 'Modifier le message';

  @override
  String get copy_text => 'Copier le texte';

  @override
  String get text_copied => 'Texte copié';

  @override
  String get delete_message => 'Supprimer le message';

  @override
  String get edited => 'Modifié';

  @override
  String get no_favorites_yet => 'Pas encore de favoris';

  @override
  String get explore_and_save =>
      'Commencez à explorer et enregistrez vos appartements ici.';

  @override
  String get damascus_countryside => 'Damas rural';

  @override
  String get jaramana => 'Jaramana';

  @override
  String get aleppo => 'Alep';

  @override
  String get homs => 'Homs';

  @override
  String get hama => 'Hama';

  @override
  String get latakia => 'Lattaquié';

  @override
  String get tartous => 'Tartous';

  @override
  String get idlib => 'Idlib';

  @override
  String get deir_alZor => 'Deir ez-Zor';

  @override
  String get raqa => 'Raqqa';

  @override
  String get al_hasakah => 'AL_Hasaka';

  @override
  String get daraa => 'Daraa';

  @override
  String get sweida => 'Sweida';

  @override
  String get quneitra => 'Quneitra';

  @override
  String get property_manager => 'Gestionnaire immobilier';

  @override
  String get add_new => 'Ajouter';

  @override
  String get my_properties => 'Mes propriétés';

  @override
  String get properties => 'Propriétés';

  @override
  String get inbound => 'Entrant';

  @override
  String get history => 'Historique';

  @override
  String get no_properties_found => 'Aucune propriété ajoutée.';

  @override
  String get guests => 'Invités';

  @override
  String get saved => 'sauvé';

  @override
  String get title_hint => 'Appartement Jasmin';

  @override
  String get booking_in_progress => 'Confirmation de votre réservation...';

  @override
  String get booking_success_title => 'Réservation réussie !';

  @override
  String get booking_success_message =>
      'Nous vous contacterons bientôt pour confirmer les détails.';

  @override
  String get action_okay => 'D\'accord';

  @override
  String get location => 'Emplacement';

  @override
  String get verified_account => 'COMPTE VÉRIFIÉ';

  @override
  String get unknown_location => 'Emplacement inconnu';

  @override
  String get back_to_top => 'Retour en haut';

  @override
  String get filter_title => 'Filtrer les résultats';

  @override
  String get filter_reset => 'Réinitialiser';

  @override
  String get filter_location_section => 'Emplacement géographique';

  @override
  String get filter_current_location => 'Ma position actuelle';

  @override
  String get filter_map_location => 'Sur la carte';

  @override
  String get filter_price_section => 'Fourchette de prix (Dollar \$)';

  @override
  String get filter_type_section => 'Type de bien';

  @override
  String get filter_area_section => 'Surface (m²)';

  @override
  String get filter_details_section => 'Détails du bien';

  @override
  String get filter_total_rooms => 'Nombre de pièces';

  @override
  String get filter_bedrooms => 'Chambres';

  @override
  String get filter_bathrooms => 'Salles de bain';

  @override
  String get filter_any => 'Tout';

  @override
  String get filter_apply_button => 'Afficher les résultats';

  @override
  String get type_apartment => 'Appartement';

  @override
  String get type_villa => 'Villa';

  @override
  String get type_farm => 'Ferme';

  @override
  String get type_country_house => 'Maison de campagne';

  @override
  String get type_studio => 'Studio';

  @override
  String get phone_number_hint => '(963) 999 999 999';

  @override
  String get enter_hint => 'Entrez';

  @override
  String get new_messages => 'Nouveaux messages';

  @override
  String get modify_reservation => 'Modifier la Réservation';

  @override
  String changing_dates_for(Object propertyTitle) {
    return 'Changement de dates pour $propertyTitle';
  }

  @override
  String get confirm_new_dates => 'Confirmer les Nouvelles Dates';

  @override
  String get cancel_booking_title => 'Annuler la Réservation ?';

  @override
  String cancel_booking_msg(Object propertyTitle) {
    return 'Êtes-vous sûr de vouloir annuler votre séjour à $propertyTitle ? Cette action est irréversible.';
  }

  @override
  String get keep_stay => 'Garder la Réservation';

  @override
  String get yes_cancel => 'Oui, Annuler';

  @override
  String get view_receipt => 'Voir le Reçu';

  @override
  String get check_in => 'ARRIVÉE';

  @override
  String get check_out => 'DÉPART';

  @override
  String get edit => 'Modifier';

  @override
  String get status_pending => 'EN ATTENTE';

  @override
  String get status_confirmed => 'CONFIRMÉ';

  @override
  String get status_completed => 'TERMINÉ';

  @override
  String get status_canceled => 'ANNULÉ';

  @override
  String get status_conflicted => 'CONFLIT';

  @override
  String get rate_the_apartment => 'Évaluation de l\'appartement';

  @override
  String get view_details => 'voir les détails';

  @override
  String get password_length_message =>
      'Le mot de passe doit contenir au moins 6 caractères.';

  @override
  String get not_chat_yourself => 'On ne peut pas discuter avec soi-même';

  @override
  String get reviews_title => 'Avis et Évaluations';

  @override
  String get reviews_empty_title => 'Aucun avis pour le moment';

  @override
  String get reviews_empty_subtitle => 'Soyez le premier à donner votre avis !';

  @override
  String get error_generic_title => 'Oups, une erreur s\'est produite';

  @override
  String get action_retry => 'Réessayer';

  @override
  String get added_successfully => 'Ajouté avec succès';

  @override
  String get property_added_message =>
      'Votre dossier est en cours de traitement et sera visible par tous dès qu\'il sera approuvé.';

  @override
  String get complete_all_fields =>
      'Veuillez compléter tous les renseignements requis.';

  @override
  String get at_least_one_img => 'Au moins une image est requise';

  @override
  String get click_to_select_location =>
      'Cliquez pour sélectionner l\'emplacement';

  @override
  String get search => 'recherche...';

  @override
  String get confirm_location => 'confirmer l\'emplacement';

  @override
  String get confirm_post_property => 'Confirmation de l\'annonce immobilière';

  @override
  String get confirm_post_property_message =>
      'Les détails du bien seront envoyés pour vérification. Êtes-vous sûr(e) que les informations sont correctes ?';

  @override
  String get yes_post_it => 'Oui, publiez-le.';
}

// =======================================================
// FILE PATH: lib\l10n\app_localizations_ru.dart
// =======================================================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for Russian (`ru`).
class AppLocalizationsRu extends AppLocalizations {
  AppLocalizationsRu([String locale = 'ru']) : super(locale);

  @override
  String get welcome_back => 'С возвращением';

  @override
  String get login_to_continue => 'Войдите, чтобы продолжить поиск';

  @override
  String get mobile_number => 'Номер телефона';

  @override
  String get send_verification_code => 'Отправить код подтверждения';

  @override
  String get login => 'Войти';

  @override
  String get logout => 'Выйти';

  @override
  String get dont_have_account => 'Нет аккаунта?';

  @override
  String get my_bookings => 'Мои бронирования';

  @override
  String get bookings => 'бронирования';

  @override
  String get my_favorites => 'Избранное';

  @override
  String get favorites => 'избранное';

  @override
  String get chats => 'чаты';

  @override
  String get select_theme => 'выберите тему';

  @override
  String get select_language => 'выберите язык';

  @override
  String get messages => 'Сообщения';

  @override
  String get register => 'Регистрация';

  @override
  String get home => 'Главная';

  @override
  String get settings => 'Настройки';

  @override
  String get theme => 'Тема';

  @override
  String get my_profile => 'Мой профиль';

  @override
  String get become_a_renter => 'Стать арендодателем';

  @override
  String get language => 'Язык';

  @override
  String get first_name => 'Имя';

  @override
  String get last_name => 'Фамилия';

  @override
  String get have_account => 'У вас уже есть аккаунт?';

  @override
  String get create_account => 'Создать аккаунт';

  @override
  String get join_to_find =>
      'Присоединяйтесь к нам, чтобы найти идеальную квартиру!';

  @override
  String get password => 'Пароль';

  @override
  String get confirm_password => 'Подтвердите пароль';

  @override
  String get id_document_message =>
      'Пожалуйста, загрузите фото вашего удостоверения личности в целях безопасности:';

  @override
  String get upload_id_message => 'Нажмите, чтобы загрузить документ';

  @override
  String get png_jpg => 'PNG, JPG, PDF до 10 МБ';

  @override
  String get profile_image_message =>
      'Выберите подходящее фото!\nЕсли нужно..\n\nваше фото профиля будет видно владельцу квартиры, когда вы напишете ему сообщение!';

  @override
  String get next => 'Далее';

  @override
  String get previous => 'Назад';

  @override
  String get send_code => 'Отправить код подтверждения';

  @override
  String get date_of_birth => 'Дата рождения';

  @override
  String get six_digits => 'Пожалуйста, введите 6-значный PIN-код';

  @override
  String get field_required => 'Это поле обязательно';

  @override
  String get image_required => 'Это изображение обязательно';

  @override
  String get malaz => 'Малаз';

  @override
  String get share_your_property => 'Поделитесь с нами деталями вашего объекта';

  @override
  String get add_property => 'Добавить объект';

  @override
  String get uploud_photo_property => 'Нажмите, чтобы загрузить фото объекта';

  @override
  String get essential_details => 'Основные детали';

  @override
  String get bedrooms => 'Спальни:';

  @override
  String get bathrooms => 'Ванные:';

  @override
  String get bathrooms_no_dots => 'Ванные';

  @override
  String get area => 'Площадь:';

  @override
  String get price => 'Цена';

  @override
  String get property_type => 'Тип недвижимости';

  @override
  String get apartment => 'Квартира';

  @override
  String get villa => 'Вилла';

  @override
  String get house => 'Дом';

  @override
  String get farm => 'Ферма';

  @override
  String get country_house => 'Загородный дом';

  @override
  String get location_details => 'Детали местоположения';

  @override
  String get city => 'Город:';

  @override
  String get syria => 'Сирия';

  @override
  String get governorate => 'Провинция:';

  @override
  String get damascus => 'Дамаск';

  @override
  String get address => 'Адрес:';

  @override
  String get address_loc => 'Аль-Хамак, Бостан Аль-Дур';

  @override
  String get description => 'Описание';

  @override
  String get describe_property => 'Опишите детали вашего объекта...';

  @override
  String get save => 'Сохранить';

  @override
  String get verified_host => 'Проверенный хозяин';

  @override
  String get owner => 'Владелец';

  @override
  String get rooms => 'Комнаты';

  @override
  String get title => 'Заголовок';

  @override
  String get reviews => 'Отзывы';

  @override
  String get review => 'Отзыв';

  @override
  String get view_all => 'Посмотреть все';

  @override
  String get per_month => 'в месяц';

  @override
  String get book_now => 'Забронировать';

  @override
  String get month => 'месяц';

  @override
  String get new_ => 'Новое';

  @override
  String get network_error_message =>
      'Произошла ошибка сети. Пожалуйста, проверьте подключение к интернету и попробуйте еще раз.';

  @override
  String get request_cancelled_error_message => 'Запрос был отменен';

  @override
  String get unexpected_error_message => 'Произошла непредвиденная ошибка';

  @override
  String get retry => 'Повторить';

  @override
  String get warring => 'Предупреждение';

  @override
  String get edit_profile => 'Редактировать профиль';

  @override
  String get identity_verification => 'проверка личности';

  @override
  String get identity_verification_input =>
      'Пожалуйста, введите свой пароль для подтверждения личности';

  @override
  String get current_password => 'Текущий пароль';

  @override
  String get cancel => 'Отмена';

  @override
  String get incorrect_password => 'Неверный пароль';

  @override
  String get verify => 'проверка';

  @override
  String get profile_updated_success => 'Профиль успешно обновлен и кэширован';

  @override
  String get change_password => 'Сменить пароль';

  @override
  String get otp_sent_success => 'Код подтверждения отправлен на ваш телефон';

  @override
  String get enter_otp_hint => 'Введите 6-значный код, отправленный вам';

  @override
  String get new_password => 'Новый пароль';

  @override
  String get confirm_new_password => 'Подтвердите новый пароль';

  @override
  String get password_mismatch => 'Пароли не совпадают';

  @override
  String get password_changed_success => 'Пароль успешно изменен';

  @override
  String get resend_code => 'Отправить код повторно';

  @override
  String get done => 'сделанный';

  @override
  String get please_enter_password => 'Пожалуйста, введите пароль';

  @override
  String get passwords_do_not_match => 'Пароли не совпадают';

  @override
  String get wronge_otp =>
      'Введенный код неверный, пожалуйста, попробуйте еще раз';

  @override
  String get otp_verified_success => 'OTP-код успешно подтвержден';

  @override
  String get booking_request_sent =>
      'Запрос на бронирование отправлен владельцу';

  @override
  String get nights => 'ночи';

  @override
  String get confirm_booking => 'Подтвердить бронирование';

  @override
  String reviews_count(int count) {
    return '($count отзывов)';
  }

  @override
  String get no_description => 'Описание не предоставлено.';

  @override
  String get baths => 'Ванны';

  @override
  String get click_to_view => 'Нажмите, чтобы прочитать';

  @override
  String get active_partners => 'Активные партнеры';

  @override
  String get recent_messages => 'Последние сообщения';

  @override
  String get malaz_chat => 'Малаз Чат';

  @override
  String get no_conversations => 'Пока нет чатов';

  @override
  String get active => 'Активен';

  @override
  String get delete_chat_title => 'Удалить чат?';

  @override
  String get delete_chat_confirm =>
      'Это приведет к безвозвратному удалению беседы.';

  @override
  String get delete => 'Удалить';

  @override
  String get online_now => 'В сети';

  @override
  String get editing_message_hint => 'Редактирование...';

  @override
  String get type_message_hint => 'Напишите сообщение...';

  @override
  String get edit_message => 'Изменить сообщение';

  @override
  String get copy_text => 'Копировать текст';

  @override
  String get text_copied => 'Текст скопирован';

  @override
  String get delete_message => 'Удалить сообщение';

  @override
  String get edited => 'Изменено';

  @override
  String get no_favorites_yet => 'Избранного пока нет';

  @override
  String get explore_and_save =>
      'Начните поиск и сохраняйте понравившиеся квартиры здесь.';

  @override
  String get damascus_countryside => 'Дамаск (сельская местность)';

  @override
  String get jaramana => 'Джарамана';

  @override
  String get aleppo => 'Алеппо';

  @override
  String get homs => 'Хомс';

  @override
  String get hama => 'Хама';

  @override
  String get latakia => 'Латакия';

  @override
  String get tartous => 'Тартус';

  @override
  String get idlib => 'Идлиб';

  @override
  String get deir_alZor => 'Дейр-эз-Зор';

  @override
  String get raqa => 'Ракка';

  @override
  String get al_hasakah => 'AL_Hasaka';

  @override
  String get daraa => 'Деръа';

  @override
  String get sweida => 'Эс-Сувейда';

  @override
  String get quneitra => 'Эль-Кунейтра';

  @override
  String get property_manager => 'Управляющий недвижимостью';

  @override
  String get add_new => 'Добавить';

  @override
  String get my_properties => 'Моя недвижимость';

  @override
  String get properties => 'Объекты';

  @override
  String get inbound => 'Входящие';

  @override
  String get history => 'История';

  @override
  String get no_properties_found => 'Объекты не найдены.';

  @override
  String get guests => 'Гости';

  @override
  String get saved => 'сохранено';

  @override
  String get title_hint => 'Апартаменты Жасмин';

  @override
  String get booking_in_progress => 'Подтверждение бронирования...';

  @override
  String get booking_success_title => 'Бронирование успешно!';

  @override
  String get booking_success_message =>
      'Мы свяжемся с вами в ближайшее время для подтверждения деталей.';

  @override
  String get action_okay => 'Хорошо';

  @override
  String get location => 'Местоположение';

  @override
  String get verified_account => 'ПОДТВЕРЖДЕННЫЙ АККАУНТ';

  @override
  String get unknown_location => 'Неизвестное место';

  @override
  String get back_to_top => 'Наверх';

  @override
  String get filter_title => 'Фильтры';

  @override
  String get filter_reset => 'Сброс';

  @override
  String get filter_location_section => 'Местоположение';

  @override
  String get filter_current_location => 'Текущее местоположение';

  @override
  String get filter_map_location => 'На карте';

  @override
  String get filter_price_section => 'Диапазон цен (Доллар \$)';

  @override
  String get filter_type_section => 'Тип недвижимости';

  @override
  String get filter_area_section => 'Площадь (кв. м)';

  @override
  String get filter_details_section => 'Детали';

  @override
  String get filter_total_rooms => 'Всего комнат';

  @override
  String get filter_bedrooms => 'Спальни';

  @override
  String get filter_bathrooms => 'Ванные';

  @override
  String get filter_any => 'Все';

  @override
  String get filter_apply_button => 'Показать результаты';

  @override
  String get type_apartment => 'Квартира';

  @override
  String get type_villa => 'Вилла';

  @override
  String get type_farm => 'Ферма';

  @override
  String get type_country_house => 'Загородный дом';

  @override
  String get type_studio => 'Студия';

  @override
  String get phone_number_hint => '(963) 999 999 999';

  @override
  String get enter_hint => 'Введите';

  @override
  String get new_messages => 'Новые сообщения';

  @override
  String get modify_reservation => 'Изменить бронирование';

  @override
  String changing_dates_for(Object propertyTitle) {
    return 'Изменение дат для $propertyTitle';
  }

  @override
  String get confirm_new_dates => 'Подтвердить новые даты';

  @override
  String get cancel_booking_title => 'Отменить бронирование?';

  @override
  String cancel_booking_msg(Object propertyTitle) {
    return 'Вы уверены, что хотите отменить проживание в $propertyTitle? Это действие невозможно отменить.';
  }

  @override
  String get keep_stay => 'Оставить бронь';

  @override
  String get yes_cancel => 'Да, отменить';

  @override
  String get view_receipt => 'Посмотреть чек';

  @override
  String get check_in => 'ЗАЕЗД';

  @override
  String get check_out => 'ВЫЕЗД';

  @override
  String get edit => 'Изменить';

  @override
  String get status_pending => 'В ОЖИДАНИИ';

  @override
  String get status_confirmed => 'ПОДТВЕРЖДЕНО';

  @override
  String get status_completed => 'ЗАВЕРШЕНО';

  @override
  String get status_canceled => 'ОТМЕНЕНО';

  @override
  String get status_conflicted => 'КОНФЛИКТ';

  @override
  String get rate_the_apartment => 'Рейтинг квартиры';

  @override
  String get view_details => 'посмотреть подробности';

  @override
  String get password_length_message =>
      'Пароль должен содержать не менее 6 символов.';

  @override
  String get not_chat_yourself => 'С самим собой разговаривать нельзя.';

  @override
  String get reviews_title => 'Отзывы и Оценки';

  @override
  String get reviews_empty_title => 'Отзывов пока нет';

  @override
  String get reviews_empty_subtitle => 'Будьте первым, кто оценит это жилье!';

  @override
  String get error_generic_title => 'Ой, что-то пошло не так';

  @override
  String get action_retry => 'Повторить';

  @override
  String get added_successfully => 'Добавлено успешно';

  @override
  String get property_added_message =>
      'Ваша заявка на размещение объявления находится в процессе обработки и станет доступна всем после одобрения.';

  @override
  String get complete_all_fields =>
      'Пожалуйста, заполните всю необходимую информацию.';

  @override
  String get at_least_one_img => 'Требуется как минимум одно изображение.';

  @override
  String get click_to_select_location =>
      'нажмите, чтобы выбрать местоположение';

  @override
  String get search => 'поиск...';

  @override
  String get confirm_location => 'подтвердить местоположение';

  @override
  String get confirm_post_property =>
      'Подтверждение размещения объявления об объекте недвижимости';

  @override
  String get confirm_post_property_message =>
      'Информация об объекте недвижимости будет отправлена ​​на проверку. Вы уверены, что данные верны?';

  @override
  String get yes_post_it => '«Да, опубликуйте это».';
}

// =======================================================
// FILE PATH: lib\l10n\app_localizations_tr.dart
// =======================================================

// ignore: unused_import
import 'package:intl/intl.dart' as intl;
import 'app_localizations.dart';

// ignore_for_file: type=lint

/// The translations for Turkish (`tr`).
class AppLocalizationsTr extends AppLocalizations {
  AppLocalizationsTr([String locale = 'tr']) : super(locale);

  @override
  String get welcome_back => 'Tekrar Hoş Geldiniz';

  @override
  String get login_to_continue => 'Aramanıza devam etmek için giriş yapın';

  @override
  String get mobile_number => 'Cep Telefonu Numarası';

  @override
  String get send_verification_code => 'Doğrulama kodunu gönder';

  @override
  String get login => 'Giriş Yap';

  @override
  String get logout => 'Çıkış Yap';

  @override
  String get dont_have_account => 'Hesabınız yok mu?';

  @override
  String get my_bookings => 'Rezervasyonlarım';

  @override
  String get bookings => 'rezervasyonlar';

  @override
  String get my_favorites => 'Favorilerim';

  @override
  String get favorites => 'favoriler';

  @override
  String get chats => 'sohbetler';

  @override
  String get select_theme => 'tema seç';

  @override
  String get select_language => 'dil seç';

  @override
  String get messages => 'Mesajlar';

  @override
  String get register => 'Kayıt Ol';

  @override
  String get home => 'Anasayfa';

  @override
  String get settings => 'Ayarlar';

  @override
  String get theme => 'Tema';

  @override
  String get my_profile => 'Profilim';

  @override
  String get become_a_renter => 'Ev Sahibi Olun';

  @override
  String get language => 'Dil';

  @override
  String get first_name => 'Ad';

  @override
  String get last_name => 'Soyad';

  @override
  String get have_account => 'Zaten bir hesabınız var mı?';

  @override
  String get create_account => 'Hesap Oluştur';

  @override
  String get join_to_find => 'Hayalinizdeki daireyi bulmak için bize katılın!';

  @override
  String get password => 'Şifre';

  @override
  String get confirm_password => 'Şifreyi Onayla';

  @override
  String get id_document_message =>
      'Güvenlik nedeniyle lütfen kimlik belgenizin bir fotoğrafını yükleyin:';

  @override
  String get upload_id_message => 'Kimlik belgesi yüklemek için tıklayın';

  @override
  String get png_jpg => 'PNG, JPG, PDF en fazla 10MB';

  @override
  String get profile_image_message =>
      'Sizi yansıtan bir resim seçin!\nBuna ihtiyacınız varsa..\n\nprofil resminiz gelecekteki daire sahibine mesaj attığınızda görünecektir!';

  @override
  String get next => 'İleri';

  @override
  String get previous => 'Geri';

  @override
  String get send_code => 'Doğrulama kodunu gönder';

  @override
  String get date_of_birth => 'Doğum Tarihi';

  @override
  String get six_digits => 'Lütfen 6 haneli PIN kodunu girin';

  @override
  String get field_required => 'Bu alan zorunludur';

  @override
  String get image_required => 'Bu resim zorunludur';

  @override
  String get malaz => 'MALAZ';

  @override
  String get share_your_property => 'Mülk detaylarınızı bizimle paylaşın';

  @override
  String get add_property => 'Mülk Ekle';

  @override
  String get uploud_photo_property =>
      'Mülkünüzün fotoğraflarını yüklemek için tıklayın';

  @override
  String get essential_details => 'Temel Detaylar';

  @override
  String get bedrooms => 'Yatak Odası:';

  @override
  String get bathrooms => 'Banyo:';

  @override
  String get bathrooms_no_dots => 'Banyo';

  @override
  String get area => 'Alan:';

  @override
  String get price => 'Fiyat';

  @override
  String get property_type => 'Mülk Tipi';

  @override
  String get apartment => 'Daire';

  @override
  String get villa => 'Villa';

  @override
  String get house => 'Ev';

  @override
  String get farm => 'Çiftlik';

  @override
  String get country_house => 'Kır Evi';

  @override
  String get location_details => 'Konum Detayları';

  @override
  String get city => 'Şehir:';

  @override
  String get syria => 'Suriye';

  @override
  String get governorate => 'İl:';

  @override
  String get damascus => 'Şam';

  @override
  String get address => 'Adres:';

  @override
  String get address_loc => 'Alhamak, Bostan Aldoor';

  @override
  String get description => 'Açıklama';

  @override
  String get describe_property => 'Mülkünüzün detaylarını açıklayın...';

  @override
  String get save => 'Kaydet';

  @override
  String get verified_host => 'Doğrulanmış Ev Sahibi';

  @override
  String get owner => 'Mülk Sahibi';

  @override
  String get rooms => 'Odalar';

  @override
  String get title => 'Başlık';

  @override
  String get reviews => 'Değerlendirmeler';

  @override
  String get review => 'Değerlendirme';

  @override
  String get view_all => 'Hepsini Gör';

  @override
  String get per_month => 'aylık';

  @override
  String get book_now => 'Hemen Ayırt';

  @override
  String get month => 'ay';

  @override
  String get new_ => 'Yeni';

  @override
  String get network_error_message =>
      'Ağ hatası oluştu. Lütfen internet bağlantınızı kontrol edin ve tekrar deneyin.';

  @override
  String get request_cancelled_error_message => 'İstek iptal edildi';

  @override
  String get unexpected_error_message => 'Beklenmedik bir hata oluştu';

  @override
  String get retry => 'Tekrar dene';

  @override
  String get warring => 'Uyarı';

  @override
  String get edit_profile => 'Profil Düzenle';

  @override
  String get identity_verification => 'kimlik doğrulama';

  @override
  String get identity_verification_input =>
      'Kimliğinizi doğrulamak için lütfen şifrenizi girin';

  @override
  String get current_password => 'Mevcut Şifre';

  @override
  String get cancel => 'İptal';

  @override
  String get incorrect_password => 'Yanlış Şifre';

  @override
  String get verify => 'doğrulama';

  @override
  String get profile_updated_success =>
      'Profil başarıyla güncellendi ve önbelleğe alındı';

  @override
  String get change_password => 'Şifreyi Değiştir';

  @override
  String get otp_sent_success => 'Doğrulama kodu telefonunuza gönderildi';

  @override
  String get enter_otp_hint => 'Size gönderilen 6 haneli kodu girin';

  @override
  String get new_password => 'Yeni Şifre';

  @override
  String get confirm_new_password => 'Yeni Şifreyi Onayla';

  @override
  String get password_mismatch => 'Şifreler eşleşmiyor';

  @override
  String get password_changed_success => 'Şifre başarıyla değiştirildi';

  @override
  String get resend_code => 'Kodu Tekrar Gönder';

  @override
  String get done => 'Tamamlandı';

  @override
  String get please_enter_password => 'Lütfen şifrenizi giriniz';

  @override
  String get passwords_do_not_match => 'Şifreler eşleşmiyor';

  @override
  String get wronge_otp => 'Girilen kod yanlış, lütfen tekrar deneyin';

  @override
  String get otp_verified_success => 'Doğrulama kodu başarıyla onaylandı';

  @override
  String get booking_request_sent =>
      'Rezervasyon talebi ev sahibine gönderildi';

  @override
  String get nights => 'gece';

  @override
  String get confirm_booking => 'Rezervasyonu Onayla';

  @override
  String reviews_count(int count) {
    return '($count değerlendirme)';
  }

  @override
  String get no_description => 'Açıklama belirtilmedi.';

  @override
  String get baths => 'Banyolar';

  @override
  String get click_to_view => 'Mesajları görmek için tıklayın';

  @override
  String get active_partners => 'Aktif Ortaklar';

  @override
  String get recent_messages => 'Son Mesajlar';

  @override
  String get malaz_chat => 'Malaz Sohbet';

  @override
  String get no_conversations => 'Henüz konuşma yok';

  @override
  String get active => 'Aktif';

  @override
  String get delete_chat_title => 'Sohbeti Sil?';

  @override
  String get delete_chat_confirm =>
      'Bu işlem konuşmayı kalıcı olarak silecektir.';

  @override
  String get delete => 'Sil';

  @override
  String get online_now => 'Şimdi çevrimiçi';

  @override
  String get editing_message_hint => 'Mesajı düzenle...';

  @override
  String get type_message_hint => 'Mesajınızı yazın...';

  @override
  String get edit_message => 'Mesajı Düzenle';

  @override
  String get copy_text => 'Metni Kopyala';

  @override
  String get text_copied => 'Metin kopyalandı';

  @override
  String get delete_message => 'Mesajı Sil';

  @override
  String get edited => 'Düzenlendi';

  @override
  String get no_favorites_yet => 'Henüz favori yok';

  @override
  String get explore_and_save =>
      'Keşfetmeye başlayın ve beğendiğiniz daireleri buraya kaydedin.';

  @override
  String get damascus_countryside => 'Şam Kırsalı';

  @override
  String get jaramana => 'Jaramana';

  @override
  String get aleppo => 'Halep';

  @override
  String get homs => 'Humus';

  @override
  String get hama => 'Hama';

  @override
  String get latakia => 'Lazkiye';

  @override
  String get tartous => 'Tartus';

  @override
  String get idlib => 'İdlib';

  @override
  String get deir_alZor => 'Deyrizor';

  @override
  String get raqa => 'Rakka';

  @override
  String get al_hasakah => 'AL_Hasaka';

  @override
  String get daraa => 'Dera';

  @override
  String get sweida => 'Süveyda';

  @override
  String get quneitra => 'Kuneytire';

  @override
  String get property_manager => 'Emlak Yöneticisi';

  @override
  String get add_new => 'Ekle';

  @override
  String get my_properties => 'Mülklerim';

  @override
  String get properties => 'Mülkler';

  @override
  String get inbound => 'Gelen';

  @override
  String get history => 'Geçmiş';

  @override
  String get no_properties_found => 'Mülk bulunamadı.';

  @override
  String get guests => 'Misafirler';

  @override
  String get saved => 'kaydedildi';

  @override
  String get title_hint => 'Yasemin Apartmanı';

  @override
  String get booking_in_progress => 'Rezervasyonunuz onaylanıyor...';

  @override
  String get booking_success_title => 'Rezervasyon Başarılı!';

  @override
  String get booking_success_message =>
      'Detayları onaylamak için yakında sizinle iletişime geçeceğiz.';

  @override
  String get action_okay => 'Tamam';

  @override
  String get location => 'Konum';

  @override
  String get verified_account => 'DOĞRULANMIŞ HESAP';

  @override
  String get unknown_location => 'Bilinmeyen Konum';

  @override
  String get back_to_top => 'Başa dön';

  @override
  String get filter_title => 'Sonuçları Filtrele';

  @override
  String get filter_reset => 'Sıfırla';

  @override
  String get filter_location_section => 'Konum';

  @override
  String get filter_current_location => 'Mevcut Konum';

  @override
  String get filter_map_location => 'Haritada';

  @override
  String get filter_price_section => 'Fiyat Aralığı (Dolar \$)';

  @override
  String get filter_type_section => 'Emlak Tipi';

  @override
  String get filter_area_section => 'Alan (m²)';

  @override
  String get filter_details_section => 'Özellikler';

  @override
  String get filter_total_rooms => 'Toplam Oda';

  @override
  String get filter_bedrooms => 'Yatak Odası';

  @override
  String get filter_bathrooms => 'Banyo';

  @override
  String get filter_any => 'Tümü';

  @override
  String get filter_apply_button => 'Sonuçları Göster';

  @override
  String get type_apartment => 'Daire';

  @override
  String get type_villa => 'Villa';

  @override
  String get type_farm => 'Çiftlik';

  @override
  String get type_country_house => 'Kır Evi';

  @override
  String get type_studio => 'Stüdyo';

  @override
  String get phone_number_hint => '(963) 999 999 999';

  @override
  String get enter_hint => 'Size gönderilen';

  @override
  String get new_messages => 'Yeni mesajlar';

  @override
  String get modify_reservation => 'Rezervasyonu Düzenle';

  @override
  String changing_dates_for(Object propertyTitle) {
    return '$propertyTitle için tarihleri değiştirme';
  }

  @override
  String get confirm_new_dates => 'Yeni Tarihleri Onayla';

  @override
  String get cancel_booking_title => 'Rezervasyonu İptal Et?';

  @override
  String cancel_booking_msg(Object propertyTitle) {
    return '$propertyTitle tesisindeki konaklamanızı iptal etmek istediğinizden emin misiniz? Bu işlem geri alınamaz.';
  }

  @override
  String get keep_stay => 'Rezervasyonu Koru';

  @override
  String get yes_cancel => 'Evet, İptal Et';

  @override
  String get view_receipt => 'Fişi Görüntüle';

  @override
  String get check_in => 'GİRİŞ';

  @override
  String get check_out => 'ÇIKIŞ';

  @override
  String get edit => 'Düzenle';

  @override
  String get status_pending => 'BEKLEMEDE';

  @override
  String get status_confirmed => 'ONAYLANDI';

  @override
  String get status_completed => 'TAMAMLANDI';

  @override
  String get status_canceled => 'İPTAL EDİLDİ';

  @override
  String get status_conflicted => 'ÇAKIŞMA';

  @override
  String get rate_the_apartment => 'Daire Değerlendirmesi';

  @override
  String get view_details => 'ayrıntıları görüntüle';

  @override
  String get password_length_message => 'Parola en az 6 karakter içermelidir.';

  @override
  String get not_chat_yourself => 'Kendi kendine sohbet edemezsin.';

  @override
  String get reviews_title => 'Değerlendirmeler ve Yorumlar';

  @override
  String get reviews_empty_title => 'Henüz değerlendirme yok';

  @override
  String get reviews_empty_subtitle => 'Bu mülkü ilk değerlendiren siz olun!';

  @override
  String get error_generic_title => 'Ups, bir şeyler ters gitti';

  @override
  String get action_retry => 'Tekrar Dene';

  @override
  String get added_successfully => 'Başarıyla eklendi';

  @override
  String get property_added_message =>
      'Mülkünüz şu anda işleme alınıyor ve onaylandıktan sonra herkesin görebileceği şekilde yayınlanacaktır.';

  @override
  String get complete_all_fields =>
      'Lütfen gerekli tüm bilgileri eksiksiz doldurun.';

  @override
  String get at_least_one_img => 'En az bir görsel gereklidir.';

  @override
  String get click_to_select_location => 'Konum seçmek için tıklayın';

  @override
  String get search => 'aramak...';

  @override
  String get confirm_location => 'konumu onaylayın';

  @override
  String get confirm_post_property => 'Emlak ilanının onaylanması';

  @override
  String get confirm_post_property_message =>
      'Mülke ait detaylar inceleme için gönderilecektir. Bilgilerin doğru olduğundan emin misiniz?';

  @override
  String get yes_post_it => 'Evet, yayınlayın.';
}

// =======================================================
// FILE PATH: lib\main.dart
// =======================================================

// main.dart
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_localizations/flutter_localizations.dart';
import 'package:malaz/presentation/cubits/auth/auth_cubit.dart';
import 'package:malaz/presentation/cubits/booking/booking_cubit.dart';
import 'package:malaz/presentation/cubits/booking/manage_booking.dart';
import 'package:malaz/presentation/cubits/booking/my_booking.dart';
import 'package:malaz/presentation/cubits/favorites/favorites_cubit.dart';
import 'package:malaz/presentation/cubits/chat/chat_cubit.dart';

import 'package:malaz/presentation/cubits/home/home_cubit.dart';
import 'package:malaz/presentation/cubits/language/language_cubit.dart';
import 'package:malaz/presentation/cubits/location/location_cubit.dart';
import 'package:malaz/presentation/cubits/property/property_cubit.dart';
import 'package:malaz/presentation/cubits/review/review_cubit.dart';
import 'package:malaz/presentation/cubits/theme/theme_cubit.dart';

import 'package:malaz/presentation/screens/auth/login/login_screen.dart';
import 'package:malaz/presentation/screens/auth/register/home_register_screen.dart';
import 'package:malaz/presentation/screens/settings/settings_screen.dart';
import 'package:malaz/presentation/screens/splash_screen/splash_screen.dart';
import 'package:shared_preferences/shared_preferences.dart';

import 'core/config/routes/app_routes.dart';
import 'core/config/theme/app_theme.dart';

import 'core/service_locator/service_locator.dart';
import 'l10n/app_localizations.dart';


/// [main]
///
/// - `WidgetsFlutterBinding.ensureInitialized():` Ensures that the Flutter framework is initialized.
///   This is required before calling native Flutter functions (like [runApp]).
///
/// - `await setUpServices()`: Calls an asynchronous function to set up and initialize
///   the application's services, such as dependency injection using [get_it].
///
/// - `runApp(const RentalApp())`: Starts the application by displaying the root widget [RentalApp].
///
/// [RentalApp] is a StatelessWidget that serves as the application's root.
///
/// - [MultiBlocProvider]: Provides multiple BLoC states to the widget tree.
///   This allows descendant widgets to access [ThemeCubit], [LanguageCubit], and [HomeCubit].
///   Each Cubit is created using `sl<T>()`, which fetches the registered service instance
///   from the service locator.
///
/// - `child: const RentalAppView()`: Renders [RentalAppView] as its child widget.
///
/// [RentalAppView] is a StatelessWidget that builds the main UI of the app.
///
/// - `context.watch<ThemeCubit>().state` & `context.watch<LanguageCubit>().state`:
///   These lines listen for changes in [ThemeCubit] and [LanguageCubit].
///   When the state of either cubit changes, Flutter rebuilds this widget.
///
/// - [MaterialApp]: The main widget that wraps a number of widgets required for
///   Material Design applications.
///   - [title]: The app title used by the operating system.
///   - [debugShowCheckedModeBanner]: Hides the "Debug" banner in the top-right corner.
///   - [theme] & [darkTheme]: Define the light and dark themes for the app.
///   - [themeMode]: Controls which theme to use (light, dark, or system) based on the [ThemeCubit]'s state.
///   - [locale]: Sets the app's current language based on the [LanguageCubit]'s state.
///   - [supportedLocales]: A list of languages supported by the app.
///   - [localizationsDelegates]: Provides translations and localized content for the app.
///   - [localeResolutionCallback]: Logic to determine the best supported locale based on the device's locale.
///   - [routes]: Defines the named navigation routes in the app, allowing navigation to screens
///     like [LoginScreen], [HomeRegisterScreen], and [SettingsScreen].
///   - [home]: The widget displayed when the app starts, which is [SplashScreen] here.
///
Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await setUpServices();

  runApp(const RentalApp());
}

class RentalApp extends StatelessWidget {
  const RentalApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MultiBlocProvider(
      providers: [
        BlocProvider(create: (context) => sl<ThemeCubit>()),
        BlocProvider(create: (context) => sl<LanguageCubit>()),
        BlocProvider(create: (context) => sl<HomeCubit>()),
        BlocProvider(create: (context) => sl<FavoritesCubit>()..loadFavorites()),
        BlocProvider.value(value: sl<AuthCubit>()),
        BlocProvider(create: (context) => sl<ChatCubit>()),
        BlocProvider(create: (context) => sl<AddApartmentCubit>()),
        BlocProvider(create: (context) => sl<MyApartmentsCubit>()),
        BlocProvider(create: (context) => sl<BookingCubit>()),
        BlocProvider(create: (context) => sl<LocationCubit>()..loadSavedLocation(),),
        BlocProvider(create: (context) => sl<ManageBookingCubit>()),
        BlocProvider(create: (context) => sl<MyBookingCubit>()),
        BlocProvider(create: (context) => sl<ManageBookingCubit>()),
        BlocProvider(create: (context) => sl<ReviewsCubit>()),
      ],
      child: const RentalAppView(),
    );
  }
}

class RentalAppView extends StatelessWidget {
  const RentalAppView({super.key});

  @override
  Widget build(BuildContext context) {
    final themeState = context.watch<ThemeCubit>().state;
    final languageState = context.watch<LanguageCubit>().state;

    final router = buildAppRouter();

    return MaterialApp.router(
      title: 'Malaz Rental',
      debugShowCheckedModeBanner: false,
      theme: AppTheme.lightTheme,
      darkTheme: AppTheme.darkTheme,
      themeMode: themeState.themeMode,
      locale: languageState.locale,
      supportedLocales: AppLocalizations.supportedLocales,
      localizationsDelegates: const [
        AppLocalizations.delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
      ],
      localeResolutionCallback: (locale, supportedLocales) {
        for (var supportedLocale in supportedLocales) {
          if (supportedLocale.languageCode == locale?.languageCode) {
            return supportedLocale;
          }
        }
        return supportedLocales.first;
      },
      routerConfig: router,
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\cubits\auth\auth_cubit.dart
// =======================================================

import 'dart:developer';
import 'dart:io';

import 'package:dio/dio.dart';
import 'package:equatable/equatable.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import 'package:malaz/domain/usecases/auth/check_auth_usecase.dart';
import 'package:malaz/domain/usecases/auth/get_current_user_usecase.dart';
import 'package:malaz/domain/usecases/auth/login_usecase.dart';
import 'package:malaz/domain/usecases/auth/logout_usecase.dart';
import 'package:path_provider/path_provider.dart';
import '../../../core/errors/failures.dart';
import '../../../core/service_locator/service_locator.dart';
import '../../../core/usecases/usecase.dart';
import '../../../data/datasources/local/auth/auth_local_data_source.dart';
import '../../../domain/repositories/auth/auth_repository.dart';
import '../../../domain/usecases/auth/register_usecase.dart';
import '../../../domain/usecases/auth/send_otp_usecase.dart';
import '../../../domain/usecases/auth/verify_otp_usecase.dart';

// --- States --- //

abstract class AuthState extends Equatable {
  @override
  List<Object?> get props => [];
}

class AuthInitial extends AuthState {}

class AuthLoading extends AuthState {}

class AuthAuthenticated extends AuthState {
  final UserEntity user;
  AuthAuthenticated(this.user);
  @override
  List<Object?> get props => [user];
}

class AuthUnauthenticated extends AuthState {}

class AuthPending extends AuthState {
  final UserEntity user;
  AuthPending(this.user);
  @override
  List<Object?> get props => [user];
}

class AuthError extends AuthState {
  final String message;
  AuthError({required this.message});
  @override
  List<Object?> get props => [message];
}

class OtpSending extends AuthState {}

class OtpSent extends AuthState {}

class OtpSendError extends AuthState {
  final String message;
  OtpSendError(this.message);
}

class OtpVerifying extends AuthState {}

class OtpVerified extends AuthState {}

class OtpVerifyError extends AuthState {
  final String message;
  OtpVerifyError(this.message);
}

class OtpSentSuccess extends AuthState {}

class PasswordUpdatedSuccess extends AuthState {}

// --- Cubit --- //

class AuthCubit extends Cubit<AuthState> {
  final LoginUsecase loginUsecase;
  final LogoutUsecase logoutUsecase;
  final GetCurrentUserUsecase getCurrentUserUsecase;
  final CheckAuthUsecase checkAuthUsecase;
  final RegisterUsecase registerUsecase;
  final SendOtpUsecase sendOtpUsecase;
  final VerifyOtpUsecase verifyOtpUsecase;
  final AuthRepository repository;

  AuthCubit(
      {required this.loginUsecase,
      required this.logoutUsecase,
      required this.getCurrentUserUsecase,
      required this.checkAuthUsecase,
      required this.registerUsecase,
      required this.sendOtpUsecase,
      required this.verifyOtpUsecase,
      required this.repository}) : super(AuthInitial());

  Future<void> checkAuth() async {
    final res = await checkAuthUsecase(NoParams());

    res.fold(
          (_) {
        if (state is AuthPending) return;
        emit(AuthUnauthenticated());
      },
          (status) {
        if (status.isPending && status.user != null) {
          emit(AuthPending(status.user!));
        } else if (status.isAuthenticated && status.user != null) {
          emit(AuthAuthenticated(status.user!));
        } else {
          if (state is AuthPending) return;
          emit(AuthUnauthenticated());
        }
      },
    );
  }

  Future<void> register({
    required String phone,
    required String firstName,
    required String lastName,
    required String password,
    required String dateOfBirth,
    required XFile profileImage,
    required XFile identityImage,
  }) async {
    emit(AuthLoading());

    try {
      final res = await registerUsecase(RegisterParams(
        phone: phone,
        role: 'PENDING',
        firstName: firstName,
        lastName: lastName,
        password: password,
        passwordConfirmation: password,
        dateOfBirth: dateOfBirth,
        profileImage: profileImage,
        identityCardImage: identityImage,
      ));
      print('>>>> ${res}');
      res.fold(
        (failure) {
          emit(AuthError(message: _mapFailureToMessage(failure)));
          emit(AuthUnauthenticated());
        },
        (user) async {
          final storage = FlutterSecureStorage();
          await storage.write(key: AppConstants.passwordUserKey, value: password);
          await storage.write(key: AppConstants.phoneUserKey, value: phone);

          final role = user.role.toLowerCase();
          if (role == 'pending') {
            emit(AuthPending(user));
          } else {
            emit(AuthAuthenticated(user));
          }
        },
      );
    } catch (e) {
      emit(AuthError(message: 'Error preparing images: $e'));
      emit(AuthUnauthenticated());
    }
  }

  Future<void> login({required String phone, required String password,}) async {
    emit(AuthLoading());

    final res = await loginUsecase(
      LoginParams(phoneNumber: phone, password: password),
    );

    res.fold(
          (failure) {
        if (failure is PendingApprovalFailure) {
          emit(AuthPending(
            UserEntity.emptyPending(),
          ));
        } else if (failure is PhoneNotFoundFailure) {
          emit(AuthError(
            message: 'This phone number does not exist in our records.',
          ));
        } else if (failure is WrongPasswordFailure) {
          emit(AuthError(message: 'Invalid credentials'));
        } else {
          emit(AuthError(message: _mapFailureToMessage(failure)));
        }
      },
          (user) async {
        if (user.role.toUpperCase() == 'PENDING') {
          final storage = FlutterSecureStorage();
          await storage.write(key: AppConstants.passwordUserKey, value: password);
          await storage.write(key: AppConstants.phoneUserKey, value: phone);
          emit(AuthPending(user));
        } else {
          emit(AuthAuthenticated(user));
        }
      },
    );
  }

  Future<void> logout() async {
    emit(AuthLoading());
    final result = await logoutUsecase(NoParams());

    result.fold(
          (failure) => emit(AuthError(message:failure.message ?? "Logout Failed")),
          (_) {
        emit(AuthUnauthenticated());
      },
    );
  }

  Future<void> sendOtp(String phone) async {
    emit(OtpSending());
    final res = await sendOtpUsecase(SendOtpParams(phone));
    res.fold(
      (failure) => emit(OtpSendError(_mapFailureToMessage(failure))),
      (_) => emit(OtpSent()),
    );
  }

  Future<void> verifyOtp(String phone, String otp) async {
    emit(OtpVerifying());
    final res = await verifyOtpUsecase(VerifyOtpParams(phone: phone, otp: otp));
    res.fold(
      (failure) => emit(OtpVerifyError(_mapFailureToMessage(failure))),
      (success) {
        if (success)
          emit(OtpVerified());
        else
          emit(OtpVerifyError('Invalid code'));
      },
    );
  }

  Future<void> sendPasswordResetOtp(String phone) async {
    emit(AuthLoading());

    final result = await repository.sendPasswordResetOtp(phone);

    result.fold(
          (failure) => emit(AuthError(message: failure.message.toString())),
          (message) => emit(OtpSentSuccess()),
    );
  }

  Future<void> checkRoleUsingLogin({required String phone, required String password}) async {
    emit(AuthLoading());

    final res = await loginUsecase(
      LoginParams(phoneNumber: phone, password: password),
    );

    res.fold(
      (failure) {
        emit(AuthError(message: _mapFailureToMessage(failure)));
      },
      (user) {
        if (user.role == 'PENDING') {
          emit(AuthPending(user));
        } else if (user.role == 'USER') {
          emit(AuthAuthenticated(user));
        } else {
          emit(AuthUnauthenticated());
        }
      },
    );
  }

  Future<void> silentRoleCheck() async {
    final storage = FlutterSecureStorage();
    final password = await storage.read(key: AppConstants.passwordUserKey);
    final phone = await storage.read(key: AppConstants.phoneUserKey);

    log(password ?? 'null');
    log(phone ?? 'null');
    final res = await loginUsecase(
      LoginParams(phoneNumber: phone.toString(), password: password.toString()),
    );

    res.fold(
          (failure) {
        debugPrint("Silent check failed: ${_mapFailureToMessage(failure)}");
      },
          (user) {
        if (user.role == 'USER') {
          emit(AuthAuthenticated(user));
        } else if (user.role == 'PENDING') {
          emit(AuthPending(user));
        }
      },
    );
  }

  Future<bool> verifyPasswordSilently(String password) async {
    final currentState = state;
    if (currentState is AuthAuthenticated) {
      final result = await loginUsecase(LoginParams(
        phoneNumber: currentState.user.phone,
        password: password,
      ));
      return result.isRight();
    }
    return false;
  }

  Future<void> updatePassword({
    required String phone,
    required String otp,
    required String newPassword,
  }) async {
    emit(AuthLoading());

    final result = await repository.updatePassword(
      phone: phone,
      otp: otp,
      newPassword: newPassword,
    );

    result.fold(
          (failure) => emit(AuthError(message: failure.message.toString())),
          (message) => emit(PasswordUpdatedSuccess()), // حالة نجاح جديدة
    );
  }

  Future<void> updateUserData({
    required String firstName,
    required String lastName,
    String? imagePath,
    String? existingImageUrl,
  }) async {
    emit(AuthLoading());
    try {
      FormData formData = FormData.fromMap({
        "first_name": firstName,
        "last_name": lastName,
      });

      if (imagePath != null && imagePath.isNotEmpty) {
        formData.files.add(MapEntry(
          "profile_image",
          await MultipartFile.fromFile(imagePath, filename: "new_profile.jpg"),
        ));
      } else if (existingImageUrl != null) {
        final File? tempFile = await _downloadFile(existingImageUrl);
        if (tempFile != null) {
          formData.files.add(MapEntry(
            "profile_image",
            await MultipartFile.fromFile(tempFile.path, filename: "existing_profile.jpg"),
          ));
        }
      }

      print("Final Check - Files count: ${formData.files.length}");

      if (formData.files.isEmpty) {
        emit(AuthError(message: "Profile image is required by the server."));
        return;
      }

      final result = await repository.updateProfile(formData);

      result.fold(
            (failure) => emit(AuthError(message: failure.message.toString())),
            (user) {
          sl<AuthLocalDatasource>().cacheUser(user);
          emit(AuthAuthenticated(user));
        },
      );
    } catch (e) {
      emit(AuthError(message: "Update Error: ${e.toString()}"));
    }
  }

  Future<File?> _downloadFile(String url) async {
    try {
      final token = await sl<AuthLocalDatasource>().getCachedToken();

      final response = await Dio().get(
        url,
        options: Options(
          responseType: ResponseType.bytes,
          headers: {
            'Authorization': 'Bearer $token',
            'Accept': 'application/json',
          },
        ),
      );

      final tempDir = await getTemporaryDirectory();
      final file = File('${tempDir.path}/temp_profile_${DateTime.now().millisecondsSinceEpoch}.jpg');
      await file.writeAsBytes(response.data);

      print("Download Success. File size: ${await file.length()} bytes");
      return file;
    } catch (e) {
      print("Download error in _downloadFile: $e");
      return null;
    }
  }

  String _mapFailureToMessage(Failure f) {
    if (f is PhoneNotFoundFailure)
      return 'This phone number does not exist in our records.';
    if (f is WrongPasswordFailure) return 'Incorrect Password';
    if (f is InvalidCredentialsFailure) return 'Invalid credentials';
    if (f is ServerFailure) return (f.message ?? 'Server error');
    if (f is NetworkFailure) return 'Check your internet connection';
    return 'An unexpected error occurred';
  }
}

// =======================================================
// FILE PATH: lib\presentation\cubits\booking\booking_cubit.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/domain/entities/booking/booking.dart';
import 'package:malaz/domain/usecases/booking/Get_Booked_Dates_Use_Case.dart';
import 'package:malaz/domain/usecases/booking/make_book_use_case.dart';

abstract class BookingState extends Equatable {
  const BookingState();
  @override
  List<Object> get props => [];
}

class BookingInitial extends BookingState {}

class BookingLoading extends BookingState {}

class BookingLoaded extends BookingState {
  final List<DateTime> bookedDays;

  const BookingLoaded(this.bookedDays);

  @override
  List<Object> get props => [bookedDays];
}

class BookingError extends BookingState {
  final String message;
  const BookingError(this.message);
}

class SendingBooking extends BookingState {}

class SentBooking extends BookingState {}

class SendingBookingError extends BookingState {
  final String message;
  const SendingBookingError(this.message);
}

class BookingCubit extends Cubit<BookingState> {
  final GetBookedDatesUseCase getBookedDatesUseCase;
  final MakeBookUseCase makeBookUseCase;
  BookingCubit(this.getBookedDatesUseCase, this.makeBookUseCase)
      : super(BookingInitial());

  Future<void> loadBookedDates(int propertyId) async {
    emit(BookingLoading());
    final response = await getBookedDatesUseCase.call(propertyId: propertyId);
    response.fold(
          (failure) => emit(BookingError(failure.message!)),
          (bookedRanges) {
        List<DateTime> dates = bookedRanges
            .expand((range) => _breakToDates(range.checkIn!, range.checkOut!))
            .toList();
        emit(BookingLoaded(dates));
      },
    );
  }

  Future<void> makeBook(Booking booking) async {
    emit(SendingBooking());
    final response = await makeBookUseCase.call(booking: booking);

    response.fold(
            (failure) => emit(SendingBookingError(failure.message!)),
            (_) => emit(SentBooking()));
  }

  List<DateTime> _breakToDates(DateTime checkIn, DateTime checkOut) {
    DateTime counter = checkIn;
    List<DateTime> dates = [];

    while (counter.isBefore(checkOut.add(const Duration(days: 1)))) {
      dates.add(counter);
      counter = counter.add(const Duration(days: 1));
    }

    return dates;
  }
}

// =======================================================
// FILE PATH: lib\presentation\cubits\booking\manage_booking.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/domain/entities/booking/booking.dart';
import '../../../domain/usecases/booking/all_booking_use_case.dart';
import '../../../domain/usecases/booking/update_status_use_case.dart';

// --- States ---
abstract class ManageBookingState extends Equatable {
  const ManageBookingState();
  @override
  List<Object?> get props => [];
}

class ManageBookingInitial extends ManageBookingState {}

class AllBookingLoading extends ManageBookingState {}
class AllBookingsLoaded extends ManageBookingState {
  final List<Booking> bookings;
  const AllBookingsLoaded(this.bookings);
  @override
  List<Object?> get props => [bookings];
}
class AllBookingError extends ManageBookingState {
  final String message;
  const AllBookingError(this.message);
}

class UpdateStatusLoading extends ManageBookingState {}
class UpdateStatusSuccess extends ManageBookingState {
  final String message;
  const UpdateStatusSuccess(this.message);
}
class UpdateStatusError extends ManageBookingState {
  final String message;
  const UpdateStatusError(this.message);
}

// --- Cubit ---
class ManageBookingCubit extends Cubit<ManageBookingState> {
  final GetUserBooking allBookingUseCase;
  final UpdateStatus updateStatusUseCase;

  ManageBookingCubit(this.allBookingUseCase, this.updateStatusUseCase)
      : super(ManageBookingInitial());

  Future<void> fetchAllBookings(int userId) async {
    emit(AllBookingLoading());
    final response = await allBookingUseCase(userId: userId);

    response.fold(
          (failure) => emit(AllBookingError(failure.message ?? "error")),
          (bookingList) => emit(AllBookingsLoaded(bookingList.booking)),
    );
  }

  Future<void> updateBookingStatus(int bookingId, String status, int ownerId) async {
    emit(UpdateStatusLoading());

    final response = await updateStatusUseCase.call(propertyId: bookingId, status: status);

    response.fold(
          (failure)
          {emit(UpdateStatusError(failure.message ?? "Failed to update status, please try again."));
            fetchAllBookings(ownerId);},
          (success) {
        emit(UpdateStatusSuccess("Booking $status successfully"));
        fetchAllBookings(ownerId);
      },
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\booking\my_booking.dart
// =======================================================


// --- States ---
import 'package:equatable/equatable.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

import '../../../domain/entities/booking/booking.dart';
import '../../../domain/usecases/booking/My_booking_usecase.dart';
import '../../../domain/usecases/booking/update_Booking_Date.dart';
import '../../../domain/usecases/booking/update_status_use_case.dart';

abstract class MyBookingState extends Equatable {
  const MyBookingState();
  @override
  List<Object?> get props => [];
}

class MyBookingInitial extends MyBookingState {}

class MyBookingLoading extends MyBookingState {}

class MyBookingLoaded extends MyBookingState {
  final List<Booking> bookings;
  const MyBookingLoaded(this.bookings);
  @override
  List<Object?> get props => [bookings];
}

class MyBookingCancelSuccess extends MyBookingState {}

class MyBookingUpdateSuccess extends MyBookingState {}

class MyBookingError extends MyBookingState {
  final String message;
  const MyBookingError(this.message);
}


// --- Cubit ---
class MyBookingCubit extends Cubit<MyBookingState> {
  final GetMyBooking getMyBookingUseCase;
  final UpdateBookingUseCase updateBookingUseCase;
  final UpdateStatus updateStatusUseCase;

  MyBookingCubit(this.getMyBookingUseCase, this.updateBookingUseCase, this.updateStatusUseCase) : super(MyBookingInitial());

  Future<void> fetchMyBookings(int userId) async {
    emit(MyBookingLoading());
    final response = await getMyBookingUseCase(userId: userId);

    response.fold(
          (failure) => emit(MyBookingError(failure.message ?? "حدث خطأ أثناء جلب الحجوزات")),
          (bookingList) => emit(MyBookingLoaded(bookingList.booking)),
    );
  }
  Future<void> updateBookingDates({
    required int bookingId,
    required DateTime checkIn,
    required DateTime checkOut,
    required int userId,
  }) async {
    emit(MyBookingLoading());

    final String checkInStr = checkIn.toIso8601String().split('T')[0];
    final String checkOutStr = checkOut.toIso8601String().split('T')[0];

    final result = await updateBookingUseCase(
      bookingId: bookingId,
      checkIn: checkInStr,
      checkOut: checkOutStr,
    );

    result.fold(
          (failure) => emit(MyBookingError(failure.message ?? "فشل تحديث الحجز")),
          (_) async {
        emit(MyBookingUpdateSuccess());
        await fetchMyBookings(userId);
      },
    );
  }
  Future<void> cancelBooking({required int propertyId, required int userId}) async {
    emit(MyBookingLoading());

    final result = await updateStatusUseCase(propertyId:propertyId , status: "cancelled");

    result.fold(
          (failure) => emit(MyBookingError(failure.message ?? "فشل إلغاء الحجز")),
          (_) async {
        emit(MyBookingCancelSuccess());
        await fetchMyBookings(userId);
      },
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\cubits\chat\chat_cubit.dart
// =======================================================

import 'dart:developer';

import 'package:flutter_bloc/flutter_bloc.dart';

import '../../../data/models/chat/chat_message_model.dart';
import '../../../data/models/chat/conversation_model.dart';
import '../../../domain/repositories/chat/chat_repository.dart';

/// ===========================
/// ----------[states]---------
/// ===========================

abstract class ChatState {}

class ChatInitial extends ChatState {}

class ChatLoading extends ChatState {}

class ChatConversationsLoaded extends ChatState {
  final List<ConversationModel> conversations;
  ChatConversationsLoaded(this.conversations);
}

class ChatMessagesInitialLoading extends ChatState {}

class ChatMessagesLoaded extends ChatState {
  final List<ChatMessageModel> messages;
  final int conversationId;

  ChatMessagesLoaded({
    required this.messages,
    required this.conversationId,
  });

  ChatMessagesLoaded copyWith({
    List<ChatMessageModel>? messages,
    int? conversationId,
  }) {
    return ChatMessagesLoaded(
      messages: messages ?? this.messages,
      conversationId: conversationId ?? this.conversationId,
    );
  }
}

class ChatConversationsError extends ChatState {
  final String message;
  ChatConversationsError(this.message);
}


/// ===========================
/// ----------[cubit]---------
/// ===========================

class ChatCubit extends Cubit<ChatState> {
  final ChatRepository repository;
  List<ChatMessageModel> allMessages = [];

  ChatCubit({required this.repository}) : super(ChatInitial());

  void handlePusherEvent(String eventName, Map<String, dynamic> data) {
    if (state is! ChatMessagesLoaded) return;
    final currentState = state as ChatMessagesLoaded;

    final msgData = data['message'] ?? data;
    final incomingMsg = ChatMessageModel.fromJson(msgData);

    switch (eventName) {
      case 'MessageSent':
        _handleIncomingNewMessage(currentState, incomingMsg);
        break;
      case 'MessageUpdated':
        _handleIncomingUpdate(currentState, incomingMsg);
        break;
      case 'MessageDeleted':
        _handleIncomingDelete(currentState, incomingMsg.id);
        break;
      case 'MessageRead':
        _handleIncomingUpdate(currentState, incomingMsg);
        break;
    }
  }

  void _handleIncomingNewMessage(ChatMessagesLoaded currentState, ChatMessageModel msg) {
    final bool alreadyExists = currentState.messages.any((m) => m.id == msg.id);

    if (!alreadyExists) {
      final updatedMessages = [msg, ...currentState.messages];
      emit(currentState.copyWith(messages: updatedMessages));
    }
  }

  void _handleIncomingUpdate(ChatMessagesLoaded currentState, ChatMessageModel msg) {
    final newList = currentState.messages.map((m) => m.id == msg.id ? msg : m).toList();
    emit(currentState.copyWith(messages: newList));
  }

  void _handleIncomingDelete(ChatMessagesLoaded currentState, int msgId) {
    final newList = currentState.messages.where((m) => m.id != msgId).toList();
    emit(currentState.copyWith(messages: newList));
  }

  Future<void> getConversations() async {
    emit(ChatLoading());
    final result = await repository.getConversations();
    if (isClosed) return;
    result.fold(
          (failure) => emit(ChatConversationsError(failure.message.toString())),
          (conversations) => emit(ChatConversationsLoaded(conversations)),
    );
  }

  Future<void> deleteConversation(int conversationId) async {
    emit(ChatLoading());
    final result = await repository.deleteConversation(conversationId);
    result.fold(
          (failure) => emit(ChatConversationsError(failure.message.toString())),
          (_) => getConversations(),
    );
  }

  Future<int?> saveNewConversation(int otherUserId) async {
    clearMessages();
    final result = await repository.saveNewConversation(otherUserId);
    return result.fold(
          (failure) => null,
          (conversation) {
        emit(ChatMessagesLoaded(messages: [], conversationId: conversation.id));
        return conversation.id;
      },
    );
  }

  void getMessages(int conversationId, {bool isSilent = false}) async {
    allMessages = [];
    emit(ChatMessagesInitialLoading());

    final result = await repository.getMessages(conversationId);

    result.fold(
          (error) => emit(ChatConversationsError(error.toString())),
          (messages) {
        allMessages = messages;
        emit(ChatMessagesLoaded(messages: messages, conversationId: conversationId));
      },
    );
  }

  Future<void> sendMessage(int conversationId, String body, int myId) async {
    if (state is! ChatMessagesLoaded) return;
    final currentState = state as ChatMessagesLoaded;

    final result = await repository.sendMessage(conversationId, body);

    result.fold(
          (failure) {
        log(">>>> Send Message Failed: ${failure.message}");
      },
          (actualMsg) {
        log(">>>> Message Received and Adding to UI: ${actualMsg.id}");

        final updatedList = [actualMsg, ...currentState.messages];

        emit(currentState.copyWith(messages: updatedList));
      },
    );
  }

  Future<void> editMessage(int messageId, String newBody) async {
    if (state is! ChatMessagesLoaded) return;
    final currentState = state as ChatMessagesLoaded;

    final updatedList = currentState.messages.map((m) {
      return m.id == messageId ? m.copyWith(body: newBody, updatedAt: DateTime.now()) : m;
    }).toList();
    emit(currentState.copyWith(messages: updatedList));

    final result = await repository.editMessage(messageId, newBody);
    result.fold(
          (failure) => emit(currentState),
          (_) => null,
    );
  }

  Future<void> deleteMessage(int messageId) async {
    if (state is! ChatMessagesLoaded) return;
    final currentState = state as ChatMessagesLoaded;

    final updatedList = currentState.messages.where((m) => m.id != messageId).toList();
    emit(currentState.copyWith(messages: updatedList));

    final result = await repository.deleteMessage(messageId);
    result.fold(
          (failure) => emit(currentState),
          (_) => null,
    );
  }

  Future<void> markMessageAsRead(int conversationId) async {
    if (state is ChatConversationsLoaded) {
      final currentState = state as ChatConversationsLoaded;
      final updatedConvs = currentState.conversations.map((c) {
        if (c.id == conversationId) {
          return c.copyWith(unreadCount: 0);
        }
        return c;
      }).toList();
      emit(ChatConversationsLoaded(updatedConvs));
    }

    await repository.markAsRead(conversationId);
  }

  void clearMessages() {
    allMessages = [];
    emit(ChatInitial());
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\chat\pusher_service\pusher_service.dart
// =======================================================

import 'dart:convert';
import 'dart:developer';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:pusher_channels_flutter/pusher_channels_flutter.dart';
import 'package:http/http.dart' as http;

class PusherService {
  static final PusherService _instance = PusherService._internal();
  factory PusherService() => _instance;
  PusherService._internal();

  PusherChannelsFlutter pusher = PusherChannelsFlutter.getInstance();
  bool _isInitialized = false;

  Future<void> init({required String token}) async {
    if (_isInitialized) return;

    try {
      await pusher.init(
        apiKey: AppConstants.apiKeyForPusher,
        cluster: AppConstants.clusterForPusher,
        onAuthorizer: (channelName, socketId, options) async {
          log(">>>> [Pusher] Manual Authorizing for: $channelName");

          try {
            final response = await http.post(
              Uri.parse(AppConstants.baseurlForPusher),
              headers: {
                "Authorization": "Bearer $token",
                "Accept": "application/json",
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: {
                "socket_id": socketId,
                "channel_name": channelName,
              },
            );

            if (response.statusCode == 200) {
              final jsonResponse = jsonDecode(response.body);
              log(">>>> [Pusher] Auth Success for $channelName");
              return jsonResponse;
            } else {
              log(">>>> [Pusher] Server Refused Auth: ${response.statusCode}");
              return null;
            }
          } catch (e) {
            log(">>>> [Pusher] HTTP Auth Exception: $e");
            return null;
          }
        },
        onConnectionStateChange: (current, previous) => log(">>>> Pusher: $previous -> $current"),
        onSubscriptionSucceeded: (name, data) => log(">>>> Successfully Subscribed to $name"),
        onSubscriptionError: (msg, err) => log(">>>> Subscription Error: $msg"),
        onError: (msg, code, err) => log(">>>> Pusher Error: [$code] $msg"),
      );

      await pusher.connect();
      _isInitialized = true;
    } catch (e) {
      log(">>>> Pusher Critical Init Error: $e");
    }
  }

  Future<void> subscribe({
    required String channelName,
    required Function(PusherEvent event) onEvent,
  }) async {
    try {
      log(">>>> Preparing channel: $channelName");
      await pusher.unsubscribe(channelName: channelName);

      await pusher.subscribe(
        channelName: channelName,
          onEvent: (dynamic event) {
            if (event is PusherEvent) {
              log(">>>> New Event: [${event.eventName}]");

              if (event.eventName.startsWith('pusher:')) {
                log(">>>> Internal Pusher Event ignored.");
                return;
              }

              try {
                final dynamic rawData = event.data;
                Map<String, dynamic> decodedData;

                if (rawData is String) {
                  decodedData = jsonDecode(rawData);
                } else if (rawData is Map) {
                  decodedData = Map<String, dynamic>.from(rawData);
                } else {
                  decodedData = {};
                }

                onEvent(PusherEvent(
                  channelName: event.channelName,
                  eventName: event.eventName,
                  data: jsonEncode(decodedData),
                ));
              } catch (e) {
                log(">>>> JSON Parsing Error: $e");
              }
            }
          }
      );

      log(">>>> Subscription request sent for $channelName");

    } catch (e) {
      log(">>>> Subscription Error in PusherService: $e");
    }
  }

  Future<void> unsubscribe(String channelName) async {
    try {
      await pusher.unsubscribe(channelName: channelName);
      log(">>>> Unsubscribed from $channelName");
    } catch (e) {
      log(">>>> Unsubscribe Error: $e");
    }
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\favorites\favorites_cubit.dart
// =======================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:equatable/equatable.dart';
import 'package:malaz/domain/usecases/favorites/delete_favorites_use_case.dart';

import '../../../domain/entities/apartment/apartment.dart';
import '../../../domain/usecases/favorites/add_favorites_use_case.dart';
import '../../../domain/usecases/favorites/get_favorites_use_case.dart';

abstract class FavoritesState extends Equatable {
  const FavoritesState();
  @override
  List<Object> get props => [];
}

class FavoritesInitial extends FavoritesState {}
class FavoritesLoading extends FavoritesState {}

class FavoritesLoaded extends FavoritesState {
  final List<Apartment> favorites;
  final int lastUpdated;

  const FavoritesLoaded(this.favorites, this.lastUpdated);

  @override
  List<Object> get props => [favorites, lastUpdated];
}

class FavoritesError extends FavoritesState {
  final String message;
  const FavoritesError(this.message);
}

class FavoritesCubit extends Cubit<FavoritesState> {
  final GetFavoritesUseCase getFavoritesUseCase;
  final AddFavoriteUseCase addFavoriteUseCase;
  final DeleteFavoriteUseCase deleteFavoriteUseCase;


  List<Apartment> _currentFavorites = [];

  FavoritesCubit({
    required this.getFavoritesUseCase,
    required this.addFavoriteUseCase,
    required this.deleteFavoriteUseCase,
  }) : super(FavoritesInitial());

  Future<void> loadFavorites() async {
    if (_currentFavorites.isEmpty) emit(FavoritesLoading());

    final result = await getFavoritesUseCase.call();

    result.fold(
          (failure) => emit(FavoritesError(failure.message!)),
          (apartments) {
        _currentFavorites = apartments;
        _emitLoaded();
      },
    );
  }

  Future<void> toggleFavorite(Apartment apartment) async {
    final isFav = isFavorite(apartment.id);

    if (isFav) {
      _currentFavorites.removeWhere((element) => element.id == apartment.id);
    } else {
      _currentFavorites.add(apartment);
    }
    _emitLoaded();

    final result = isFav
        ? await deleteFavoriteUseCase.call(apartment.id)
        : await addFavoriteUseCase.call(apartment.id);

    result.fold(
          (failure) {
        if (isFav) {
          _currentFavorites.add(apartment);
        } else {
          _currentFavorites.removeWhere((element) => element.id == apartment.id); // نحذفها
        }
        emit(FavoritesError(failure.message!));
        _emitLoaded();
      },
          (_) {
      },
    );
  }

  bool isFavorite(int id) {
    return _currentFavorites.any((element) => element.id == id);
  }

  void _emitLoaded() {
    emit(FavoritesLoaded(
      List.from(_currentFavorites),
      DateTime.now().millisecondsSinceEpoch,
    ));
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\home\home_cubit.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:malaz/domain/entities/filters/filters.dart';
import '../../../domain/entities/apartment/apartment.dart';
import '../../../core/errors/failures.dart';
import '../../../data/utils/failure_mapper.dart';
import '../../../domain/usecases/home/apartments_use_case.dart';

/// ===========================
/// ----------[states]---------
/// ===========================

abstract class HomeState extends Equatable {
  const HomeState();
  @override
  List<Object?> get props => [];
}

class HomeInitial extends HomeState {}
class HomeLoading extends HomeState {}

class HomeLoaded extends HomeState {
  final List<Apartment> apartments;
  final bool hasReachedMax;
  final bool hasReachedStart;

  const HomeLoaded({
    required this.apartments,
    this.hasReachedMax = false,
    this.hasReachedStart = true,
  });

  @override
  List<Object?> get props => [apartments, hasReachedMax, hasReachedStart];

  HomeLoaded copyWith({
    List<Apartment>? apartments,
    bool? hasReachedMax,
    bool? hasReachedStart,
  }) {
    return HomeLoaded(
      apartments: apartments ?? this.apartments,
      hasReachedMax: hasReachedMax ?? this.hasReachedMax,
      hasReachedStart: hasReachedStart ?? this.hasReachedStart,
    );
  }
}

class HomeError extends HomeState {
  final String message;
  const HomeError({required this.message});
  @override
  List<Object> get props => [message];
}

/// ===========================
/// ----------[cubit]----------
/// ===========================

class HomeCubit extends Cubit<HomeState> {
  final GetApartmentsUseCase getApartmentsUseCase;

  String? _nextCursor;
  String? _prevCursor;
  Filter? _currentFilter;

  bool _isFetching = false;

  HomeCubit({required this.getApartmentsUseCase}) : super(HomeInitial());

  Future<void> loadApartments({
    bool isRefresh = false,
    bool loadNext = false,
    Filter? newFilter
  }) async {
    if (_isFetching) return;
    _isFetching = true;

    try {
      if(newFilter != null) {
        /// TODO: optimizing exists when currentFilter == newFilter
        _currentFilter = newFilter;
        isRefresh = true;
      }
      String? cursorToSend;
      if (isRefresh) {
        cursorToSend = null;
        emit(HomeLoading());
      } else if (loadNext) {
        cursorToSend = _nextCursor;
        if (cursorToSend == null) {
          _isFetching = false;
          return;
        }
      } else {
        if (state is! HomeLoaded) emit(HomeLoading());
        cursorToSend = null;
      }
      final result = await getApartmentsUseCase.call(cursor: cursorToSend, filter: _currentFilter);

      _nextCursor = result.nextCursor;
      _prevCursor = result.prevCursor;

      if (loadNext && state is HomeLoaded) {
        final currentList = (state as HomeLoaded).apartments;
        emit(HomeLoaded(
          apartments: currentList + result.apartments,
          hasReachedMax: _nextCursor == null,
          hasReachedStart: _prevCursor == null,
        ));
      } else {
        emit(HomeLoaded(
          apartments: result.apartments,
          hasReachedMax: _nextCursor == null,
          hasReachedStart: _prevCursor == null,
        ));
      }

    } catch (e) {
      final Failure failure = FailureMapper.map(e);

      String keyMessage;

      if (failure is NetworkFailure) {
        keyMessage = AppConstants.networkFailureKey;
      } else if(failure is ServerFailure) {
        keyMessage = failure.message ?? AppConstants.cancelledFailureKey;
      } else {
        keyMessage = AppConstants.unknownFailureKey;
      }

      if (!isClosed) emit(HomeError(message: keyMessage));
    } finally {
      _isFetching = false;
    }
  }

  void clearFilter() {
    _currentFilter = null;
    loadApartments(isRefresh: true);
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\language\language_cubit.dart
// =======================================================


import 'package:equatable/equatable.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// ===========================
/// ----------[states]---------
/// ===========================

class LanguageState extends Equatable {
  final Locale locale;

  const LanguageState({this.locale = const Locale('en')});

  @override
  List<Object> get props => [locale];

  LanguageState copyWith({Locale? locale}) {
    return LanguageState(locale: locale ?? this.locale);
  }
}

/// ===========================
/// ----------[cubit]----------
/// ===========================

class LanguageCubit extends Cubit<LanguageState> {
  final SharedPreferences _prefs;
  static const String _languageKey = 'language_code';

  LanguageCubit(this._prefs) : super(const LanguageState()) {
    loadLanguage();
  }

  void loadLanguage() {
    final languageCode = _prefs.getString(_languageKey) ?? 'en'; // Default to 'en'
    emit(LanguageState(locale: Locale(languageCode)));
  }

  void updateLanguage(Locale newLocale) {
    _prefs.setString(_languageKey, newLocale.languageCode);
    emit(state.copyWith(locale: newLocale));
  }
}

// =======================================================
// FILE PATH: lib\presentation\cubits\location\location_cubit.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

import '../../../domain/entities/location/location_entity.dart';
import '../../../domain/usecases/location/get_current_location_usecase.dart';
import '../../../domain/usecases/location/load_saved_location_usecase.dart';

import '../../../domain/usecases/location/update_manual_location_usecase.dart';

/// ===========================
/// ----------[states]---------
/// ===========================

abstract class LocationState extends Equatable {
  @override
  List<Object?> get props => [];
}

class LocationInitial extends LocationState {}
class LocationLoading extends LocationState {}
class LocationLoaded extends LocationState {
  final LocationEntity location;
  LocationLoaded(this.location);
  @override
  List<Object?> get props => [location];
}
class LocationError extends LocationState {
  final String message;
  LocationError(this.message);
}

/// ===========================
/// ----------[cubit]----------
/// ===========================
class LocationCubit extends Cubit<LocationState> {
  final GetCurrentLocationUseCase getCurrentLocationUseCase;
  final LoadSavedLocationUseCase loadSavedLocationUseCase;
  final UpdateManualLocationUseCase updateManualLocationUseCase;

  LocationCubit({
    required this.getCurrentLocationUseCase,
    required this.loadSavedLocationUseCase,
    required this.updateManualLocationUseCase,
  }) : super(LocationInitial());

  Future<void> getCurrentLocation(String lang) async {
    emit(LocationLoading());
    try {
      final loc = await getCurrentLocationUseCase(lang);
      emit(LocationLoaded(loc));
    } catch (e) { emit(LocationError(e.toString())); }
  }

  Future<void> loadSavedLocation() async {
    final loc = await loadSavedLocationUseCase();
    if (loc != null) emit(LocationLoaded(loc));
  }

  void clearLocation() {
    emit(LocationInitial());
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\property\property_cubit.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter/src/widgets/framework.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:image_picker/image_picker.dart';
import 'package:path/path.dart';
import '../../../core/constants/app_constants.dart';
import '../../../core/errors/failures.dart';
import '../../../data/utils/failure_mapper.dart';
import '../../../domain/entities/apartment/apartment.dart';
import '../../../domain/usecases/apartment/add_apartment_use_case.dart';
import '../../../domain/usecases/apartment/my_apartment_use_case.dart';
import '../../../l10n/app_localizations.dart';


abstract class ApartmentState extends Equatable {
  @override
  List<Object?> get props => [];
}

class ApartmentInitial extends ApartmentState {}

class AddApartmentLoading extends ApartmentState {}
class AddApartmentSuccess extends ApartmentState {
  final String message;
  AddApartmentSuccess({required this.message});
  @override
  List<Object?> get props => [message];
}
class AddApartmentError extends ApartmentState {
  final String message;
  AddApartmentError({required this.message});
  @override
  List<Object?> get props => [message];
}

class MyApartmentsLoading extends ApartmentState {}
class MyApartmentsLoaded extends ApartmentState {
  final List<Apartment> myApartments;
  final bool hasReachedMax;

  MyApartmentsLoaded({required this.myApartments, this.hasReachedMax = false});
  @override
  List<Object?> get props => [myApartments, hasReachedMax];
}
class MyApartmentsError extends ApartmentState {
  final String message;
  MyApartmentsError({required this.message});
  @override
  List<Object?> get props => [message];
}


class AddApartmentCubit extends Cubit<ApartmentState> {
  final AddApartmentUseCase addApartmentUseCase;

  AddApartmentCubit({required this.addApartmentUseCase}) : super(ApartmentInitial());

  Future<void> submitApartment({
    required String title,
    required int price,
    required String city,
    required String governorate,
    required String address,
    required String description,
    required String type,
    required int rooms,
    required int bathrooms,
    required int bedrooms,
    required int area,
    required List<XFile> images,
    required XFile main_pic,
    required double latitide,
    required double longitude
  }) async {
    emit(AddApartmentLoading());

    final params = ApartmentParams(
      title: title,
      price: price,
      city: city,
      governorate: governorate,
      address: address,
      description: description,
      type: type,
      rooms: rooms,
      bathrooms: bathrooms,
      bedrooms: bedrooms,
      area: area,
      mainImageUrl: images,
      main_pic: main_pic,
      latitude: latitide,
      longitude: longitude
    );

    final result = await addApartmentUseCase.call(params);

    result.fold(
          (failure) => emit(AddApartmentError(message: _mapFailureToMessage(failure))),
          (unit) => emit(AddApartmentSuccess(message: "تم رفع العقار بنجاح، وهو الآن قيد المراجعة.")),
    );
  }

  void resetState() => emit(ApartmentInitial());

  String _mapFailureToMessage(Failure f) {
    if (f is ServerFailure) return f.message ?? "خطأ من السيرفر";
    if (f is NetworkFailure) return "network falure";
    return "unexpected error";
  }
}


class MyApartmentsCubit extends Cubit<ApartmentState> {
  final GetMyApartmentsUseCase getMyApartmentsUseCase;

  String? _nextCursor;
  bool _isFetching = false;

  MyApartmentsCubit({required this.getMyApartmentsUseCase})
      : super(ApartmentInitial());

  Future<void> fetchMyApartments({bool isRefresh = false}) async {
    if (_isFetching) return;
    if (!isRefresh && state is MyApartmentsLoaded &&
        (state as MyApartmentsLoaded).hasReachedMax) return;

    _isFetching = true;

    try {
      if (isRefresh) {
        _nextCursor = null;
        emit(MyApartmentsLoading());
      } else if (state is ApartmentInitial) {
        emit(MyApartmentsLoading());
      }

      final result = await getMyApartmentsUseCase.call(cursor: _nextCursor);

      List<Apartment> currentList = [];
      if (state is MyApartmentsLoaded && !isRefresh) {
        currentList = (state as MyApartmentsLoaded).myApartments;
      }

      _nextCursor = result.nextCursor;

      final bool reachedMax = _nextCursor == null || result.apartments.isEmpty;

      emit(MyApartmentsLoaded(
        myApartments: isRefresh ? result.apartments : (currentList +
            result.apartments),
        hasReachedMax: reachedMax,
      ));
    } catch (e) {
      final Failure failure = FailureMapper.map(e);
      String keyMessage = (failure is ServerFailure)
          ? (failure.message ?? AppConstants.cancelledFailureKey)
          : AppConstants.unknownFailureKey;

      if (!isClosed) emit(MyApartmentsError(message: keyMessage));
    } finally {
      _isFetching = false;
    }
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\review\review_cubit.dart
// =======================================================

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:equatable/equatable.dart';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:malaz/core/errors/failures.dart';
import 'package:malaz/domain/usecases/review/add_review_usecase.dart';
import '../../../domain/entities/review/review.dart';
import '../../../domain/usecases/review/get_review_use_case.dart';

abstract class ReviewsState extends Equatable {
  const ReviewsState();
  @override
  List<Object?> get props => [];
}

class ReviewsInitial extends ReviewsState {}

class ReviewsLoading extends ReviewsState {}

class ReviewsLoaded extends ReviewsState {
  final List<Review> reviews;
  final bool hasReachedMax;

  const ReviewsLoaded({
    required this.reviews,
    this.hasReachedMax = false,
  });

}
class AddReviewLoading extends ReviewsState {}

class AddReviewSuccess extends ReviewsState {}

class AddReviewError extends ReviewsState {
  final String message;
  const AddReviewError({required this.message});
  @override
  List<Object> get props => [message];
}

class ReviewsError extends ReviewsState {
  final String message;
  const ReviewsError({required this.message});
  @override
  List<Object> get props => [message];
}

class ReviewsCubit extends Cubit<ReviewsState> {
  final GetReviewsUseCase getReviewsUseCase;
  final AddReviewsUseCase addReviewUseCase;
  String? _nextCursor;
  bool _isFetching = false;

  ReviewsCubit(this.getReviewsUseCase, this.addReviewUseCase) : super(ReviewsInitial());

  Future<void> loadReviews({
    required int propertyId,
    bool isRefresh = false,
    bool loadNext = false,
  }) async {
    if (_isFetching) return;
    _isFetching = true;

    try {
      String? cursorToSend;

      if (isRefresh) {
        cursorToSend = null;
        emit(ReviewsLoading());
      } else if (loadNext) {
        cursorToSend = _nextCursor;
        if (cursorToSend == null) {
          _isFetching = false;
          return;
        }
      } else {
        if (state is! ReviewsLoaded) emit(ReviewsLoading());
        cursorToSend = null;
      }

      final result = await getReviewsUseCase.call(
        propertyId: propertyId,
        cursor: cursorToSend,
      );

      result.fold(
            (failure) {
          String keyMessage = AppConstants.unknownFailureKey;
          if (failure is NetworkFailure) {
            keyMessage = AppConstants.networkFailureKey;
          } else if (failure is ServerFailure) {
            keyMessage = failure.message ?? AppConstants.cancelledFailureKey;
          }
          emit(ReviewsError(message: keyMessage));
        },
            (reviewsList) {
          _nextCursor = reviewsList.nextCursor;

          if (loadNext && state is ReviewsLoaded) {
            final currentList = (state as ReviewsLoaded).reviews;
            emit(ReviewsLoaded(
              reviews: currentList + reviewsList.reviews,
              hasReachedMax: _nextCursor == null,
            ));
          } else {
            emit(ReviewsLoaded(
              reviews: reviewsList.reviews,
              hasReachedMax: _nextCursor == null,
            ));
          }
        },
      );

    } catch (e) {
      if (!isClosed) emit(const ReviewsError(message: "Unexpected Error"));
    } finally {
      _isFetching = false;
    }
  }

  Future<void> addReview({
    required int propertyId,
    required double rating,
    required String body,
  }) async {
    // لا نصدر حالة Loading كاملة لكي لا تختفي التقييمات الموجودة خلف الـ Dialog
    // يمكن إظهار مؤشر تحميل داخل الـ Dialog نفسه أو SnackBar

    final result = await addReviewUseCase.call(
      idProperty: propertyId,
      rating: rating.toString(),
      body: body,
    );

    result.fold(
          (failure) => emit(ReviewsError(message: failure.message ?? "Failed to add review")),
          (success) {
        // بعد النجاح: نعيد تحميل التقييمات لكي يظهر تقييم المستخدم الجديد فوراً
        loadReviews(propertyId: propertyId, isRefresh: true);
      },
    );
  }

  String _mapFailureToMessage(Failure failure) {
    if (failure is NetworkFailure) return AppConstants.networkFailureKey;
    if (failure is ServerFailure) return failure.message ?? AppConstants.unknownFailureKey;
    return AppConstants.unknownFailureKey;
  }
}
// =======================================================
// FILE PATH: lib\presentation\cubits\settings\settings_cubit.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:shared_preferences/shared_preferences.dart';

/// ===========================
/// ----------[states]---------
/// ===========================

/// [SettingsCubit] & [SettingsState]
/// not in work currently the whole code here is nothing but scribble
/// If you are about to fix this screen you can delete everything below
class SettingsState extends Equatable {
  final ThemeMode themeMode;
  final Locale locale;

  const SettingsState({
    this.themeMode = ThemeMode.system,
    this.locale = const Locale('en'),
  });

  @override
  List<Object> get props => [themeMode, locale];

  SettingsState copyWith({
    ThemeMode? themeMode,
    Locale? locale,
  }) {
    return SettingsState(
      themeMode: themeMode ?? this.themeMode,
      locale: locale ?? this.locale,
    );
  }
}

/// ===========================
/// ----------[cubit]----------
/// ===========================

class SettingsCubit extends Cubit<SettingsState> {
  final SharedPreferences _prefs;

  static const String _themeKey = 'theme_mode';
  static const String _languageKey = 'language_code';

  SettingsCubit(this._prefs) : super(const SettingsState()) {
    loadSettings();
  }

  void loadSettings() {
    final themeModeString = _prefs.getString(_themeKey);
    ThemeMode themeMode;
    if (themeModeString == 'light') {
      themeMode = ThemeMode.light;
    } else if (themeModeString == 'dark') {
      themeMode = ThemeMode.dark;
    } else {
      themeMode = ThemeMode.system;
    }

    final languageCode = _prefs.getString(_languageKey) ?? 'ar';

    emit(SettingsState(themeMode: themeMode, locale: Locale(languageCode)));
  }

  void updateThemeMode(ThemeMode newThemeMode) {
    _prefs.setString(_themeKey, newThemeMode.name);

    emit(state.copyWith(themeMode: newThemeMode));
  }

  void updateLanguage(Locale newLocale) {
    _prefs.setString(_languageKey, newLocale.languageCode);

    emit(state.copyWith(locale: newLocale));
  }
}

// =======================================================
// FILE PATH: lib\presentation\cubits\theme\theme_cubit.dart
// =======================================================

import 'package:equatable/equatable.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:shared_preferences/shared_preferences.dart';

import '../../../core/constants/app_constants.dart';

/// ===========================
/// ----------[states]---------
/// ===========================

class ThemeState extends Equatable {
  final ThemeMode themeMode;

  const ThemeState(this.themeMode);

  @override
  List<Object> get props => [themeMode];
}

/// ===========================
/// ----------[cubit]----------
/// ===========================

class ThemeCubit extends Cubit<ThemeState> {
  final SharedPreferences _prefs;

  ThemeCubit(this._prefs) : super(const ThemeState(ThemeMode.system)) {
    _loadTheme();
  }

  void _loadTheme() {
    final savedTheme = _prefs.getString(AppConstants.themeKey);

    if (savedTheme == 'dark') {
      emit(const ThemeState(ThemeMode.dark));
    } else if (savedTheme == 'light') {
      emit(const ThemeState(ThemeMode.light));
    } else {
      emit(const ThemeState(ThemeMode.system));
    }
  }

  Future<void> changeTheme(ThemeMode mode) async {
    if (state.themeMode == mode) return;

    String modeStr = 'system';
    if (mode == ThemeMode.dark) modeStr = 'dark';
    if (mode == ThemeMode.light) modeStr = 'light';

    await _prefs.setString(AppConstants.themeKey, modeStr);
    emit(ThemeState(mode));
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\brand\build_branding.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:lottie/lottie.dart';

import '../../../core/config/color/app_color.dart';
import '../../../l10n/app_localizations.dart';

class BuildBranding extends StatelessWidget implements PreferredSizeWidget {
  final bool meta;
  final LottieBuilder? lottie;
  final bool name;
  final bool logo;
  final double width;
  final double height;
  const BuildBranding({super.key})
      : meta = false,
        lottie = null,
        width = 0,
        height = 0,
        logo = true,
        name = true;

  const BuildBranding.noLogo({super.key})
      : meta = false,
        lottie = null,
        width = 0,
        height = 0,
        logo = false,
        name = true;

  const BuildBranding.noName({super.key})
      : meta = false,
        lottie = null,
        width = 0,
        height = 0,
        logo = true,
        name = false;

  const BuildBranding.metaStyle({super.key})
      : meta = true,
        lottie = null,
        width = 0,
        height = 0,
        logo = false,
        name = false;

  const BuildBranding.nameLottie(
      {super.key,
      required LottieBuilder this.lottie,
      required this.width,
      required this.height})
      : meta = false,
        logo = false,
        name = true;

  const BuildBranding.logoLottie(
      {super.key,
      required LottieBuilder this.lottie,
      required this.width,
      required this.height})
      : meta = false,
        logo = true,
        name = false;

  @override
  Widget build(BuildContext context) {
    if (meta) {
      return _BuildMeta();
    }

    if (lottie == null) {
      if (name && logo) {
        return _BuildNormal();
      }
      if (name) {
        return _BuildNoName();
      }
      if (logo) {
        return _BuildNoLogo();
      }
    }

    if (name) {
      return _BuildNameLottie(lottie!, width, height);
    }

    return _BuildLogoLottie(lottie!, width, height);
  }

  @override
  Size get preferredSize => const Size.fromHeight(kToolbarHeight);
}

class _BuildMeta extends StatelessWidget {
  const _BuildMeta();

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;

    return Align(
      alignment: Alignment.bottomCenter,
      child: Padding(
        padding: const EdgeInsets.only(bottom: 20.0),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              'FROM',
              style: TextStyle(
                fontSize: 14,
                fontWeight: FontWeight.w300,
                color: colorScheme.onSurface,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              'MALAZ',
              style: TextStyle(
                fontSize: 18,
                fontWeight: FontWeight.bold,
                color: colorScheme.primary,
                letterSpacing: 1.5,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _BuildNormal extends StatelessWidget {
  const _BuildNormal();
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    final colorScheme = Theme.of(context).colorScheme;
    return Row(mainAxisAlignment: MainAxisAlignment.center, children: [
      ShaderMask(
        shaderCallback: (bounds) =>
            AppColors.premiumGoldGradient.createShader(bounds),
        child: Text(l10n.malaz,
            style: const TextStyle(
                color: Colors.white,
                fontSize: 40,
                fontWeight: FontWeight.bold)),
      ),
      const SizedBox(width: 10),
      SizedBox(
          height: 60,
          width: 50,
          child: Image.asset("assets/icons/key_logo.png",
              color: colorScheme.primary)),
    ]);
  }
}

class _BuildNoName extends StatelessWidget {
  const _BuildNoName();
  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    return SizedBox(
        height: 60,
        width: 50,
        child: Image.asset("assets/icons/key_logo.png",
            color: colorScheme.primary));
  }
}

class _BuildNoLogo extends StatelessWidget {
  const _BuildNoLogo();
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return ShaderMask(
      shaderCallback: (bounds) =>
          AppColors.premiumGoldGradient.createShader(bounds),
      child: Text(l10n.malaz,
          style: const TextStyle(
              color: Colors.white, fontSize: 40, fontWeight: FontWeight.bold)),
    );
  }
}

class _BuildNameLottie extends StatelessWidget {
  final LottieBuilder lottie;
  final double width;
  final double height;
  const _BuildNameLottie(this.lottie, this.width, this.height);

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Row(mainAxisAlignment: MainAxisAlignment.center, children: [
      ShaderMask(
        shaderCallback: (bounds) =>
            AppColors.premiumGoldGradient.createShader(bounds),
        child: Text(l10n.malaz,
            style: const TextStyle(
                color: Colors.white,
                fontSize: 40,
                fontWeight: FontWeight.bold)),
      ),
      SizedBox(height: height, width: width, child: lottie),
    ]);
  }
}

class _BuildLogoLottie extends StatelessWidget {
  final LottieBuilder lottie;
  final double width;
  final double height;
  const _BuildLogoLottie(this.lottie, this.width, this.height);

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    return Row(mainAxisAlignment: MainAxisAlignment.center, children: [
      SizedBox(
          height: height,
          width: width,
          child: Image.asset(
              "assets/icons/key_logo.png",
              color: colorScheme.primary
          )
      ),
      const SizedBox(width: 1),
      SizedBox(height: 75, width: 100, child: lottie),
    ]);
  }
}

// =======================================================
// FILE PATH: lib\presentation\global_widgets\buttons\animated_heart_button.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/domain/entities/apartment/apartment.dart';
import 'package:path/path.dart';
import '../../cubits/favorites/favorites_cubit.dart';

class AnimatedHeartButton extends StatefulWidget {
  bool isFavorite;
  Apartment apartment;
  final VoidCallback onTap;
  final double size;

  AnimatedHeartButton({
    super.key,
    required this.isFavorite,
    required this.apartment,
    required this.onTap,
    this.size = 24,
  });

  @override
  State<AnimatedHeartButton> createState() => _AnimatedHeartButtonState();
}

class _AnimatedHeartButtonState extends State<AnimatedHeartButton> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 150),
    );

    _scaleAnimation = Tween<double>(begin: 1.0, end: 0.8).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOut),
    );
  }

  @override
  void didUpdateWidget(covariant AnimatedHeartButton oldWidget) {
    super.didUpdateWidget(oldWidget);
    if (widget.isFavorite != oldWidget.isFavorite) {
      _triggerAnimation();
    }
  }

  void _triggerAnimation() {
    _controller.forward().then((_) => _controller.reverse());
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: () {
        _triggerAnimation();
        widget.onTap();
        setState(() {
          widget.isFavorite = context.read<FavoritesCubit>().isFavorite(widget.apartment.id);
        });
      },
      child: ScaleTransition(
        scale: _scaleAnimation,
        child: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: Colors.white.withOpacity(0.2),
            shape: BoxShape.circle,
            border: Border.all(
              color: Colors.white.withOpacity(0.3),
              width: 1,
            ),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.1),
                blurRadius: 4,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: Icon(
            widget.isFavorite ? Icons.favorite_rounded : Icons.favorite_border_rounded,
            color: widget.isFavorite ? Colors.red : Colors.white,
            size: widget.size,
          ),
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\buttons\custom_button.dart
// =======================================================

import 'package:flutter/material.dart';
import '../../../core/config/color/app_color.dart';

class CustomButton extends StatelessWidget {
  final String text;
  final VoidCallback? onPressed;
  final bool isOutline;

  const CustomButton({
    Key? key,
    required this.text,
    this.onPressed,
    this.isOutline = false,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final colorScheme = theme.colorScheme;
    final isDeactivated = onPressed == null;

    return AnimatedContainer(
      duration: const Duration(milliseconds: 200),
      width: double.infinity,
      height: 58,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        border: isOutline ? Border.all(color: const Color(0xFFD4AF37).withOpacity(0.5), width: 1.5) : null,
        gradient: isOutline || isDeactivated ? null : AppColors.premiumGoldGradient2,
        color: isOutline ? Colors.transparent : (isDeactivated ? Colors.grey.shade300 : null),
        boxShadow: isDeactivated || isOutline ? [] : [
           BoxShadow(
             color: const Color(0xFFD4AF37).withOpacity(0.3),
             blurRadius: 15,
             offset: const Offset(0, 8),
             spreadRadius: -2,
           ),
        ],
      ),
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: onPressed,
          borderRadius: BorderRadius.circular(18),
          splashColor: Colors.white12,
          child: Center(
            child: Text(
              text,
              style: TextStyle(
                fontSize: 16,
                fontWeight: FontWeight.w700,
                letterSpacing: 1.2,
                color: isOutline ? const Color(0xFFD4AF37) : (isDeactivated ? Colors.grey.shade600 : Colors.white),
                shadows: isOutline || isDeactivated ? [] : [
                   const Shadow(
                     color: Colors.black26,
                     offset: Offset(0, 1),
                     blurRadius: 2,
                   )
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\global_widgets\cards\apartment\apartment_card.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/l10n/app_localizations.dart';
import 'package:malaz/presentation/global_widgets/buttons/animated_heart_button.dart';
import '../../../../domain/entities/apartment/apartment.dart';
import '../../../cubits/favorites/favorites_cubit.dart';

/// ============================================================================
/// [ApartmentCard]
/// A modern, high-end card widget that displays property summary.
///
/// * [Features]:
/// - Hero Animation for seamless transitions.
/// - Image Slider (Simulated using PageView).
/// - Floating Rating Badge.
/// - Clean Typography utilizing the app theme.
/// ============================================================================
class ApartmentCard extends StatelessWidget {
  final Apartment apartment;
  final VoidCallback onTap;

  const ApartmentCard({
    super.key,
    required this.apartment,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20,vertical: 10),
      child: Container(
        margin: const EdgeInsets.only(bottom: 24),
        decoration: BoxDecoration(
          color: Theme.of(context).cardColor,
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.05),
              blurRadius: 20,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(24),
          child: Material(
            color: Colors.transparent,
            child: InkWell(
              onTap: onTap,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _BuildCardImageArea(apartment: apartment),

                  _BuildCardDetails(apartment: apartment),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

/// [_BuildCardImageArea]
/// Handles the top part of the card: The Image Slider and the Overlay Badges.
class _BuildCardImageArea extends StatefulWidget {
  final Apartment apartment;

  const _BuildCardImageArea({required this.apartment});

  @override
  State<_BuildCardImageArea> createState() => _BuildCardImageAreaState();
}

class _BuildCardImageAreaState extends State<_BuildCardImageArea> {
  final PageController _pageController = PageController();
  int _currentPage = 0;

  @override
  Widget build(BuildContext context) {
    final List<String> images = [
      widget.apartment.mainImageUrl,
      widget.apartment.mainImageUrl,
      widget.apartment.mainImageUrl,
    ];

    return Stack(
      children: [
        SizedBox(
          height: 400,
          width: double.infinity,
          child: Hero(
            tag: 'apartment_image_${widget.apartment.id}',
            child: PageView.builder(
              controller: _pageController,
              itemCount: images.length,
              onPageChanged: (index) {
                setState(() => _currentPage = index);
              },
              itemBuilder: (context, index) {
                return Image.network(
                  images[index],
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) =>
                      Container(color: Colors.grey[300], child: const Icon(Icons.error)),
                );
              },
            ),
          ),
        ),

        Positioned(
          top: 16,
          left: 16,
          child: _BuildRatingBadge(rating: widget.apartment.rating),
        ),

        Positioned(
          top: 16,
          right: 16,
          child: _BuildFavoriteIcon(apartment: widget.apartment),
        ),

        Positioned(
          bottom: 12,
          left: 0,
          right: 0,
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: List.generate(
              images.length,
                  (index) => AnimatedContainer(
                duration: const Duration(milliseconds: 300),
                margin: const EdgeInsets.symmetric(horizontal: 4),
                height: 6,
                width: _currentPage == index ? 20 : 6,
                decoration: BoxDecoration(
                  color: _currentPage == index ? Colors.white : Colors.white.withOpacity(0.5),
                  borderRadius: BorderRadius.circular(3),
                ),
              ),
            ),
          ),
        ),
      ],
    );
  }
}

/// [_BuildCardDetails]
/// Displays the textual information below the image.
class _BuildCardDetails extends StatelessWidget {
  final Apartment apartment;

  const _BuildCardDetails({required this.apartment});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Expanded(
                child: Text(
                  apartment.title,
                  style: theme.textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.bold,
                  ),
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                ),
              ),
              if (apartment.status == 'approved')
                const Icon(Icons.verified, size: 16, color: Colors.blue),
            ],
          ),
          const SizedBox(height: 8),

          Row(
            children: [
              Icon(Icons.location_on, size: 14, color: theme.colorScheme.secondary),
              const SizedBox(width: 4),
              Expanded(
                child: Text(
                  '${apartment.city}, ${apartment.address}',
                  style: theme.textTheme.bodyMedium?.copyWith(
                    color: theme.colorScheme.onSurface.withOpacity(0.6),
                  ),
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),

          Divider(color: Colors.grey.withOpacity(0.1)),
          const SizedBox(height: 12),

          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              RichText(
                text: TextSpan(
                  children: [
                    TextSpan(
                      text: '\$${apartment.price}',
                      style: theme.textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.bold,
                        color: theme.colorScheme.primary,
                      ),
                    ),
                    TextSpan(
                      text: ' / ${AppLocalizations.of(context).month}',
                      style: theme.textTheme.bodySmall?.copyWith(
                        color: theme.colorScheme.onSurface.withOpacity(0.6),
                      ),
                    ),
                  ],
                ),
              ),

              Row(
                children: [
                  _BuildMiniAmenity(icon: Icons.bed, text: '${apartment.bedrooms}'),
                  const SizedBox(width: 8),
                  _BuildMiniAmenity(icon: Icons.bathtub, text: '${apartment.bathrooms}'),
                  const SizedBox(width: 8),
                  _BuildMiniAmenity(icon: Icons.square_foot, text: '${apartment.area} m²'),
                ],
              ),
            ],
          ),
        ],
      ),
    );
  }
}

/// [_BuildRatingBadge]
/// A blurry glass-effect badge for rating.
class _BuildRatingBadge extends StatelessWidget {
  final num rating;

  const _BuildRatingBadge({required this.rating});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: Colors.black.withOpacity(0.6),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withOpacity(0.2)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          const Icon(Icons.star, color: Colors.amber, size: 14),
          const SizedBox(width: 4),
          Text(
            rating > 0 ? rating.toString() : AppLocalizations.of(context).new_,
            style: const TextStyle(
              color: Colors.white,
              fontSize: 12,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }
}

/// [_BuildFavoriteIcon]
/// A dedicated widget for the favorite button on the card.
class _BuildFavoriteIcon extends StatelessWidget {
  final Apartment apartment;

  const _BuildFavoriteIcon({required this.apartment});

  @override
  Widget build(BuildContext context) {
    bool isFav = context.read<FavoritesCubit>().isFavorite(apartment.id);
    return AnimatedHeartButton(isFavorite: isFav,apartment: apartment, onTap: () {
      context.read<FavoritesCubit>().toggleFavorite(apartment);
    });
  }
}

/// [_BuildMiniAmenity]
/// Small icon and text for quick info (Bed/Bath).
class _BuildMiniAmenity extends StatelessWidget {
  final IconData icon;
  final String text;

  const _BuildMiniAmenity({required this.icon, required this.text});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Row(
      children: [
        Icon(icon, size: 16, color: theme.colorScheme.tertiary),
        const SizedBox(width: 4),
        Text(
          text,
          style: theme.textTheme.bodySmall?.copyWith(fontWeight: FontWeight.w600),
        ),
      ],
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\cards\apartment\apartment_shimmer_card.dart
// =======================================================

import 'package:flutter/material.dart';

const Color _placeholderColor = Colors.white;

/// ============================================================================
/// [BuildShimmerCard]
/// A high-fidelity skeleton loading widget.
///
/// * [Fix]: The main container background is removed so the shimmer effect
/// applies only to the inner shapes (text lines, image box), creating a proper skeleton.
/// ============================================================================
class BuildShimmerCard extends StatelessWidget {
  const BuildShimmerCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20,vertical: 10),
      child: Container(
        margin: const EdgeInsets.only(bottom: 24),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(24),
        ),
        child: const Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _BuildShimmerImageArea(),

            SizedBox(height: 16),

            _BuildShimmerDetailsArea(),

            SizedBox(height: 16),
          ],
        ),
      ),
    );
  }
}

/// ============================================================================
/// [SUB-WIDGETS]
/// Breakdown of the Shimmer Card components
/// ============================================================================

/// [_BuildShimmerImageArea]
/// Represents the large image placeholder.
class _BuildShimmerImageArea extends StatelessWidget {
  const _BuildShimmerImageArea();

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 400,
      width: double.infinity,
      decoration: BoxDecoration(
        color: _placeholderColor,
        borderRadius: BorderRadius.circular(24),
      ),
      child: Stack(
        children: [
          Positioned(
            top: 16,
            left: 16,
            child: Container(
              width: 60,
              height: 24,
              decoration: BoxDecoration(
                color: _placeholderColor,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.grey[100]!, width: 1),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/// [_BuildShimmerDetailsArea]
/// Container for Title, Location, and Footer rows.
class _BuildShimmerDetailsArea extends StatelessWidget {
  const _BuildShimmerDetailsArea();

  @override
  Widget build(BuildContext context) {
    return const Padding(
      padding: EdgeInsets.symmetric(horizontal: 16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _BuildShimmerTitleRow(),
          SizedBox(height: 8),
          _BuildShimmerLocationRow(),
          SizedBox(height: 16),
          Divider(color: _placeholderColor, thickness: 1),
          SizedBox(height: 12),
          _BuildShimmerBottomRow(),
        ],
      ),
    );
  }
}

/// [_BuildShimmerTitleRow]
/// Placeholder for Title + Verification Badge.
class _BuildShimmerTitleRow extends StatelessWidget {
  const _BuildShimmerTitleRow();

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        Expanded(
          child: Container(
            height: 20,
            decoration: BoxDecoration(
              color: _placeholderColor,
              borderRadius: BorderRadius.circular(8),
            ),
          ),
        ),
        const SizedBox(width: 16),
        Container(
          width: 16,
          height: 16,
          decoration: const BoxDecoration(
            color: _placeholderColor,
            shape: BoxShape.circle,
          ),
        ),
      ],
    );
  }
}

/// [_BuildShimmerLocationRow]
/// Placeholder for Location Icon + Address Text.
class _BuildShimmerLocationRow extends StatelessWidget {
  const _BuildShimmerLocationRow();

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Container(
          width: 14,
          height: 14,
          decoration: const BoxDecoration(
            color: _placeholderColor,
            shape: BoxShape.circle,
          ),
        ),
        const SizedBox(width: 4),
        Container(
          height: 14,
          width: 150,
          decoration: BoxDecoration(
            color: _placeholderColor,
            borderRadius: BorderRadius.circular(8),
          ),
        ),
      ],
    );
  }
}

/// [_BuildShimmerBottomRow]
/// Placeholder for Price Column + Amenities Row.
class _BuildShimmerBottomRow extends StatelessWidget {
  const _BuildShimmerBottomRow();

  @override
  Widget build(BuildContext context) {
    return const Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        _BuildShimmerPriceColumn(),

        _BuildShimmerAmenitiesRow(),
      ],
    );
  }
}

/// [_BuildShimmerPriceColumn]
/// Helper for the price part.
class _BuildShimmerPriceColumn extends StatelessWidget {
  const _BuildShimmerPriceColumn();

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          height: 24,
          width: 80,
          decoration: BoxDecoration(
            color: _placeholderColor,
            borderRadius: BorderRadius.circular(8),
          ),
        ),
        const SizedBox(height: 4),
        Container(
          height: 10,
          width: 40,
          decoration: BoxDecoration(
            color: _placeholderColor,
            borderRadius: BorderRadius.circular(4),
          ),
        ),
      ],
    );
  }
}

/// [_BuildShimmerAmenitiesRow]
/// Helper for the list of amenities.
class _BuildShimmerAmenitiesRow extends StatelessWidget {
  const _BuildShimmerAmenitiesRow();

  @override
  Widget build(BuildContext context) {
    return const Row(
      children: [
        _BuildAmenityShimmerItem(),
        SizedBox(width: 12),
        _BuildAmenityShimmerItem(),
        SizedBox(width: 12),
        _BuildAmenityShimmerItem(),
      ],
    );
  }
}

/// [_BuildAmenityShimmerItem]
/// Represents a single amenity (Icon Circle + Text Line).
class _BuildAmenityShimmerItem extends StatelessWidget {
  const _BuildAmenityShimmerItem();

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Container(
          width: 16,
          height: 16,
          decoration: const BoxDecoration(
            color: _placeholderColor,
            shape: BoxShape.circle,
          ),
        ),
        const SizedBox(width: 4),
        Container(
          height: 12,
          width: 20,
          decoration: BoxDecoration(
            color: _placeholderColor,
            borderRadius: BorderRadius.circular(4),
          ),
        ),
      ],
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\cards\review\review_card.dart
// =======================================================


import 'package:flutter/material.dart';
import 'package:malaz/core/config/color/app_color.dart';

import '../../../../domain/entities/review/review.dart';

class ReviewCard extends StatelessWidget {
  final Review review;

  const ReviewCard({super.key, required this.review});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Container(
      margin: const EdgeInsets.only(bottom: 16),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: theme.cardColor,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.withOpacity(0.1)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.03),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              CircleAvatar(
                radius: 20,
                backgroundColor: AppColors.primaryLight.withOpacity(0.2),
                backgroundImage: review.userImage.isNotEmpty
                    ? NetworkImage(review.userImage)
                    : null,
                child: review.userImage.isEmpty
                    ? Text(review.userName[0], style: TextStyle(color: AppColors.primaryDark))
                    : null,
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      review.userName,
                      style: theme.textTheme.bodyMedium?.copyWith(
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    Text(
                      review.createdAt.split('T')[0],
                      style: theme.textTheme.labelSmall?.copyWith(
                        color: Colors.grey,
                      ),
                    ),
                  ],
                ),
              ),
              _BuildRatingStars(rating: review.rating),
            ],
          ),

          const SizedBox(height: 12),

          Text(
            review.body,
            style: theme.textTheme.bodyMedium?.copyWith(height: 1.5),
          ),
        ],
      ),
    );
  }
}

class _BuildRatingStars extends StatelessWidget {
  final int rating;
  const _BuildRatingStars({required this.rating});

  @override
  Widget build(BuildContext context) {
    return Row(
      children: List.generate(5, (index) {
        return Icon(
          index < rating ? Icons.star_rounded : Icons.star_border_rounded,
          color: AppColors.primaryDark,
          size: 18,
        );
      }),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\cards\review\review_shimmer_card.dart
// =======================================================

import 'package:flutter/material.dart';

class ReviewShimmerCard extends StatelessWidget {
  const ReviewShimmerCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.transparent,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.withOpacity(0.1)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 40,
                height: 40,
                decoration: const BoxDecoration(
                  color: Colors.white,
                  shape: BoxShape.circle,
                ),
              ),

              const SizedBox(width: 12),

              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      width: 120,
                      height: 14,
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(4),
                      ),
                    ),
                    const SizedBox(height: 6),
                    Container(
                      width: 80,
                      height: 10,
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(4),
                      ),
                    ),
                  ],
                ),
              ),

              Row(
                children: List.generate(5, (index) => Container(
                  margin: const EdgeInsets.only(left: 2),
                  width: 14,
                  height: 14,
                  decoration: BoxDecoration(
                    color: Colors.white, // لون للنجوم
                    borderRadius: BorderRadius.circular(2),
                  ),
                )),
              )
            ],
          ),

          const SizedBox(height: 16),

          Container(
            width: double.infinity,
            height: 12,
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(4),
            ),
          ),
          const SizedBox(height: 8),
          Container(
            width: MediaQuery.of(context).size.width * 0.7,
            height: 12,
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(4),
            ),
          ),
          const SizedBox(height: 8),
          Container(
            width: MediaQuery.of(context).size.width * 0.4,
            height: 12,
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(4),
            ),
          ),
        ],
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\error_view_screen.dart
// =======================================================

import 'package:flutter/material.dart';

import '../../core/constants/app_constants.dart';
import '../../l10n/app_localizations.dart';

class BuildErrorView extends StatelessWidget {
  final String message;
  final VoidCallback onRetry;

  const BuildErrorView({super.key, required this.message, required this.onRetry});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    String displayMessage = message;

    if (message == AppConstants.networkFailureKey) {
      displayMessage = AppLocalizations.of(context).network_error_message;
    } else if (message == AppConstants.cancelledFailureKey) {
      displayMessage =
          AppLocalizations.of(context).request_cancelled_error_message;
    } else {
      displayMessage = AppLocalizations.of(context).unexpected_error_message;
    }

    return Center(
      child: SingleChildScrollView(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                color: theme.colorScheme.error.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.cloud_off_rounded,
                size: 64,
                color: theme.colorScheme.error,
              ),
            ),
            const SizedBox(height: 24),
            Text(
              AppLocalizations.of(context).warring,
              style: theme.textTheme.headlineMedium?.copyWith(
                fontWeight: FontWeight.bold,
                color: theme.colorScheme.onSurface,
              ),
            ),
            const SizedBox(height: 12),
            Text(
              displayMessage,
              textAlign: TextAlign.center,
              style: theme.textTheme.bodyLarge?.copyWith(
                color: theme.colorScheme.onSurface.withOpacity(0.7),
                height: 1.5,
              ),
            ),
            const SizedBox(height: 32),
            SizedBox(
              width: 200,
              height: 54,
              child: ElevatedButton.icon(
                onPressed: onRetry,
                style: ElevatedButton.styleFrom(
                  backgroundColor: theme.colorScheme.primary,
                  foregroundColor: theme.colorScheme.onPrimary,
                  elevation: 4,
                  shadowColor: theme.colorScheme.primary.withOpacity(0.4),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                icon: const Icon(Icons.refresh_rounded),
                label: Text(
                  AppLocalizations.of(context).retry,
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\global_widgets\glowing_key\build_glowing_key.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:malaz/core/constants/app_constants.dart';

import '../../../core/config/color/app_color.dart';

class BuildGlowingKey extends StatelessWidget {
  final double size, opacity, rotation;
  final Color? color, shadowColor;
  const BuildGlowingKey({super.key, required this.size, required this.opacity, required this.rotation, this.color = Colors.white, this.shadowColor = AppColors.primaryLight});

  @override
  Widget build(BuildContext context) {
    return Opacity(
      opacity: opacity,
      child: Transform.rotate(
        angle: rotation,
        child: Container(
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                color: shadowColor?.withOpacity(0.4) ?? Colors.white,
                blurRadius: 40,
                spreadRadius: 10,
              ),
            ],
          ),
          child: Image.asset(
            AppConstants.LogoPath,
            width: size,
            height: size,
            color: color ?? Colors.white,
            colorBlendMode: BlendMode.srcIn,
          ),
        ),
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\global_widgets\user_profile_image\user_profile_image.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';
import '../../../core/constants/app_constants.dart';
import '../../../core/service_locator/service_locator.dart';
import '../../../data/datasources/local/auth/auth_local_data_source.dart';
import '../../../core/config/color/app_color.dart';

class UserProfileImage extends StatelessWidget {
  final int userId;
  final double radius;
  final String? firstName;
  final String? lastName;
  final bool isPremiumStyle;

  const UserProfileImage({
    super.key,
    required this.userId,
    this.firstName,
    this.lastName,
    this.radius = 35,
    this.isPremiumStyle = true,
  });

  Future<Map<String, String>> _getHeaders() async {
    final authLocal = sl<AuthLocalDatasource>();
    final token = await authLocal.getCachedToken();
    return {
      'Authorization': 'Bearer $token',
      'Accept': 'application/json',
    };
  }

  String _getInitials() {
    final String f = (firstName != null && firstName!.isNotEmpty) ? firstName![0].toUpperCase() : '';
    final String l = (lastName != null && lastName!.isNotEmpty) ? lastName![0].toUpperCase() : '';
    return '$f$l';
  }

  Widget _buildInitialsPlaceholder() {
    final initials = _getInitials();
    return Container(
      width: radius * 2,
      height: radius * 2,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(radius * 0.6), // Squircle
        gradient: AppColors.premiumGoldGradient,
      ),
      alignment: Alignment.center,
      child: initials.isEmpty
          ? Icon(Icons.person, color: Colors.white, size: radius)
          : Text(
        initials,
        style: TextStyle(
          color: Colors.white,
          fontWeight: FontWeight.w900,
          fontSize: radius * 0.7,
        ),
      ),
    );
  }

  Widget _buildShimmerLoading(bool isDark) {
    return Shimmer.fromColors(
      baseColor: isDark ? Colors.grey[800]! : Colors.grey[300]!,
      highlightColor: isDark ? Colors.grey[700]! : Colors.grey[100]!,
      child: Container(
        width: radius * 2,
        height: radius * 2,
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(radius * 0.6),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final String url = AppConstants.userProfileImage(userId);
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      padding: isPremiumStyle ? const EdgeInsets.all(2) : EdgeInsets.zero,
      decoration: BoxDecoration(
        gradient: isPremiumStyle ? AppColors.premiumGoldGradient : null,
        borderRadius: BorderRadius.circular(radius * 0.7),
      ),
      child: Container(
        padding: isPremiumStyle ? const EdgeInsets.all(2) : EdgeInsets.zero,
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          borderRadius: BorderRadius.circular(radius * 0.65),
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(radius * 0.6),
          child: FutureBuilder<Map<String, String>>(
            future: _getHeaders(),
            builder: (context, snapshot) {
              if (!snapshot.hasData) return _buildShimmerLoading(isDark);

              return Image.network(
                url,
                headers: snapshot.data,
                width: radius * 2,
                height: radius * 2,
                fit: BoxFit.cover,
                loadingBuilder: (context, child, loadingProgress) {
                  if (loadingProgress == null) return child;
                  return _buildShimmerLoading(isDark);
                },
                errorBuilder: (context, error, stackTrace) => _buildInitialsPlaceholder(),
              );
            },
          ),
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\auth\login\login_screen.dart
// =======================================================

import 'dart:ui';

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:malaz/presentation/global_widgets/brand/build_branding.dart';
import 'package:modal_progress_hud_nsn/modal_progress_hud_nsn.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../cubits/auth/auth_cubit.dart';
import '../../../global_widgets/brand/build_branding.dart';
import '../../../global_widgets/buttons/custom_button.dart';
import '../shared_widgets/shared_widgets.dart';

class LoginScreen extends StatefulWidget {
  GlobalKey<FormState> formKey;
  LoginScreen({super.key, required this.formKey});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _phoneController = TextEditingController();
  final _passwordController = TextEditingController();

  @override
  void dispose() {
    _phoneController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: BlocConsumer<AuthCubit, AuthState>(
        listener: (context, state) {
          if (state is AuthPending) {
            context.go('/pending');
          }
          if (state is AuthAuthenticated) {
            context.go('/home');
          }
          if (state is AuthError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                  content: Text(state.message), backgroundColor: Colors.red),
            );
          }
        },
        builder: (context, state) {
          final isLoading = state is AuthLoading;

          return ModalProgressHUD(
            color: Colors.white,
            inAsyncCall: isLoading,
            child: SingleChildScrollView(
              child: SafeArea(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 24),
                  child: Form(
                    key: widget.formKey,
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const SizedBox(
                          height: 25,
                        ),

                        // Logo
                        Center(
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(24),
                            child: BackdropFilter(
                              filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                              child: Container(
                                padding: const EdgeInsets.all(10),
                                decoration: BoxDecoration(
                                  color: colorScheme.primary.withOpacity(0.05),
                                  borderRadius: BorderRadius.circular(24),
                                  border: Border.all(color: colorScheme.primary.withOpacity(0.1)),
                                ),
                                child: Image.asset('assets/icons/key_logo.png', width: 65, color: colorScheme.primary),
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(
                          height: 24,
                        ),

                        // Text headers
                        Column(
                          children: [
                            Text(
                              tr.welcome_back,
                              style: TextStyle(
                                fontSize: 30,
                                fontWeight: FontWeight.bold,
                                color: colorScheme.primary,
                                letterSpacing: -1,
                              ),
                            ),
                            const SizedBox(height: 8),
                            Text(
                              tr.login_to_continue,
                              style: TextStyle(
                                color: colorScheme.onSurface.withOpacity(0.6),
                                fontSize: 14,
                                letterSpacing: 0.5,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(
                          height: 70,
                        ),

                        // Mobile number Text field
                        BuildTextfield(
                          label: tr.mobile_number,
                          hintText: tr.phone_number_hint,
                          icon: Icons.phone,
                          obscure: false,
                          haveSuffixEyeIcon: false,
                          formKey: widget.formKey,
                          keyboardType: TextInputType.phone,
                          controller:_phoneController,
                        ),

                        // Password Text field
                        BuildTextfield(
                          label: tr.password,
                          hintText: "${tr.enter_hint} ${tr.password}",
                          icon: Icons.password,
                          obscure: true,
                          haveSuffixEyeIcon: true,
                          formKey: widget.formKey,
                          controller: _passwordController,
                        ),
                        const SizedBox(
                          height: 70,
                        ),

                        // Login Button
                        CustomButton(
                          text: tr.login,
                          onPressed: isLoading ? null : () {
                             if (widget.formKey.currentState?.validate() ?? false) {
                               context.read<AuthCubit>().login(
                                     phone: _phoneController.text.trim(),
                                     password: _passwordController.text.trim(),
                               );
                             }
                          },
                        ),
                        const SizedBox(
                          height: 12,
                        ),

                        // To Go to Register pages (home_register_screen.dart)
                        const BuildRegisterRow(),
                        const SizedBox(
                          height: 70,
                        ),

                        // Branding
                        BuildBranding.metaStyle()
                      ],
                    ),
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\auth\my_profile\screen\my_profile_screen.dart
// =======================================================

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';

import '../../../../../core/config/color/app_color.dart';
import '../../../../../l10n/app_localizations.dart';
import '../../../../cubits/auth/auth_cubit.dart';
import '../../../../cubits/location/location_cubit.dart';
import '../../../../global_widgets/glowing_key/build_glowing_key.dart';
import '../../../../global_widgets/user_profile_image/user_profile_image.dart';

class MyProfileScreen extends StatefulWidget {
  const MyProfileScreen({super.key});

  @override
  State<MyProfileScreen> createState() => _MyProfileScreenState();
}

class _MyProfileScreenState extends State<MyProfileScreen> {
  late TextEditingController _firstNameController;
  late TextEditingController _lastNameController;
  bool _isEditable = false;
  String? _tempLocalImagePath;

  @override
  void initState() {
    super.initState();
    _firstNameController = TextEditingController();
    _lastNameController = TextEditingController();

    final state = context.read<AuthCubit>().state;
    if (state is AuthAuthenticated) {
      _firstNameController.text = state.user.first_name;
      _lastNameController.text = state.user.last_name;
    }

    context.read<LocationCubit>().loadSavedLocation();
  }

  @override
  void dispose() {
    _firstNameController.dispose();
    _lastNameController.dispose();
    super.dispose();
  }

  Future<void> _handleLocationUpdate() async {
    HapticFeedback.mediumImpact();
    final lang = Localizations.localeOf(context).languageCode;
    await context.read<LocationCubit>().getCurrentLocation(lang);
  }

  Future<void> _pickImage() async {
    final ImagePicker picker = ImagePicker();
    final XFile? image = await picker.pickImage(source: ImageSource.gallery);
    if (image != null) {
      setState(() => _tempLocalImagePath = image.path);
    }
  }

  void _requestEditProfile(BuildContext context) {
    HapticFeedback.lightImpact();
    _showModernPasswordDialog(context);
  }

  Future<void> _saveProfileChanges(dynamic user) async {
    HapticFeedback.mediumImpact();
    await context.read<AuthCubit>().updateUserData(
      firstName: _firstNameController.text,
      lastName: _lastNameController.text,
      imagePath: _tempLocalImagePath,
      existingImageUrl: user.profile_image_url,
    );
    setState(() {
      _isEditable = false;
      _tempLocalImagePath = null;
    });
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: colorScheme.background,
      body: BlocBuilder<AuthCubit, AuthState>(
        builder: (context, state) {
          dynamic currentUser = (state is AuthAuthenticated) ? state.user : null;

          return CustomScrollView(
            physics: const BouncingScrollPhysics(),
            slivers: [
              _buildAppBar(tr, colorScheme, currentUser),
              SliverToBoxAdapter(
                child: Transform.translate(
                  offset: const Offset(0, -25),
                  child: _buildMainContainer(tr, colorScheme, state),
                ),
              ),
            ],
          );
        },
      ),
    );
  }

  Widget _buildAppBar(AppLocalizations tr, ColorScheme colorScheme, dynamic user) {
    return SliverAppBar(
      expandedHeight: 280,
      pinned: true,
      stretch: true,
      elevation: 0,
      backgroundColor: Colors.transparent,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(
          bottom: Radius.circular(40),
        ),
      ),
      leading: IconButton(
        icon: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), shape: BoxShape.circle),
          child: Icon(Icons.arrow_back, color: colorScheme.surface, size: 18),
        ),
        onPressed: () => context.go('/home'),
      ),
      actions: [
        if (_isEditable)
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 10),
            child: ElevatedButton(
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.white,
                foregroundColor: AppColors.primaryLight,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
              ),
              onPressed: () => _saveProfileChanges(user),
              child: Text(tr.done, style: const TextStyle(fontWeight: FontWeight.w900)),
            ),
          ),
      ],
      flexibleSpace: FlexibleSpaceBar(
        stretchModes: const [
          StretchMode.zoomBackground,
          StretchMode.blurBackground,
        ],
        background: ClipRRect(
          borderRadius: const BorderRadius.vertical(bottom: Radius.circular(40)),
          child: Stack(
            fit: StackFit.expand,
            children: [
              Container(
                decoration: const BoxDecoration(
                    gradient: AppColors.premiumGoldGradient2
                ),
              ),

              PositionedDirectional(
                top: -20,
                start: -40,
                child: const BuildGlowingKey(size: 180,opacity:  0.15,rotation: -0.2),
              ),

              PositionedDirectional(
                bottom: 40,
                end: -10,
                child: const BuildGlowingKey(size: 140,opacity: 0.12,rotation: 0.5),
              ),

              PositionedDirectional(
                top: 40,
                end: 80,
                child: const BuildGlowingKey(size: 70,opacity:  0.12,rotation: 2.5),
              ),

              Padding(
                padding: const EdgeInsets.fromLTRB(25, 100, 25, 40),
                child: Row(
                  children: [
                    _buildAvatarWrapper(user?.id, colorScheme),
                    const SizedBox(width: 20),
                    Expanded(child: _buildProfileHeaderInfo(tr, colorScheme)),
                  ],
                ),
              ),
            ],
          ),
        )
      ),
    );
  }

  Widget _buildMainContainer(AppLocalizations tr, ColorScheme colorScheme, AuthState state) {
    return Container(
      decoration: BoxDecoration(
        color: colorScheme.background,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(35)),
        boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, -5))],
      ),
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 30),
      child: Column(
        children: [
          const SizedBox(height: 60),
          _buildProfileActionsBar(colorScheme, tr),
          const SizedBox(height: 40),
          _buildModernInfoCard(colorScheme, tr, state),
          const SizedBox(height: 100),
        ],
      ),
    );
  }

  Widget _buildProfileHeaderInfo(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          "${_firstNameController.text} ${_lastNameController.text}",
          style: TextStyle(fontSize: 26, fontWeight: FontWeight.w900, color: colorScheme.surface),
        ),
        const SizedBox(height: 6),
        BlocBuilder<LocationCubit, LocationState>(
          builder: (context, state) {
            String address = tr.unknown_location;
            if (state is LocationLoading) {
              address = 'Leading...';
            }
            if (state is LocationLoaded) {
              address = state.location.address;
            }
            return Row(
              children: [
                Icon(Icons.location_on, size: 14, color: colorScheme.surface),
                const SizedBox(width: 4),
                Expanded(child: Text(address, style: TextStyle(color: colorScheme.surface, fontSize: 13, fontWeight: FontWeight.bold), overflow: TextOverflow.ellipsis)),
              ],
            );
          },
        ),
        const SizedBox(height: 12),
        _buildBadge(tr.verified_account, colorScheme),
      ],
    );
  }

  Widget _buildAvatarWrapper(int? userId, ColorScheme colorScheme) {
    return Stack(
      alignment: Alignment.center,
      clipBehavior: Clip.none,
      children: [
        _tempLocalImagePath != null
            ? Container(
          width: 96,
          height: 96,
          decoration: BoxDecoration(
            gradient: AppColors.premiumGoldGradient,
            borderRadius: BorderRadius.circular(30),
          ),
          padding: const EdgeInsets.all(3),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(27),
            child: Image.file(
              File(_tempLocalImagePath!),
              fit: BoxFit.cover,
            ),
          ),
        )
            : UserProfileImage(
          userId: userId ?? 0,
          radius: 46,
          isPremiumStyle: true,
          firstName: _firstNameController.text,
          lastName: _lastNameController.text,
        ),

        if (_isEditable)
          Positioned(
            bottom: -5,
            right: -5,
            child: GestureDetector(
              onTap: _pickImage,
              child: Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: colorScheme.surface,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: AppColors.primaryLight, width: 1.5),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.1),
                      blurRadius: 8,
                      offset: const Offset(0, 4),
                    )
                  ],
                ),
                child: const Icon(
                  Icons.camera_alt_rounded,
                  size: 18,
                  color: AppColors.primaryDark,
                ),
              ),
            ),
          ),
      ],
    );
  }

  Widget _buildProfileActionsBar(ColorScheme colorScheme, AppLocalizations tr) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 8),
      decoration: BoxDecoration(
        color: colorScheme.surface,
        borderRadius: BorderRadius.circular(20),
        border: Border.all(
          color: isDark ? Colors.white10 : Colors.black.withOpacity(0.05),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(isDark ? 0.2 : 0.05),
            blurRadius: 30,
            offset: const Offset(0, 10),
          )
        ],
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceAround,
        children: [
          _actionItem(Icons.bookmark_border_rounded, tr.favorites, () => context.push('/favorites'), colorScheme),
          _vDivider(),
          _actionItem(Icons.map_outlined, tr.location, _handleLocationUpdate, colorScheme),
          _vDivider(),
          _actionItem(Icons.verified_user_outlined, tr.edit_profile, () => _requestEditProfile(context), colorScheme, isPrimary: true),
        ],
      ),
    );
  }

  Widget _buildModernInfoCard(ColorScheme colorScheme, AppLocalizations tr, AuthState state) {
    return Column(
      children: [
        _buildInfoField(Icons.person_rounded, tr.first_name, _firstNameController, colorScheme),
        const SizedBox(height: 12),
        _buildInfoField(Icons.badge_rounded, tr.last_name, _lastNameController, colorScheme),
        const SizedBox(height: 12),
        _buildPasswordField(tr, colorScheme, state),
      ],
    );
  }

  Widget _buildInfoField(IconData icon, String label, TextEditingController controller, ColorScheme colorScheme) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return AnimatedContainer(
      duration: const Duration(milliseconds: 300),
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      decoration: BoxDecoration(
        color: colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(isDark ? 0.2 : 0.04),
            blurRadius: 20,
            offset: const Offset(0, 8),
          )
        ],
        border: Border.all(
          color: _isEditable
              ? colorScheme.primary.withOpacity(0.5)
              : (isDark ? Colors.white10 : Colors.black.withOpacity(0.05)),
          width: 1.2,
        ),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: colorScheme.primary.withOpacity(0.12),
              borderRadius: BorderRadius.circular(14),
            ),
            child: Icon(
                icon,
                color: colorScheme.primary,
                size: 22
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  label.toUpperCase(),
                  style: TextStyle(
                    color: colorScheme.primary.withOpacity(0.8),
                    fontSize: 9,
                    fontWeight: FontWeight.w900,
                    letterSpacing: 1.2,
                  ),
                ),
                const SizedBox(height: 2),
                TextField(
                  controller: controller,
                  enabled: _isEditable,
                  cursorColor: colorScheme.primary,
                  style: TextStyle(
                    fontWeight: FontWeight.w700,
                    fontSize: 16,
                    color: colorScheme.onSurface,
                  ),
                  decoration: InputDecoration(
                    border: InputBorder.none,
                    isDense: true,
                    contentPadding: EdgeInsets.zero,
                    hintText: _isEditable ? "Enter $label..." : null,
                    hintStyle: TextStyle(fontSize: 14, fontWeight: FontWeight.normal, color: Colors.grey.withOpacity(0.5)),
                  ),
                ),
              ],
            ),
          ),
          if (_isEditable)
            Icon(Icons.edit_rounded, size: 14, color: colorScheme.primary.withOpacity(0.5)),
        ],
      ),
    );
  }

  Widget _buildPasswordField(AppLocalizations tr, ColorScheme colorScheme, AuthState state) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return InkWell(
      onTap: () => state is AuthAuthenticated
          ? context.push('/reset-password', extra: state.user.phone)
          : null,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        padding: const EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: colorScheme.surface,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isDark ? Colors.white10 : Colors.black.withOpacity(0.05),
            width: 1.2,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(isDark ? 0.2 : 0.04),
              blurRadius: 20,
              offset: const Offset(0, 8),
            )
          ],
        ),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: colorScheme.primary.withOpacity(0.12),
                borderRadius: BorderRadius.circular(14),
              ),
              child: Icon(
                  Icons.lock_outline_rounded,
                  color: colorScheme.primary,
                  size: 22
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    tr.password.toUpperCase(),
                    style: TextStyle(
                      color: colorScheme.primary.withOpacity(0.8),
                      fontSize: 9,
                      fontWeight: FontWeight.w900,
                      letterSpacing: 1.2,
                    ),
                  ),
                  const SizedBox(height: 4),
                  const Text(
                    "••••••••",
                    style: TextStyle(
                      fontWeight: FontWeight.w700,
                      fontSize: 18,
                      letterSpacing: 3,
                    ),
                  ),
                ],
              ),
            ),
            Container(
              padding: const EdgeInsets.all(4),
              decoration: BoxDecoration(
                color: colorScheme.primary.withOpacity(0.05),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.chevron_right_rounded,
                color: colorScheme.primary.withOpacity(0.5),
                size: 20,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildBadge(String text, ColorScheme colorScheme) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
      decoration: BoxDecoration(color: Colors.white10, borderRadius: BorderRadius.circular(20), border: Border.all(color: Colors.white24)),
      child: Row(mainAxisSize: MainAxisSize.min, children: [
        Icon(Icons.verified, size: 12, color: colorScheme.tertiary),
        const SizedBox(width: 5),
        Text(text, style: TextStyle(color: colorScheme.surface, fontSize: 10, fontWeight: FontWeight.bold)),
      ]),
    );
  }

  Widget _actionItem(IconData icon, String label, VoidCallback onTap, ColorScheme colorScheme, {bool isPrimary = false}) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 4),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: isPrimary
                    ? colorScheme.primary.withOpacity(0.15)
                    : colorScheme.primary.withOpacity(0.06),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Icon(
                  icon,
                  color: colorScheme.primary,
                  size: 24
              ),
            ),
            const SizedBox(height: 8),
            Text(
              label.toUpperCase(),
              style: TextStyle(
                fontSize: 9,
                fontWeight: FontWeight.w900,
                letterSpacing: 0.8,
                color: isPrimary ? colorScheme.primary : colorScheme.onSurface.withOpacity(0.7),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _vDivider() => Container(width: 1, height: 30, color: Colors.grey.withOpacity(0.2));

  void _showModernPasswordDialog(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;
    final passwordController = TextEditingController();
    final isDark = Theme.of(context).brightness == Brightness.dark;
    bool isLoading = false;

    showDialog(
      context: context,
      barrierDismissible: true,
      builder: (context) => StatefulBuilder(
        builder: (context, setStateDialog) {
          return AlertDialog(
            backgroundColor: Theme.of(context).scaffoldBackgroundColor,
            surfaceTintColor: Colors.transparent,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(28)),
            contentPadding: const EdgeInsets.fromLTRB(24, 20, 24, 10),
            title: Column(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: colorScheme.primary.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(Icons.lock_person_rounded, color: colorScheme.primary, size: 28),
                ),
                const SizedBox(height: 16),
                Text(
                  tr.identity_verification,
                  textAlign: TextAlign.center,
                  style: TextStyle(fontWeight: FontWeight.w800, fontSize: 20, color: colorScheme.onSurface),
                ),
              ],
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Text(
                  tr.identity_verification_input,
                  textAlign: TextAlign.center,
                  style: TextStyle(fontSize: 14, color: colorScheme.onSurface.withOpacity(0.6)),
                ),
                const SizedBox(height: 24),
                TextField(
                  controller: passwordController,
                  obscureText: true,
                  autofocus: true,
                  decoration: InputDecoration(
                    hintText: tr.current_password,
                    filled: true,
                    fillColor: isDark ? Colors.white.withOpacity(0.05) : Colors.grey.shade100,
                    prefixIcon: Icon(Icons.password_rounded, size: 20, color: colorScheme.primary.withOpacity(0.5)),
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide.none),
                    focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide(color: colorScheme.primary.withOpacity(0.5))),
                  ),
                ),
              ],
            ),
            actionsAlignment: MainAxisAlignment.spaceEvenly,
            actionsPadding: const EdgeInsets.fromLTRB(15, 0, 15, 20),
            actions: [
              TextButton(
                onPressed: isLoading ? null : () => Navigator.pop(context),
                child: Text(tr.cancel, style: const TextStyle(fontWeight: FontWeight.w600)),
              ),
              ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: colorScheme.primary,
                  foregroundColor: colorScheme.onPrimary,
                  padding: const EdgeInsets.symmetric(horizontal: 32, vertical: 12),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                ),
                onPressed: isLoading ? null : () async {
                  setStateDialog(() => isLoading = true);
                  final isCorrect = await context.read<AuthCubit>().verifyPasswordSilently(passwordController.text);
                  if (isCorrect) {
                    Navigator.pop(context);
                    this.setState(() => _isEditable = true);
                  } else {
                    setStateDialog(() => isLoading = false);
                    ScaffoldMessenger.of(context).showSnackBar(
                      SnackBar(
                        content: Text(tr.incorrect_password),
                        backgroundColor: colorScheme.error,
                        behavior: SnackBarBehavior.floating,
                      ),
                    );
                  }
                },
                child: isLoading
                    ? const SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white))
                    : Text(tr.verify, style: const TextStyle(fontWeight: FontWeight.bold)),
              ),
            ],
          );
        },
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\auth\register\home_register_screen.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/presentation/screens/auth/register/register_screen1.dart';
import 'package:malaz/presentation/screens/auth/register/register_screen2.dart';
import 'package:malaz/presentation/screens/auth/register/register_screen3.dart';
import 'package:malaz/presentation/screens/auth/register/register_screen4.dart';
import 'package:malaz/presentation/screens/auth/register/register_screen5.dart';
import 'package:smooth_page_indicator/smooth_page_indicator.dart';

import '../../../../core/config/color/app_color.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../cubits/auth/auth_cubit.dart';
import '../shared_widgets/shared_widgets.dart';

class HomeRegisterScreen extends StatefulWidget {
  HomeRegisterScreen({super.key});

  @override
  State<HomeRegisterScreen> createState() => _HomeRegisterScreenState();
}

class _HomeRegisterScreenState extends State<HomeRegisterScreen> {
  final PageController _controller = PageController();
  final GlobalKey<RegisterScreen4State> registerScreen4Key = GlobalKey<RegisterScreen4State>();
  final GlobalKey<RegisterScreen5State> registerScreen5Key = GlobalKey<RegisterScreen5State>();
  final GlobalKey<BuildPincodeTextfieldState> _pinTextfieldKey = GlobalKey<BuildPincodeTextfieldState>();

  final List<GlobalKey<FormState>> formKeys = List.generate(5, (_) => GlobalKey<FormState>());


  /// data inputs from user storage here
  final RegisterData registerData = RegisterData();
  bool _pinValid = false;  /// PIN verification status
  int currentPage = 0;

  /// Update PIN status from RegisterScreen1
  void updatePinValidity(bool value) {
    setState(() => _pinValid = value);
  }

  bool myConditionCheck() {
    final currentFormKey = formKeys[currentPage];
    /// If there is no form on the current page -> we block navigation (unexpected but safe situation)
    if (currentFormKey.currentState == null) {
      return true; /// true => Block movement
    }

    /// We are verifying the current form
    final bool isFormValid = currentFormKey.currentState!.validate();
    if (!isFormValid) {
      return true; /// Navigation is prevented because the form is invalid
    }

    /// Page-specific conditions
    if (currentPage == 0) {
      /// Check the PIN status inside BuildPincodeTextfield
      final pinState = _pinTextfieldKey.currentState;
      if (pinState == null) {
        /// The state cannot be reached -> Block navigation
        return true;
      }

      /// If the length is incorrect, we will show the error and prevent movement
      if (!pinState.isPinValid()) {
        pinState.showError();
        return true;
      }

      /// Now we check the server verification result (stored in _pinValid)
      if (!_pinValid) {
        /// Six numbers were entered, but the server has not yet confirmed or rejected them.
        pinState.showError();
        return true;
      }
    } else if (currentPage == 3) {
      if (registerScreen4Key.currentState == null || !registerScreen4Key.currentState!.isImageSelected()) {
        registerScreen4Key.currentState?.showImageError(true);
        return true;
      }
    } else if (currentPage == 4) {
      if (registerScreen5Key.currentState == null || !registerScreen5Key.currentState!.isImageSelected()) {
        registerScreen5Key.currentState?.showImageError(true);
        return true;
      }
    }

    /// All tests are successful => Movement is permitted
    return false;
  }


  void _onPageChanged(int newPage) {
    if (myConditionCheck()) {
      _controller.animateToPage(
        currentPage,
        duration: Duration(milliseconds: 100),
        curve: Curves.easeInOut,
      );
    } else {
      setState(() => currentPage = newPage);
    }
  }

  void _submitRegister() {
    final phone = registerData.phone.trim();
    final firstName = registerData.firstName.trim();
    final lastName = registerData.lastName.trim();
    final password = registerData.password.trim();
    final dob = registerData.dateOfBirth.trim();
    final profile = registerData.profileImage;
    final identity = registerData.identityImage;

    print('>>>>>> submitRegister called with: phone="$phone", first="$firstName", last="$lastName", password="${password.isNotEmpty}", dob="$dob", profile=${profile != null}, identity=${identity != null}');

    if (phone.isEmpty || firstName.isEmpty || lastName.isEmpty || password.isEmpty || dob.isEmpty || profile == null || identity == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please fill all fields and upload images')),
      );
      return;
    }

    context.read<AuthCubit>().register(
      phone: phone,
      firstName: firstName,
      lastName: lastName,
      password: password,
      dateOfBirth: dob,
      profileImage: profile,
      identityImage: identity,
    );
  }


  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;
    return BlocListener<AuthCubit, AuthState>(
      listener: (context, state) {
        if (!mounted) return;

        if (state is AuthPending) {
          context.go('/pending');
        } else if (state is AuthAuthenticated) {
          context.go('/home');
        } else if (state is AuthError) {
          ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(state.message),
                backgroundColor: Colors.red,
                behavior: SnackBarBehavior.floating,
              )
          );
        }
      },
      child: Scaffold(
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
        body: ListView(
          children: [
            SizedBox(
              height: 800,
              width: 450,
              child: PageView(
                controller: _controller,
                onPageChanged: _onPageChanged,
                children: [
                  RegisterScreen1(
                    formKey: formKeys[0],
                    pinKey: _pinTextfieldKey,
                    registerData: registerData,
                    onPinVerified: updatePinValidity,
                  ),
                  RegisterScreen2(
                    formKey: formKeys[1],
                    registerData: registerData,
                  ),
                  RegisterScreen3(
                    formKey: formKeys[2],
                    registerData: registerData,
                  ),
                  RegisterScreen4(
                    key: registerScreen4Key,
                    formKey: formKeys[3],
                    registerData: registerData,
                  ),
                  RegisterScreen5(
                    key: registerScreen5Key,
                    formKey: formKeys[4],
                    registerData: registerData,
                    onRegisterPressed: _submitRegister,
                  ),
                ],
              ),
            ),
            const SizedBox(
              height: 8,
            ),
            Center(
              child: ShaderMask(
                shaderCallback: (bounds) => AppColors.premiumGoldGradient.createShader(bounds),
                child: SmoothPageIndicator(
                  controller: _controller,
                  count: 5,
                  effect: ExpandingDotsEffect(
                      activeDotColor: Colors.white,
                      dotColor: Colors.yellow,
                      dotHeight: 15,
                      dotWidth: 20,
                      spacing: 15
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class RegisterData {
  String phone = '';
  String firstName = '';
  String lastName = '';
  String password = '';
  String confirmPassword = '';
  String dateOfBirth = '';
  XFile? profileImage;
  XFile? identityImage;
}

// =======================================================
// FILE PATH: lib\presentation\screens\auth\register\register_screen1.dart
// =======================================================

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/core/config/color/app_color.dart';
import 'package:modal_progress_hud_nsn/modal_progress_hud_nsn.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../cubits/auth/auth_cubit.dart';
import '../../../global_widgets/brand/build_branding.dart';
import '../shared_widgets/shared_widgets.dart';
import 'home_register_screen.dart';

class RegisterScreen1 extends StatefulWidget {
  final GlobalKey<FormState> formKey;
  final GlobalKey<BuildPincodeTextfieldState> pinKey;
  final RegisterData registerData;
  final Function(bool)? onPinVerified;

  const RegisterScreen1({
    super.key,
    required this.formKey,
    required this.pinKey,
    required this.registerData,
    this.onPinVerified,
  });

  @override
  State<RegisterScreen1> createState() => _RegisterScreen1State();
}

class _RegisterScreen1State extends State<RegisterScreen1> {
  bool _isSending = false;
  String? _pinError;

  void _showCustomSnackBar(BuildContext context, String message, {bool isError = false}) {
    if (!mounted) return;
    ScaffoldMessenger.of(context).hideCurrentSnackBar();
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: isError ? Colors.red : Colors.green,
        behavior: SnackBarBehavior.floating,
      ),
    );
  }

  void _sendVerificationCode() {
    final phone = widget.registerData.phone.trim();
    if (phone.isEmpty) {
      _showCustomSnackBar(context, 'Please enter your phone first', isError: true);
      return;
    }
    context.read<AuthCubit>().sendOtp(phone);
  }

  void _verifyPin(String pin) {
    if (pin.length != 6) {
      setState(() => _pinError = 'Please enter a 6-digit PIN code');
      widget.onPinVerified?.call(false);
      return;
    }
    setState(() => _pinError = null);
    final phone = widget.registerData.phone.trim();
    widget.pinKey.currentState?.verifyStarted();
    context.read<AuthCubit>().verifyOtp(phone, pin);
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return BlocConsumer<AuthCubit, AuthState>(
      listener: (context, state) {
        if (!mounted) return;

        if (state is OtpSending) {
          setState(() => _isSending = true);
        } else if (state is OtpSent) {
          setState(() => _isSending = false);
          _showCustomSnackBar(context, tr.otp_sent_success);
        } else if (state is OtpSendError) {
          setState(() => _isSending = false);
          _showCustomSnackBar(context, state.message, isError: true);
        }

        if (state is OtpVerified) {
          widget.pinKey.currentState?.verifyFinished(success: true);
          widget.onPinVerified?.call(true);
          _showCustomSnackBar(context, tr.otp_verified_success);
        } else if (state is OtpVerifyError) {
          final msg = state.message.isNotEmpty ? state.message : 'Invalid code';
          widget.pinKey.currentState?.verifyFinished(success: false, message: msg);
          widget.onPinVerified?.call(false);
          setState(() => _pinError = msg);
        }
      },
      builder: (context, state) {
        return ModalProgressHUD(
          color: Colors.white,
          inAsyncCall: _isSending,
          child: Scaffold(
            backgroundColor: Theme.of(context).scaffoldBackgroundColor,
            body: SingleChildScrollView(
              child: SafeArea(
                child: Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 24),
                  child: Form(
                    key: widget.formKey,
                    child: Column(
                      children: [
                        const SizedBox(height: 25),
                        Center(
                          child: ClipRRect(
                            borderRadius: BorderRadius.circular(24),
                            child: BackdropFilter(
                              filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                              child: Container(
                                padding: const EdgeInsets.all(10),
                                decoration: BoxDecoration(
                                  color: colorScheme.primary.withOpacity(0.05),
                                  borderRadius: BorderRadius.circular(24),
                                  border: Border.all(color: colorScheme.primary.withOpacity(0.1)),
                                ),
                                child: Image.asset('assets/icons/key_logo.png', width: 65, color: colorScheme.primary),
                              ),
                            ),
                          ),
                        ),
                        const SizedBox(height: 24),
                        Text(
                          tr.create_account,
                          style: TextStyle(
                            fontSize: 30,
                            fontWeight: FontWeight.bold,
                            color: colorScheme.primary,
                            letterSpacing: -1,
                          ),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          tr.join_to_find,
                          style: TextStyle(color: colorScheme.onSurface.withOpacity(0.6), fontSize: 12),
                        ),
                        const SizedBox(height: 100),
                        BuildTextfield(
                          label: tr.mobile_number,
                          hintText: tr.phone_number_hint,
                          icon: Icons.phone,
                          obscure: false,
                          keyboardType: TextInputType.phone,
                          haveSuffixEyeIcon: false,
                          formKey: widget.formKey,
                          onChanged: (value) => widget.registerData.phone = value,
                        ),
                        const SizedBox(height: 16),
                        BuildVerficationCodeButton(
                          onPressed: _isSending ? null : _sendVerificationCode,
                        ),
                        Padding(
                          padding: const EdgeInsets.all(16),
                          child: BuildPincodeTextfield(
                            key: widget.pinKey,
                            onChanged: (pin) {
                              if (pin.length == 6) _verifyPin(pin);
                            },
                            onVerified: (success) => widget.onPinVerified?.call(success),
                          ),
                        ),
                        if (_pinError != null)
                        Padding(
                            padding: const EdgeInsets.only(top: 8),
                            child: Text(_pinError!, style: TextStyle(color: colorScheme.error, fontWeight: FontWeight.bold)),
                        ),
                        const SizedBox(height: 40),
                        const BuildLoginRow(),
                        const SizedBox(height: 90),
                        BuildBranding.metaStyle()
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
        );
      },
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\auth\register\register_screen2.dart
// =======================================================

import 'dart:ui';

import 'package:flutter/material.dart';
import 'package:malaz/presentation/screens/auth/register/home_register_screen.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../global_widgets/brand/build_branding.dart';
import '../shared_widgets/shared_widgets.dart';

class RegisterScreen2 extends StatefulWidget {
  final GlobalKey<FormState> formKey;
  final RegisterData registerData;
  const RegisterScreen2(
      {super.key, required this.formKey, required this.registerData});

  @override
  State<RegisterScreen2> createState() => _RegisterScreen2State();
}

class _RegisterScreen2State extends State<RegisterScreen2> {
  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: SingleChildScrollView(
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(
              horizontal: 24,
            ),
            child: Form(
              key: widget.formKey,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const SizedBox(
                    height: 25,
                  ),

                  // Logo
                  Center(
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(24),
                      child: BackdropFilter(
                        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: colorScheme.primary.withOpacity(0.05),
                            borderRadius: BorderRadius.circular(24),
                            border: Border.all(
                                color: colorScheme.primary.withOpacity(0.1)),
                          ),
                          child: Image.asset('assets/icons/key_logo.png',
                              width: 65, color: colorScheme.primary),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(
                    height: 24,
                  ),

                  // Create Account - Header Text 1
                  Text(
                      tr.create_account,
                      style: TextStyle(
                        fontSize: 30,
                        fontWeight: FontWeight.bold,
                        color: colorScheme.primary,
                        letterSpacing: -1,
                    ),
                  ),
                  const SizedBox(
                    height: 8,
                  ),

                  // Join To Find - Header Text 2
                  Text(
                    tr.join_to_find,
                    style: TextStyle(color: colorScheme.onSecondary, fontSize: 12),
                  ),
                  const SizedBox(
                    height: 50,
                  ),

                  // First Name Field
                  BuildTextfield(
                    label: tr.first_name,
                    hintText: "${tr.enter_hint} ${tr.first_name}",
                    icon: Icons.person,
                    obscure: false,
                    keyboardType: TextInputType.name,
                    haveSuffixEyeIcon: false,
                    formKey: widget.formKey,
                    onChanged: (value) => widget.registerData.firstName = value,
                  ),

                  // Last Name Field
                  BuildTextfield(
                    label: tr.last_name,
                    hintText: "${tr.enter_hint} ${tr.last_name}",
                    icon: Icons.person,
                    obscure: false,
                    keyboardType: TextInputType.name,
                    haveSuffixEyeIcon: false,
                    formKey: widget.formKey,
                    onChanged: (value) => widget.registerData.lastName = value,
                  ),

                  // Date Of Birth Field
                  BuildTextfield(
                    label: tr.date_of_birth,
                    hintText: "${tr.enter_hint} ${tr.date_of_birth}",
                    icon: Icons.calendar_today_outlined,
                    onPressedForDate: true,
                    formKey: widget.formKey,
                    onChanged: (value) =>
                        widget.registerData.dateOfBirth = value,
                  ),
                  const SizedBox(height: 40),
                  const BuildLoginRow(),
                  const SizedBox(height: 80),
                  BuildBranding.metaStyle()
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\auth\register\register_screen3.dart
// =======================================================

import 'dart:ui';

import 'package:flutter/material.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../global_widgets/brand/build_branding.dart';
import '../shared_widgets/shared_widgets.dart';
import 'home_register_screen.dart';

class RegisterScreen3 extends StatelessWidget {
  final GlobalKey<FormState> formKey;
  final RegisterData registerData;
  const RegisterScreen3({super.key, required this.formKey, required this.registerData});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: SingleChildScrollView(
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(
              horizontal: 24,
            ),
            child: Form(
              key: formKey,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const SizedBox(
                    height: 25,
                  ),

                  // Logo
                  Center(
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(24),
                      child: BackdropFilter(
                        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: colorScheme.primary.withOpacity(0.05),
                            borderRadius: BorderRadius.circular(24),
                            border: Border.all(
                                color: colorScheme.primary.withOpacity(0.1)),
                          ),
                          child: Image.asset('assets/icons/key_logo.png',
                              width: 65, color: colorScheme.primary),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(
                    height: 24,
                  ),

                  // Create Account - Header Text 1
                  Text(
                    tr.create_account,
                    style: TextStyle(
                      fontSize: 30,
                      fontWeight: FontWeight.bold,
                      color: colorScheme.primary,
                      letterSpacing: -1,
                    ),
                  ),
                  const SizedBox(
                    height: 8,
                  ),

                  // Join To Find - Header Text 2
                  Text(
                    tr.join_to_find,
                    style: TextStyle(color: colorScheme.onSurface.withOpacity(0.6), fontSize: 12),
                  ),
                  const SizedBox(
                    height: 100,
                  ),

                  // Password Field
                  BuildTextfield(
                    label: tr.password,
                    hintText: "${tr.enter_hint} ${tr.password}",
                    icon: Icons.password,
                    haveSuffixEyeIcon: true,
                    obscure: true,
                    formKey: formKey,
                    onChanged: (value) => registerData.password = value,
                  ),

                  //  Confirm Password Field
                  BuildTextfield(
                    label: tr.confirm_password,
                    hintText: "${tr.enter_hint} ${tr.confirm_password}",
                    icon: Icons.password,
                    haveSuffixEyeIcon: true,
                    obscure: true,
                    formKey: formKey,
                    onChanged: (value) => registerData.confirmPassword = value,
                  ),
                  const SizedBox(height: 40),
                  const BuildLoginRow(),
                  const SizedBox(height: 80),
                  BuildBranding.metaStyle()
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\auth\register\register_screen4.dart
// =======================================================

import 'dart:io';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/config/color/app_color.dart';
import 'package:malaz/presentation/screens/auth/register/home_register_screen.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../global_widgets/brand/build_branding.dart';
import '../shared_widgets/shared_widgets.dart';

class RegisterScreen4 extends StatefulWidget {
  final GlobalKey<FormState> formKey;
  final RegisterData registerData;
  const RegisterScreen4({super.key, required this.formKey, required this.registerData});

  @override
  State<RegisterScreen4> createState() => RegisterScreen4State();
}

class RegisterScreen4State extends State<RegisterScreen4> {
  XFile? _image;
  bool _showImageError = false;

  void _submit() {
    if (_image == null) {
      setState(() {
        _showImageError = true;
      });
    } else {
      setState(() {
        _showImageError = false;
      });
    }
  }
  void showImageError(bool show) {
    setState(() {
      _showImageError = show;
    });
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: SingleChildScrollView(
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(
              horizontal: 24,
            ),
            child: Form(
              key: widget.formKey,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const SizedBox(
                    height: 25,
                  ),

                  // Logo
                  Center(
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(24),
                      child: BackdropFilter(
                        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: colorScheme.primary.withOpacity(0.05),
                            borderRadius: BorderRadius.circular(24),
                            border: Border.all(
                                color: colorScheme.primary.withOpacity(0.1)),
                          ),
                          child: Image.asset('assets/icons/key_logo.png',
                              width: 65, color: colorScheme.primary),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(
                    height: 24,
                  ),

                  // Create Account - Header Text 1
                  Text(
                    tr.create_account,
                    style: TextStyle(
                      fontSize: 30,
                      fontWeight: FontWeight.bold,
                      color: colorScheme.primary,
                      letterSpacing: -1,
                    ),
                  ),
                  const SizedBox(
                    height: 8,
                  ),

                  // Join To Find - Header Text 2
                  Text(
                    tr.join_to_find,
                    style: TextStyle(color: colorScheme.onSurface.withOpacity(0.6), fontSize: 12),
                  ),
                  const SizedBox(
                    height: 100,
                  ),

                  // ID Document Message
                  Text(
                    tr.id_document_message, // Using getter
                    style: TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: colorScheme.primary,
                    ),
                  ),
                  const SizedBox(
                    height: 24,
                  ),

                  // Image Input
                  ImageUploadWidget(
                    isError: _showImageError,
                    onImageSelected: (XFile? img) {
                      setState(() {
                        _image = img;
                        widget.registerData.identityImage = img;
                        _showImageError = false;
                      });
                    },
                  ),
                  if (_showImageError)
                    Padding(
                      padding: const EdgeInsets.only(top: 8),
                      child: Text(
                        tr.image_required,
                        style: TextStyle(color: Colors.red, fontWeight: FontWeight.bold),
                      ),
                    ),
                  const SizedBox(
                    height: 70,
                  ),

                  // Navigator.push to Login Page
                  const BuildLoginRow(),
                  const SizedBox(
                    height: 100,
                  ),

                  // Branding
                  BuildBranding.metaStyle()
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
  bool isImageSelected() {
    return _image != null;
  }
}

class ImageUploadWidget extends StatefulWidget {
  final Function(XFile?) onImageSelected;
  final bool isError;

  const ImageUploadWidget({Key? key, required this.onImageSelected,this.isError = false,}) : super(key: key);
  @override
  _ImageUploadWidgetState createState() => _ImageUploadWidgetState();
}

class _ImageUploadWidgetState extends State<ImageUploadWidget> {
  XFile? _image;

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      setState(() {
        _image = XFile(pickedFile.path);
      });
      widget.onImageSelected(_image);
    }
  }

  Widget _uploadBox({required IconData icon, required String label, String? sub, required Color color}) {
    return InkWell(
      onTap: _pickImage,
      child: DottedBox(
        isError: widget.isError,
        hasImage: _image != null,
        child: _image == null
            ? Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 36, color: color),
            const SizedBox(height: 8),
            Text(label, style: TextStyle(fontWeight: FontWeight.w600, color: color)),
            if (sub != null) ...[
              const SizedBox(height: 6),
              Text(sub, style: TextStyle(fontSize: 12, color: color)),
            ],
          ],
        )
            : Image.file(
          File(_image!.path),
          fit: BoxFit.cover,
          width: double.infinity,
          height: double.infinity,
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return SizedBox(
      width: 350,
      height: 145,
      child: _uploadBox(
        color: colorScheme.primary,
        icon: Icons.cloud_upload_outlined,
        label: tr.upload_id_message,
        sub: tr.png_jpg,
      ),
    );
  }
}

class DottedBox extends StatelessWidget {
  final Widget child;
  final bool isError;
  final bool hasImage;

  const DottedBox({
    required this.child,
    this.isError = false,
    this.hasImage = false,
    Key? key,
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    Widget content = hasImage
        ? child
        : ShaderMask(
      shaderCallback: (bounds) => AppColors.premiumGoldGradient2.createShader(bounds),
      child: child,
    );

    return Container(
      width: double.infinity,
      height: double.infinity,
      decoration: BoxDecoration(
        color: colorScheme.primary.withOpacity(0.1),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(
          color: isError ? colorScheme.error : colorScheme.primary,
          style: BorderStyle.solid,
        ),
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(12),
        child: content,
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\auth\register\register_screen5.dart
// =======================================================

import 'dart:io';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:image_picker/image_picker.dart';
import 'package:malaz/core/config/color/app_color.dart';
import 'package:malaz/presentation/global_widgets/buttons/custom_button.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../cubits/auth/auth_cubit.dart';
import '../../../global_widgets/brand/build_branding.dart';
import 'home_register_screen.dart';

class RegisterScreen5 extends StatefulWidget {
  final GlobalKey<FormState> formKey;
  final RegisterData registerData;
  final VoidCallback onRegisterPressed;

  const RegisterScreen5({super.key, required this.formKey, required this.registerData, required this.onRegisterPressed});

  @override
  State<RegisterScreen5> createState() => RegisterScreen5State();
}

class RegisterScreen5State extends State<RegisterScreen5> {
  XFile? _image;
  bool _showImageError = false;

  void showImageError(bool show) {
    setState(() {
      _showImageError = show;
    });
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: SingleChildScrollView(
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: Form(
              key: widget.formKey,
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const SizedBox(
                    height: 25,
                  ),

                  // Logo
                  Center(
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(24),
                      child: BackdropFilter(
                        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: colorScheme.primary.withOpacity(0.05),
                            borderRadius: BorderRadius.circular(24),
                            border: Border.all(
                                color: colorScheme.primary.withOpacity(0.1)),
                          ),
                          child: Image.asset('assets/icons/key_logo.png',
                              width: 65, color: colorScheme.primary),
                        ),
                      ),
                    ),
                  ),
                  const SizedBox(
                    height: 24,
                  ),

                  // Create Account - Header Text 1
                  Text(
                    tr.create_account,
                    style: TextStyle(
                      fontSize: 30,
                      fontWeight: FontWeight.bold,
                      color: colorScheme.primary,
                      letterSpacing: -1,
                    ),
                  ),
                  const SizedBox(
                    height: 8,
                  ),

                  // Join To Find - Header Text 2
                  Text(
                    tr.join_to_find,
                    style: TextStyle(color: colorScheme.onSurface.withOpacity(0.6), fontSize: 12),
                  ),
                  const SizedBox(
                    height: 50,
                  ),

                  // Profile Image Message
                  Text(
                      tr.profile_image_message,
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: colorScheme.primary,
                      ),
                  ),
                  const SizedBox(
                    height: 24,
                  ),

                  // Profile Image Input
                  ImageUploadWidget(
                    isError: _showImageError,
                    onImageSelected: (XFile? img) {
                      setState(() {
                        widget.registerData.profileImage = img;
                        _image = img;
                        _showImageError = false;
                      });
                    },
                  ),
                  if (_showImageError)
                    Padding(
                      padding: const EdgeInsets.only(top: 8),
                      child: Text(
                        tr.image_required,
                        style: TextStyle(color: Colors.red, fontWeight: FontWeight.bold),
                      ),
                    ),
                  const SizedBox(
                    height: 50,
                  ),

                  // Register Button
                  CustomButton(
                    text: tr.register,
                    onPressed: widget.onRegisterPressed,
                  ),
                  const SizedBox(
                    height: 50,
                  ),

                  // Branding
                  BuildBranding.metaStyle()
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
  bool isImageSelected() {
    return _image != null;
  }
}
class ImageUploadWidget extends StatefulWidget {
  final Function(XFile?) onImageSelected;
  final bool isError;

  const ImageUploadWidget({Key? key, required this.onImageSelected, this.isError = false}) : super(key: key);

  @override
  _ImageUploadWidgetState createState() => _ImageUploadWidgetState();
}

class _ImageUploadWidgetState extends State<ImageUploadWidget> {
  XFile? _image;

  Future<void> _pickImage() async {
    final picker = ImagePicker();
    final pickedFile = await picker.pickImage(source: ImageSource.gallery);

    if (pickedFile != null) {
      setState(() {
        _image = XFile(pickedFile.path);
      });
      widget.onImageSelected(_image);
    }
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;

    return SizedBox(
      width: 150,
      height: 150,
      child: _uploadBox(
        icon: Icons.person,
        color: colorScheme.primary,
      ),
    );
  }

  Widget _uploadBox({required IconData icon, required Color color}) {
    return InkWell(
      customBorder: const CircleBorder(),
      onTap: _pickImage,
      child: DottedBox(
        isError: widget.isError,
        hasImage: _image != null,
        child: _image == null
            ? Icon(icon, size: 80, color: color)
            : Image.file(
          File(_image!.path),
          fit: BoxFit.cover,
          width: double.infinity,
          height: double.infinity,
        ),
      ),
    );
  }
}

class DottedBox extends StatelessWidget {
  final Widget child;
  final bool isError;
  final bool hasImage;

  const DottedBox({
    required this.child,
    this.isError = false,
    this.hasImage = false,
    Key? key
  }) : super(key: key);

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;

    return Container(
      width: double.infinity,
      height: double.infinity,
      padding: hasImage ? EdgeInsets.zero : const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: colorScheme.primary.withOpacity(0.1),
        shape: BoxShape.circle,
        border: Border.all(
          color: isError ? colorScheme.error : colorScheme.primary,
          width: 2,
        ),
      ),
      child: ClipOval(
        child: hasImage
            ? child
            : ShaderMask(
          shaderCallback: (bounds) => AppColors.premiumGoldGradient.createShader(bounds),
          child: child,
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\auth\reset_password_screen\ResetPasswordScreen.dart
// =======================================================

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:pin_code_fields/pin_code_fields.dart';
import 'package:go_router/go_router.dart';
import '../../../../core/config/color/app_color.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../cubits/auth/auth_cubit.dart';

class ResetPasswordScreen extends StatefulWidget {
  final String phoneNumber;
  const ResetPasswordScreen({super.key, required this.phoneNumber});

  @override
  State<ResetPasswordScreen> createState() => _ResetPasswordScreenState();
}

class _ResetPasswordScreenState extends State<ResetPasswordScreen> {
  int _currentStep = 1;
  bool _obscureNewPassword = true;
  bool _obscureConfirmPassword = true;

  final _otpController = TextEditingController();
  final _newPasswordController = TextEditingController();
  final _confirmPasswordController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final size = MediaQuery.of(context).size;

    final bgColor = isDark ? const Color(0xFF121212) : const Color(0xFFFFFDF9);
    final textColor = isDark ? Colors.white : const Color(0xFF3E2723);
    final subTextColor = isDark ? Colors.white70 : const Color(0xFF5D4037);

    return BlocListener<AuthCubit, AuthState>(
      listenWhen: (previous, current) => previous != current,
      listener: (context, state) {
        if (state is OtpSentSuccess) {
          setState(() => _currentStep = 2);
          _showSnackBar(context, tr.otp_sent_success, Colors.green);
        }
        if (state is OtpVerifyError) {
          _otpController.clear();
          _showSnackBar(context, tr.wronge_otp, Colors.red);
        }
        if (state is OtpVerified) {
          setState(() => _currentStep = 3);
          _showSnackBar(context, tr.otp_verified_success, Colors.green);
        }
        if (state is PasswordUpdatedSuccess) {
          _showSuccessSheet(tr, isDark, textColor);
        }
        if (state is AuthError) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(state.message),
              backgroundColor: Colors.red,
              behavior: SnackBarBehavior.floating,
              margin: const EdgeInsets.all(20),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            ),
          );
        }
      },
      child: Scaffold(
        resizeToAvoidBottomInset: true,
        body: Container(
          width: size.width,
          height: size.height,
          decoration: BoxDecoration(
            color: bgColor,
            gradient: isDark ? null : RadialGradient(
              center: const Alignment(-0.5, -0.7),
              radius: 1.5,
              colors: [const Color(0xFFFFFFFF), const Color(0xFFFDF5E6), const Color(0xFFF5EEDC)],
            ),
          ),
          child: Stack(
            children: [
              if (!isDark) _buildLightDecorations(size),
              SafeArea(
                child: LayoutBuilder(
                  builder: (context, constraints) {
                    return SingleChildScrollView(
                      physics: const BouncingScrollPhysics(),
                      child: ConstrainedBox(
                        constraints: BoxConstraints(minHeight: constraints.maxHeight),
                        child: IntrinsicHeight(
                          child: Padding(
                            padding: const EdgeInsets.symmetric(horizontal: 24),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                const SizedBox(height: 60),
                                _buildHeader(tr, textColor),
                                const SizedBox(height: 40),
                                BlocBuilder<AuthCubit, AuthState>(
                                  builder: (context, state) {
                                    return Stack(
                                      alignment: Alignment.center,
                                      children: [
                                        Opacity(
                                          opacity: state is AuthLoading ? 0.4 : 1.0,
                                          child: AbsorbPointer(
                                            absorbing: state is AuthLoading,
                                            child: _glassCard(
                                              isDark: isDark,
                                              cardColor: isDark
                                                  ? Colors.white.withOpacity(0.08)
                                                  : const Color(0xFFFDF5E6).withOpacity(0.8),
                                              child: _buildStepContent(tr, isDark, textColor, subTextColor),
                                            ),
                                          ),
                                        ),

                                        if (state is AuthLoading)
                                          _buildElegantLoading(isDark),
                                      ],
                                    );
                                  },
                                ),
                                const SizedBox(height: 40),
                              ],
                            ),
                          ),
                        ),
                      ),
                    );
                  },
                ),
              ),
              Positioned(
                top: MediaQuery.of(context).padding.top + 10,
                left: 10,
                child: IconButton(
                  icon: Icon(Icons.arrow_back_ios_new, color: textColor),
                  onPressed: () => context.pop(),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildElegantLoading(bool isDark) {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: isDark ? Colors.black45 : Colors.white70,
        shape: BoxShape.circle,
        boxShadow: [
          BoxShadow(
            color: AppColors.primaryLight.withOpacity(0.2),
            blurRadius: 15,
            spreadRadius: 2,
          )
        ],
      ),
      child: const CircularProgressIndicator(
        color: AppColors.primaryLight,
        strokeWidth: 3,
      ),
    );
  }

  Widget _buildStepContent(AppLocalizations tr, bool isDark, Color textColor, Color subTextColor) {
    switch (_currentStep) {
      case 1: return _stepSendOtp(tr, subTextColor);
      case 2: return _stepVerifyOtp(tr, textColor, isDark);
      case 3:
        return Column(
          children: [
            _buildCustomField(
              isDark, textColor,
              controller: _newPasswordController,
              hint: tr.new_password,
              icon: Icons.lock_outline,
              isPassword: true,
              obscureText: _obscureNewPassword,
              onToggle: () => setState(() => _obscureNewPassword = !_obscureNewPassword),
            ),
            const SizedBox(height: 16),
            _buildCustomField(
              isDark, textColor,
              controller: _confirmPasswordController,
              hint: tr.confirm_password,
              icon: Icons.check_circle_outline,
              isPassword: true,
              obscureText: _obscureConfirmPassword,
              onToggle: () => setState(() => _obscureConfirmPassword = !_obscureConfirmPassword),
            ),
            const SizedBox(height: 32),
            _premiumButton(
              onPressed: () {
                if (_newPasswordController.text.isEmpty || _confirmPasswordController.text.isEmpty) {
                  _showSnackBar(context, tr.please_enter_password, Colors.orange);
                  return;
                }

                if (_newPasswordController.text.length < 6) {
                  _showSnackBar(context, tr.password_length_message, Colors.red);
                  return;
                }

                if (_newPasswordController.text != _confirmPasswordController.text) {
                  _showSnackBar(context, tr.passwords_do_not_match, Colors.red);
                  return;
                }

                context.read<AuthCubit>().updatePassword(
                  phone: widget.phoneNumber,
                  otp: _otpController.text,
                  newPassword: _newPasswordController.text,
                );
              },
              label: tr.save,
            ),
          ],
        );
      default: return const SizedBox();
    }
  }

  Widget _buildCustomField(bool isDark, Color textColor, {
    required TextEditingController controller,
    required String hint,
    required IconData icon,
    bool isPassword = false,
    bool obscureText = false,
    VoidCallback? onToggle,
  }) {
    return TextField(
      controller: controller,
      obscureText: obscureText,
      style: TextStyle(color: textColor),
      decoration: InputDecoration(
        prefixIcon: Icon(icon, color: AppColors.primaryLight),
        suffixIcon: isPassword ? IconButton(
          icon: Icon(obscureText ? Icons.visibility_off_outlined : Icons.visibility_outlined,
              color: AppColors.primaryLight.withOpacity(0.6)),
          onPressed: onToggle,
        ) : null,
        hintText: hint,
        hintStyle: TextStyle(color: isDark ? Colors.white38 : Colors.brown.withOpacity(0.4)),
        filled: true,
        fillColor: isDark ? Colors.white.withOpacity(0.05) : Colors.white.withOpacity(0.5),
        border: OutlineInputBorder(borderRadius: BorderRadius.circular(16), borderSide: BorderSide.none),
      ),
    );
  }

  void _showSnackBar(BuildContext context, String message, Color color) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: color,
        behavior: SnackBarBehavior.floating,
        margin: const EdgeInsets.all(20),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ),
    );
  }

  Widget _stepSendOtp(AppLocalizations tr, Color subTextColor) {
    return Column(
      children: [
        Text(tr.identity_verification_input, textAlign: TextAlign.center, style: TextStyle(color: subTextColor, fontSize: 16)),
        const SizedBox(height: 32),
        _premiumButton(
          onPressed: () => context.read<AuthCubit>().sendPasswordResetOtp(widget.phoneNumber),
          label: tr.send_code,
        ),
      ],
    );
  }

  Widget _stepVerifyOtp(AppLocalizations tr, Color textColor, bool isDark) {
    return Column(
      children: [
        PinCodeTextField(
          appContext: context,
          length: 6,
          controller: _otpController,
          keyboardType: TextInputType.number,
          textStyle: TextStyle(color: textColor, fontWeight: FontWeight.bold),
          pinTheme: PinTheme(
            shape: PinCodeFieldShape.box,
            borderRadius: BorderRadius.circular(12),
            fieldHeight: 50,
            fieldWidth: 40,
            inactiveColor: isDark ? Colors.white24 : Colors.brown.shade100,
            selectedColor: AppColors.primaryLight,
            activeColor: AppColors.primaryLight,
            activeFillColor: isDark ? Colors.white10 : Colors.white,
          ),
          onCompleted: (v) {
            context.read<AuthCubit>().verifyOtp(
              widget.phoneNumber,
              v,
            );
          },
        ),
        const SizedBox(height: 24),
        TextButton(
            onPressed: () => context.read<AuthCubit>().sendPasswordResetOtp(widget.phoneNumber),
            child: Text(tr.resend_code, style: TextStyle(color: AppColors.primaryLight, fontWeight: FontWeight.w600))
        ),
      ],
    );
  }

  Widget _buildHeader(AppLocalizations tr, Color textColor) {
    return Column(
      children: [
        Container(
          padding: const EdgeInsets.all(20),
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            border: Border.all(color: AppColors.primaryLight.withOpacity(0.5), width: 1.5),
            gradient: LinearGradient(colors: [AppColors.primaryLight.withOpacity(0.1), Colors.transparent]),
          ),
          child: Icon(_getIconForStep(), size: 42, color: AppColors.primaryLight),
        ),
        const SizedBox(height: 24),
        Text(_getTitleForStep(tr), textAlign: TextAlign.center, style: TextStyle(fontSize: 26, fontWeight: FontWeight.bold, color: textColor)),
      ],
    );
  }

  Widget _glassCard({required bool isDark, required Color cardColor, required Widget child}) {
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(28),
        boxShadow: isDark ? [] : [BoxShadow(color: AppColors.primaryLight.withOpacity(0.08), blurRadius: 40, spreadRadius: 2, offset: const Offset(0, 20))],
      ),
      child: ClipRRect(
        borderRadius: BorderRadius.circular(28),
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 15, sigmaY: 15),
          child: Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(color: cardColor, borderRadius: BorderRadius.circular(28), border: Border.all(color: isDark ? Colors.white10 : AppColors.primaryLight.withOpacity(0.15), width: 1)),
            child: child,
          ),
        ),
      ),
    );
  }

  Widget _premiumButton({required VoidCallback onPressed, required String label}) {
    return Container(
      width: double.infinity,
      height: 58,
      decoration: BoxDecoration(
        gradient: AppColors.premiumGoldGradient2,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [BoxShadow(color: AppColors.primaryLight.withOpacity(0.3), blurRadius: 20, offset: const Offset(0, 10))],
      ),
      child: ElevatedButton(
        onPressed: onPressed,
        style: ElevatedButton.styleFrom(backgroundColor: Colors.transparent, shadowColor: Colors.transparent, shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16))),
        child: Text(label, style: const TextStyle(color: Colors.black, fontWeight: FontWeight.bold, fontSize: 17)),
      ),
    );
  }

  void _showSuccessSheet(AppLocalizations tr, bool isDark, Color textColor) {
    showModalBottomSheet(
      context: context,
      isDismissible: false,
      backgroundColor: isDark ? const Color(0xFF1A1A1A) : const Color(0xFFFFFDF9),
      shape: const RoundedRectangleBorder(borderRadius: BorderRadius.vertical(top: Radius.circular(32))),
      builder: (context) => Container(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(Icons.check_circle, color: AppColors.primaryLight, size: 90),
            const SizedBox(height: 24),
            Text(tr.password_changed_success, style: TextStyle(color: textColor, fontSize: 22, fontWeight: FontWeight.bold)),
            const SizedBox(height: 32),
            _premiumButton(onPressed: () => context.go('/login'), label: tr.login),
          ],
        ),
      ),
    );
  }

  Widget _buildLightDecorations(Size size) {
    return Stack(children: [
      Positioned(top: size.height * 0.1, left: -50, child: CircleAvatar(radius: 120, backgroundColor: AppColors.primaryLight.withOpacity(0.04))),
      Positioned(bottom: size.height * 0.2, right: -30, child: CircleAvatar(radius: 80, backgroundColor: AppColors.primaryLight.withOpacity(0.03))),
    ]);
  }

  IconData _getIconForStep() {
    if (_currentStep == 1) return Icons.security;
    if (_currentStep == 2) return Icons.vibration;
    return Icons.lock_open_rounded;
  }

  String _getTitleForStep(AppLocalizations tr) {
    if (_currentStep == 1) return tr.identity_verification;
    if (_currentStep == 2) return tr.enter_otp_hint;
    return tr.change_password;
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\auth\shared_widgets\shared_widgets.dart
// =======================================================

import 'dart:io';

import 'package:dio/dio.dart';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import 'package:pin_code_fields/pin_code_fields.dart';

import '../../../../core/config/color/app_color.dart';
import '../../../../l10n/app_localizations.dart';

class BuildCard extends StatelessWidget {
  const BuildCard({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 350,
      decoration: const BoxDecoration(
          image: DecorationImage(
              image: AssetImage('assets/icons/card_box.png'),
              fit: BoxFit.fill)),
    );
  }
}

class BuildPincodeTextfield extends StatefulWidget {
  final GlobalKey<BuildPincodeTextfieldState>? pinKey;
  final Function(String)? onChanged;
  final Function(bool)? onVerified;

  const BuildPincodeTextfield({super.key, this.pinKey, this.onChanged, this.onVerified});

  @override
  State<BuildPincodeTextfield> createState() => BuildPincodeTextfieldState();
}

class BuildPincodeTextfieldState extends State<BuildPincodeTextfield> {
  final TextEditingController _pinController = TextEditingController();
  final FocusNode _focusNode = FocusNode();
  String? _errorMessage;
  bool _isVerifying = false;

  @override
  void initState() {
    super.initState();
    _focusNode.addListener(() {
      if (!_focusNode.hasFocus) {
        _validatePin(_pinController.text);
      }
    });
  }

  // @override
  // void dispose() {
  //   _pinController.dispose();
  //   _focusNode.dispose();
  //   //super.dispose();
  // }

  void _validatePin(String value) {
    setState(() {
      if (value.length != 6) {
        _errorMessage = 'Please enter a 6-digit PIN code';
      } else {
        _errorMessage = null;
      }
    });
  }

  bool isPinValid() {
    return _pinController.text.length == 6 && _errorMessage == null;
  }

  void showError() {
    setState(() => _errorMessage = 'Please enter a 6-digit PIN code');
  }

  Future<void> verifyStarted() async {
    setState(() => _isVerifying = true);
  }

  Future<void> verifyFinished({required bool success, String? message}) async {
    if (!mounted) return;
    setState(() {
      _isVerifying = false;
      _errorMessage = success ? null : (message ?? 'Invalid code');
    });
    widget.onVerified?.call(success);
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final bool hasError = _errorMessage != null;

    return Column(
      mainAxisSize: MainAxisSize.min,
      crossAxisAlignment: CrossAxisAlignment.center,
      children: [
        PinCodeTextField(
          key: widget.pinKey,
          appContext: context,
          length: 6,
          controller: _pinController,
          focusNode: _focusNode,
          keyboardType: TextInputType.number,
          cursorColor: colorScheme.primary,
          animationType: AnimationType.fade,
          textStyle: TextStyle(
              fontWeight: FontWeight.w700,
              fontSize: 18,
              color: colorScheme.primary
          ),
          pinTheme: PinTheme(
            shape: PinCodeFieldShape.box,
            borderRadius: BorderRadius.circular(12),
            fieldHeight: 48,
            fieldWidth: 40,
            borderWidth: 1,
            inactiveFillColor: Colors.transparent,
            selectedFillColor: Colors.transparent,
            activeFillColor: Colors.transparent,
            inactiveColor: colorScheme.outlineVariant.withOpacity(0.4),
            selectedColor: hasError ? Colors.redAccent : colorScheme.primary,
            activeColor: hasError ? Colors.redAccent : colorScheme.primary.withOpacity(0.4),
          ),
          enableActiveFill: true,
          onChanged: (value) {
            widget.onChanged?.call(value);
            if (value.length != 6) {
              setState(() => _errorMessage = 'Please enter a 6-digit PIN code');
            } else {
              setState(() => _errorMessage = null);
            }
          },
          beforeTextPaste: (text) => true,
        ),

        if (hasError)
          Padding(
            padding: const EdgeInsets.only(top: 10),
            child: Text(
              _errorMessage!,
              style: const TextStyle(
                  color: Colors.redAccent,
                  fontWeight: FontWeight.w500,
                  fontSize: 13
              ),
            ),
          ),

        if (_isVerifying)
          const Padding(
            padding: EdgeInsets.only(top: 15),
            child: SizedBox(
                width: 20,
                height: 20,
                child: CircularProgressIndicator(strokeWidth: 2.5)
            ),
          ),
      ],
    );
  }
}

class BuildRegisterRow extends StatelessWidget {
  const BuildRegisterRow({super.key});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          tr.dont_have_account,
          style: TextStyle(color: colorScheme.onSurface),
        ),
        GestureDetector(
          onTap: () {
            context.go('/home_register');
          },
          child: Text(
            '   ' + tr.register,
            style: TextStyle(color: colorScheme.primary, fontWeight: FontWeight.bold),
          ),
        ),
      ],
    );
  }
}

class BuildLoginRow extends StatelessWidget {
  const BuildLoginRow({super.key});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Text(
          tr.have_account,
          style: TextStyle(color: colorScheme.onSurface),
        ),
        GestureDetector(
          onTap: () {
            context.go('/login');
          },
          child: Text(
            '  '+tr.login,
            style: TextStyle(
                color: colorScheme.primary, fontWeight: FontWeight.bold
            ),
          ),
        ),
      ],
    );
  }
}

class BuildRibbon extends StatelessWidget {
  const BuildRibbon({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 200,
      decoration: const BoxDecoration(
        image: DecorationImage(
          image: AssetImage(
            'assets/icons/ribbon.png',
          ),
          fit: BoxFit.fill,
        ),
      ),
    );
  }
}

class BuildTextfield extends StatefulWidget {
  final String label;
  final String hintText;
  final IconData icon;
  final bool obscure;
  final TextInputType keyboardType;
  final bool haveSuffixEyeIcon;
  final bool onPressedForDate;
  final GlobalKey<FormState>? formKey;
  final TextEditingController? controller;
  final void Function(String)? onChanged;

  const BuildTextfield({
    super.key,
    required this.label,
    required this.hintText,
    required this.icon,
    this.obscure = false,
    this.haveSuffixEyeIcon = false,
    this.onPressedForDate = false,
    this.keyboardType = TextInputType.text,
    this.formKey,
    this.controller,
    this.onChanged,
  });

  @override
  State<BuildTextfield> createState() => _BuildTextfieldState();
}

class _BuildTextfieldState extends State<BuildTextfield> {
  late bool _obscureText;
  late final TextEditingController _internalController;

  TextEditingController get _effectiveController =>
      widget.controller ?? _internalController;

  @override
  void initState() {
    super.initState();
    _obscureText = widget.obscure;
    _internalController = TextEditingController();
  }

  @override
  void dispose() {
    _internalController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.only(left: 12, bottom: 8, right: 12),
          child: Text(
            widget.label,
            style: TextStyle(
              fontSize: 14,
              fontWeight: FontWeight.bold,
              color: colorScheme.primary.withOpacity(0.8),
              letterSpacing: 0.5,
            ),
          ),
        ),
        Container(
          decoration: BoxDecoration(
            color: colorScheme.primary.withOpacity(0.05),
            borderRadius: BorderRadius.circular(18),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.04),
                blurRadius: 16,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: TextFormField(
            controller: _effectiveController,
            obscureText: _obscureText,
            keyboardType: widget.keyboardType,
            readOnly: widget.onPressedForDate,
            style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 16),
            validator: (data) {
              if (data == null || data.isEmpty) {
                return tr.field_required;
              }
              return null;
            },
            onChanged: (data) {
              if (widget.formKey != null) {
                widget.formKey!.currentState?.validate();
              }
              if (widget.onChanged != null) widget.onChanged!(data);
            },
            onTap: widget.onPressedForDate ? _handleDatePicker : null,
            decoration: InputDecoration(
              hintText: widget.hintText,
              hintStyle: TextStyle(
                  color: colorScheme.secondary,
                  fontSize: 14,
                  fontWeight: FontWeight.w400),
              prefixIcon:
                  Icon(widget.icon, color: colorScheme.primary, size: 22),
              suffixIcon: widget.haveSuffixEyeIcon
                  ? IconButton(
                      icon: Icon(
                        _obscureText
                            ? Icons.visibility_outlined
                            : Icons.visibility_off_outlined,
                        color: colorScheme.primary.withOpacity(0.7),
                        size: 20,
                      ),
                      onPressed: () =>
                          setState(() => _obscureText = !_obscureText),
                    )
                  : null,
              filled: true,
              fillColor: Colors.transparent,
              contentPadding:
                  const EdgeInsets.symmetric(vertical: 18, horizontal: 20),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(18),
                borderSide: BorderSide(
                    color: colorScheme.outlineVariant.withOpacity(0.4),
                    width: 1.2),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(18),
                borderSide: BorderSide(color: colorScheme.primary, width: 1.5),
              ),
              errorBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(18),
                borderSide:
                    const BorderSide(color: Colors.redAccent, width: 1.2),
              ),
              focusedErrorBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(18),
                borderSide:
                    const BorderSide(color: Colors.redAccent, width: 1.5),
              ),
              errorStyle: const TextStyle(
                color: Colors.redAccent,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
        ),
        const SizedBox(height: 16),
      ],
    );
  }

  Future<void> _handleDatePicker() async {
    DateTime? pickedDate = await showDatePicker(
      context: context,
      initialDate: DateTime(2008),
      firstDate: DateTime(1900),
      lastDate: DateTime(2008),
      builder: (context, child) {
        return Theme(
          data: Theme.of(context).copyWith(
            colorScheme: ColorScheme.light(
              primary: Theme.of(context).colorScheme.primary,
              onPrimary: Theme.of(context).colorScheme.onPrimary,
              onSurface: Theme.of(context).colorScheme.onSurface,
            ),
          ),
          child: child!,
        );
      },
    );
    if (pickedDate != null) {
      final formattedDate = "${pickedDate.year.toString().padLeft(4, '0')}-"
          "${pickedDate.month.toString().padLeft(2, '0')}-"
          "${pickedDate.day.toString().padLeft(2, '0')}";
      _effectiveController.text = formattedDate;

      if (widget.formKey != null) widget.formKey!.currentState?.validate();
      if (widget.onChanged != null) widget.onChanged!(formattedDate);
    }
  }
}

class BuildVerficationCodeButton extends StatelessWidget {
  final VoidCallback? onPressed;
  const BuildVerficationCodeButton({super.key, this.onPressed});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Align(
      alignment: AlignmentDirectional.centerStart,
      child: TextButton.icon(
        onPressed: onPressed,
        icon: Icon(Icons.send, color: colorScheme.primary),
        label: Text(tr.send_code, style: TextStyle(color: colorScheme.primary)),
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\auth\under_review\under_review.dart
// =======================================================

import 'dart:async';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:malaz/presentation/global_widgets/buttons/custom_button.dart';
import 'package:modal_progress_hud_nsn/modal_progress_hud_nsn.dart';
import '../../../../core/config/color/app_color.dart';
import '../../../../l10n/app_localizations.dart';
import '../../../cubits/auth/auth_cubit.dart';

class UnderReview extends StatefulWidget {
  const UnderReview({Key? key}) : super(key: key);

  @override
  State<UnderReview> createState() => _UnderReviewState();
}

class _UnderReviewState extends State<UnderReview> {
  Timer? _timer;
  bool modalProgressHUDisOn = false;

  @override
  void initState() {
    super.initState();
    _startSilentTimer();
  }

  void _startSilentTimer() {
    _timer = Timer.periodic(const Duration(seconds: 10), (timer) {
      final state = context.read<AuthCubit>().state;
      if (state is AuthPending) {
        context.read<AuthCubit>().silentRoleCheck();
      }
    });
  }

  @override
  void dispose() {
    _timer?.cancel();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {

    return BlocListener<AuthCubit, AuthState>(
        listener: (context, state) {
          if (state is AuthAuthenticated) {
            context.go('/home');
          }
        },
        child:ModalProgressHUD(
          color: Colors.white,
          inAsyncCall: modalProgressHUDisOn,
          child: Scaffold(
            backgroundColor: Theme.of(context).scaffoldBackgroundColor,
            body: Center(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal:24.0),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  ShaderMask(
                  shaderCallback: (bounds) => AppColors.premiumGoldGradient.createShader(bounds),
                  child: Icon(
                    Icons.hourglass_top_rounded,
                    size: 80,
                    color: Colors.yellow,
                  ),
                ),
                  const SizedBox(
                  height: 16,
                ),
                  ShaderMask(
                  shaderCallback: (bounds) => AppColors.premiumGoldGradient.createShader(bounds),
                  child: Text(
                    'Your request is under review by the application administrators. We will notify you when it is approved.',
                    textAlign: TextAlign.center,
                    style: TextStyle(fontSize: 16, color: Colors.grey),
                  ),
                ),
                  const SizedBox(
                  height: 100,
                ),
                  SizedBox(
                  width: 250,
                  height: 50,
                  child: CustomButton(
                    text: 'Check Now',
                    onPressed: modalProgressHUDisOn ? null : _startSilentTimer, /// Disable the button during execution
                  ),
                ),
                  const SizedBox(
                  height: 14,
                ),
                  SizedBox(
                  width: 250,
                  height: 50,
                  child: CustomButton(
                    text: 'Log Out',
                    onPressed: () => context.read<AuthCubit>().logout(),
                  ),
                ),
                ],
              ),
            ),
          ),
        ),
      )
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\book_now\book_now_screen.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:malaz/domain/entities/apartment/apartment.dart';
import 'package:malaz/l10n/app_localizations.dart';
import 'package:shimmer/shimmer.dart';
import 'package:table_calendar/table_calendar.dart';

import '../../../data/utils/dialog.dart';
import '../../../domain/entities/booking/booking.dart';
import '../../cubits/booking/booking_cubit.dart';
import '../../global_widgets/buttons/custom_button.dart';

/// ============================================================================
/// [BookingBottomSheet]
/// Main Widget that manages the State (Logic & Data) only.
/// It delegates the UI rendering to specialized [_Build...] widgets.
/// TODO: there's an optimization on ensuring selected a valid range
/// ============================================================================
class BookingBottomSheet extends StatefulWidget {
  final Apartment apartment;

  const BookingBottomSheet({super.key, required this.apartment});

  @override
  State<BookingBottomSheet> createState() => _BookingBottomSheetState();
}

class _BookingBottomSheetState extends State<BookingBottomSheet> {
  final DateTime _firstDay = DateTime.now();
  late final DateTime _lastDay;

  DateTime? _rangeStart;
  DateTime? _rangeEnd;
  DateTime _focusedDay = DateTime.now();
  CalendarFormat _calendarFormat = CalendarFormat.month;

  @override
  void initState() {
    super.initState();
    _lastDay = DateTime.now().add(const Duration(days: 730));
    context.read<BookingCubit>().loadBookedDates(widget.apartment.id);
  }

  void _onRangeSelected(DateTime? start, DateTime? end, DateTime focusedDay) {
    setState(() {
      _focusedDay = focusedDay;
      _rangeStart = start;
      _rangeEnd = end;
    });
  }

  void _onDaySelected(DateTime selectedDay, DateTime focusedDay) {
    if (!isSameDay(_rangeStart, selectedDay)) {
      setState(() {
        _focusedDay = focusedDay;
        _rangeStart = selectedDay;
        _rangeEnd = null;
        _calendarFormat = CalendarFormat.month;
      });
    }
  }

  void _onPageChanged(DateTime focusedDay) {
    _focusedDay = focusedDay;
  }

  void _onConfirmBooking(Apartment apartment) {
    if (_rangeStart == null || _rangeEnd == null) return;
    int nights = _rangeEnd!.difference(_rangeStart!).inDays;
    int finalTotalPrice = nights * apartment.price;
    context.read<BookingCubit>().makeBook(
      Booking(
        propertyId: apartment.id,
        checkIn: _rangeStart!,
        checkOut: _rangeEnd!,
        totalPrice: finalTotalPrice.toString()
      )
    );
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return BlocListener<BookingCubit, BookingState>(
      listener: (context, state) {
        if (state is SendingBooking) {
          showLoadingDialog(context);
        } else if (state is SentBooking) {
          context.pop();

          showSuccessDialog(context, () {
            context.pop();
          });
        } else if (state is SendingBookingError) {
          context.pop();

          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(state.message),
              backgroundColor: Colors.red,
              behavior: SnackBarBehavior.floating,
            ),
          );

          context.read<BookingCubit>().loadBookedDates(widget.apartment.id);
        }
      },
      child: Container(
        height: MediaQuery.of(context).size.height * 0.85,
        decoration: BoxDecoration(
          color: theme.scaffoldBackgroundColor,
          borderRadius: const BorderRadius.vertical(top: Radius.circular(30)),
        ),
        child: Column(
          children: [
            const _BuildDragHandle(),
            const _BuildHeader(),
            Expanded(
              child: SingleChildScrollView(
                child: BlocBuilder<BookingCubit, BookingState>(
                  buildWhen: (previous, current) {
                    return current is! SendingBooking &&
                        current is! SentBooking &&
                        current is! SendingBookingError;
                  },
                  builder: (context, state) {
                    if (state is BookingLoading) {
                      return const Center(child: _BuildShimmerCalendar());
                    }
                    if (state is BookingLoaded) {
                      return _BuildCalendar(
                        firstDay: _firstDay,
                        lastDay: _lastDay,
                        focusedDay: _focusedDay,
                        rangeStart: _rangeStart,
                        rangeEnd: _rangeEnd,
                        calendarFormat: _calendarFormat,
                        bookedDays: state.bookedDays,
                        onDaySelected: _onDaySelected,
                        onRangeSelected: _onRangeSelected,
                        onPageChanged: _onPageChanged,
                      );
                    }
                    if (state is BookingError) {
                      return const _BuildCalendarErrorView();
                    }
                    return const SizedBox.shrink();
                  },
                ),
              ),
            ),
            _BuildBottomSummary(
              apartment: widget.apartment,
              rangeStart: _rangeStart,
              rangeEnd: _rangeEnd,
              onConfirm: _onConfirmBooking,
            ),
          ],
        ),
      ),
    );
  }
}

/// ============================================================================
/// [UI_BUILDING_WIDGETS]
/// Separated components for cleaner code.
/// ============================================================================

/// [_BuildDragHandle]
/// The small grey bar at the top indicating the sheet is draggable.
class _BuildDragHandle extends StatelessWidget {
  const _BuildDragHandle();

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Container(
        margin: const EdgeInsets.only(top: 12, bottom: 8),
        width: 50,
        height: 10,
        decoration: BoxDecoration(
          color: Colors.grey.withOpacity(0.3),
          borderRadius: BorderRadius.circular(10),
        ),
      ),
    );
  }
}

/// [_BuildHeader]
/// Contains the title "Select Dates" and the close button.
class _BuildHeader extends StatelessWidget {
  const _BuildHeader();

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [],
      ),
    );
  }
}

/// [_BuildCalendar]
/// The core calendar widget wrapping [TableCalendar].
/// Handles styling and interaction callbacks.
class _BuildCalendar extends StatelessWidget {
  final DateTime firstDay;
  final DateTime lastDay;
  final DateTime focusedDay;
  final DateTime? rangeStart;
  final DateTime? rangeEnd;
  final CalendarFormat calendarFormat;
  final List<DateTime> bookedDays;

  final Function(DateTime, DateTime) onDaySelected;
  final Function(DateTime?, DateTime?, DateTime) onRangeSelected;
  final Function(DateTime) onPageChanged;

  const _BuildCalendar({
    required this.firstDay,
    required this.lastDay,
    required this.focusedDay,
    required this.rangeStart,
    required this.rangeEnd,
    required this.calendarFormat,
    required this.bookedDays,
    required this.onDaySelected,
    required this.onRangeSelected,
    required this.onPageChanged,
  });

  bool _isDayBooked(DateTime day) {
    for (DateTime bookedDate in bookedDays) {
      if (isSameDay(day, bookedDate)) return true;
    }
    return false;
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      child: TableCalendar(
        firstDay: firstDay,
        lastDay: lastDay,
        focusedDay: focusedDay,
        calendarFormat: calendarFormat,
        rangeStartDay: rangeStart,
        rangeEndDay: rangeEnd,
        rangeSelectionMode: RangeSelectionMode.toggledOn,
        startingDayOfWeek: StartingDayOfWeek.saturday,
        headerStyle: HeaderStyle(
          titleCentered: true,
          formatButtonVisible: false,
          titleTextStyle: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.bold,
            color: theme.colorScheme.primary,
          ),
          leftChevronIcon:
              Icon(Icons.chevron_left, color: theme.colorScheme.tertiary),
          rightChevronIcon:
              Icon(Icons.chevron_right, color: theme.colorScheme.tertiary),
        ),
        calendarStyle: CalendarStyle(
          rangeHighlightColor: theme.colorScheme.tertiary.withOpacity(0.2),
          todayDecoration: BoxDecoration(
            color: theme.colorScheme.primary.withOpacity(0.5),
            shape: BoxShape.circle,
          ),
          selectedDecoration: BoxDecoration(
            color: theme.colorScheme.tertiary,
            shape: BoxShape.circle,
          ),
        ),
        selectedDayPredicate: (day) => isSameDay(rangeStart, day),
        onDaySelected: onDaySelected,
        onRangeSelected: onRangeSelected,
        onPageChanged: onPageChanged,

        /// TODO: we can optimize this, due to time pressure lets lay on it :(
        enabledDayPredicate: (day) {
          if (day.isBefore(DateTime.now().subtract(const Duration(days: 1)))) {
            return false;
          }
          if (_isDayBooked(day)) return false;
          if (rangeStart == null) {
            return true;
          }
          if (rangeStart != null && rangeEnd != null) {
            return true;
          }
          if (rangeStart != null) {
            for (var booked in bookedDays) {
              if (booked.isBefore(rangeStart!)) {
                if (day.isBefore(rangeStart!) && day.isBefore(booked)) {
                  return false;
                }
              } else {
                if (day.isAfter(rangeStart!) && day.isAfter(booked)) {
                  return false;
                }
              }
            }
          }
          return true;
        },
        calendarBuilders: CalendarBuilders(
          disabledBuilder: (context, day, focusedDay) {
            return Container(
              margin: const EdgeInsets.all(4.0),
              alignment: Alignment.center,
              decoration: BoxDecoration(
                color: Colors.grey.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Text(
                '${day.day}',
                style: const TextStyle(
                  color: Colors.grey,
                  decoration: TextDecoration.lineThrough,
                ),
              ),
            );
          },
          rangeStartBuilder: (context, day, focusedDay) {
            return Container(
              margin: const EdgeInsets.all(4.0),
              alignment: Alignment.center,
              decoration: BoxDecoration(
                color: theme.colorScheme.tertiary,
                shape: BoxShape.circle,
              ),
              child: Text(
                '${day.day}',
                style: const TextStyle(
                    color: Colors.white, fontWeight: FontWeight.bold),
              ),
            );
          },
          rangeEndBuilder: (context, day, focusedDay) {
            return Container(
              margin: const EdgeInsets.all(4.0),
              alignment: Alignment.center,
              decoration: BoxDecoration(
                color: theme.colorScheme.tertiary,
                shape: BoxShape.circle,
              ),
              child: Text(
                '${day.day}',
                style: const TextStyle(
                    color: Colors.white, fontWeight: FontWeight.bold),
              ),
            );
          },
        ),
      ),
    );
  }
}

/// [_BuildShimmerCalendar]
/// A skeleton loading effect mimicking the actual calendar layout.
class _BuildShimmerCalendar extends StatelessWidget {
  const _BuildShimmerCalendar();

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final baseColor = theme.brightness == Brightness.dark
        ? Colors.grey[800]!
        : Colors.grey[300]!;
    final highlightColor = theme.brightness == Brightness.dark
        ? Colors.grey[700]!
        : Colors.grey[100]!;

    return Shimmer.fromColors(
      baseColor: baseColor,
      highlightColor: highlightColor,
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 16.0),
        child: Column(
          children: [
            Padding(
              padding: const EdgeInsets.symmetric(vertical: 10.0),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const CircleAvatar(radius: 15),
                  Container(
                    width: 120,
                    height: 20,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(4),
                    ),
                  ),
                  const CircleAvatar(radius: 15),

                ],
              ),
            ),

            const SizedBox(height: 10),

            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: List.generate(7, (index) =>
                  Container(
                    width: 30,
                    height: 15,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(4),
                    ),
                  )
              ),
            ),

            const SizedBox(height: 10),

            Column(
              children: List.generate(5, (rowIndex) =>
                  Padding(
                    padding: const EdgeInsets.only(bottom: 8.0),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: List.generate(7, (colIndex) =>
                      const CircleAvatar(
                        radius: 20,
                        backgroundColor: Colors.white,
                      )
                      ),
                    ),
                  )
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/// [_BuildCalendarErrorView]
/// Displays a user-friendly error message with a retry button.
class _BuildCalendarErrorView extends StatelessWidget {

  const _BuildCalendarErrorView();

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context);

    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24.0),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(
              Icons.calendar_today_outlined,

              size: 64,
              color: theme.colorScheme.error.withOpacity(0.5),
            ),
            const SizedBox(height: 16),
            Text(
              l10n.unexpected_error_message,
              style: theme.textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.bold,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 8),
            Text(
              l10n.unexpected_error_message,
              style: theme.textTheme.bodyMedium?.copyWith(
                color: Colors.grey,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 24),
          ],
        ),
      ),
    );
  }
}

/// [_BuildBottomSummary]
/// The footer section showing price calculation and the confirm button.
class _BuildBottomSummary extends StatelessWidget {
  final Apartment apartment;
  final DateTime? rangeStart;
  final DateTime? rangeEnd;
  final Function(Apartment) onConfirm;

  const _BuildBottomSummary({
    required this.apartment,
    required this.rangeStart,
    required this.rangeEnd,
    required this.onConfirm,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    int nights = 0;
    if (rangeStart != null && rangeEnd != null) {
      nights = rangeEnd!.difference(rangeStart!).inDays;
    }
    int totalPrice = nights * apartment.price;

    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: theme.cardColor,
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, -5),
          )
        ],
      ),
      child: SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      nights > 0
                          ? '$nights ${AppLocalizations.of(context).nights}'
                          : AppLocalizations.of(context).book_now,
                      style: theme.textTheme.bodyMedium
                          ?.copyWith(color: Colors.grey),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '\$${totalPrice.toStringAsFixed(0)}',
                      style: theme.textTheme.headlineSmall?.copyWith(
                        fontWeight: FontWeight.bold,
                        color: theme.colorScheme.primary,
                      ),
                    ),
                  ],
                ),
                SizedBox(
                  width: 150,
                  child: CustomButton(
                    text: AppLocalizations.of(context).confirm_booking,
                    onPressed: (nights > 0) ? () => onConfirm(apartment) : null,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\chats\chats_screen.dart
// =======================================================

import 'dart:developer';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:pusher_channels_flutter/pusher_channels_flutter.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import 'package:shimmer/shimmer.dart';
import '../../../core/config/color/app_color.dart';
import '../../../core/service_locator/service_locator.dart';
import '../../../data/datasources/local/auth/auth_local_data_source.dart';
import '../../../data/models/chat/conversation_model.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/chat/chat_cubit.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../cubits/chat/pusher_service/pusher_service.dart';
import '../../global_widgets/glowing_key/build_glowing_key.dart';
import '../../global_widgets/user_profile_image/user_profile_image.dart';

class ChatsScreen extends StatefulWidget {
  const ChatsScreen({Key? key}) : super(key: key);

  @override
  State<ChatsScreen> createState() => _ChatsScreenState();
}

class _ChatsScreenState extends State<ChatsScreen> {
  @override
  void initState() {
    super.initState();
    _setupPusherListener();
  }

  void _setupPusherListener() async {
    final myUser = _getCurrentUser(context);
    String? token = await sl<AuthLocalDatasource>().getCachedToken();

    if (myUser == null || token == null) return;

    await PusherService().init(token: token);

    await PusherService().subscribe(
      channelName: 'private-user.${myUser.id}',
      onEvent: (event) {
        log("List Event: ${event.eventName}");
        context.read<ChatCubit>().getConversations();
      },
    );
  }

  @override
  void dispose() {
    final myUser = _getCurrentUser(context);
    if (myUser != null) {
      PusherChannelsFlutter.getInstance().unsubscribe(channelName: 'private-conversations.${myUser.id}');
    }
    super.dispose();
  }

  UserEntity? _getCurrentUser(BuildContext context) {
    final authState = context.read<AuthCubit>().state;
    if (authState is AuthAuthenticated) return authState.user;
    if (authState is AuthPending) return authState.user;
    return null;
  }

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;

    final isDark = Theme.of(context).brightness == Brightness.dark;
    final myUser = _getCurrentUser(context);

    return BlocProvider(
      create: (context) => sl<ChatCubit>()..getConversations(),
      child: Scaffold(
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
        body: BlocBuilder<ChatCubit, ChatState>(
          builder: (context, state) {
            return RefreshIndicator(
              color: colorScheme.primary,
              onRefresh: () async => await context.read<ChatCubit>().getConversations(),
              child: CustomScrollView(
                physics: const AlwaysScrollableScrollPhysics(parent: BouncingScrollPhysics()),
                slivers: [
                  _buildAppBar(context, isDark, tr, colorScheme),
                  SliverToBoxAdapter(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _BuildHeader(title: tr.active_partners,colorScheme: colorScheme),
                        _buildActivitySection(state, isDark, myUser?.id),
                        _BuildHeader(title: tr.recent_messages,colorScheme: colorScheme),
                      ],
                    ),
                  ),
                  _buildMessagesContent(state, isDark, myUser?.id, tr, colorScheme),
                  const SliverToBoxAdapter(child: SizedBox(height: 100)),
                ],
              ),
            );
          },
        ),
      ),
    );
  }

  Widget _buildAppBar(BuildContext context, bool isDark, AppLocalizations tr, ColorScheme colorScheme) {
    return SliverAppBar(
      expandedHeight: 100,
      floating: true,
      pinned: true,
      elevation: 0,
      backgroundColor: Colors.transparent,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(
          bottom: Radius.circular(32),
        ),
      ),
      flexibleSpace: FlexibleSpaceBar(
        background: ClipRRect(
          borderRadius: const BorderRadius.vertical(bottom: Radius.circular(32)),
          child: Stack(
            fit: StackFit.expand,
            children: [
              Container(decoration: const BoxDecoration(gradient: AppColors.premiumGoldGradient2)),
              PositionedDirectional(
                top: -20,
                start: -40,
                child: const BuildGlowingKey(size: 180,opacity:  0.15, rotation: -0.2),
              ),

              PositionedDirectional(
                bottom: 40,
                end: -10,
                child: const BuildGlowingKey(size: 140,opacity:  0.12,rotation:  0.5),
              ),
              Positioned(
                bottom: 16,
                left: 20,
                right: 20,
                child: Text(
                  tr.malaz_chat,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.w900,
                    fontSize: 32,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
      actions: [
        _buildActionIcon(Icons.search_rounded),
        const SizedBox(width: 16),
      ],
    );
  }

  Widget _buildActionIcon(IconData icon) {
    return Container(
      margin: const EdgeInsets.only(top: 10),
      decoration: BoxDecoration(color: Colors.white.withOpacity(0.15), shape: BoxShape.circle),
      child: IconButton(
        icon: Icon(icon, color: Colors.white, size: 22),
        onPressed: () {},
      ),
    );
  }

  Widget _buildActivitySection(ChatState state, bool isDark, int? myId) {
    if (state is ChatLoading) return _buildHorizontalShimmer(isDark);
    if (state is ChatConversationsLoaded) {
      return _BuildActivitiesSection(conversations: state.conversations, isDark: isDark, myId: myId);
    }
    return const SizedBox(height: 110);
  }

  Widget _buildMessagesContent(ChatState state, bool isDark, int? myId, AppLocalizations tr, colorScheme) {
    if (state is ChatLoading) return _BuildShimmerList(isDark: isDark);
    if (state is ChatConversationsLoaded) {
      if (state.conversations.isEmpty) {
        return SliverToBoxAdapter(
          child: Center(child: Padding(padding: EdgeInsets.only(top: 80), child: Center(child: Text(tr.no_conversations)))),
        );
      }
      return _BuildMessagesList(conversations: state.conversations, isDark: isDark, myId: myId, colorScheme: colorScheme,);
    }
    if (state is ChatConversationsError) {
      return SliverToBoxAdapter(child: Center(child: Text(state.message, style: const TextStyle(color: Colors.red))));
    }
    return const SliverToBoxAdapter(child: SizedBox());
  }

  Widget _buildHorizontalShimmer(bool isDark) {
    return SizedBox(
      height: 115,
      child: Shimmer.fromColors(
        baseColor: isDark ? Colors.grey[900]! : Colors.grey[300]!,
        highlightColor: isDark ? Colors.grey[800]! : Colors.grey[100]!,
        child: ListView.builder(
          scrollDirection: Axis.horizontal,
          padding: const EdgeInsets.symmetric(horizontal: 16),
          itemCount: 5,
          itemBuilder: (_, __) => Padding(
            padding: const EdgeInsets.only(right: 18),
            child: Column(
              children: [
                Container(
                  width: 60,
                  height: 60,
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(22),
                  ),
                ),
                const SizedBox(height: 8),
                Container(
                  width: 40,
                  height: 10,
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(5),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _BuildActivitiesSection extends StatelessWidget {
  final List<ConversationModel> conversations;
  final bool isDark;
  final int? myId;
  const _BuildActivitiesSection({required this.conversations, required this.isDark, this.myId});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    return SizedBox(
      height: 115,
      child: ListView.builder(
        scrollDirection: Axis.horizontal,
        padding: const EdgeInsets.symmetric(horizontal: 16),
        itemCount: conversations.length,
        itemBuilder: (context, index) {
          final otherUser = conversations[index].userOneId == myId ? conversations[index].userTwo : conversations[index].userOne;
          return Padding(
            padding: const EdgeInsets.only(right: 18),
            child: Column(
              children: [
                Container(
                  padding: const EdgeInsets.all(2.5),
                  decoration: BoxDecoration(
                    gradient: AppColors.premiumGoldGradient,
                    borderRadius: BorderRadius.circular(22),
                  ),
                  child: UserProfileImage(
                    userId: otherUser!.id,
                    firstName: otherUser.first_name,
                    lastName: otherUser.last_name,
                    radius: 28,
                    isPremiumStyle: true,
                  ),
                ),
                const SizedBox(height: 8),
                Text(otherUser.first_name,
                    style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: colorScheme.onSurface)),
              ],
            ),
          );
        },
      ),
    );
  }
}

class _BuildMessagesList extends StatelessWidget {
  final List<ConversationModel> conversations;
  final bool isDark;
  final ColorScheme colorScheme;
  final int? myId;

  const _BuildMessagesList({required this.conversations, required this.isDark, required this.colorScheme, this.myId});

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;

    return SliverPadding(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      sliver: SliverList(
        delegate: SliverChildBuilderDelegate((context, index) {
          final conv = conversations[index];
          final otherUser = conv.userOneId == myId ? conv.userTwo : conv.userOne;

          return Padding(
            padding: const EdgeInsets.only(bottom: 14),
            child: Dismissible(
              key: Key(conv.id.toString()),
              direction: DismissDirection.endToStart,
              confirmDismiss: (direction) async {
                HapticFeedback.heavyImpact();
                return await _showDeleteConfirm(context);
              },
              onDismissed: (_) => context.read<ChatCubit>().deleteConversation(conv.id),
              background: Container(
                padding: const EdgeInsets.symmetric(horizontal: 20),
                alignment: Alignment.centerRight,
                decoration: BoxDecoration(color: colorScheme.error.withOpacity(0.8), borderRadius: BorderRadius.circular(24)),
                child: const Icon(Icons.delete_outline_rounded, color: Colors.white, size: 28),
              ),
              child: InkWell(
                onTap: () {
                  context.read<ChatCubit>().markMessageAsRead(conv.id);
                  context.push('/one_chat', extra: {
                    'id': conv.id,
                    'firstName': otherUser!.first_name,
                    'lastName': otherUser.last_name,
                    'otherUserId': otherUser.id,
                  });
                },
                borderRadius: BorderRadius.circular(24),
                child: Container(
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
                  decoration: BoxDecoration(
                    color: colorScheme.surface,
                    borderRadius: BorderRadius.circular(24),
                    border: Border.all(color: colorScheme.primary.withOpacity(0.05)),
                    boxShadow: [
                      BoxShadow(color: Colors.black.withOpacity(isDark ? 0.2 : 0.03), blurRadius: 15, offset: const Offset(0, 5))
                    ],
                  ),
                  child: Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(2.5),
                        decoration: BoxDecoration(
                          gradient: AppColors.premiumGoldGradient,
                          borderRadius: BorderRadius.circular(22),
                        ),
                        child: UserProfileImage(
                          userId: otherUser!.id,
                          firstName: otherUser.first_name,
                          lastName: otherUser.last_name,
                          radius: 25,
                          isPremiumStyle: true,
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                                '${otherUser.first_name} ${otherUser.last_name}',
                                style: TextStyle(fontWeight: FontWeight.w800, fontSize: 16, color: colorScheme.onSurface)
                            ),
                            const SizedBox(height: 4),
                            Text(
                                tr.click_to_view,
                                style: TextStyle(fontSize: 12, color: colorScheme.onSurface.withOpacity(0.5))
                            ),
                          ],
                        ),
                      ),
                      _buildTrailing(conv, tr, colorScheme),
                    ],
                  ),
                ),
              ),
            ),
          );
        }, childCount: conversations.length),
      ),
    );
  }

  Widget _buildTrailing(ConversationModel conv, AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.center,
      crossAxisAlignment: CrossAxisAlignment.end,
      children: [
        Text(
            conv.unreadCount > 0 ? tr.new_messages : tr.active,
            style: TextStyle(
                fontSize: 10,
                color: conv.unreadCount > 0 ? colorScheme.primary : Colors.green,
                fontWeight: FontWeight.bold
            )
        ),
        const SizedBox(height: 8),
        if (conv.unreadCount > 0)
          TweenAnimationBuilder<double>(
            tween: Tween(begin: 0.0, end: 1.0),
            duration: const Duration(milliseconds: 500),
            builder: (context, value, child) => Transform.scale(
              scale: value,
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                    gradient: AppColors.premiumGoldGradient,
                    borderRadius: BorderRadius.circular(10),
                    boxShadow: [
                      BoxShadow(color: AppColors.primaryLight.withOpacity(0.3), blurRadius: 8)
                    ]
                ),
                child: Text('${conv.unreadCount}', style: const TextStyle(color: Colors.white, fontSize: 10, fontWeight: FontWeight.bold)),
              ),
            ),
          )
        else
          Icon(Icons.done_all_rounded, size: 18, color: colorScheme.primary.withOpacity(0.4)),
      ],
    );
  }

  Future<bool?> _showDeleteConfirm(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;

    return showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
        backgroundColor: Theme.of(context).scaffoldBackgroundColor,
        title: Row(
          children: [
            const Icon(Icons.delete_sweep_rounded, color: Colors.redAccent),
            const SizedBox(width: 10),
            Text(tr.delete_chat_title,
                style: TextStyle(color: colorScheme.onSurface, fontWeight: FontWeight.bold)),
          ],
        ),
        content: Text(tr.delete_chat_confirm,
            style: TextStyle(color: colorScheme.onSurface.withOpacity(0.7))),
        actionsPadding: const EdgeInsets.symmetric(horizontal: 16),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context, false),
            child: Text(tr.cancel,
                style: TextStyle(color: colorScheme.onSurface.withOpacity(0.5), fontWeight: FontWeight.bold)),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, true),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.redAccent,
              foregroundColor: Colors.white,
              elevation: 0,
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
            ),
            child: Text(tr.delete, style: const TextStyle(fontWeight: FontWeight.bold)),
          ),
        ],
      ),
    );
  }
}

class _BuildShimmerList extends StatelessWidget {
  final bool isDark;
  const _BuildShimmerList({required this.isDark});

  @override
  Widget build(BuildContext context) {
    final skeletonColor = isDark ? Colors.grey[800]! : Colors.grey[300]!;
    final highlightColor = isDark ? Colors.grey[700]! : Colors.grey[100]!;

    return SliverPadding(
      padding: const EdgeInsets.symmetric(horizontal: 16),
      sliver: SliverList(
        delegate: SliverChildBuilderDelegate(
              (context, index) => Shimmer.fromColors(
            baseColor: skeletonColor,
            highlightColor: highlightColor,
            child: Padding(
              padding: const EdgeInsets.only(bottom: 14),
              child: Row(
                children: [
                  Container(
                    width: 60,
                    height: 60,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(22),
                    ),
                  ),
                  const SizedBox(width: 16),

                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Container(
                          width: 120,
                          height: 12,
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(6),
                          ),
                        ),
                        const SizedBox(height: 12),
                        Container(
                          width: double.infinity,
                          height: 10,
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(6),
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(width: 20),

                  Container(
                    width: 30,
                    height: 10,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(5),
                    ),
                  ),
                ],
              ),
            ),
          ),
          childCount: 6,
        ),
      ),
    );
  }
}

class _BuildHeader extends StatelessWidget {
  final String title;
  final ColorScheme colorScheme;
  const _BuildHeader({required this.title, required this.colorScheme});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.fromLTRB(22, 28, 22, 16),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(title, style: TextStyle(color: colorScheme.primary, fontSize: 19, fontWeight: FontWeight.w900)),
          Icon(Icons.arrow_forward_ios_rounded, size: 14, color: Theme.of(context).colorScheme.primary),
        ],
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\chats\ChatWithAPerson.dart
// =======================================================

import 'dart:convert';
import 'dart:developer';
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:intl/intl.dart';
import 'package:shimmer/shimmer.dart';
import '../../../core/config/color/app_color.dart';
import '../../../core/service_locator/service_locator.dart';
import '../../../data/datasources/local/auth/auth_local_data_source.dart';
import '../../../data/models/chat/chat_message_model.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/chat/chat_cubit.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../cubits/chat/pusher_service/pusher_service.dart';
import '../../global_widgets/user_profile_image/user_profile_image.dart';

class ChatWithAPerson extends StatefulWidget {
  final int conversationId;
  final String firstName;
  final String lastName;
  final int otherUserId;

  const ChatWithAPerson({
    super.key,
    required this.conversationId,
    required this.firstName,
    required this.lastName,
    required this.otherUserId,
  });

  @override
  State<ChatWithAPerson> createState() => _ChatWithAPersonState();
}

class _ChatWithAPersonState extends State<ChatWithAPerson> {
  final TextEditingController _messageController = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  ChatMessageModel? _editingMessage;
  int? myId;
  String? _currentSubscribedChannel;

  int? _getMyId(BuildContext context) {
    final state = context.read<AuthCubit>().state;
    if (state is AuthAuthenticated) return state.user.id;
    if (state is AuthPending) return state.user.id;
    return null;
  }

  void _onSendMessage(BuildContext context, int myId, {int? overrideId}) {
    final text = _messageController.text.trim();
    if (text.isEmpty) return;

    final chatCubit = context.read<ChatCubit>();

    int finalId = overrideId ?? -1;
    if (finalId == -1 && chatCubit.state is ChatMessagesLoaded) {
      finalId = (chatCubit.state as ChatMessagesLoaded).conversationId;
    }
    if (finalId == -1) finalId = widget.conversationId;

    if (finalId != -1) {
      chatCubit.sendMessage(finalId, text, myId);
      _messageController.clear();
      _scrollToBottom();
    }
  }

  void _scrollToBottom() {
    if (_scrollController.hasClients) {
      _scrollController.animateTo(0.0,
          duration: const Duration(milliseconds: 300), curve: Curves.easeOut);
    }
  }

  @override
  @override
  void initState() {
    super.initState();
    final authState = context.read<AuthCubit>().state;
    if (authState is AuthAuthenticated) myId = authState.user.id;

    context.read<ChatCubit>().getMessages(widget.conversationId);
    _connectToPusher();
  }

  void _connectToPusher() async {
    String? token = await sl<AuthLocalDatasource>().getCachedToken();
    if (token == null) return;

    await PusherService().init(token: token);

    _subscribeToCurrentConversation();
  }

  void _subscribeToCurrentConversation([int? overrideId]) async {
    final int idToSubscribe = overrideId ?? widget.conversationId;

    if (idToSubscribe <= 0) {
      log(">>>> Skipping Pusher subscription: Conversation not created yet.");
      return;
    }
    final channelName = "private-conversations.$idToSubscribe";

    if (_currentSubscribedChannel == channelName) return;

    if (_currentSubscribedChannel != null) {
      log(">>>> Unsubscribing from old channel: $_currentSubscribedChannel");
      await PusherService().unsubscribe(_currentSubscribedChannel!);
    }

    log(">>>> Attempting to subscribe to: $channelName");

    await PusherService().subscribe(
      channelName: channelName,
      onEvent: (event) {
        log(">>>> Event Received in UI: ${event.eventName}");

        if (event.eventName == "pusher:subscription_succeeded") return;

        try {
          final Map<String, dynamic> data = jsonDecode(event.data);
          if (mounted) {
            context.read<ChatCubit>().handlePusherEvent(event.eventName, data);
          }
        } catch (e) {
          log(">>>> UI Parsing Error: $e");
        }
      },
    );

    _currentSubscribedChannel = channelName;
  }

  @override
  void dispose() {
    if (_currentSubscribedChannel != null) {
      PusherService().unsubscribe(_currentSubscribedChannel!);
    }
    _messageController.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final bgColor = isDark ? const Color(0xFF121318) : const Color(0xFFFAF8F5);
    final myId = _getMyId(context);

    final screenSize = MediaQuery.of(context).size;

    return Builder(
      builder: (childContext) {
        final tr = AppLocalizations.of(childContext)!;
        return Scaffold(
          backgroundColor: bgColor,
          resizeToAvoidBottomInset: true,
          body: Stack(
            children: [
              Positioned.fill(
                child: IgnorePointer(
                  child: SizedBox(
                    width: screenSize.width,
                    height: screenSize.height,
                    child: Opacity(
                      opacity: isDark ? 0.1 : 0.2,
                      child: Transform.rotate(
                        angle: 0.36,
                        child: GridView.builder(
                          physics: const NeverScrollableScrollPhysics(),
                          gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                            crossAxisCount: 4,
                            mainAxisSpacing: 60,
                            crossAxisSpacing: 60,
                          ),
                          itemBuilder: (context, index) {
                            return Transform.rotate(
                              angle: (index % 2 == 0) ? 0.3 : -0.3,
                              child: Image.asset(
                                'assets/icons/key_logo.png',
                                color: isDark ? colorScheme.primary : const Color(0xFFAF895F),
                                fit: BoxFit.contain,
                              ),
                            );
                          },
                          itemCount: 60,
                        ),
                      ),
                    ),
                  ),
                ),
              ),

              Column(
                children: [
                  _buildAppBar(childContext, isDark),
                  Expanded(
                    child: BlocConsumer<ChatCubit, ChatState>(
                        listener: (context, state) {
                          if (state is ChatMessagesLoaded) {

                            final channelName = "private-conversations.${state.conversationId}";
                            if (_currentSubscribedChannel != channelName) {
                              log("🔄 New Conversation detected (${state.conversationId}), re-subscribing...");
                              _subscribeToCurrentConversation(state.conversationId);
                            }

                            if (state.messages.isNotEmpty) {
                              if (myId == null) return;

                              final unreadMessages = state.messages.where((msg) =>
                              msg.senderId != myId && msg.readAt == null).toList();

                              if (unreadMessages.isNotEmpty) {
                                if (!mounted) return;
                                for (var msg in unreadMessages) {
                                  context.read<ChatCubit>().markMessageAsRead(msg.id);
                                }
                              }
                            }
                          }
                        },
                        builder: (context, state) {
                          List<ChatMessageModel> messages = [];

                          if (state is ChatMessagesLoaded) {
                            messages = state.messages;
                          } else {
                            messages = context.read<ChatCubit>().allMessages;
                          }

                          if (state is ChatMessagesInitialLoading && messages.isEmpty) {
                            return _buildShimmerMessages(isDark);
                          }

                          if (messages.isNotEmpty) {
                            return ListView.builder(
                              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 20),
                              controller: _scrollController,
                              reverse: true,
                              itemCount: messages.length,
                              itemBuilder: (context, index) {
                                final msg = messages[index];
                                return ChatBubble(
                                  message: msg,
                                  isMe: msg.senderId == myId,
                                  onLongPress: () => _showMessageActions(childContext, msg, msg.senderId == myId, tr),
                                  isSameUser: index > 0 && messages[index].senderId == messages[index - 1].senderId,
                                );
                              },
                            );
                          }

                          return const SizedBox();
                        }
                    ),
                  ),
                  _buildMessageInput(childContext, isDark, myId ?? 0, tr),
                ],
              ),
            ],
          ),
        );
      },
    );
  }

  PreferredSizeWidget _buildAppBar(BuildContext context, bool isDark) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;

    return AppBar(
      elevation: 0,
      toolbarHeight: 120,
      automaticallyImplyLeading: false,
      backgroundColor: Colors.transparent,
      flexibleSpace: Container(
        decoration: const BoxDecoration(
          gradient: AppColors.premiumGoldGradient2,
          borderRadius: BorderRadius.vertical(bottom: Radius.circular(30)),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 15,
              offset: Offset(0, 5),
            )
          ],
        ),
        child: Stack(
          clipBehavior: Clip.none,
          children: [
            PositionedDirectional(
              top: -10,
              start: -20,
              child: _buildGlowingKey(100, 0.12, -0.2),
            ),
            PositionedDirectional(
              bottom: -10,
              end: 20,
              child: _buildGlowingKey(80, 0.1, 0.5),
            ),

            SafeArea(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 8.0,vertical: 12),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => context.pop(),
                      icon: const Icon(Icons.arrow_back_ios_new_rounded, color: Colors.white, size: 20),
                    ),
                    UserProfileImage(
                      userId: widget.otherUserId,
                      firstName: widget.firstName,
                      lastName: widget.lastName,
                      radius: 22,
                      isPremiumStyle: true,
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            '${widget.firstName} ${widget.lastName}',
                            style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 17,
                              color: Colors.white,
                            ),
                          ),
                          const SizedBox(height: 2),
                          Row(
                            children: [
                              Container(
                                width: 8,
                                height: 8,
                                decoration: const BoxDecoration(
                                  color: Colors.greenAccent,
                                  shape: BoxShape.circle,
                                  boxShadow: [BoxShadow(color: Colors.greenAccent, blurRadius: 4)],
                                ),
                              ),
                              const SizedBox(width: 6),
                              Text(
                                tr.online_now,
                                style: const TextStyle(
                                  fontSize: 12,
                                  color: Colors.white70,
                                  fontWeight: FontWeight.w500,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.more_vert_rounded, color: Colors.white),
                      onPressed: () {},
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildGlowingKey(double size, double opacity, double rotation) {
    return Opacity(
      opacity: opacity,
      child: Transform.rotate(
        angle: rotation,
        child: Image.asset(
          'assets/icons/key_logo.png',
          width: size,
          height: size,
          color: Colors.white,
        ),
      ),
    );
  }

  Widget _buildMessageInput(BuildContext context, bool isDark, int myId, AppLocalizations tr) {
    return Container(
      padding: const EdgeInsets.fromLTRB(16, 8, 16, 25),
      decoration: BoxDecoration(
        color: Theme.of(context).scaffoldBackgroundColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(25)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          if (_editingMessage != null)
            Padding(
              padding: const EdgeInsets.only(bottom: 8.0),
              child: Row(
                children: [
                  const Icon(Icons.edit, size: 14, color: Color(0xFFAF895F)),
                  const SizedBox(width: 5),
                  Text(tr.editing_message_hint, style: TextStyle(fontSize: 12, fontStyle: FontStyle.italic)),
                  const Spacer(),
                  IconButton(icon: const Icon(Icons.close, size: 16), onPressed: () => setState(() => _editingMessage = null)),
                ],
              ),
            ),
          Row(
            children: [
              Expanded(
                child: Container(
                  padding: const EdgeInsets.symmetric(horizontal: 15),
                  decoration: BoxDecoration(
                    color: isDark ? Colors.white.withOpacity(0.08) : Colors.grey[100],
                    borderRadius: BorderRadius.circular(25),
                  ),
                  child: TextField(
                    controller: _messageController,
                    maxLines: null,
                    decoration: InputDecoration(hintText: tr.type_message_hint, border: InputBorder.none),
                  ),
                ),
              ),
              const SizedBox(width: 10),
              GestureDetector(
                onTap: () async {
                  final text = _messageController.text.trim();
                  if (text.isEmpty) return;

                  if (_editingMessage != null) {
                    context.read<ChatCubit>().editMessage(_editingMessage!.id, text);
                    setState(() => _editingMessage = null);
                    _messageController.clear();
                  } else {
                    final myIdValue = myId ?? 0;
                    final chatCubit = context.read<ChatCubit>();
                    final text = _messageController.text.trim();

                    if (text.isEmpty) return;

                    int currentId = -1;
                    if (chatCubit.state is ChatMessagesLoaded) {
                      currentId = (chatCubit.state as ChatMessagesLoaded).conversationId;
                    }

                    if (currentId == -1) {
                      final newId = await chatCubit.saveNewConversation(widget.otherUserId);

                      if (newId != null && newId != -1) {
                        _onSendMessage(context, myIdValue, overrideId: newId);
                      } else {
                        if (chatCubit.state is ChatMessagesLoaded) {
                          final fallbackId = (chatCubit.state as ChatMessagesLoaded).conversationId;
                          if (fallbackId != -1) {
                            _onSendMessage(context, myIdValue, overrideId: fallbackId);
                            return;
                          }
                        }
                      }
                    } else {
                      _onSendMessage(context, myIdValue);
                    }
                  }
                },
                child: Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    gradient: AppColors.premiumGoldGradient2,
                    borderRadius: BorderRadius.circular(16),
                    boxShadow: [
                      BoxShadow(
                        color: const Color(0xFFAF895F).withOpacity(0.4),
                        blurRadius: 12,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: Icon(
                    _editingMessage != null ? Icons.check_rounded : Icons.send_rounded,
                    color: Colors.white,
                    size: 22,
                  ),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  void _showMessageActions(BuildContext cubitContext, ChatMessageModel message, bool isMe, AppLocalizations tr) {
    HapticFeedback.mediumImpact();
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          borderRadius: const BorderRadius.vertical(top: Radius.circular(30)),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            const SizedBox(height: 10),
            Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey[300], borderRadius: BorderRadius.circular(10))),
            if (isMe) ListTile(leading: const Icon(Icons.edit_rounded, color: Color(0xFFAF895F)), title: Text(tr.edit_message), onTap: () {
              context.pop();
              _messageController.text = message.body;
              setState(() => _editingMessage = message);
            }),
            ListTile(leading: const Icon(Icons.copy_rounded, color: Color(0xFFAF895F)), title: Text(tr.copy_text), onTap: () {
              Clipboard.setData(ClipboardData(text: message.body));
              context.pop();
              ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(tr.text_copied)));
            }),
            if (isMe) ListTile(leading: const Icon(Icons.delete_outline_rounded, color: Colors.redAccent), title: Text(tr.delete_message, style: TextStyle(color: Colors.redAccent)), onTap: () {
              cubitContext.read<ChatCubit>().deleteMessage(message.id);
              context.pop();
            }),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  Widget _buildShimmerMessages(bool isDark) {
    return Shimmer.fromColors(
      baseColor: isDark ? Colors.grey[900]! : Colors.grey[300]!,
      highlightColor: isDark ? Colors.grey[800]! : Colors.grey[100]!,
      child: ListView.builder(
        reverse: true,
        padding: const EdgeInsets.all(20),
        itemCount: 8,
        itemBuilder: (_, i) => Align(
          alignment: i % 2 == 0 ? Alignment.centerRight : Alignment.centerLeft,
          child: Container(margin: const EdgeInsets.only(bottom: 20), height: 50, width: 220, decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(15))),
        ),
      ),
    );
  }
}

class ChatBubble extends StatelessWidget {
  final ChatMessageModel message;
  final bool isMe;
  final VoidCallback onLongPress;
  final bool isSameUser;

  const ChatBubble({super.key, required this.message, required this.isMe, required this.onLongPress, required this.isSameUser});

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return GestureDetector(
      onLongPress: onLongPress,
      child: Align(
        alignment: isMe ? Alignment.centerRight : Alignment.centerLeft,
        child: Container(
          margin: EdgeInsets.only(bottom: isSameUser ? 3 : 15),
          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
          constraints: BoxConstraints(maxWidth: MediaQuery.of(context).size.width * 0.78),
          decoration: BoxDecoration(
            gradient: isMe ? AppColors.premiumGoldGradient2 : null,
            color: isMe ? null : Colors.white,
            borderRadius: BorderRadius.only(
              topLeft: const Radius.circular(20),
              topRight: const Radius.circular(20),
              bottomLeft: Radius.circular(isMe ? 22 : (isSameUser ? 22 : 6)),
              bottomRight: Radius.circular(isMe ? (isSameUser ? 22 : 6) : 22),
            ),
            boxShadow: [BoxShadow(color: Colors.black.withOpacity(isDark ? 0.15 : 0.05), blurRadius: 8, offset: const Offset(0, 3))],
          ),
          child: Column(
            crossAxisAlignment: isMe ? CrossAxisAlignment.end : CrossAxisAlignment.start,
            children: [
              Text(
                message.body,
                style: TextStyle(color: isMe ? (isDark ? Colors.black : Colors.white) : Colors.black87, fontSize: 15, height: 1.3),
              ),
              const SizedBox(height: 6),
              Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  if (message.isEdited || message.updatedAt != message.createdAt)
                    Padding(
                      padding: EdgeInsets.only(left: 5),
                      child: Text(' ${tr.edited}   ', style: TextStyle(fontSize: 9, fontStyle: FontStyle.italic, color: Colors.white70)),
                    ),
                  Text(
                    DateFormat('hh:mm a').format(message.createdAt),
                    style: TextStyle(fontSize: 10, color: isMe ? Colors.white : Colors.grey),
                  ),
                  if (isMe) ...[
                    const SizedBox(width: 4),
                    Icon(
                      Icons.done_all_rounded,
                      size: 15,
                      color: message.readAt != null ? Colors.blueAccent : Colors.white60,
                    ),
                  ],
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\details\details_screen.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/presentation/global_widgets/buttons/custom_button.dart';
import 'package:go_router/go_router.dart';
import 'package:malaz/domain/entities/user/user_entity.dart';
import 'package:malaz/presentation/global_widgets/user_profile_image/user_profile_image.dart';
import '../../../core/service_locator/service_locator.dart';
import '../../../domain/entities/apartment/apartment.dart';
import '../../../core/config/color/app_color.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../cubits/favorites/favorites_cubit.dart';
import '../../cubits/chat/chat_cubit.dart';
import '../../cubits/review/review_cubit.dart';
import '../book_now/book_now_screen.dart';
import '../reviews_bottom_sheet/reviews_bottom_sheet.dart';

/// ============================================================================
/// [DetailsScreen]
/// The full details page for a specific apartment.
/// Uses [CustomScrollView] with [SliverAppBar] for a premium scrolling experience.
/// ============================================================================
class DetailsScreen extends StatefulWidget {
  final Apartment apartment;

  const DetailsScreen({super.key, required this.apartment});

  @override
  State<DetailsScreen> createState() => _DetailsScreenState();
}

class _DetailsScreenState extends State<DetailsScreen> {
  @override
  void initState() {
    super.initState();
    context.read<ChatCubit>().getConversations();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Theme.of(context).colorScheme.background,
      bottomNavigationBar: _BuildBottomBookingBar(apartment: widget.apartment),
      body: CustomScrollView(
        slivers: [
          _BuildSliverAppBar(apartment: widget.apartment),
          SliverToBoxAdapter(
            child: Padding(
              padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 20),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _BuildTitleAndRating(apartment: widget.apartment),
                  const SizedBox(height: 24),
                  _BuildOwnerCard(
                    owner: widget.apartment.owner,
                  ),
                  const SizedBox(height: 24),
                  _BuildAmenitiesSection(apartment: widget.apartment),
                  const SizedBox(height: 24),
                  _BuildDescription(description: widget.apartment.description),
                  const SizedBox(height: 24),
                  _BuildReviewSection(
                    id: widget.apartment.id,
                    rating: widget.apartment.rating,
                  ),
                  const SizedBox(height: 100),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

/// ============================================================================
/// [UI_BUILDING_WIDGETS]
/// ============================================================================

/// [_BuildSliverAppBar]
/// Handles the collapsible header with the Hero image and action buttons.
class _BuildSliverAppBar extends StatelessWidget {
  final Apartment apartment;

  const _BuildSliverAppBar({required this.apartment});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    final List<String> galleryImages = [
      apartment.mainImageUrl,
      apartment.mainImageUrl,
      apartment.mainImageUrl,
    ];

    return SliverAppBar(
      expandedHeight: 600,
      pinned: true,
      backgroundColor: theme.colorScheme.background,
      elevation: 0,
      systemOverlayStyle: SystemUiOverlayStyle.light,
      leading: Padding(
        padding: const EdgeInsets.all(8.0),
        child: _AppBarActionButton(
          icon: Icons.arrow_back_ios_rounded,
          onTap: () => Navigator.pop(context),
        ),
      ),
      actions: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 8.0),
          child: _AppBarActionButton(
            icon: Icons.share,
            onTap: () {
              // TODO: Implement Share Logic
            },
          ),
        ),
        Padding(
          padding: const EdgeInsets.only(right: 16.0),
          child: BlocBuilder<FavoritesCubit, FavoritesState>(
            builder: (context, state) {
              final isFav =
                  context.read<FavoritesCubit>().isFavorite(apartment.id);

              return _AppBarActionButton(
                icon: isFav ? Icons.favorite : Icons.favorite_border,
                iconColor: isFav ? Colors.red : null,
                onTap: () {
                  context.read<FavoritesCubit>().toggleFavorite(apartment);
                },
              );
            },
          ),
        ),
      ],
      flexibleSpace: FlexibleSpaceBar(
        background: Hero(
          tag: 'apartment_image_${apartment.id}',
          child: PageView.builder(
            itemCount: galleryImages.length,
            itemBuilder: (context, index) {
              return Stack(
                fit: StackFit.expand,
                children: [
                  Image.network(
                    galleryImages[index],
                    fit: BoxFit.cover,
                  ),
                  const DecoratedBox(
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        begin: Alignment.topCenter,
                        end: Alignment.center,
                        colors: [
                          Colors.black26,
                          Colors.transparent,
                        ],
                      ),
                    ),
                  ),
                ],
              );
            },
          ),
        ),
      ),
    );
  }
}

/// ============================================================================
/// [HELPER_WIDGET] - _AppBarActionButton
/// ============================================================================
class _AppBarActionButton extends StatelessWidget {
  final IconData icon;
  final VoidCallback onTap;
  final Color? iconColor;

  const _AppBarActionButton({
    required this.icon,
    required this.onTap,
    this.iconColor,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(50),
      child: Container(
        padding: const EdgeInsets.all(10),
        decoration: BoxDecoration(
          color: Colors.white.withOpacity(0.2),
          shape: BoxShape.circle,
          border: Border.all(
            color: Colors.white.withOpacity(0.3),
            width: 1,
          ),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withOpacity(0.1),
              blurRadius: 4,
              offset: const Offset(0, 2),
            ),
          ],
        ),
        child: Icon(
          icon,
          color: iconColor ?? Colors.white,
          size: 20,
        ),
      ),
    );
  }
}

/// [_BuildTitleAndRating]
/// Displays the main title, location, and rating summary.
class _BuildTitleAndRating extends StatelessWidget {
  final Apartment apartment;

  const _BuildTitleAndRating({required this.apartment});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _BuildTypeBadge(type: apartment.type),
        const SizedBox(height: 12),
        Text(
          apartment.title,
          style: theme.textTheme.headlineSmall?.copyWith(
            fontWeight: FontWeight.bold,
            height: 1.2,
          ),
        ),
        const SizedBox(height: 8),
        Row(
          children: [
            Icon(Icons.location_on,
                size: 16, color: theme.colorScheme.secondary),
            const SizedBox(width: 4),
            Expanded(
              child: Text(
                maxLines: 2,
                '${apartment.city}, ${apartment.address}',
                style: theme.textTheme.bodyMedium?.copyWith(
                  color: theme.colorScheme.onSurface.withOpacity(0.7),
                ),
                softWrap: true,
              ),
            )
          ],
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            const Icon(Icons.star, color: Colors.amber, size: 20),
            const SizedBox(width: 4),
            RichText(
              text: TextSpan(
                style: theme.textTheme.bodyLarge,
                children: [
                  TextSpan(
                    text: '${apartment.rating}',
                    style: const TextStyle(fontWeight: FontWeight.bold),
                  ),
                  TextSpan(
                    text: ' ${l10n.reviews_count(apartment.numberOfReviews)}',
                    style: TextStyle(
                      color: theme.colorScheme.onSurface.withOpacity(0.6),
                      fontSize: 14,
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ],
    );
  }
}

class _BuildTypeBadge extends StatelessWidget {
  final String type;

  const _BuildTypeBadge({required this.type});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;

    String localizedType = type;
    if (type.toLowerCase() == 'apartment')
      localizedType = l10n.apartment;
    else if (type.toLowerCase() == 'villa')
      localizedType = l10n.villa;
    else if (type.toLowerCase() == 'house')
      localizedType = l10n.house;
    else if (type.toLowerCase() == 'farm')
      localizedType = l10n.farm;
    else if (type.toLowerCase() == 'country house')
      localizedType = l10n.country_house;

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: theme.colorScheme.tertiary.withOpacity(0.1),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: theme.colorScheme.tertiary.withOpacity(0.2),
        ),
      ),
      child: Text(
        localizedType.toUpperCase(),
        style: theme.textTheme.labelSmall?.copyWith(
          color: theme.colorScheme.tertiary,
          fontWeight: FontWeight.bold,
          letterSpacing: 1.0,
        ),
      ),
    );
  }
}

/// [_BuildOwnerCard]
/// A mock card to display host information.
class _BuildOwnerCard extends StatelessWidget {
  final UserEntity owner;
  const _BuildOwnerCard({required this.owner});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.withOpacity(0.1)),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.03),
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            height: 54,
            width: 54,
            decoration: BoxDecoration(
              gradient: AppColors.premiumGoldGradient,
              borderRadius: BorderRadius.circular(16),
              boxShadow: [
                BoxShadow(
                  color: const Color(0xFFAF895F).withOpacity(0.2),
                  blurRadius: 8,
                  offset: const Offset(0, 3),
                )
              ],
            ),
            padding: const EdgeInsets.all(1.5),
            child: UserProfileImage(
              userId: owner.id,
              firstName: owner.first_name,
              lastName: owner.last_name,
              isPremiumStyle: true,
              radius: 25,
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  '${owner.first_name} ${owner.last_name}',
                  style: theme.textTheme.titleMedium
                      ?.copyWith(fontWeight: FontWeight.bold),
                ),
                Row(
                  children: [
                    const Icon(Icons.verified_user_rounded,
                        size: 14, color: Colors.green),
                    const SizedBox(width: 4),
                    Text(
                      l10n.verified_host,
                      style: theme.textTheme.bodySmall?.copyWith(
                          color: Colors.green, fontWeight: FontWeight.w600),
                    ),
                  ],
                ),
              ],
            ),
          ),
          Container(
              decoration: BoxDecoration(
                color: theme.colorScheme.primary.withOpacity(0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: IconButton(
                onPressed: () async {
                  int? myId = _getMyId(context);
                  if (owner.id == myId) {
                    _showSnackBar(
                        context, l10n.not_chat_yourself, theme.primaryColor);
                  } else {
                    final chatCubit = context.read<ChatCubit>();
                    final router = GoRouter.of(context);

                    await chatCubit.getConversations();

                    int existingId = 0;
                    final state = chatCubit.state;

                    if (state is ChatConversationsLoaded) {
                      final foundConversations = state.conversations
                          .where((c) =>
                              c.userOneId == owner.id ||
                              c.userTwoId == owner.id)
                          .toList();

                      if (foundConversations.isNotEmpty) {
                        existingId = foundConversations.first.id;
                      }
                    }

                    if (existingId > 0) {
                      chatCubit.getMessages(existingId);
                    } else {
                      chatCubit.clearMessages();
                    }

                    router.push('/one_chat', extra: {
                      'id': existingId,
                      'firstName': owner.first_name,
                      'lastName': owner.last_name,
                      'otherUserId': owner.id,
                    });
                  }
                },
                icon:
                    Icon(Icons.chat_outlined, color: theme.colorScheme.primary),
              ))
        ],
      ),
    );
  }

  int? _getMyId(BuildContext context) {
    final state = context.read<AuthCubit>().state;
    if (state is AuthAuthenticated) return state.user.id;
    if (state is AuthPending) return state.user.id;
    return null;
  }

  void _showSnackBar(BuildContext context, String message, Color color) {
    if (!context.mounted) return;

    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: color,
        behavior: SnackBarBehavior.floating,
        margin: const EdgeInsets.all(20),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ),
    );
  }
}

/// [_BuildAmenitiesSection]
/// Displays the numbers (Rooms, Baths, Area) in stylish boxes.
class _BuildAmenitiesSection extends StatelessWidget {
  final Apartment apartment;

  const _BuildAmenitiesSection({required this.apartment});

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: [
        _BuildAmenityBox(
          icon: Icons.bed_outlined,
          label: l10n.rooms,
          value: '${apartment.rooms}',
        ),
        _BuildAmenityBox(
          icon: Icons.bathtub_outlined,
          label: l10n.baths,
          value: '${apartment.bathrooms}',
        ),
        _BuildAmenityBox(
          icon: Icons.square_foot,
          label: l10n.area.replaceAll(':', ''),
          value: '${apartment.area} m²',
        ),
      ],
    );
  }
}

class _BuildAmenityBox extends StatelessWidget {
  final IconData icon;
  final String label;
  final String value;

  const _BuildAmenityBox({
    required this.icon,
    required this.label,
    required this.value,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Container(
      width: 100,
      padding: const EdgeInsets.symmetric(vertical: 16),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.withOpacity(0.1)),
      ),
      child: Column(
        children: [
          Icon(icon, color: theme.colorScheme.tertiary, size: 28),
          const SizedBox(height: 8),
          Text(
            value,
            style: theme.textTheme.titleMedium
                ?.copyWith(fontWeight: FontWeight.bold),
          ),
          Text(
            label,
            style: theme.textTheme.bodySmall?.copyWith(color: Colors.grey),
          ),
        ],
      ),
    );
  }
}

/// [_BuildDescription]
/// Displays the description text.
class _BuildDescription extends StatelessWidget {
  final String description;

  const _BuildDescription({required this.description});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          l10n.description,
          style:
              theme.textTheme.titleLarge?.copyWith(fontWeight: FontWeight.bold),
        ),
        const SizedBox(height: 12),
        Text(
          description.isEmpty ? l10n.no_description : description,
          style: theme.textTheme.bodyMedium?.copyWith(
            color: theme.colorScheme.onSurface.withOpacity(0.8),
            height: 1.5,
          ),
        ),
      ],
    );
  }
}

/// [_BuildReviewSection]
/// Shows a mock review to fulfill the requirement.
class _BuildReviewSection extends StatelessWidget {
  final int id;
  final num rating;
  const _BuildReviewSection({required this.id, required this.rating});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(
              l10n.reviews,
              style: theme.textTheme.titleLarge
                  ?.copyWith(fontWeight: FontWeight.bold),
            ),
            TextButton(
                onPressed: () {
                  showModalBottomSheet(
                    context: context,
                    isScrollControlled: true,
                    backgroundColor: Colors.transparent,
                    builder: (context) => BlocProvider(
                      create: (context) => sl<ReviewsCubit>(),
                      child: ReviewsBottomSheet(propertyId: id, rating: rating),
                    ),
                  );
                },
                child: Text(l10n.view_all)),
          ],
        ),
        const SizedBox(height: 12),
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: Colors.grey.withOpacity(0.05),
            borderRadius: BorderRadius.circular(12),
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  CircleAvatar(
                    radius: 16,
                    child: Icon(Icons.person, size: 16),
                  ),
                  const SizedBox(width: 8),
                  Text('Happy Guest',
                      style: theme.textTheme.bodyMedium
                          ?.copyWith(fontWeight: FontWeight.bold)),
                  const Spacer(),
                  const Icon(Icons.star, color: Colors.amber, size: 14),
                  const Text('5.0'),
                ],
              ),
              const SizedBox(height: 8),
              const Text(
                  'Great apartment! Loved the view and the host was very nice.'),
            ],
          ),
        ),
      ],
    );
  }
}

/// [_BuildBottomBookingBar]
/// The fixed bottom bar containing Price and Book Button.
class _BuildBottomBookingBar extends StatelessWidget {
  final Apartment apartment;

  const _BuildBottomBookingBar({required this.apartment});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context)!;
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        border: Border(top: BorderSide(color: Colors.grey.withOpacity(0.1))),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, -5),
          ),
        ],
      ),
      child: Row(
        children: [
          Expanded(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  '\$${apartment.price}',
                  style: theme.textTheme.headlineSmall?.copyWith(
                    fontWeight: FontWeight.bold,
                    color: theme.colorScheme.primary,
                  ),
                ),
                Text(
                  l10n.per_month,
                  style:
                      theme.textTheme.bodySmall?.copyWith(color: Colors.grey),
                ),
              ],
            ),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: CustomButton(
              onPressed: () {
                showModalBottomSheet(
                  context: context,
                  isScrollControlled: true,
                  backgroundColor: Colors.transparent,
                  builder: (context) => BookingBottomSheet(
                    apartment: apartment,
                  ),
                );
              },
              text: l10n.book_now,
            ),
          ),
        ],
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\favorites\favorites_screen.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/favorites/favorites_cubit.dart';
import '../../global_widgets/cards/apartment/apartment_card.dart';

class FavoritesScreen extends StatefulWidget {
  const FavoritesScreen({super.key});

  @override
  State<FavoritesScreen> createState() => _FavoritesScreenState();
}

class _FavoritesScreenState extends State<FavoritesScreen> {

  @override
  void initState() {
    super.initState();
    context.read<FavoritesCubit>().loadFavorites();
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context);

    return Scaffold(
      appBar: AppBar(
        title: Text(
          l10n.my_favorites,
          style: theme.textTheme.headlineSmall?.copyWith(fontWeight: FontWeight.bold),
        ),
        centerTitle: true,
        backgroundColor: theme.scaffoldBackgroundColor,
        elevation: 0,
      ),
      body: BlocConsumer<FavoritesCubit, FavoritesState>(
        listener: (context, state) {
          if (state is FavoritesError) {
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(content: Text(state.message), backgroundColor: Colors.red),
            );
          }
        },
        builder: (context, state) {
          if (state is FavoritesLoading) {
            return const Center(child: CircularProgressIndicator());
          }

          if (state is FavoritesLoaded) {
            final favorites = state.favorites;

            if (favorites.isEmpty) {
              return _BuildEmptyFavorites();
            }

            return ListView.builder(
              padding: const EdgeInsets.all(20),
              itemCount: favorites.length,
              itemBuilder: (context, index) {
                final apartment = favorites[index];

                return Padding(
                  key: ValueKey(apartment.id),
                  padding: const EdgeInsets.only(bottom: 20),
                  child: Stack(
                    children: [
                      ApartmentCard(
                        apartment: apartment,
                          onTap: () {
                            context.push('/details', extra: apartment);
                          },
                      ),
                    ],
                  ),
                );
              },
            );
          }

          return const SizedBox.shrink();
        },
      ),
    );
  }
}

class _BuildEmptyFavorites extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Container(
            padding: const EdgeInsets.all(30),
            decoration: BoxDecoration(
              color: Theme.of(context).colorScheme.tertiary.withOpacity(0.1),
              shape: BoxShape.circle,
            ),
            child: Icon(Icons.favorite_border_rounded, size: 60, color: Theme.of(context).colorScheme.tertiary),
          ),
          const SizedBox(height: 20),
          Text(
            l10n.no_favorites_yet,
            style: Theme.of(context).textTheme.headlineSmall?.copyWith(fontWeight: FontWeight.bold),
          ),
          const SizedBox(height: 10),
          Text(
            l10n.explore_and_save,
            textAlign: TextAlign.center,
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(color: Colors.grey),
          ),
        ],
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\home\filter_bottom_sheet.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:lottie/lottie.dart';
import 'package:malaz/core/config/color/app_color.dart';
import 'package:malaz/presentation/cubits/home/home_cubit.dart';
import 'package:malaz/presentation/cubits/location/location_cubit.dart';
import 'package:malaz/l10n/app_localizations.dart';

import '../../../domain/entities/filters/filters.dart';

class FilterBottomSheet extends StatefulWidget {
  const FilterBottomSheet({super.key});

  @override
  State<FilterBottomSheet> createState() => _FilterBottomSheetState();
}

class _FilterBottomSheetState extends State<FilterBottomSheet> {
  RangeValues _priceRange = const RangeValues(0, 5000);
  RangeValues _areaRange = const RangeValues(50, 10000);

  RangeValues _roomsRange = const RangeValues(0, 100);
  RangeValues _bedroomsRange = const RangeValues(0, 50);
  RangeValues _bathroomsRange = const RangeValues(0, 50);

  String? _selectedTypeKey;

  bool _useCurrentLocation = false;
  bool _useMapLocation = false;
  double? _selectedLat;
  double? _selectedLng;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final l10n = AppLocalizations.of(context);

    return Container(
      height: MediaQuery.of(context).size.height * 0.9,
      decoration: BoxDecoration(
        color: theme.scaffoldBackgroundColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          _BuildHeader(
            title: l10n.filter_title,
            resetText: l10n.filter_reset,
            onReset: _resetFilters,
          ),
          Expanded(
            child: ListView(
              padding: const EdgeInsets.fromLTRB(20, 10, 20, 100),
              children: [
                SizedBox(
                  width: 100,
                  height: 150,
                  child: Lottie.asset('assets/lottie/search_on_tablet.json'),
                ),
                _BuildSectionTitle(title: l10n.filter_location_section),
                _BuildLocationSection(
                  currentLocationTitle: l10n.filter_current_location,
                  mapLocationTitle: l10n.filter_map_location,
                  useCurrentLocation: _useCurrentLocation,
                  useMapLocation: _useMapLocation,
                  onCurrentLocationTap: () {
                    setState(() {
                      _useCurrentLocation = !_useCurrentLocation;
                      _useMapLocation = false;
                    });
                    if (_useCurrentLocation) {
                      final lang = Localizations.localeOf(context).languageCode;
                      context.read<LocationCubit>().getCurrentLocation(lang);
                    }
                  },
                  onMapLocationTap: () {
                    /// TODO: open map :)
                    setState(() {
                      _useMapLocation = !_useMapLocation;
                      _useCurrentLocation = false;
                    });
                  },
                ),
                const SizedBox(height: 24),
                _BuildSectionTitle(title: l10n.filter_price_section),
                _BuildPriceSlider(
                  currentRange: _priceRange,
                  min: 0,
                  max: 5000,
                  onChanged: (values) => setState(() => _priceRange = values),
                ),
                const SizedBox(height: 24),
                _BuildSectionTitle(title: l10n.filter_type_section),
                _BuildPropertyTypeSelector(
                  selectedTypeKey: _selectedTypeKey,
                  typeMap: {
                    "Apartment": l10n.type_apartment,
                    "Villa": l10n.type_villa,
                    "Farm": l10n.type_farm,
                    "CountryHouse": l10n.type_country_house,
                    "Studio": l10n.type_studio,
                  },
                  onTypeSelected: (key) =>
                      setState(() => _selectedTypeKey = key),
                ),
                const SizedBox(height: 24),
                _BuildSectionTitle(title: l10n.filter_area_section),
                _BuildAreaSlider(
                  currentRange: _areaRange,
                  min: 0,
                  max: 10000,
                  onChanged: (values) => setState(() => _areaRange = values),
                ),
                const SizedBox(height: 24),
                _BuildSectionTitle(title: l10n.filter_details_section),
                _BuildIntRangeSlider(
                  title: l10n.filter_total_rooms,
                  currentRange: _roomsRange,
                  min: 0,
                  max: 100,
                  onChanged: (val) => setState(() => _roomsRange = val),
                ),
                const SizedBox(height: 16),
                _BuildIntRangeSlider(
                  title: l10n.filter_bedrooms,
                  currentRange: _bedroomsRange,
                  min: 0,
                  max: 50,
                  onChanged: (val) => setState(() => _bedroomsRange = val),
                ),
                const SizedBox(height: 16),
                _BuildIntRangeSlider(
                  title: l10n.filter_bathrooms,
                  currentRange: _bathroomsRange,
                  min: 0,
                  max: 50,
                  onChanged: (val) => setState(() => _bathroomsRange = val),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          _BuildApplyButton(
            label: l10n.filter_apply_button,
            onTap: () => _applyFilters(context),
            isLocationLoading: _useCurrentLocation &&
                context.watch<LocationCubit>().state is LocationLoading,
          ),
        ],
      ),
    );
  }

  void _resetFilters() {
    setState(() {
      _priceRange = const RangeValues(0, 1000);
      _areaRange = const RangeValues(50, 500);

      _roomsRange = const RangeValues(0, 100);
      _bedroomsRange = const RangeValues(0, 50);
      _bathroomsRange = const RangeValues(0, 50);

      _selectedTypeKey = null;
      _useCurrentLocation = false;
      _useMapLocation = false;
    });
  }

  void _applyFilters(BuildContext context) {
    double? lat, lng;

    if (_useCurrentLocation) {
      final locState = context.read<LocationCubit>().state;
      if (locState is LocationLoaded) {
        lat = locState.location.lat;
        lng = locState.location.lng;
      }
    } else if (_useMapLocation) {
      lat = _selectedLat;
      lng = _selectedLng;
    }

    final params = Filter(
      minPrice: _priceRange.start,
      maxPrice: _priceRange.end,
      minArea: _areaRange.start,
      maxArea: _areaRange.end,
      type: _selectedTypeKey,
      minRooms: _roomsRange.start.toInt(),
      maxRooms: _roomsRange.end.toInt(),
      minBedrooms: _bedroomsRange.start.toInt(),
      maxBedrooms: _bedroomsRange.end.toInt(),
      minBathrooms: _bathroomsRange.start.toInt(),
      maxBathrooms: _bathroomsRange.end.toInt(),
      lat: lat,
      lng: lng,
      radiusInKm: (lat != null) ? 10.0 : null,
    );

    context.read<HomeCubit>().loadApartments(newFilter: params);
    Navigator.pop(context);
  }
}

/// ============================================================================
/// [UI_BUILDING_WIDGETS] - Modular Components
/// ============================================================================

class _BuildHeader extends StatelessWidget {
  final String title;
  final String resetText;
  final VoidCallback onReset;

  const _BuildHeader(
      {required this.title, required this.resetText, required this.onReset});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 16),
      child: Column(
        children: [
          Container(
            width: 75,
            height: 10,
            decoration: BoxDecoration(
              color: Colors.grey.withOpacity(0.3),
              borderRadius: BorderRadius.circular(16),
            ),
          ),
          const SizedBox(height: 16),
          TextButton.icon(
            onPressed: onReset,
            icon: const Icon(Icons.refresh, size: 18),
            label: Text(resetText),
            style: TextButton.styleFrom(foregroundColor: AppColors.error),
          ),
        ],
      ),
    );
  }
}

class _BuildSectionTitle extends StatelessWidget {
  final String title;
  const _BuildSectionTitle({required this.title});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Text(
        title,
        style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
      ),
    );
  }
}

class _BuildLocationSection extends StatelessWidget {
  final String currentLocationTitle;
  final String mapLocationTitle;
  final bool useCurrentLocation;
  final bool useMapLocation;
  final VoidCallback onCurrentLocationTap;
  final VoidCallback onMapLocationTap;

  const _BuildLocationSection({
    required this.currentLocationTitle,
    required this.mapLocationTitle,
    required this.useCurrentLocation,
    required this.useMapLocation,
    required this.onCurrentLocationTap,
    required this.onMapLocationTap,
  });

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: _SelectionCard(
            icon: Icons.my_location,
            title: currentLocationTitle,
            isSelected: useCurrentLocation,
            onTap: onCurrentLocationTap,
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: _SelectionCard(
            icon: Icons.map_outlined,
            title: mapLocationTitle,
            isSelected: useMapLocation,
            onTap: onMapLocationTap,
          ),
        ),
      ],
    );
  }
}

class _BuildPriceSlider extends StatelessWidget {
  final RangeValues currentRange;
  final double min;
  final double max;
  final ValueChanged<RangeValues> onChanged;

  const _BuildPriceSlider({
    required this.currentRange,
    required this.min,
    required this.max,
    required this.onChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text("\$${currentRange.start.toInt()}",
                style: const TextStyle(
                    color: AppColors.tertiary, fontWeight: FontWeight.bold)),
            Text("\$${currentRange.end.toInt()}",
                style: const TextStyle(
                    color: AppColors.tertiary, fontWeight: FontWeight.bold)),
          ],
        ),
        RangeSlider(
          values: currentRange,
          min: min,
          max: max,
          divisions: 100,
          activeColor: AppColors.primaryDark,
          inactiveColor: Colors.grey.withOpacity(0.2),
          labels: RangeLabels(
            "\$${currentRange.start.toInt()}",
            "\$${currentRange.end.toInt()}",
          ),
          onChanged: onChanged,
        ),
      ],
    );
  }
}

class _BuildPropertyTypeSelector extends StatelessWidget {
  final String? selectedTypeKey;
  final Map<String, String> typeMap;
  final ValueChanged<String?> onTypeSelected;

  const _BuildPropertyTypeSelector({
    required this.selectedTypeKey,
    required this.typeMap,
    required this.onTypeSelected,
  });

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      child: Row(
        children: typeMap.entries.map((entry) {
          final isSelected = selectedTypeKey == entry.key;
          return Padding(
            padding: const EdgeInsetsDirectional.only(end: 8),
            child: ChoiceChip(
              label: Text(entry.value),
              selected: isSelected,
              selectedColor: AppColors.primaryDark,
              backgroundColor: Theme.of(context).cardColor,
              labelStyle: TextStyle(
                color: isSelected
                    ? Colors.white
                    : Theme.of(context).textTheme.bodyMedium?.color,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
              ),
              onSelected: (selected) {
                onTypeSelected(selected ? entry.key : null);
              },
            ),
          );
        }).toList(),
      ),
    );
  }
}

class _BuildAreaSlider extends StatelessWidget {
  final RangeValues currentRange;
  final double min;
  final double max;
  final ValueChanged<RangeValues> onChanged;

  const _BuildAreaSlider({
    required this.currentRange,
    required this.min,
    required this.max,
    required this.onChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text("${currentRange.start.round()} m²",
                style: const TextStyle(
                    color: AppColors.tertiary, fontWeight: FontWeight.bold)),
            Text("${currentRange.end.round()} m²",
                style: const TextStyle(
                    color: AppColors.tertiary, fontWeight: FontWeight.bold)),
          ],
        ),
        RangeSlider(
          values: currentRange,
          min: min,
          max: max,
          divisions: 100,
          activeColor: AppColors.primaryDark,
          inactiveColor: Colors.grey.withOpacity(0.2),
          onChanged: onChanged,
        ),
      ],
    );
  }
}

class _BuildRoomsCounters extends StatelessWidget {
  final String totalRoomsLabel;
  final String bedroomsLabel;
  final String bathroomsLabel;
  final String anyLabel;
  final int rooms;
  final int bedrooms;
  final int bathrooms;
  final ValueChanged<int> onRoomsChanged;
  final ValueChanged<int> onBedroomsChanged;
  final ValueChanged<int> onBathroomsChanged;

  const _BuildRoomsCounters({
    required this.totalRoomsLabel,
    required this.bedroomsLabel,
    required this.bathroomsLabel,
    required this.anyLabel,
    required this.rooms,
    required this.bedrooms,
    required this.bathrooms,
    required this.onRoomsChanged,
    required this.onBedroomsChanged,
    required this.onBathroomsChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).cardColor,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.withOpacity(0.1)),
      ),
      child: Column(
        children: [
          _CounterRow(
              title: totalRoomsLabel,
              anyLabel: anyLabel,
              value: rooms,
              onChanged: onRoomsChanged),
          const Divider(),
          _CounterRow(
              title: bedroomsLabel,
              anyLabel: anyLabel,
              value: bedrooms,
              onChanged: onBedroomsChanged),
          const Divider(),
          _CounterRow(
              title: bathroomsLabel,
              anyLabel: anyLabel,
              value: bathrooms,
              onChanged: onBathroomsChanged),
        ],
      ),
    );
  }
}

class _BuildApplyButton extends StatelessWidget {
  final String label;
  final VoidCallback onTap;
  final bool isLocationLoading;

  const _BuildApplyButton(
      {required this.label,
      required this.onTap,
      required this.isLocationLoading});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Theme.of(context).scaffoldBackgroundColor,
        boxShadow: [
          BoxShadow(
            color: theme.colorScheme.primary.withOpacity(0.25),
            blurRadius: 15,
            offset: const Offset(0, 4),
            spreadRadius: 1,
          ),
        ],
      ),
      child: Container(
        width: double.infinity,
        height: 56,
        decoration: BoxDecoration(
            color: theme.colorScheme.surface,
            shape: BoxShape.rectangle,
            boxShadow: [
              BoxShadow(
                color: theme.colorScheme.primary.withOpacity(0.25),
                blurRadius: 15,
                offset: const Offset(0, 4),
                spreadRadius: 1,
              ),
            ],
            border: Border.all(
              color: theme.colorScheme.primary.withOpacity(0.3),
              width: 1.5,
            ),
            borderRadius: BorderRadius.circular(32)),
        child: ElevatedButton(
          onPressed: isLocationLoading ? null : onTap,
          style: ElevatedButton.styleFrom(
            backgroundColor: AppColors.primaryDark,
            shape:
                RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
            elevation: 0,
          ),
          child: isLocationLoading
              ? const SizedBox(
                  height: 24,
                  width: 24,
                  child: CircularProgressIndicator(
                      color: Colors.white, strokeWidth: 2))
              : Text(label,
                  style: const TextStyle(
                      color: Colors.white,
                      fontSize: 16,
                      fontWeight: FontWeight.bold)),
        ),
      ),
    );
  }
}

class _SelectionCard extends StatelessWidget {
  final IconData icon;
  final String title;
  final bool isSelected;
  final VoidCallback onTap;

  const _SelectionCard({
    required this.icon,
    required this.title,
    required this.isSelected,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        height: 80,
        decoration: BoxDecoration(
          color: isSelected
              ? AppColors.primaryLight.withOpacity(0.1)
              : Theme.of(context).cardColor,
          border: Border.all(
            color: isSelected
                ? AppColors.primaryLight
                : Colors.grey.withOpacity(0.2),
            width: isSelected ? 2 : 1,
          ),
          borderRadius: BorderRadius.circular(12),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon,
                color: isSelected ? AppColors.primaryLight : Colors.grey),
            const SizedBox(height: 8),
            Text(
              title,
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 12,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                color: isSelected ? AppColors.primaryLight : Colors.grey,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _CounterRow extends StatelessWidget {
  final String title;
  final String anyLabel;
  final int value;
  final ValueChanged<int> onChanged;

  const _CounterRow(
      {required this.title,
      required this.anyLabel,
      required this.value,
      required this.onChanged});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context).colorScheme;
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(title,
              style: TextStyle(
                  fontWeight: FontWeight.w500, color: theme.onSurface)),
          Row(
            children: [
              IconButton(
                  icon: Icon(Icons.remove),
                  onPressed: () => value > 0 ? onChanged(value - 1) : null,
                  color: theme.onSurface),
              SizedBox(
                  width: 40,
                  child: Center(
                      child: Text(value == 0 ? anyLabel : "$value+",
                          style:
                              const TextStyle(fontWeight: FontWeight.bold)))),
              IconButton(
                  icon: Icon(Icons.add),
                  onPressed: () => onChanged(value + 1),
                  color: theme.onSurface),
            ],
          ),
        ],
      ),
    );
  }
}

class _BuildIntRangeSlider extends StatelessWidget {
  final String title;
  final RangeValues currentRange;
  final double min;
  final double max;
  final ValueChanged<RangeValues> onChanged;

  const _BuildIntRangeSlider({
    required this.title,
    required this.currentRange,
    required this.min,
    required this.max,
    required this.onChanged,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            Text(title, style: const TextStyle(fontWeight: FontWeight.w500)),
            Text(
              "${currentRange.start.toInt()} - ${currentRange.end.toInt()}",
              style: const TextStyle(
                  color: AppColors.tertiary, fontWeight: FontWeight.bold),
            ),
          ],
        ),
        RangeSlider(
          values: currentRange,
          min: min,
          max: max,
          divisions: (max - min).toInt(),
          activeColor: AppColors.primaryDark,
          inactiveColor: Colors.grey.withOpacity(0.2),
          labels: RangeLabels(
            currentRange.start.toInt().toString(),
            currentRange.end.toInt().toString(),
          ),
          onChanged: onChanged,
        ),
      ],
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\home\home_screen.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import 'package:lottie/lottie.dart';
import 'package:malaz/core/config/color/app_color.dart';
import 'package:malaz/core/constants/app_constants.dart';
import 'package:malaz/presentation/global_widgets/brand/build_branding.dart';
import 'package:shimmer/shimmer.dart';
import '../../../core/config/routes/route_info.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/home/home_cubit.dart';
import '../../global_widgets/cards/apartment/apartment_card.dart';
import '../../global_widgets/cards/apartment/apartment_shimmer_card.dart';
import '../side_drawer/app_drawer.dart';
import 'filter_bottom_sheet.dart';

class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const HomeView();
  }
}

class HomeView extends StatefulWidget {
  const HomeView({super.key});

  @override
  State<HomeView> createState() => _HomeViewState();
}

class _HomeViewState extends State<HomeView> {
  final GlobalKey<ScaffoldState> _scaffoldKey = GlobalKey<ScaffoldState>();
  final ScrollController _scrollController = ScrollController();

  bool _showStickyHeader = false;

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);

    final cubit = context.read<HomeCubit>();
    if (cubit.state is HomeInitial) {
      cubit.loadApartments();
    }
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  void _onScroll() {
    if (_isBottom) {
      context.read<HomeCubit>().loadApartments(loadNext: true);
    }

    if (_scrollController.hasClients) {
      final show = _scrollController.offset > 200;
      if (show != _showStickyHeader) {
        setState(() {
          _showStickyHeader = show;
        });
      }
    }
  }

  bool get _isBottom {
    if (!_scrollController.hasClients) return false;
    final maxScroll = _scrollController.position.maxScrollExtent;
    final currentScroll = _scrollController.offset;
    return currentScroll >= (maxScroll * 0.9);
  }

  void _scrollToTop() {
    _scrollController.animateTo(
      0,
      duration: const Duration(milliseconds: 600),
      curve: Curves.easeInOutQuint,
    );
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return Scaffold(
      key: _scaffoldKey,
      backgroundColor: theme.scaffoldBackgroundColor,
      drawer: const AppDrawer(),
      body: SafeArea(
        child: Stack(
          children: [
            _BuildScrollableBody(
              scrollController: _scrollController,
              scaffoldKey: _scaffoldKey,
            ),
            _BuildStickyHeader(
              isVisible: _showStickyHeader,
              onTapBack: _scrollToTop,
            ),
          ],
        ),
      ),
    );
  }
}

/// ============================================================================
/// [UI_BUILDING_WIDGETS]
/// ============================================================================

/// [_BuildScrollableBody]
class _BuildScrollableBody extends StatelessWidget {
  final ScrollController scrollController;
  final GlobalKey<ScaffoldState> scaffoldKey;

  const _BuildScrollableBody({
    required this.scrollController,
    required this.scaffoldKey,
  });

  @override
  Widget build(BuildContext context) {
    return RefreshIndicator(
      onRefresh: () async {
        await context.read<HomeCubit>().loadApartments(isRefresh: true);
      },
      child: CustomScrollView(
        controller: scrollController,
        slivers: [
          SliverToBoxAdapter(
            child: _BuildMainBrandingHeader(scaffoldKey: scaffoldKey),
          ),
          const SliverToBoxAdapter(child: SizedBox(height: 10)),
          BlocBuilder<HomeCubit, HomeState>(
            builder: (context, state) {
              if (state is HomeLoading) {
                return const SliverToBoxAdapter(child: _BuildShimmerLoading());
              }

              if (state is HomeError) {
                return SliverFillRemaining(
                  hasScrollBody: false,
                  child: _BuildErrorView(message: state.message),
                );
              }

              if (state is HomeLoaded) {
                if (state.apartments.isEmpty) {
                  return SliverFillRemaining(
                    hasScrollBody: false,
                    child: _BuildErrorView(
                        message: AppLocalizations.of(context)
                            .unexpected_error_message),
                  );
                }

                return SliverList(
                  delegate: SliverChildBuilderDelegate(
                    (context, index) {
                      if (index >= state.apartments.length) {
                        return state.hasReachedMax
                            ? const SizedBox.shrink()
                            : const _BuildBottomLoader();
                      }
                      final apartment = state.apartments[index];
                      return ApartmentCard(
                        apartment: apartment,
                        onTap: () {
                          context.pushNamed(RouteNames.details,
                              extra: apartment);
                        },
                      );
                    },
                    childCount: state.hasReachedMax
                        ? state.apartments.length
                        : state.apartments.length + 1,
                  ),
                );
              }

              return const SliverToBoxAdapter(child: SizedBox.shrink());
            },
          ),
        ],
      ),
    );
  }
}

/// [_BuildMainBrandingHeader]
class _BuildMainBrandingHeader extends StatelessWidget {
  final GlobalKey<ScaffoldState> scaffoldKey;

  const _BuildMainBrandingHeader({required this.scaffoldKey});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 15),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          _BuildIconButton(
            icon: Icons.menu_rounded,
            onTap: () => scaffoldKey.currentState?.openDrawer(),
          ),
          BuildBranding.nameLottie(
              lottie: Lottie.asset('assets/lottie/shake_share_laptop.json'),
              width: 80,
              height: 80),
          _BuildIconButton(
            icon: Icons.tune_rounded,
            color: AppColors.primaryDark.withOpacity(0.1),
            iconColor: AppColors.primaryDark,
            onTap: () {
              showModalBottomSheet(
                context: context,
                isScrollControlled: true,
                backgroundColor: Colors.transparent,
                builder: (context) => const FilterBottomSheet(),
              );
            },
          ),
        ],
      ),
    );
  }
}

/// [_BuildStickyHeader]
class _BuildStickyHeader extends StatelessWidget {
  final bool isVisible;
  final VoidCallback onTapBack;

  const _BuildStickyHeader({
    required this.isVisible,
    required this.onTapBack,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return AnimatedPositioned(
      duration: const Duration(milliseconds: 400),
      curve: Curves.easeInOutBack,
      top: isVisible ? 10 : -80,
      left: 0,
      right: 0,
      child: Center(
        child: Material(
          color: Colors.transparent,
          child: InkWell(
            onTap: onTapBack,
            borderRadius: BorderRadius.circular(30),
            child: Container(
              width: 100,
              height: 25,
              decoration: BoxDecoration(
                  color: theme.colorScheme.surface,
                  shape: BoxShape.rectangle,
                  boxShadow: [
                    BoxShadow(
                      color: theme.colorScheme.primary.withOpacity(0.25),
                      blurRadius: 15,
                      offset: const Offset(0, 4),
                      spreadRadius: 1,
                    ),
                  ],
                  border: Border.all(
                    color: theme.colorScheme.primary.withOpacity(0.3),
                    width: 1.5,
                  ),
                  borderRadius: BorderRadius.circular(32)),
              child: Icon(
                Icons.keyboard_arrow_up_rounded,
                color: theme.colorScheme.primary,
                size: 16,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

/// ============================================================================
/// [HELPER_WIDGETS]
/// ============================================================================
class _BuildIconButton extends StatelessWidget {
  final IconData icon;
  final VoidCallback onTap;
  final Color? color;
  final Color? iconColor;

  const _BuildIconButton({
    required this.icon,
    required this.onTap,
    this.color,
    this.iconColor,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;

    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.all(10),
        decoration: BoxDecoration(
            color: color ?? (isDark ? Colors.grey[800] : Colors.white),
            borderRadius: BorderRadius.circular(20 * 0.6),
            boxShadow: [
              BoxShadow(
                color: theme.colorScheme.primary.withOpacity(0.25),
                blurRadius: 15,
                offset: const Offset(0, 4),
              )
            ],
            border: Border.all(color: Colors.grey.withOpacity(0.1))),
        child: Icon(icon,
            color: iconColor ?? theme.colorScheme.onSurface.withOpacity(0.8),
            size: 24),
      ),
    );
  }
}

class _BuildBottomLoader extends StatelessWidget {
  const _BuildBottomLoader();

  @override
  Widget build(BuildContext context) {
    return const Padding(
      padding: EdgeInsets.all(24.0),
      child: Center(
          child: SizedBox(
              width: 24,
              height: 24,
              child: CircularProgressIndicator(strokeWidth: 2))),
    );
  }
}

class _BuildShimmerLoading extends StatelessWidget {
  const _BuildShimmerLoading();

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Column(
      children: List.generate(
        3,
        (index) => Shimmer.fromColors(
          baseColor: isDark ? Colors.grey[800]! : Colors.grey[300]!,
          highlightColor: isDark ? Colors.grey[700]! : Colors.grey[100]!,
          child: const BuildShimmerCard(),
        ),
      ),
    );
  }
}

/// [_BuildErrorView]
class _BuildErrorView extends StatelessWidget {
  final String message;

  const _BuildErrorView({required this.message});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    String displayMessage = message;

    if (message == AppConstants.networkFailureKey) {
      displayMessage = AppLocalizations.of(context).network_error_message;
    } else if (message == AppConstants.cancelledFailureKey) {
      displayMessage =
          AppLocalizations.of(context).request_cancelled_error_message;
    } else {
      displayMessage = AppLocalizations.of(context).unexpected_error_message;
    }

    return Center(
      child: SingleChildScrollView(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              padding: const EdgeInsets.all(24),
              decoration: BoxDecoration(
                color: theme.colorScheme.error.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.cloud_off_rounded,
                size: 64,
                color: theme.colorScheme.error,
              ),
            ),
            const SizedBox(height: 24),
            Text(
              AppLocalizations.of(context).warring,
              style: theme.textTheme.headlineMedium?.copyWith(
                fontWeight: FontWeight.bold,
                color: theme.colorScheme.onSurface,
              ),
            ),
            const SizedBox(height: 12),
            Text(
              displayMessage,
              textAlign: TextAlign.center,
              style: theme.textTheme.bodyLarge?.copyWith(
                color: theme.colorScheme.onSurface.withOpacity(0.7),
                height: 1.5,
              ),
            ),
            const SizedBox(height: 32),
            SizedBox(
              width: 200,
              height: 54,
              child: ElevatedButton.icon(
                onPressed: () {
                  context.read<HomeCubit>().loadApartments(isRefresh: true);
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: theme.colorScheme.primary,
                  foregroundColor: theme.colorScheme.onPrimary,
                  elevation: 4,
                  shadowColor: theme.colorScheme.primary.withOpacity(0.4),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                  ),
                ),
                icon: const Icon(Icons.refresh_rounded),
                label: Text(
                  AppLocalizations.of(context).retry,
                  style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\main_wrapper\main_wrapper.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:google_nav_bar/google_nav_bar.dart';
import 'package:malaz/presentation/screens/home/home_screen.dart';
import '../../../l10n/app_localizations.dart';
import '../manage_my_bookings/manage_my_booking_screen.dart';
import '../chats/chats_screen.dart';
import '../favorites/favorites_screen.dart';
import '../manage_property/manage_property.dart';

class MainWrapper extends StatefulWidget {
  const MainWrapper({super.key});

  @override
  State<MainWrapper> createState() => _MainWrapperScreenState();
}

class _MainWrapperScreenState extends State<MainWrapper> {
  int _selectedIndex = 0;

  final List<Widget> _screens = [
    const HomeScreen(),
    const ChatsScreen(),
    // const FavoritesScreen(),
    //const SizedBox.shrink(),
    const ManageMyBookingsScreen(),
    const ManagePropertiesScreen(),
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: IndexedStack(
        index: _selectedIndex,
        children: _screens,
      ),
      bottomNavigationBar: _BuildModernNavBar(
        selectedIndex: _selectedIndex,
        onTabChange: (index) {
          setState(() {
            _selectedIndex = index;
          });
        },
      ),
    );
  }
}

/// ============================================================================
/// [_BuildModernNavBar]
/// Modified to be Responsive using MediaQuery.
/// ============================================================================
class _BuildModernNavBar extends StatelessWidget {
  final int selectedIndex;
  final Function(int) onTabChange;

  const _BuildModernNavBar({
    required this.selectedIndex,
    required this.onTabChange,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final tr = AppLocalizations.of(context)!;

    final double screenWidth = MediaQuery.of(context).size.width;
    final bool isSmallScreen = screenWidth < 400;

    return Container(
      decoration: BoxDecoration(
        color: theme.scaffoldBackgroundColor,
        boxShadow: [
          BoxShadow(
            blurRadius: 20,
            color: Colors.black.withOpacity(0.1),
          )
        ],
      ),
      child: SafeArea(
        child: Padding(
          padding: EdgeInsets.symmetric(
              horizontal: isSmallScreen ? 8.0 : 15.0,
              vertical: 8
          ),
          child: GNav(
            rippleColor: theme.colorScheme.primary.withOpacity(0.1),
            hoverColor: theme.colorScheme.primary.withOpacity(0.1),

            gap: isSmallScreen ? 4 : 8,

            activeColor: theme.colorScheme.primary,

            iconSize: isSmallScreen ? 22 : 24,

            padding: EdgeInsets.symmetric(
                horizontal: isSmallScreen ? 10 : 20,
                vertical: 12
            ),

            duration: const Duration(milliseconds: 400),
            tabBackgroundColor: theme.colorScheme.primary.withOpacity(0.1),
            color: Colors.grey,

            mainAxisAlignment: MainAxisAlignment.spaceBetween,

            tabs:  [
              GButton(
                icon: Icons.home_rounded,
                text: tr.home,
              ),
              GButton(
                icon: Icons.chat_outlined,
                text: tr.chats,
              ),
              // GButton(
              //   icon: Icons.favorite_border_rounded,
              //   text: tr.saved,
              // ),
              GButton(
                icon: Icons.edit_calendar_sharp,
                text: tr.bookings,
              ),
              GButton(
                icon: Icons.paid_outlined,
                text: tr.my_properties,
              ),
            ],
            selectedIndex: selectedIndex,
            onTabChange: onTabChange,
          ),
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\manage_my_bookings\manage_my_booking_screen.dart
// =======================================================

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:intl/intl.dart';
import 'package:table_calendar/table_calendar.dart';

import '../../../core/config/color/app_color.dart';
import '../../../domain/entities/apartment/apartment.dart';
import '../../../domain/entities/booking/booking.dart';
import '../../../domain/entities/booking/booking_list.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../cubits/booking/booking_cubit.dart';
import '../../cubits/booking/my_booking.dart';
import '../../cubits/review/review_cubit.dart';
import '../../global_widgets/glowing_key/build_glowing_key.dart';
import '../review_apartment/apartment_review_dialog.dart';

class ManageMyBookingsScreen extends StatefulWidget {
  const ManageMyBookingsScreen({super.key});

  @override
  State<ManageMyBookingsScreen> createState() => _ManageBookingsScreenState();
}

class _ManageBookingsScreenState extends State<ManageMyBookingsScreen> {
  String? _selectedFilter;

  @override
  void initState() {
    super.initState();
    _loadInitialData();
  }

  void _loadInitialData() {
    final authState = context.read<AuthCubit>().state;
    if (authState is AuthAuthenticated) {
      context.read<MyBookingCubit>().fetchMyBookings(authState.user.id);
    }
  }

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
        body: BlocListener<MyBookingCubit, MyBookingState>(
    listener: (context, state) {
    },
      child:  RefreshIndicator(
        onRefresh: () async {
      _loadInitialData();
      await Future.delayed(const Duration(seconds: 1));
    },
          color: colorScheme.primary,
          child: BlocBuilder<MyBookingCubit, MyBookingState>(
        builder: (context, state) {
          BookingList myBookingList = BookingList(booking: []);
          if (state is MyBookingLoaded) {
            myBookingList = BookingList(booking: state.bookings);
          }
          final bookingsToDisplay = _selectedFilter == null
              ? myBookingList.booking
              : myBookingList.booking.where((b) =>
          b.status?.toLowerCase() == _selectedFilter!.toLowerCase()
          ).toList();

          return CustomScrollView(
            physics: const AlwaysScrollableScrollPhysics(
              parent: BouncingScrollPhysics(),
            ),
            slivers: [
              _buildPremiumAppBar(context, tr, colorScheme),
              _buildActiveFilterIndicator(tr),

              if (state is MyBookingLoading)
                const SliverFillRemaining(child: Center(child: CircularProgressIndicator()))
              else if (state is MyBookingError)
                SliverFillRemaining(child: Center(child: Text(state.message)))

              else if (bookingsToDisplay.isEmpty)
                  _buildEmptyState(tr)

                else
                  SliverPadding(
                    padding: const EdgeInsets.fromLTRB(20, 20, 20, 100),
                    sliver: SliverList(
                      delegate: SliverChildBuilderDelegate(
                            (context, index) => _PremiumBookingCard(
                          booking: bookingsToDisplay[index],
                          onEdit: () => _handleEdit(context, bookingsToDisplay[index]),
                          onCancel: () => _handleCancel(context, bookingsToDisplay[index]),
                        ),
                        childCount: bookingsToDisplay.length,
                      ),
                    ),
                  ),
            ],
          );
        },
      ),)
    ));
  }

  Widget _buildEmptyState(AppLocalizations tr) {
    return SliverFillRemaining(
      hasScrollBody: false,
      child: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.inventory_2_outlined, size: 80, color: Colors.grey[300]),
            const SizedBox(height: 16),
            Text("no_data_found" ?? "No bookings found",
                style: TextStyle(color: Colors.grey[400])),
          ],
        ),
      ),
    );
  }

  Widget _buildPremiumAppBar(BuildContext context, AppLocalizations tr, ColorScheme colorScheme) {
    return SliverAppBar(
      expandedHeight: 100,
      floating: true,
      pinned: true,
      elevation: 0,
      backgroundColor: Colors.transparent,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(
          bottom: Radius.circular(32),
        ),
      ),
      actions: [
        Padding(
          padding: const EdgeInsetsDirectional.only(end: 15, top: 10),
          child: PopupMenuButton<String?>(
            initialValue: _selectedFilter,
            onSelected: (String? statusName) {
              HapticFeedback.mediumImpact();
              setState(() {
                _selectedFilter = statusName;
              });
            },
            child: Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Colors.white.withOpacity(0.15),
                shape: BoxShape.circle,
                border: Border.all(color: Colors.white.withOpacity(0.2)),
              ),
              child: const Icon(Icons.tune_rounded, color: Colors.white, size: 22),
            ),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
            itemBuilder: (context) => [
              _buildPopupItem(null, "All Bookings", Icons.all_inbox_rounded, colorScheme),
              _buildPopupItem("pending", tr.status_pending, Icons.timer_outlined, colorScheme),
              _buildPopupItem("confirmed", tr.status_confirmed, Icons.check_circle_outline, colorScheme),
              _buildPopupItem("completed", tr.status_completed, Icons.history_edu_rounded, colorScheme),
              _buildPopupItem("cancelled", tr.status_canceled, Icons.block_flipped, colorScheme),
            ],
          ),
        ),
      ],
      flexibleSpace: FlexibleSpaceBar(
        background: ClipRRect(
          borderRadius: const BorderRadius.vertical(bottom: Radius.circular(32)),
          child: Stack(
            fit: StackFit.expand,
            children: [
              Container(decoration: const BoxDecoration(gradient: AppColors.premiumGoldGradient2)),
              PositionedDirectional(
                top: -20,
                start: -40,
                child: const BuildGlowingKey(size: 180,opacity:  0.15, rotation: -0.2),
              ),

              PositionedDirectional(
                bottom: 40,
                end: -10,
                child: const BuildGlowingKey(size: 140,opacity:  0.12,rotation:  0.5),
              ),
              Positioned(
                bottom: 16,
                left: 20,
                right: 20,
                child: Text(
                  tr.my_bookings,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.w900,
                    fontSize: 30,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  PopupMenuItem<String?> _buildPopupItem(String? status, String label, IconData icon, ColorScheme colorScheme) {
    return PopupMenuItem(
      value: status,
      child: Row(
        children: [
          Icon(icon, size: 18, color: _selectedFilter == status ? colorScheme.primary : colorScheme.onSurface),
          const SizedBox(width: 12),
          Text(
            label,
            style: TextStyle(
              fontWeight: _selectedFilter == status ? FontWeight.bold : FontWeight.normal,
              color: _selectedFilter == status ? colorScheme.primary : colorScheme.onSurface,
            ),
          ),
        ],
      ),
    );
  }

  void _handleEdit(BuildContext context, Booking booking) {
    context.read<BookingCubit>().loadBookedDates(booking.apartment!.id);

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _EditBookingSheet(booking: booking),
    );
  }

  void _handleCancel(BuildContext context, Booking booking) {
    final theme = Theme.of(context);
    final tr = AppLocalizations.of(context)!;

    HapticFeedback.heavyImpact();

    showGeneralDialog(
      context: context,
      barrierDismissible: true,
      barrierLabel: '',
      barrierColor: Colors.black.withOpacity(0.6),
      transitionDuration: const Duration(milliseconds: 400),
      pageBuilder: (context, anim1, anim2) => const SizedBox(),
      transitionBuilder: (context, anim1, anim2, child) {
        final curve = Curves.bounceOut.transform(anim1.value);
        return Transform.scale(
          scale: curve,
          child: Opacity(
            opacity: anim1.value,
            child: AlertDialog(
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(35)),
              backgroundColor: theme.scaffoldBackgroundColor,
              contentPadding: const EdgeInsets.fromLTRB(24, 32, 24, 24),
              content: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Stack(
                    alignment: Alignment.center,
                    children: [
                      Container(
                        height: 90,
                        width: 90,
                        decoration: BoxDecoration(
                          color: Colors.red.withOpacity(0.1),
                          shape: BoxShape.circle,
                        ),
                      ),
                      const Icon(Icons.error_outline_rounded, color: Colors.redAccent, size: 55),
                    ],
                  ),
                  const SizedBox(height: 25),

                  Text(
                    tr.cancel_booking_title,
                    style: TextStyle(fontWeight: FontWeight.w900, fontSize: 24, letterSpacing: -0.5),
                  ),
                  const SizedBox(height: 12),

                  RichText(
                    textAlign: TextAlign.center,
                    text: TextSpan(
                      style: TextStyle(color: theme.colorScheme.onSurface, fontSize: 14, height: 1.6),
                      children: [
                        TextSpan(text: tr.cancel_booking_msg(booking.apartment!.title)),
                        TextSpan(
                          text: "'${booking.apartment!.title}'",
                          style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.black),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 35),

                  Row(
                    children: [
                      Expanded(
                        child: TextButton(
                          onPressed: () => Navigator.pop(context),
                          style: TextButton.styleFrom(
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(18)),
                          ),
                          child: Text(
                            tr.keep_stay,
                            style: TextStyle(color: theme.colorScheme.onSurface, fontWeight: FontWeight.bold),
                          ),
                        ),
                      ),
                      const SizedBox(width: 15),
                      Expanded(
                        child: ElevatedButton(
                          onPressed: () {
                            final authState = context.read<AuthCubit>().state;
                            if (authState is AuthAuthenticated) {
                              context.read<MyBookingCubit>().cancelBooking(
                                propertyId: booking.id!,
                                userId: authState.user.id,
                              );
                              Navigator.pop(context);
                            }
                          },
                          style: ElevatedButton.styleFrom(
                            backgroundColor: theme.colorScheme.error,
                            foregroundColor: theme.colorScheme.surface,
                            elevation: 8,
                            shadowColor: theme.colorScheme.onSurface.withOpacity(0.3),
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(18)),
                          ),
                          child: Text(tr.yes_cancel, style: TextStyle(fontWeight: FontWeight.w900)),
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ),
        );
      },
    );
  }

  Widget _buildActiveFilterIndicator(AppLocalizations tr) {
    if (_selectedFilter == null) return const SliverToBoxAdapter(child: SizedBox(height: 10));

    return SliverToBoxAdapter(
      child: Padding(
        padding: const EdgeInsets.fromLTRB(25, 15, 25, 5),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              decoration: BoxDecoration(
                color: const Color(0xFFD4AF37).withOpacity(0.1),
                borderRadius: BorderRadius.circular(10),
                border: Border.all(color: const Color(0xFFD4AF37).withOpacity(0.2)),
              ),
              child: Row(
                children: [
                  Text(
                    "Status: ${_getStatusLabel(_selectedFilter!, tr)}",
                    style: const TextStyle(
                      color: Color(0xFFD4AF37),
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
            ),
            const Spacer(),
            TextButton(
              onPressed: () {
                HapticFeedback.lightImpact();
                setState(() => _selectedFilter = null);
              },
              child: Text(
                "Clear All", // tr.clear_all
                style: TextStyle(color: Colors.red[400], fontWeight: FontWeight.bold),
              ),
            ),
          ],
        ),
      ),
    );
  }

  String _getStatusLabel(String status, AppLocalizations tr) {
    switch (status) {
      case "pending": return tr.status_pending;
      case "confirmed": return tr.status_confirmed;
      case "completed": return tr.status_completed;
      case "cancelled": return tr.status_canceled;
      case "conflicted": return tr.status_conflicted;
      default :
        return tr.status_pending;
    }
  }

}

class _EditBookingSheet extends StatefulWidget {
  final Booking booking;
  const _EditBookingSheet({required this.booking});

  @override
  State<_EditBookingSheet> createState() => _EditBookingSheetState();
}

class _EditBookingSheetState extends State<_EditBookingSheet> {
  DateTime? _rangeStart;
  DateTime? _rangeEnd;
  DateTime _focusedDay = DateTime.now();

  @override
  void initState() {
    super.initState();
    _rangeStart = widget.booking.checkIn;
    _rangeEnd = widget.booking.checkOut;
    _focusedDay = widget.booking.checkIn!;
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final tr = AppLocalizations.of(context)!;

    return Container(
      padding: const EdgeInsets.fromLTRB(20, 15, 20, 30),
      decoration: BoxDecoration(
        color: theme.scaffoldBackgroundColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(40)),
      ),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey[300], borderRadius: BorderRadius.circular(2))),
          const SizedBox(height: 25),

          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(color: theme.colorScheme.tertiary.withOpacity(0.1), shape: BoxShape.circle),
                child: Icon(Icons.edit_calendar_rounded, color: theme.colorScheme.tertiary),
              ),
              const SizedBox(width: 15),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(tr.modify_reservation, style: theme.textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900)),
                  Text(tr.changing_dates_for(widget.booking.apartment!.title), style: const TextStyle(color: Colors.grey, fontSize: 12)),
                ],
              ),
            ],
          ),

          const SizedBox(height: 20),

          BlocBuilder<BookingCubit, BookingState>(
            builder: (context, state) {
              List<DateTime> booked = (state is BookingLoaded) ? state.bookedDays : [];

              return TableCalendar(
                firstDay: DateTime.now(),
                lastDay: DateTime.now().add(const Duration(days: 365)),
                focusedDay: _focusedDay,
                rangeStartDay: _rangeStart,
                rangeEndDay: _rangeEnd,
                rangeSelectionMode: RangeSelectionMode.toggledOn,
                startingDayOfWeek: StartingDayOfWeek.saturday,
                onRangeSelected: (start, end, focusedDay) {
                  setState(() { _rangeStart = start; _rangeEnd = end; _focusedDay = focusedDay; });
                },
                enabledDayPredicate: (day) => !booked.any((d) => isSameDay(d, day)),
                calendarStyle: CalendarStyle(
                  rangeHighlightColor: theme.colorScheme.primary.withOpacity(0.1),
                  rangeStartDecoration: BoxDecoration(color: theme.colorScheme.primary, shape: BoxShape.circle),
                  rangeEndDecoration: BoxDecoration(color: theme.colorScheme.primary, shape: BoxShape.circle),
                  todayDecoration: BoxDecoration(color: theme.colorScheme.primary.withOpacity(0.2), shape: BoxShape.circle),
                ),
                headerStyle: const HeaderStyle(formatButtonVisible: false, titleCentered: true),
              );
            },
          ),

          const SizedBox(height: 30),

          SizedBox(
            width: double.infinity,
            height: 56,
            child: ElevatedButton(
              onPressed: (_rangeStart != null && _rangeEnd != null)
                  ? () {
                final authState = context.read<AuthCubit>().state;
                if (authState is AuthAuthenticated) {
                  context.read<MyBookingCubit>().updateBookingDates(
                    bookingId: widget.booking.id!,
                    checkIn: _rangeStart!,
                    checkOut: _rangeEnd!,
                    userId: authState.user.id,
                  );
                  Navigator.pop(context);
                }
              }
                  : null,              style: ElevatedButton.styleFrom(
                backgroundColor: theme.colorScheme.primary,
                foregroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                elevation: 0,
              ),
              child: Text(tr.confirm_new_dates, style: TextStyle(fontWeight: FontWeight.w900, fontSize: 16)),
            ),
          ),
        ],
      ),
    );
  }
}

class _PremiumBookingCard extends StatelessWidget {
  final Booking booking;
  final VoidCallback onEdit;
  final VoidCallback onCancel;

  const _PremiumBookingCard({required this.booking, required this.onEdit, required this.onCancel});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final tr = AppLocalizations.of(context)!;
    final config = _getStatusConfig(booking.status!, tr);

    return Container(
      margin: const EdgeInsets.only(bottom: 25),
      decoration: BoxDecoration(
        color: theme.colorScheme.surface,
        borderRadius: BorderRadius.circular(32),
        boxShadow: [
          BoxShadow(color: Colors.black.withOpacity(0.04), blurRadius: 20, offset: const Offset(0, 10)),
        ],
      ),
      child: Column(
        children: [
          Stack(
            children: [
              ClipRRect(
                borderRadius: const BorderRadius.vertical(top: Radius.circular(32)),
                child: Image.network(booking.apartment!.mainImageUrl, height: 180, width: double.infinity, fit: BoxFit.cover),
              ),
              Positioned(
                top: 15, right: 15,
                child: _buildGlassStatus(config),
              ),
              Positioned(
                bottom: 0, left: 0, right: 0,
                child: Container(
                  height: 60,
                  decoration: BoxDecoration(
                    gradient: LinearGradient(begin: Alignment.topCenter, end: Alignment.bottomCenter, colors: [Colors.transparent, Colors.black.withOpacity(0.6)]),
                  ),
                ),
              ),
              Positioned(bottom: 12, left: 20, child: Text("\$${booking.totalPrice}", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 20))),
            ],
          ),
          Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(booking.apartment!.title, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 18)),
                const SizedBox(height: 15),

                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    _buildDateInfo(tr.check_in, booking.checkIn!, theme: theme.colorScheme),
                    Icon(Icons.swap_horiz_rounded, color: theme.primaryColor),
                    _buildDateInfo(tr.check_out, booking.checkOut!, isEnd: true, theme: theme.colorScheme),
                  ],
                ),

                const Padding(
                  padding: EdgeInsets.symmetric(vertical: 20),
                  child: Divider(height: 1),
                ),

                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    _buildGlassStatus(config),

                    if (booking.status == "pending")
                      Row(
                        children: [
                          _buildActionBtn(Icons.edit_calendar_rounded, tr.edit, Colors.blueAccent, onEdit),
                          const SizedBox(width: 8),
                          _buildActionBtn(Icons.close_rounded, tr.cancel, Colors.redAccent, onCancel),
                        ],
                      )
                    else if (booking.status == "completed")
                      _buildPremiumRateButton(context, tr, booking)
                    else
                      _buildViewDetailsBtn(context, tr)
                  ],
                )
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildViewDetailsBtn(BuildContext context, AppLocalizations tr) {
    final theme = Theme.of(context);
    return InkWell(
      onTap: () {
        // Navigate to details
      },
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          color: theme.primaryColor.withOpacity(0.05),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: theme.primaryColor.withOpacity(0.2)),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              tr.view_details,
              style: TextStyle(
                color: theme.primaryColor,
                fontWeight: FontWeight.w800,
                fontSize: 12,
              ),
            ),
            const SizedBox(width: 6),
            Icon(Icons.arrow_forward_ios_rounded, size: 12, color: theme.primaryColor),
          ],
        ),
      ),
    );
  }

  Widget _buildPremiumRateButton(BuildContext context, AppLocalizations tr, Booking booking) {
    return GestureDetector(
      onTap: () {
        HapticFeedback.lightImpact();
        _showReviewDialog(context, booking.apartment!);
      },
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
        decoration: BoxDecoration(
          gradient: AppColors.premiumGoldGradient,
          borderRadius: BorderRadius.circular(12),
          boxShadow: [
            BoxShadow(
              color: const Color(0xFFD4AF37).withOpacity(0.3),
              blurRadius: 8,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            const Icon(Icons.star_rounded, color: Colors.white, size: 18),
            const SizedBox(width: 6),
            Text(
              tr.rate_the_apartment,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 12,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showReviewDialog(BuildContext context, Apartment apartment) {
    showDialog(
      context: context,
      builder: (dialogContext) => ApartmentReviewDialog(
        propertyName: apartment.title,
        onSubmitted: (rating, comment) {
          context.read<ReviewsCubit>().addReview(
            propertyId: apartment.id,
            rating: rating,
            body: comment,
          );

          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text("Submitting your review...")),
          );
        },
      ),
    );
  }

  Widget _buildGlassStatus(_StatusConfig config) {
    return ClipRRect(
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 8, sigmaY: 8),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          decoration: BoxDecoration(color: config.color.withOpacity(0.7), borderRadius: BorderRadius.circular(12)),
          child: Text(config.label, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900, fontSize: 10)),
        ),
      ),
    );
  }

  Widget _buildDateInfo(String label, DateTime date, {bool isEnd = false, required ColorScheme theme}) {
    return Column(
      crossAxisAlignment: isEnd ? CrossAxisAlignment.end : CrossAxisAlignment.start,
      children: [
        Text(label, style: TextStyle(fontSize: 15, color: theme.primary, fontWeight: FontWeight.w800)),
        const SizedBox(height: 4),
        Text(DateFormat('dd MMM').format(date), style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w900)),
      ],
    );
  }

  Widget _buildActionBtn(IconData icon, String label, Color color, VoidCallback onTap) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(15),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 8),
        decoration: BoxDecoration(
          color: color.withOpacity(0.12),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: color.withOpacity(0.2), width: 1),
        ),
        child: Row(
          children: [
            Icon(icon, size: 16, color: color),
            const SizedBox(width: 6),
            Text(
              label,
              style: TextStyle(
                color: color,
                fontWeight: FontWeight.w800,
                fontSize: 12,
                letterSpacing: 0.5,
              ),
            ),
          ],
        ),
      ),
    );
  }

  _StatusConfig _getStatusConfig(String status, AppLocalizations tr) {
    switch (status) {
      case "confirmed": return _StatusConfig(tr.status_confirmed, Colors.green, Icons.verified);
      case "completed": return _StatusConfig(tr.status_completed, Colors.blue, Icons.task_alt);
      case "cancelled": return _StatusConfig(tr.status_canceled, Colors.red, Icons.cancel_outlined);
      case "conflicted": return _StatusConfig(tr.status_conflicted, Colors.purple, Icons.warning_amber_rounded);
      case "pending":
      default:
        return _StatusConfig(tr.status_pending, Colors.orange, Icons.schedule);
    }
  }
}

class _StatusConfig {
  final String label;
  final Color color;
  final IconData icon;
  _StatusConfig(this.label, this.color, this.icon);
}
// =======================================================
// FILE PATH: lib\presentation\screens\manage_property\booking_card.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import '../../../domain/entities/booking/booking.dart';
import '../../cubits/booking/manage_booking.dart';
import '../../cubits/chat/chat_cubit.dart';
import '../../global_widgets/user_profile_image/user_profile_image.dart';
import '../../../core/config/color/app_color.dart';

class BookingCardWidget extends StatelessWidget {
  final Booking booking;
  final bool isPending;
  final int ownerId;

  const BookingCardWidget({
    super.key,
    required this.booking,
    required this.isPending,
    required this.ownerId,
  });

  @override
  Widget build(BuildContext context) {
    final String firstName = booking.user?.first_name ?? 'Guest';
    final String lastName = booking.user?.last_name ?? '';
    final String checkInStr = "${booking.checkIn!.day}/${booking.checkIn!.month}";
    final String checkOutStr = "${booking.checkOut!.day}/${booking.checkOut!.month}";

    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Theme.of(context).cardColor,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
              color: Colors.black.withOpacity(0.05),
              blurRadius: 10,
              offset: const Offset(0, 4))
        ],
      ),
      child: Column(
        children: [
          Row(
            children: [
              UserProfileImage(userId: booking.userId!),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text("$firstName $lastName",
                        style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                    const SizedBox(height: 2),
                    Text("From $checkInStr to $checkOutStr",
                        style: TextStyle(color: Colors.grey[600], fontSize: 13)),
                  ],
                ),
              ),
              _buildChatButton(context, firstName, lastName),
            ],
          ),
          const Divider(height: 30, thickness: 0.8),
          _buildApartmentInfo(isPending),
          if (isPending) _buildActionSection(context),
        ],
      ),
    );
  }


  Widget _buildChatButton(BuildContext context, String fName, String lName) {
    return Container(
      decoration: BoxDecoration(
        color: Theme.of(context).colorScheme.primary.withOpacity(0.1),
        shape: BoxShape.circle,
      ),
      child: IconButton(
        icon: Icon(Icons.chat_outlined, color: Theme.of(context).colorScheme.primary),
        onPressed: () async {
          final chatCubit = context.read<ChatCubit>();
          chatCubit.clearMessages();
          final newId = await chatCubit.saveNewConversation(booking.userId!);
          if (newId != null && context.mounted) {
            context.pushNamed('one_chat', extra: {
              'id': newId,
              'firstName': fName,
              'lastName': lName,
              'otherUserId': booking.userId,
            });
          }
        },
      ),
    );
  }

  Widget _buildApartmentInfo(bool isPending) {
    return Row(
      children: [
        ClipRRect(
          borderRadius: BorderRadius.circular(12),
          child: Image.network(
            booking.apartment?.mainImageUrl ?? '',
            width: 50, height: 50, fit: BoxFit.cover,
            errorBuilder: (_, __, ___) => Container(width: 50, height: 50, color: Colors.grey[100], child: const Icon(Icons.home)),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(booking.apartment?.title ?? "Property",
                  maxLines: 1, overflow: TextOverflow.ellipsis,
                  style: const TextStyle(fontWeight: FontWeight.w600, fontSize: 14)),
              Text("${booking.totalPrice} \$",
                  style: const TextStyle(color: Colors.green, fontWeight: FontWeight.bold, fontSize: 14)),
            ],
          ),
        ),
        if (!isPending) _StatusBadge(status: booking.status!),
      ],
    );
  }

  Widget _buildActionSection(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(top: 20),
      child: Row(
        children: [
          Expanded(
            child: OutlinedButton(
              onPressed: () => _showConfirmActionDialog(context, 'cancelled'),
              style: OutlinedButton.styleFrom(
                side: BorderSide(color: AppColors.primaryLight.withOpacity(0.5)),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                padding: const EdgeInsets.symmetric(vertical: 12),
              ),
              child: const Text("Reject", style: TextStyle(color: AppColors.primaryLight, fontWeight: FontWeight.bold)),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: GestureDetector(
              onTap: () => _showConfirmActionDialog(context, 'confirmed'),
              child: Container(
                padding: const EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                  gradient: AppColors.premiumGoldGradient2,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Center(child: Text("Accept", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold))),
              ),
            ),
          ),
        ],
      ),
    );
  }


  void _showConfirmActionDialog(BuildContext context, String status) {
    final bool isAccept = status == 'confirmed';
    final cubit = context.read<ManageBookingCubit>();

    showDialog(
      context: context,
      builder: (confirmContext) {
        return Dialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
          child: Padding(
            padding: const EdgeInsets.all(20),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  padding: const EdgeInsets.all(15),
                  decoration: BoxDecoration(
                    color: isAccept ? Colors.green.withOpacity(0.1) : Colors.red.withOpacity(0.1),
                    shape: BoxShape.circle,
                  ),
                  child: Icon(
                    isAccept ? Icons.check_circle_rounded : Icons.cancel_rounded,
                    color: isAccept ? Colors.green : Colors.red,
                    size: 40,
                  ),
                ),
                const SizedBox(height: 20),
                Text(
                  isAccept ? "Confirm Booking?" : "Reject Request?",
                  style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 10),
                Text(
                  "Are you sure you want to change the status to $status?",
                  textAlign: TextAlign.center,
                  style: TextStyle(color: Colors.grey[600]),
                ),
                const SizedBox(height: 25),
                Row(
                  children: [
                    Expanded(
                      child: TextButton(
                        onPressed: () => Navigator.pop(confirmContext),
                        child: const Text("Back", style: TextStyle(color: Colors.grey)),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: GestureDetector(
                        onTap: () {
                          Navigator.pop(confirmContext);
                          _showSmartResultDialog(context, cubit);
                          cubit.updateBookingStatus(booking.id!, status, ownerId);
                        },
                        child: Container(
                          padding: const EdgeInsets.symmetric(vertical: 12),
                          decoration: BoxDecoration(
                            gradient: isAccept ? AppColors.premiumGoldGradient2 : null,
                            color: isAccept ? null : Colors.redAccent,
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: const Center(
                            child: Text("Confirm", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          ),
                        ),
                      ),
                    ),
                  ],
                )
              ],
            ),
          ),
        );
      },
    );
  }

  void _showSmartResultDialog(BuildContext context, ManageBookingCubit cubit) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (dialogContext) {
        bool isLoading = true;
        bool? isSuccess;
        String message = "Processing your request...";

        return StatefulBuilder(
          builder: (context, setState) {
            final subscription = cubit.stream.listen((state) {
              if (state is UpdateStatusSuccess || state is UpdateStatusError) {
                if (dialogContext.mounted) {
                  setState(() {
                    isLoading = false;
                    isSuccess = state is UpdateStatusSuccess;
                    message = isSuccess!
                        ? (state as UpdateStatusSuccess).message
                        : (state as UpdateStatusError).message;
                  });
                }
              }
            });

            return Dialog(
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
              child: Padding(
                padding: const EdgeInsets.all(25),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    if (isLoading) ...[
                      const CircularProgressIndicator(),
                      const SizedBox(height: 20),
                      const Text("Please wait...", style: TextStyle(fontWeight: FontWeight.bold)),
                    ] else ...[
                      Icon(
                        isSuccess! ? Icons.check_circle_rounded : Icons.error_outline_rounded,
                        color: isSuccess! ? Colors.green : Colors.red,
                        size: 60,
                      ),
                      const SizedBox(height: 20),
                      Text(
                        isSuccess! ? "Success" : "Notice",
                        style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                      ),
                      const SizedBox(height: 10),
                      Text(message, textAlign: TextAlign.center, style: TextStyle(color: Colors.grey[700])),
                      const SizedBox(height: 25),
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton(
                          style: ElevatedButton.styleFrom(
                            backgroundColor: isSuccess! ? Colors.green : Colors.redAccent,
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                          ),
                          onPressed: () {
                            subscription.cancel();
                            Navigator.pop(dialogContext);
                          },
                          child: const Text("OK", style: TextStyle(color: Colors.white)),
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            );
          },
        );
      },
    );
  }

}

class _StatusBadge extends StatelessWidget {
  final String status;
  const _StatusBadge({required this.status});

  @override
  Widget build(BuildContext context) {
    Color color = Colors.orange;
    if (status == 'accepted' || status == 'confirmed') color = Colors.green;
    if (status == 'canceled' || status == 'rejected' || status == 'cancelled') color = Colors.red;

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
          color: color.withOpacity(0.1),
          borderRadius: BorderRadius.circular(10),
          border: Border.all(color: color.withOpacity(0.2))),
      child: Text(status.toUpperCase(),
          style: TextStyle(color: color, fontSize: 10, fontWeight: FontWeight.bold)),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\manage_property\booking_shimmer.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:shimmer/shimmer.dart';

const Color _placeholderColor = Colors.white;

class BuildBookingShimmer extends StatelessWidget {
  const BuildBookingShimmer({super.key});

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      margin: const EdgeInsets.symmetric( vertical: 8),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isDark ? Colors.grey[900] : Colors.white,
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 10,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Shimmer.fromColors(
        baseColor: isDark ? Colors.grey[800]! : Colors.grey[300]!,
        highlightColor: isDark ? Colors.grey[700]! : Colors.grey[100]!,
        child: const Column(
          children: [
            _BuildShimmerUserHeader(),
            Divider(height: 32, color: _placeholderColor, thickness: 0.8),
            _BuildShimmerApartmentRow(),
            SizedBox(height: 20),
            _BuildShimmerActionButtons(),
          ],
        ),
      ),
    );
  }
}

class _BuildShimmerUserHeader extends StatelessWidget {
  const _BuildShimmerUserHeader();

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Container(
          width: 55, height: 55,
          decoration: const BoxDecoration(color: _placeholderColor, shape: BoxShape.circle),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(width: 100, height: 16, decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(4))),
              const SizedBox(height: 8),
              Container(width: 140, height: 12, decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(4))),
            ],
          ),
        ),
        Container(width: 40, height: 40, decoration: const BoxDecoration(color: _placeholderColor, shape: BoxShape.circle)),
      ],
    );
  }
}

class _BuildShimmerApartmentRow extends StatelessWidget {
  const _BuildShimmerApartmentRow();

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Container(
          width: 50, height: 50,
          decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(12)),
        ),
        const SizedBox(width: 12),
        Expanded(

          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(width: 120, height: 14, decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(4))),
              const SizedBox(height: 8),
              Container(width: 60, height: 14, decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(4))),
            ],
          ),
        ),
        Container(width: 65, height: 24, decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(10))),
      ],
    );
  }
}

class _BuildShimmerActionButtons extends StatelessWidget {
  const _BuildShimmerActionButtons();

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: Container(
            height: 45,
            decoration: BoxDecoration(
              border: Border.all(color: _placeholderColor, width: 2),
              borderRadius: BorderRadius.circular(12),
            ),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Container(
            height: 45,
            decoration: BoxDecoration(color: _placeholderColor, borderRadius: BorderRadius.circular(12)),
          ),
        ),
      ],
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\manage_property\manage_property.dart
// =======================================================

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:smooth_page_indicator/smooth_page_indicator.dart';
import 'package:shimmer/shimmer.dart';
import '../../../core/config/color/app_color.dart';
import '../../../core/constants/app_constants.dart';
import '../../../domain/entities/booking/booking.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../cubits/booking/manage_booking.dart';
import '../../cubits/property/property_cubit.dart';
import '../../global_widgets/cards/apartment/apartment_card.dart';
import '../../global_widgets/cards/apartment/apartment_shimmer_card.dart';
import '../../global_widgets/glowing_key/build_glowing_key.dart';
import '../../global_widgets/user_profile_image/user_profile_image.dart';
import '../details/details_screen.dart';
import '../property/add_property.dart';
import 'booking_card.dart';
import 'booking_shimmer.dart';

class ManagePropertiesScreen extends StatefulWidget {
  const ManagePropertiesScreen({super.key});

  @override
  State<ManagePropertiesScreen> createState() => _ManagePropertiesScreenState();
}

class _ManagePropertiesScreenState extends State<ManagePropertiesScreen> {
  final PageController _pageController = PageController();
  final ScrollController _myApartmentsScrollController = ScrollController();
  int _currentPage = 0;

  @override
  void initState() {
    super.initState();
    _refreshInitialData();

    _myApartmentsScrollController.addListener(() {
      if (_myApartmentsScrollController.position.pixels >=
          _myApartmentsScrollController.position.maxScrollExtent * 0.9) {
        context.read<MyApartmentsCubit>().fetchMyApartments();
      }
    });

    _pageController.addListener(() {
      if (_pageController.hasClients) {
        int next = _pageController.page!.round();
        if (_currentPage != next) {
          setState(() => _currentPage = next);
        }
      }
    });
  }

  void _refreshInitialData() {
    context.read<MyApartmentsCubit>().fetchMyApartments(isRefresh: true);
    final authState = context.read<AuthCubit>().state;
    if (authState is AuthAuthenticated) {
      final dynamic f= context.read<ManageBookingCubit>().fetchAllBookings(authState.user.id);
      print(f);
    }
  }

  @override
  void dispose() {
    _pageController.dispose();
    _myApartmentsScrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      floatingActionButton: _currentPage == 0
          ? GestureDetector(
        onTap: () => Navigator.push(
          context,
          MaterialPageRoute(builder: (context) => const AddPropertyScreen()),
        ),
        child: Container(
          height: 56,
          padding: const EdgeInsets.symmetric(horizontal: 24),
          decoration: BoxDecoration(
            gradient: AppColors.premiumGoldGradient2,
            borderRadius: BorderRadius.circular(20),
            boxShadow: [
              BoxShadow(
                color: AppColors.primaryLight.withOpacity(0.4),
                blurRadius: 15,
                spreadRadius: 2,
                offset: const Offset(0, 8),
              ),
            ],
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(
                Icons.add_home_work_rounded,
                color: Colors.white,
                size: 22,
              ),
              const SizedBox(width: 10),
              Text(
                tr.add_new,
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.w900,
                  fontSize: 15,
                  letterSpacing: 0.5,
                ),
              ),
            ],
          ),
        ),
      )
          : null,
      body: NestedScrollView(
        headerSliverBuilder: (context, innerBoxIsScrolled) {
          return [
            SliverOverlapAbsorber(
              handle: NestedScrollView.sliverOverlapAbsorberHandleFor(context),
              sliver: SliverAppBar(
                pinned: true,
                expandedHeight: 340.0,
                backgroundColor: Theme.of(context).primaryColor,
                centerTitle: true,
                elevation: 0,
                title: Text(tr.property_manager,
                    style: TextStyle(
                        fontWeight: FontWeight.w800, color: Theme.of(context).scaffoldBackgroundColor)),
                flexibleSpace: FlexibleSpaceBar(
                  collapseMode: CollapseMode.pin,
                  background: Stack(
                    fit: StackFit.expand,
                    children: [
                      Container(
                        decoration: const BoxDecoration(
                          gradient: AppColors.premiumGoldGradient2,
                        ),
                      ),

                      PositionedDirectional(
                        top: 40,
                        end: -30,
                        child: const BuildGlowingKey(size: 140,opacity:  0.15,rotation:  0.5),
                      ),
                      PositionedDirectional(
                        top: 10,
                        start: 10,
                        child: const BuildGlowingKey(size: 80,opacity:  0.15,rotation: -0.3),
                      ),

                      Positioned(
                        top: kToolbarHeight +30,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        child: Container(
                          decoration: BoxDecoration(
                            color: Theme.of(context).scaffoldBackgroundColor,
                            borderRadius: const BorderRadius.vertical(top: Radius.circular(35)),
                          ),
                          child: Padding(
                            padding: const EdgeInsets.only(top: 20),
                            child: _buildProfileHeader(),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                bottom: PreferredSize(
                  preferredSize: const Size.fromHeight(85),
                  child: Container(
                    color: Theme.of(context).scaffoldBackgroundColor,
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        _buildGradientIndicator(),
                        const SizedBox(height: 12),
                        Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceAround,
                            children: [
                              _buildTabItem(tr.properties, 0),
                              _buildTabItem(tr.inbound, 1),
                              _buildTabItem(tr.history, 2),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ];
        },

          body: PageView(
            controller: _pageController,
            children: [
              _buildNestedScrollPage(_buildPropertiesList()),
              _buildNestedScrollPage(_buildBookingsTab(targetStatus: 'pending')),
              _buildNestedScrollPage(_buildBookingsTab(targetStatus: 'history')),
            ],
          ),
        ),
      );
  }
  Widget _buildNestedScrollPage(Widget child) {
    return SafeArea(
      top: false,
      bottom: false,
      child: Builder(
        builder: (context) {
          return CustomScrollView(
            key: PageStorageKey<String>(child.hashCode.toString()),
            slivers: [
              SliverOverlapInjector(
                handle: NestedScrollView.sliverOverlapAbsorberHandleFor(context),
              ),
              SliverFillRemaining(
                hasScrollBody: true,
                child: child,
              ),
            ],
          );
        },
      ),
    );
  }

  Widget _buildBookingsTab({required String targetStatus}) {
    return BlocBuilder<AuthCubit, AuthState>(
      builder: (context, authState) {
        if (authState is! AuthAuthenticated) {
          return const Center(child: Text("Please Login"));
        }

        return BlocBuilder<ManageBookingCubit, ManageBookingState>(
          builder: (context, state) {
            if (state is AllBookingLoading) {
              return const _BuildShimmerRequest();
            }

            if (state is AllBookingError) {
              return Center(child: Text(state.message));
            }

            if (state is AllBookingsLoaded || state is UpdateStatusSuccess || state is UpdateStatusError) {

              List<Booking> allBookings = [];
              if (state is AllBookingsLoaded) {
                allBookings = state.bookings;
                print('><<<<${state.bookings.length}');
              } else {
                final currentState = context.read<ManageBookingCubit>().state;
                if (currentState is AllBookingsLoaded) allBookings = currentState.bookings;
              }

              final bookings = allBookings.where((b) {
                final status = b.status?.toLowerCase() ?? '';
                if (targetStatus == 'pending') {
                  return status == 'pending';
                } else {
                  return status != 'pending' && status.isNotEmpty;
                }
              }).toList();

              return RefreshIndicator(
                onRefresh: () async => context
                    .read<ManageBookingCubit>()
                    .fetchAllBookings(authState.user.id),
                child: bookings.isEmpty
                    ? ListView(
                  physics: const AlwaysScrollableScrollPhysics(),
                  children: [
                    SizedBox(
                      height: MediaQuery.of(context).size.height * 0.4,
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Icons.inbox_outlined, size: 60, color: Colors.grey),
                          const SizedBox(height: 10),
                          Text(targetStatus == 'pending' ? "No pending requests" : "No history found"),
                        ],
                      ),
                    ),
                  ],
                )
                    : ListView.builder(
                  physics: const AlwaysScrollableScrollPhysics(),
                  padding: const EdgeInsets.symmetric(vertical: 10),
                  itemCount: bookings.length,
                  itemBuilder: (context, index) {
                    return BookingCardWidget(
                      key: ValueKey(bookings[index].id),
                      booking: bookings[index],
                      isPending: targetStatus == 'pending',
                      ownerId: authState.user.id,
                    );
                  },
                ),
              );
            }
            return const SizedBox.shrink();
          },
        );
      },
    );
  }

  Widget _buildPropertiesList() {
    return BlocBuilder<MyApartmentsCubit, ApartmentState>(
      builder: (context, state) {
        if (state is MyApartmentsLoading) {
          return const _BuildShimmerPropertying();
        }
        if (state is MyApartmentsLoaded) {
          if (state.myApartments.isEmpty) {
            return RefreshIndicator(
              onRefresh: () => context
                  .read<MyApartmentsCubit>()
                  .fetchMyApartments(isRefresh: true),
              child: ListView(
                physics: const AlwaysScrollableScrollPhysics(),
                children: const [
                  SizedBox(height: 200, child: Center(child: Text("No properties added yet.")))
                ],
              ),
            );
          }
          return RefreshIndicator(
            onRefresh: () => context
                .read<MyApartmentsCubit>()
                .fetchMyApartments(isRefresh: true),
            child: ListView.builder(
              controller: _myApartmentsScrollController,
              padding: const EdgeInsets.fromLTRB(20, 10, 20, 100),
              itemCount: state.myApartments.length + (state.hasReachedMax ? 0 : 1),
              itemBuilder: (context, index) {
                if (index < state.myApartments.length) {
                  return ApartmentCard(
                    apartment: state.myApartments[index],
                    onTap: () => Navigator.push(
                        context,
                        MaterialPageRoute(
                            builder: (_) => DetailsScreen(
                                apartment: state.myApartments[index]))),
                  );
                } else {
                  return const Padding(
                      padding: EdgeInsets.symmetric(vertical: 20),
                      child: Center(child: CircularProgressIndicator.adaptive()));
                }
              },
            ),
          );
        }
        return const SizedBox.shrink();
      },
    );
  }

  Widget _buildProfileHeader() {
    return BlocBuilder<AuthCubit, AuthState>(
      builder: (context, state) {
        String name = "User";
        int? id;
        String firstName= '', lastName= '';
        if (state is AuthAuthenticated) {
          name = "${state.user.first_name} ${state.user.last_name}";
          id = state.user.id;
          List<String> nameParts = name.trim().split(' ');
          firstName = nameParts.isNotEmpty ? nameParts[0] : "User";
          lastName = nameParts.length > 1 ? nameParts[1] : "";
        }
        return Column(
          children: [
            UserProfileImage(
              userId: id ?? 0,
              radius: 60,
              firstName: firstName,
              lastName: lastName,
              isPremiumStyle: true,
            ),
            const SizedBox(height: 8),
            Text(name, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
          ],
        );
      },
    );
  }

  Widget _buildTabItem(String title, int index) {
    bool isSelected = _currentPage == index;
    return GestureDetector(
      onTap: () => _pageController.animateToPage(index,
          duration: const Duration(milliseconds: 300), curve: Curves.easeInOut),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 300),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
        decoration: BoxDecoration(
            color: isSelected
                ? Theme.of(context).colorScheme.primary.withOpacity(0.1)
                : Colors.transparent,
            borderRadius: BorderRadius.circular(15)),
        child: Text(title,
            style: TextStyle(
                fontSize: 14,
                fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
                color: isSelected ? Theme.of(context).colorScheme.primary : Colors.grey)),
      ),
    );
  }

  Widget _buildGradientIndicator() {
    return SmoothPageIndicator(
      controller: _pageController,
      count: 3,
      effect: ExpandingDotsEffect(
          activeDotColor: Theme.of(context).colorScheme.primary,
          dotHeight: 6,
          dotWidth: 6,
          expansionFactor: 4),
    );
  }
}

class _BuildShimmerPropertying extends StatelessWidget {
  const _BuildShimmerPropertying();
  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    return ListView.builder(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
      itemCount: AppConstants.numberOfApartmentsEachRequest,
      itemBuilder: (context, index) => Shimmer.fromColors(
        baseColor: isDark ? Colors.grey[800]! : Colors.grey[300]!,
        highlightColor: isDark ? Colors.grey[700]! : Colors.grey[100]!,
        child: const BuildShimmerCard(),
      ),
    );
  }
}

class _BuildShimmerRequest extends StatelessWidget {
  const _BuildShimmerRequest();
  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 10),
      itemCount: AppConstants.numberOfBookingEachRequest,
      itemBuilder: (context, index) => const BuildBookingShimmer(),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\property\add_property.dart
// =======================================================

import 'dart:io';
import 'dart:math';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:image_picker/image_picker.dart';
import 'package:latlong2/latlong.dart';
import 'package:malaz/presentation/global_widgets/brand/build_branding.dart';
import 'package:modal_progress_hud_nsn/modal_progress_hud_nsn.dart';
import '../../../core/config/color/app_color.dart';
import '../../../core/constants/app_constants.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/property/property_cubit.dart';
import '../../global_widgets/glowing_key/build_glowing_key.dart';
import 'map_picker.dart';

class AddPropertyScreen extends StatefulWidget {
  const AddPropertyScreen({super.key});

  @override
  State<AddPropertyScreen> createState() => _AddPropertyScreenState();
}

class _AddPropertyScreenState extends State<AddPropertyScreen> {
  final List<XFile> _images = [];
  final GlobalKey<FormState> _formKey = GlobalKey<FormState>();
  bool _showImageError = false;

  // Controllers
  final TextEditingController _bedroomsController = TextEditingController();
  final TextEditingController _bathroomsController = TextEditingController();
  final TextEditingController _areaController = TextEditingController();
  final TextEditingController _priceController = TextEditingController();
  final TextEditingController _cityController = TextEditingController();
  final TextEditingController _addressController = TextEditingController();
  final TextEditingController _descriptionController = TextEditingController();
  final TextEditingController _titleController = TextEditingController();
  final TextEditingController _roomsController = TextEditingController();
  final MapController _mapController = MapController();
  final TextEditingController _searchController = TextEditingController();
  double? _selectedLat;
  double? _selectedLng;
  String _selectedPropertyType = '';
  String? _selectedGovernorate;

  @override
  void initState() {
    super.initState();
    context.read<AddApartmentCubit>().resetState();
  }

  @override
  void dispose() {
    _bedroomsController.dispose();
    _bathroomsController.dispose();
    _areaController.dispose();
    _priceController.dispose();
    _cityController.dispose();
    _addressController.dispose();
    _descriptionController.dispose();
    _titleController.dispose();
    _roomsController.dispose();
    super.dispose();
  }

  String _mapTypeToEnglish(String localType, AppLocalizations tr) {
    if (localType == tr.apartment) return 'Apartment';
    if (localType == tr.villa) return 'Villa';
    if (localType == tr.farm) return 'Farm';
    if (localType == tr.house) return 'House';
    if (localType == tr.country_house) return 'Country House';
    return 'Apartment';
  }

  void _addPhoto(XFile? img) {
    if (img != null) {
      setState(() { _images.add(img); _showImageError = false; });
    }
  }

  void _removePhoto(int index) {
    setState(() {
      _images.removeAt(index);
      if (_images.isEmpty) _showImageError = true;
    });
  }

  void _showConfirmDialog(BuildContext context, VoidCallback onConfirm) {
    final tr = AppLocalizations.of(context)!;

    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
        child: Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(25),
            border: Border.all(color: AppColors.primaryLight.withOpacity(0.2)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: AppColors.primaryLight.withOpacity(0.1),
                  shape: BoxShape.circle,
                ),
                child: Image.asset(AppConstants.LogoPath, width: 40, height: 40, color: AppColors.primaryLight),
              ),
              const SizedBox(height: 20),
              Text(tr.confirm_post_property,
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900, letterSpacing: 0.5)),
              const SizedBox(height: 12),
              Text(tr.confirm_post_property_message,
                  textAlign: TextAlign.center, style: TextStyle(color: Colors.grey, fontSize: 14)),
              const SizedBox(height: 30),
              Row(
                children: [
                  Expanded(
                    child: TextButton(
                      onPressed: () => Navigator.pop(context),
                      child: Text(tr.edit, style: TextStyle(color: Colors.grey, fontWeight: FontWeight.bold)),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: GestureDetector(
                      onTap: onConfirm,
                      child: Container(
                        padding: const EdgeInsets.symmetric(vertical: 12),
                        decoration: BoxDecoration(
                          gradient: AppColors.premiumGoldGradient2,
                          borderRadius: BorderRadius.circular(15),
                        ),
                        child: Center(
                          child: Text(tr.yes_post_it,
                              style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
  void _showSuccessDialog(BuildContext context) {
    final tr = AppLocalizations.of(context)!;

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(25)),
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Stack(
                alignment: Alignment.center,
                children: [
                  Container(
                    width: 80, height: 80,
                    decoration: BoxDecoration(
                      shape: BoxShape.circle,
                      color: Colors.green.withOpacity(0.1),
                    ),
                  ),
                  const Icon(Icons.check_circle_rounded, color: Colors.green, size: 60),
                ],
              ),
              const SizedBox(height: 24),
              Text(tr.added_successfully,
                  style: TextStyle(fontSize: 20, fontWeight: FontWeight.w900)),
              const SizedBox(height: 10),
              Text(tr.property_added_message,
                  textAlign: TextAlign.center, style: TextStyle(color: Colors.grey)),
              const SizedBox(height: 30),
              GestureDetector(
                onTap: () {
                  Navigator.pop(context);
                  Navigator.pop(context);
                },
                child: Container(
                  width: double.infinity,
                  padding: const EdgeInsets.symmetric(vertical: 15),
                  decoration: BoxDecoration(
                    gradient: AppColors.premiumGoldGradient2,
                    borderRadius: BorderRadius.circular(15),
                  ),
                  child: Center(
                    child: Text(tr.action_okay,
                        style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _submitProperty() {
    final tr = AppLocalizations.of(context)!;
    bool isFormValid = _formKey.currentState!.validate();
    bool isImagesEmpty = _images.isEmpty;
    bool isLocationEmpty = (_selectedLat == null || _selectedLng == null);
    bool isTypeEmpty = _selectedPropertyType.isEmpty;

    if (!isFormValid || isImagesEmpty || isTypeEmpty || isLocationEmpty) {
      if (isImagesEmpty) setState(() => _showImageError = true);
      _showSnackBar(context, tr.complete_all_fields);
      return;
    }

    _showConfirmDialog(context, () {
      Navigator.pop(context);
      _executeSubmit();
    });
  }

  void _executeSubmit() {
    final tr = AppLocalizations.of(context)!;
    context.read<AddApartmentCubit>().submitApartment(
      title: _titleController.text,
      price: int.parse(_priceController.text),
      rooms: int.parse(_roomsController.text),
      bathrooms: int.parse(_bathroomsController.text),
      bedrooms: int.parse(_bedroomsController.text),
      area: int.parse(_areaController.text),
      city: _cityController.text,
      governorate: _selectedGovernorate!,
      address: _addressController.text,
      description: _descriptionController.text,
      type: _mapTypeToEnglish(_selectedPropertyType, tr),
      images: _images,
      main_pic: _images.first,
      latitide: _selectedLat ?? 0.0,
      longitude: _selectedLng ?? 0.0,
    );
  }
  void _showSnackBar(BuildContext context, String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            Icon(Icons.info_outline, color: AppColors.primaryLight),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                message,
                style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w500),
              ),
            ),
          ],
        ),
        backgroundColor: const Color(0xFF2D2C2C),
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final tr = AppLocalizations.of(context)!;

    return BlocConsumer<AddApartmentCubit, ApartmentState>(
      listener: (context, state) {
        if (state is AddApartmentSuccess || (state is AddApartmentError && state.message.contains("successfully"))) {

          _showSuccessDialog(context);
        }
        else if (state is AddApartmentError) {
          _showSnackBar(context, state.message);
        }
      },      builder: (context, state) {
      final isLoading = state is AddApartmentLoading;

      return ModalProgressHUD(
        inAsyncCall: isLoading,
        color: Colors.white,
        dismissible: false,
        child: Scaffold(
          backgroundColor: Theme.of(context).scaffoldBackgroundColor,
          appBar: const _PropertyAppBar(),
          body: SingleChildScrollView(
            child: SafeArea(
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    const SizedBox(height: 40),
                    _buildHeader(tr, colorScheme),
                    const SizedBox(height: 30),
                    _buildImageSection(tr, colorScheme),
                    const SizedBox(height: 20),
                    _buildEssentialDetailsSection(tr, colorScheme),
                    const SizedBox(height: 30),
                    _buildPriceSection(tr, colorScheme),
                    const SizedBox(height: 30),
                    _buildPropertyTypeSection(tr, colorScheme),
                    const SizedBox(height: 20),
                    _buildLocationDetailsSection(tr, colorScheme),
                    const SizedBox(height: 20),
                    _buildDescriptionSection(tr, colorScheme),
                    _buildSaveButton(tr, _submitProperty),
                    const SizedBox(height: 40),
                  ],
                ),
              ),
            ),
          ),
        ),
      );
    },
    );
  }
  Future<void> _openMapPicker() async {
    final result = await Navigator.push(
      context,
      MaterialPageRoute(builder: (context) => const MapPickerScreen()),
    );

    if (result != null) {
      setState(() {
        _selectedLat = result['lat'];
        _selectedLng = result['lng'];

        var details = result['details'];
        if (details != null) {
          _cityController.text = details['city'] ?? 'Al-Mazza Municipality';
          _addressController.text = details['address'] ?? 'Rabwa Neighborhood';
          _selectedGovernorate = details['governorate']??'Damascus Governorate';
          print(">>>> ${details['city']}");
          print(">>>> ${details['address']}");
          print(">>>> ${details['governorate']}");
        }
      });
    }
  }

  Widget _buildHeader(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      children: [
        BuildBranding(),
        Text(tr.share_your_property, style: TextStyle(color: colorScheme.onSurface.withOpacity(0.6), fontSize: 14)),
      ],
    );
  }

  Widget _buildImageSection(AppLocalizations tr, ColorScheme colorScheme) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _PropertyImageCarousel(
            images: _images,
            onImageAdded: _addPhoto,
            onImageRemoved: _removePhoto,
            showError: _showImageError,
          ),
          if (_showImageError)
            Padding(
              padding: EdgeInsets.only(top: 8),
              child: Text(tr.at_least_one_img, style: TextStyle(color: Colors.red, fontSize: 12)),
            ),
        ],
      ),
    );
  }

  Widget _buildEssentialDetailsSection(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 10),
          child: Text(tr.essential_details, style: TextStyle(color: colorScheme.primary, fontSize: 18, fontWeight: FontWeight.bold)),
        ),
        _PropertyFormInputField(controller: _titleController, icon: Icons.title, hint: tr.title_hint, preffix: tr.title+":", isnumber: false, validator: (v) => v!.isEmpty ? tr.field_required : null),
        Row(children: [
          Expanded(child: _PropertyFormInputField(controller: _roomsController, icon: Icons.meeting_room, hint: "0", preffix: "${tr.rooms}:", isnumber: true, validator: (v) => v!.isEmpty ? tr.field_required : null)),
          Expanded(child: _PropertyFormInputField(controller: _bedroomsController, icon: Icons.bed, hint: "0", preffix: tr.bedrooms, isnumber: true, validator: (v) => v!.isEmpty ? tr.field_required : null)),
        ]),
        Row(children: [
          Expanded(child: _PropertyFormInputField(controller: _bathroomsController, icon: Icons.bathtub, hint: "0", preffix: tr.bathrooms, isnumber: true, validator: (v) => v!.isEmpty ? tr.field_required : null)),
        ]),
        _PropertyFormInputField(controller: _areaController, icon: Icons.square_foot, hint: "0", preffix: tr.area, isnumber: true, suffix: "sqft", validator: (v) => v!.isEmpty ? tr.field_required : null),
      ],
    );
  }

  Widget _buildPriceSection(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(padding: const EdgeInsets.symmetric(horizontal: 24), child: Text(tr.price, style: TextStyle(color: colorScheme.primary, fontSize: 18, fontWeight: FontWeight.bold))),
        _PropertyFormInputField(controller: _priceController, icon: Icons.payments, hint: "0", preffix: "${tr.price}:", isnumber: true, suffix: "\$", validator: (v) => v!.isEmpty ? tr.field_required : null),
      ],
    );
  }

  Widget _buildPropertyTypeSection(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(padding: const EdgeInsets.symmetric(horizontal: 24), child: Text(tr.property_type, style: TextStyle(color: colorScheme.primary, fontSize: 18, fontWeight: FontWeight.bold))),
        _PropertyTypeSelector(onTypeSelected: (type) => _selectedPropertyType = type),
      ],
    );
  }

  Widget _buildLocationDetailsSection(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 10),
          child: Text(
            tr.location_details,
            style: TextStyle(
              color: colorScheme.primary,
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
        ),

        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 17),
          child: InkWell(
            onTap: _openMapPicker,
            child: Container(
              height: 300,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(12),
                border: Border.all(
                  color: colorScheme.primary.withOpacity(0.5),
                  width: 1,
                ),
              ),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(12),
                child: Stack(
                  children: [
                    FlutterMap(
                      key: ValueKey('${_selectedLat}_${_selectedLng}'),
                      options: MapOptions(
                        initialCenter: _selectedLat != null
                            ? LatLng(_selectedLat!, _selectedLng!)
                            : const LatLng(33.5138, 36.2765),
                        initialZoom: _selectedLat != null ? 15.0 : 12.0,
                        interactionOptions: const InteractionOptions(
                          flags: InteractiveFlag.none,
                        ),
                      ),
                      children: [
                        TileLayer(
                          urlTemplate: 'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png',
                          subdomains: const ['a', 'b', 'c'],
                          userAgentPackageName: 'com.malaz.app',
                        ),
                        if (_selectedLat != null)
                          MarkerLayer(
                            markers: [
                              Marker(
                                point: LatLng(_selectedLat!, _selectedLng!),
                                width: 80,
                                height: 80,
                                child: const Icon(Icons.location_on, color: Colors.red, size: 40),
                              ),
                            ],
                          ),
                      ],
                    ),

                    if (_selectedLat != null)
                      Positioned(
                        top: 10,
                        right: 10,
                        child: Container(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(20),
                            boxShadow: [BoxShadow(color: Colors.black26, blurRadius: 4)],
                          ),
                          child: Row(
                            children: [
                              Icon(Icons.edit, size: 16, color: colorScheme.primary),
                              const SizedBox(width: 4),
                              Text('${tr.edit} ${tr.location}', style: TextStyle(fontSize: 12, color: colorScheme.primary)),
                            ],
                          ),
                        ),
                      ),

                    if (_selectedLat == null)
                      Container(
                        color: Colors.black.withOpacity(0.2),
                        child: Center(
                          child: Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              const Icon(Icons.map_outlined, color: Colors.white, size: 40),
                              const SizedBox(height: 8),
                              Text(tr.click_to_select_location, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                            ],
                          ),
                        ),
                      ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ],
    );
  }
  Widget _buildDescriptionSection(AppLocalizations tr, ColorScheme colorScheme) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Padding(padding: const EdgeInsets.symmetric(horizontal: 24), child: Text(tr.description, style: TextStyle(color: colorScheme.primary, fontSize: 18, fontWeight: FontWeight.bold))),
        _PropertyFormInputField(controller: _descriptionController, hint: tr.describe_property, icon: Icons.description, preffix: "", isnumber: false, validator: (v) => v!.isEmpty ? tr.field_required : null),
      ],
    );
  }

  Widget _buildSaveButton(AppLocalizations tr, VoidCallback onTap) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 20),
      child: _PrimaryGradientButton(text: tr.save, onTap: onTap),
    );
  }
}


class _PropertyAppBar extends StatelessWidget implements PreferredSizeWidget {
  const _PropertyAppBar();
  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;

    return AppBar(flexibleSpace: FlexibleSpaceBar(
        stretchModes: const [
          StretchMode.zoomBackground,
          StretchMode.blurBackground,
        ],
        background: Stack(
          fit: StackFit.expand,
          children: [
            Container(decoration: const BoxDecoration(gradient: AppColors.premiumGoldGradient2)),

            PositionedDirectional(
              top: -20,
              start: -40,
              child: const BuildGlowingKey(size: 180,opacity: 0.15,rotation: -0.2),
            ),

            PositionedDirectional(
              bottom: 40,
              end: -10,
              child: const BuildGlowingKey(size: 140,opacity: 0.12,rotation: 0.5),
            ),

            PositionedDirectional(
              top: 40,
              end: 80,
              child: const BuildGlowingKey(size: 70,opacity: 0.12,rotation: 2.5),
            ),
          ],
        )
    ), title: Text(tr.add_property, style: TextStyle(fontWeight: FontWeight.bold,color:colorScheme.surface)),);
  }
  @override
  Size get preferredSize => const Size.fromHeight(kToolbarHeight);
}

class _PrimaryGradientButton extends StatelessWidget {
  final String text;
  final VoidCallback onTap;
  const _PrimaryGradientButton({required this.text, required this.onTap});
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: double.infinity,
        height: 55,
        decoration: BoxDecoration(borderRadius: BorderRadius.circular(12), boxShadow: [BoxShadow(color: Colors.black26, blurRadius: 5, offset: Offset(0, 3))]),
        child: Stack(
          alignment: Alignment.center,
          children: [
            Positioned.fill(child: ShaderMask(shaderCallback: (bounds) => AppColors.premiumGoldGradient2.createShader(bounds), child: Container(decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(12))))),
            Text(text, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.white)),
          ],
        ),
      ),
    );
  }
  void _showSnackBar(BuildContext context, String message, Color color) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: color,
        duration: const Duration(seconds: 2),
      ),
    );
  }
}

class _PropertyFormInputField extends StatelessWidget {
  final TextEditingController? controller;
  final String? Function(String?)? validator;
  final String hint;
  final IconData icon;
  final String preffix;
  final String suffix;
  final bool isnumber;

  const _PropertyFormInputField({
    this.controller,
    this.validator,
    required this.hint,
    required this.icon,
    required this.isnumber,
    required this.preffix,
    this.suffix = '',});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    const double horizontalPadding = 17.0;
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: horizontalPadding, vertical: 8),
      child: TextFormField(
        controller: controller,
        validator: validator,
        keyboardType: isnumber ? TextInputType.number : TextInputType.text,
        maxLines: isnumber ? 1 : null,
        minLines: isnumber ? null : 1,
        inputFormatters: isnumber ? [FilteringTextInputFormatter.digitsOnly,] : null,
        decoration: InputDecoration(
          prefixIcon: Padding(
            padding: const EdgeInsets.only(left: 15, right: 10),
            child: Row(
              mainAxisSize: MainAxisSize.min,
              children: [
                Icon(
                  icon,
                  color: colorScheme.onSurface,
                  size: 20,
                ),
                const SizedBox(width: 8),
                Text(
                  preffix,
                  style: TextStyle(
                    color: colorScheme.onSurface,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ],
            ),
          ),
          suffixIcon: (suffix.isNotEmpty && suffix != ' ')
              ? Padding(
            padding: const EdgeInsets.only(right: 15),
            child: SizedBox(
              width: 37,
              child: Align(
                alignment: Alignment.centerRight,
                child: Text(
                  suffix,
                  style: TextStyle(
                    color: colorScheme.onSurface,
                    fontWeight: FontWeight.w500,
                  ),
                ),
              ),
            ),
          )
              : null,
          hintText: hint,
          hintStyle: TextStyle(
            color: colorScheme.onSurface.withOpacity(0.4),
            fontWeight: FontWeight.w400,
          ),
          filled: true,
          fillColor: colorScheme.surface,
          contentPadding: const EdgeInsets.symmetric(vertical: 15, horizontal: 10),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: colorScheme.primary.withOpacity(0.5), width: 1.0),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: BorderSide(color: colorScheme.primary, width: 2.0),
          ),
          errorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: const BorderSide(color: Colors.red, width: 1.5),
          ),
          focusedErrorBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(12),
            borderSide: const BorderSide(color: Colors.red, width: 2.0),
          ),
        ),
      ),
    );
  }
}



class _PropertyTypeSelector extends StatefulWidget {
  final Function(String type)? onTypeSelected;
  const _PropertyTypeSelector({this.onTypeSelected});
  @override
  State<_PropertyTypeSelector> createState() => _PropertyTypeSelectorState();
}

class _PropertyTypeSelectorState extends State<_PropertyTypeSelector> {
  List<String> propertyTypes = [];
  String? _selectedType;
  @override
  void didChangeDependencies() {
    super.didChangeDependencies();
    final tr = AppLocalizations.of(context)!;
    propertyTypes = [tr.apartment, tr.villa, tr.house, tr.farm, tr.country_house];
    _selectedType ??= propertyTypes.first;
  }
  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 10),
      child: Wrap(
        spacing: 12, runSpacing: 10,
        children: propertyTypes.map((type) => _TypeSelectorButton(text: type, isSelected: _selectedType == type, onTap: () { setState(() => _selectedType = type); widget.onTypeSelected?.call(type); })).toList(),
      ),
    );
  }
}

class _TypeSelectorButton extends StatelessWidget {
  final String text; final bool isSelected; final VoidCallback onTap;
  const _TypeSelectorButton({required this.text, required this.isSelected, required this.onTap});
  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 10),
        decoration: BoxDecoration(gradient: isSelected ? AppColors.premiumGoldGradient2: null,color: !isSelected ? colorScheme.surface : null, borderRadius: BorderRadius.circular(10), border: Border.all(color: colorScheme.primary.withOpacity(0.3))),
        child: Text(text, style: TextStyle(color: isSelected ? colorScheme.onPrimary : colorScheme.onSurface, fontWeight: FontWeight.bold)),
      ),
    );
  }
}

class _PropertyImageCarousel extends StatelessWidget {
  final List<XFile> images;
  final Function(XFile?) onImageAdded;
  final Function(int index) onImageRemoved;
  final bool showError;

  const _PropertyImageCarousel({required this.images, required this.onImageAdded, required this.onImageRemoved, this.showError = false});

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    return _DottedBox(
      isError: showError,
      child: SizedBox(
        height: 250,
        child: Stack(
          children: [
            Positioned.fill(
              child: ClipRRect(
                borderRadius: BorderRadius.circular(13),
                child: images.isEmpty
                    ? Center(child: Text(tr.uploud_photo_property, style: TextStyle(color: Theme.of(context).colorScheme.primary)))
                    : PageView.builder(
                  itemCount: images.length,
                  itemBuilder: (context, index) => Stack(children: [
                    Image.file(File(images[index].path), fit: BoxFit.cover, width: double.infinity, height: double.infinity),
                    Positioned(top: 8, right: 8, child: GestureDetector(onTap: () => onImageRemoved(index), child: Container(decoration: BoxDecoration(color: Colors.red, shape: BoxShape.circle), child: Icon(Icons.close, color: Colors.white, size: 20)))),
                  ]),
                ),
              ),
            ),
            Positioned(top: 10, left: 10, child: _GradientFab(onPressed: () async {
              final img = await ImagePicker().pickImage(source: ImageSource.gallery);
              onImageAdded(img);
            })),
          ],
        ),
      ),
    );
  }
}

class _DottedBox extends StatelessWidget {
  final Widget child; final bool isError;
  const _DottedBox({required this.child, this.isError = false});
  @override
  Widget build(BuildContext context) {
    return CustomPaint(painter: __PrimaryBorderPainter(isError: isError, borderColor: Theme.of(context).colorScheme.primary), child: Padding(padding: const EdgeInsets.all(5), child: child));
  }
}

class __PrimaryBorderPainter extends CustomPainter {
  final bool isError; final Color borderColor;
  __PrimaryBorderPainter({required this.isError, required this.borderColor});
  @override
  void paint(Canvas canvas, Size size) {
    final Paint paint = Paint()..color = isError ? Colors.red : borderColor ..style = PaintingStyle.stroke..strokeWidth = 2.0;
    canvas.drawRRect(RRect.fromRectAndRadius(Offset.zero & size, Radius.circular(18)), paint);
  }
  @override bool shouldRepaint(covariant CustomPainter oldDelegate) => true;
}

class _GradientFab extends StatelessWidget {
  final VoidCallback onPressed;
  const _GradientFab({required this.onPressed});
  @override
  Widget build(BuildContext context) {
    return GestureDetector(onTap: onPressed, child: Container(width: 40, height: 40, decoration: BoxDecoration(shape: BoxShape.circle, gradient: AppColors.premiumGoldGradient2), child: Icon(Icons.add_a_photo, color: Colors.white, size: 20)));
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\property\map_picker.dart
// =======================================================

import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_map/flutter_map.dart';
import 'package:latlong2/latlong.dart';
import 'package:http/http.dart' as http;

import '../../../l10n/app_localizations.dart';

class MapPickerScreen extends StatefulWidget {
  const MapPickerScreen({super.key});

  @override
  State<MapPickerScreen> createState() => _MapPickerScreenState();
}

class _MapPickerScreenState extends State<MapPickerScreen> {
  LatLng _selectedLocation = const LatLng(33.5138, 36.2765);
  bool _isFetching = false;
  final MapController _mapController = MapController();
  final TextEditingController _searchController = TextEditingController();

  Future<void> _searchLocation(String query) async {
    if (query.isEmpty) return;
    final url = Uri.parse(
        'https://nominatim.openstreetmap.org/search?q=$query&format=json&limit=1');
    try {
      final response = await http.get(url, headers: {'User-Agent': 'MalazApp'});
      if (response.statusCode == 200) {
        final data = json.decode(response.body);
        if (data.isNotEmpty) {
          final lat = double.parse(data[0]['lat']);
          final lon = double.parse(data[0]['lon']);
          final newPos = LatLng(lat, lon);

          setState(() {
            _selectedLocation = newPos;
          });

          _mapController.move(newPos, 13.0);
        }
      }
    } catch (e) {
      debugPrint("Search Error: $e");
    }
  }

  Future<Map<String, String>> _getAddressDetails(double lat, double lng) async {
    final String appLocale = Localizations.localeOf(context).languageCode;
    final url = Uri.parse(
        'https://nominatim.openstreetmap.org/reverse?format=json&lat=$lat&lon=$lng'
            '&accept-language=$appLocale'
            '&addressdetails=1'
    );
    try {
      final response = await http.get(url, headers: {
        'User-Agent': 'MalazApp',
        'Accept-Language': appLocale,
      });

      if (response.statusCode == 200) {
        final data = json.decode(utf8.decode(response.bodyBytes));
        final addr = data['address'] ?? {};

        List<String> addressParts = [];
        if (addr['amenity'] != null) addressParts.add(addr['amenity']);
        if (addr['building'] != null) addressParts.add(addr['building']);
        if (addr['road'] != null) addressParts.add(addr['road']);
        if (addr['neighbourhood'] != null) addressParts.add(addr['neighbourhood']);
        if (addr['suburb'] != null) addressParts.add(addr['suburb']);

        String fullAddress = addressParts.join(', ');

        if (fullAddress.isEmpty) {
          fullAddress = addr['tourism'] ?? addr['leisure'] ?? addr['shop'] ?? addr['place'] ?? '';
        }
        if (fullAddress.isEmpty) {
          fullAddress = addr['city'] ?? addr['town'] ?? addr['village'] ?? '';
        }
        if (fullAddress.isEmpty) {
          fullAddress = "${lat.toStringAsFixed(4)}, ${lng.toStringAsFixed(4)}";
        }

        if (appLocale != 'ar') {
          fullAddress = fullAddress.replaceAll(RegExp(r'[\u0600-\u06FF]+'), '');
        }

        fullAddress = fullAddress.replaceAll(', ,', ',').replaceAll(RegExp(r',\s*,'), ',').trim();
        if (fullAddress.startsWith(',')) fullAddress = fullAddress.substring(1).trim();
        if (fullAddress.endsWith(',')) fullAddress = fullAddress.substring(0, fullAddress.length - 1);

        return {
          'city': (addr['city'] ?? addr['town'] ?? addr['village'] ?? '').toString(),
          'governorate': (addr['state'] ?? '').toString(),
          'address': fullAddress.isEmpty ? "Location Selected" : fullAddress,
        };
      }
    } catch (e) {
      debugPrint("Error: $e");
    }
    return {'city': '', 'governorate': '', 'address': ''};
  }

  @override
  Widget build(BuildContext context) {
    final tr = AppLocalizations.of(context)!;

    return SafeArea(child:
    Scaffold(
      body: Stack(
        children: [
          FlutterMap(
            mapController: _mapController,
            options: MapOptions(
              initialCenter: _selectedLocation,
              initialZoom: 13.0,
              onTap: (tapPosition, point) => setState(() => _selectedLocation = point),
            ),
            children: [
              TileLayer(
                urlTemplate:'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png',
                subdomains: const ['a', 'b', 'c'],
                userAgentPackageName: 'com.malaz.app',
              ),
              MarkerLayer(
                markers: [
                  Marker(
                    point: _selectedLocation,
                    child: const Icon(Icons.location_on, color: Colors.red, size: 40),
                  ),
                ],
              ),
            ],
          ),
          Positioned(
            top: 10,
            left: 15,
            right: 15,
            child: Card(
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(25),
              ),
              elevation: 4,
              child: TextField(
                controller: _searchController,
                decoration: InputDecoration(
                  hintText: tr.search,
                  contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 15),
                  border: InputBorder.none,
                  suffixIcon: IconButton(
                    icon:  Icon(Icons.search, color: Theme.of(context).primaryColor),
                    onPressed: () => _searchLocation(_searchController.text),
                  ),
                ),
                onSubmitted: (value) => _searchLocation(value),
              ),
            ),
          ),
          Positioned(
            bottom: 10,
            left: 20,
            right: 20,
            child: ElevatedButton(
              style: ElevatedButton.styleFrom(
                padding: const EdgeInsets.all(15),
              ),
              onPressed: _isFetching ? null : () async {
                setState(() => _isFetching = true);

                var details = await _getAddressDetails(
                    _selectedLocation.latitude,
                    _selectedLocation.longitude
                );

                if (!mounted) return;

                Navigator.pop(context, {
                  'lat': _selectedLocation.latitude,
                  'lng': _selectedLocation.longitude,
                  'details': details,
                });
              },
              child: _isFetching
                  ? const CircularProgressIndicator()
                  : Text(tr.confirm_location),
            ),
          ),
        ],
      ),
    ));
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\reviews_bottom_sheet\reviews_bottom_sheet.dart
// =======================================================

import 'dart:math';

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:malaz/core/config/color/app_color.dart';
import 'package:malaz/presentation/global_widgets/error_view_screen.dart';
import 'package:shimmer/shimmer.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/review/review_cubit.dart';
import '../../global_widgets/cards/review/review_card.dart';
import '../../global_widgets/cards/review/review_shimmer_card.dart';

class ReviewsBottomSheet extends StatefulWidget {
  final int propertyId;
  final num rating;

  const ReviewsBottomSheet({super.key, required this.propertyId, required this.rating});

  @override
  State<ReviewsBottomSheet> createState() => _ReviewsBottomSheetState();
}

class _ReviewsBottomSheetState extends State<ReviewsBottomSheet> {
  final ScrollController _scrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);

    final cubit = context.read<ReviewsCubit>();
    cubit.loadReviews(propertyId: widget.propertyId, isRefresh: true);
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  void _onScroll() {
    if (_isBottom) {
      context.read<ReviewsCubit>().loadReviews(
          propertyId: widget.propertyId,
          loadNext: true
      );
    }
  }

  bool get _isBottom {
    if (!_scrollController.hasClients) return false;
    final maxScroll = _scrollController.position.maxScrollExtent;
    final currentScroll = _scrollController.offset;
    return currentScroll >= (maxScroll * 0.9);
  }

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Container(
      height: MediaQuery.of(context).size.height * 0.75,
      decoration: BoxDecoration(
        color: Theme.of(context).scaffoldBackgroundColor,
        borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
      ),
      child: Column(
        children: [
          Padding(
            padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),
            child: Column(
              children: [
                Container(
                    width: 40,
                    height: 4,
                    decoration: BoxDecoration(
                        color: Colors.grey.withOpacity(0.3),
                        borderRadius: BorderRadius.circular(2)
                    )
                ),
                const SizedBox(height: 16),
                Row(
                  children: [
                    Text(
                      l10n.reviews_title,
                      style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
                    ),
                    const Spacer(),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                      decoration: BoxDecoration(
                        color: AppColors.primaryDark.withOpacity(0.1),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Row(
                        children: [
                          const Icon(Icons.star_rounded, color: AppColors.primaryDark, size: 20),
                          const SizedBox(width: 4),
                          Text(widget.rating.toString(), style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.primaryDark)),
                        ],
                      ),
                    )
                  ],
                ),
              ],
            ),
          ),
          Expanded(
            child: BlocBuilder<ReviewsCubit, ReviewsState>(
              builder: (context, state) {
                if (state is ReviewsLoading) {
                  return const Center(child: CircularProgressIndicator());
                }

                if (state is ReviewsError) {
                  return Center(child: Text(state.message));
                }

                if (state is ReviewsLoaded) {
                  if (state.reviews.isEmpty) {
                    return Center(child: Text(l10n.reviews_empty_subtitle));
                  }

                  return ListView.separated(
                    controller: _scrollController,
                    physics: const AlwaysScrollableScrollPhysics(),
                    padding: const EdgeInsets.all(20),
                    separatorBuilder: (context, index) => const SizedBox(height: 16),

                    itemCount: state.hasReachedMax ? state.reviews.length : state.reviews.length + 1,

                    itemBuilder: (context, index) {
                      if (index >= state.reviews.length) {
                        return const Padding(
                          padding: EdgeInsets.symmetric(vertical: 16),
                          child: Center(
                              child: SizedBox(
                                  width: 24,
                                  height: 24,
                                  child: CircularProgressIndicator(strokeWidth: 2)
                              )
                          ),
                        );
                      }

                      return ReviewCard(review: state.reviews[index]);
                    },
                  );
                }

                return const SizedBox.shrink();
              },
            ),
          ),
        ],
      ),
    );
  }
}

class _BuildEmptyState extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context);
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.rate_review_outlined, size: 64, color: Colors.grey.withOpacity(0.3)),
          const SizedBox(height: 16),
          Text(
            l10n.reviews_empty_title,
            style: TextStyle(color: Colors.grey.withOpacity(0.8), fontSize: 16),
          ),
        ],
      ),
    );
  }
}

class _BuildReviewShimmer extends StatelessWidget {
  const _BuildReviewShimmer();

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Padding(
      padding: const EdgeInsets.all(20.0),
      child: Shimmer.fromColors(
        baseColor: isDark ? Colors.grey[800]! : Colors.grey[300]!,
        highlightColor: isDark ? Colors.grey[700]! : Colors.grey[100]!,
        child: ListView.separated(
          itemCount: 6,
          separatorBuilder: (context, index) => const SizedBox(height: 16),
          itemBuilder: (context, index) => const ReviewShimmerCard(),
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\review_apartment\apartment_review_dialog.dart
// =======================================================

import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class ApartmentReviewDialog extends StatefulWidget {
  final String propertyName;
  final Function(double rating, String comment) onSubmitted;

  const ApartmentReviewDialog({
    super.key,
    required this.propertyName,
    required this.onSubmitted,
  });

  @override
  State<ApartmentReviewDialog> createState() => _ApartmentReviewDialogState();
}

class _ApartmentReviewDialogState extends State<ApartmentReviewDialog> {
  double _currentRating = 0;
  final TextEditingController _commentController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);

    return BackdropFilter(
      filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
      child: AlertDialog(
        backgroundColor: theme.scaffoldBackgroundColor,
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(35)),
        contentPadding: const EdgeInsets.all(25),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              padding: const EdgeInsets.all(15),
              decoration: BoxDecoration(
                color: Colors.amber.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: const Icon(Icons.star_rounded, color: Colors.amber, size: 40),
            ),
            const SizedBox(height: 20),

            Text(
              "Rate your stay", // استخدم المترجم هنا tr.rate_apartment
              style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 22),
            ),
            const SizedBox(height: 8),
            Text(
              widget.propertyName,
              textAlign: TextAlign.center,
              style: TextStyle(color: Colors.grey[600], fontSize: 14),
            ),
            const SizedBox(height: 25),

            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: List.generate(5, (index) {
                return GestureDetector(
                  onTap: () {
                    HapticFeedback.mediumImpact();
                    setState(() => _currentRating = index + 1.0);
                  },
                  child: AnimatedContainer(
                    duration: const Duration(milliseconds: 200),
                    child: Icon(
                      Icons.star_rounded,
                      size: 45,
                      color: index < _currentRating ? Colors.amber : Colors.grey[300],
                    ),
                  ),
                );
              }),
            ),
            const SizedBox(height: 25),

            // حقل التعليق
            TextField(
              controller: _commentController,
              maxLines: 3,
              decoration: InputDecoration(
                hintText: "Tell us about your experience...",
                hintStyle: TextStyle(color: Colors.grey[400], fontSize: 13),
                filled: true,
                fillColor: Colors.grey[100],
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(20),
                  borderSide: BorderSide.none,
                ),
                contentPadding: const EdgeInsets.all(15),
              ),
            ),
            const SizedBox(height: 30),

            // أزرار التحكم
            Row(
              children: [
                Expanded(
                  child: TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: Text("Later", style: TextStyle(color: Colors.grey[400])),
                  ),
                ),
                const SizedBox(width: 12),
                Expanded(
                  child: ElevatedButton(
                    onPressed: _currentRating == 0
                        ? null
                        : () {
                      widget.onSubmitted(_currentRating, _commentController.text);
                      Navigator.pop(context);
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: theme.colorScheme.primary,
                      foregroundColor: Colors.white,
                      elevation: 0,
                      padding: const EdgeInsets.symmetric(vertical: 15),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
                    ),
                    child: const Text("Submit", style: TextStyle(fontWeight: FontWeight.bold)),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\settings\settings_screen.dart
// =======================================================


import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import '../../cubits/settings/settings_cubit.dart';

enum ThemeOption { light, dark, system }

/// [SettingsScreen]
/// It's not in work currently the whole code here is nothing but scribble
/// If you are about to fix this screen you can delete everything below
class SettingsScreen extends StatelessWidget {
  const SettingsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final colorScheme = theme.colorScheme;

    return Scaffold(
      backgroundColor: colorScheme.background,
      appBar: AppBar(
        title: const Text('Settings', style: TextStyle(fontWeight: FontWeight.bold)),
        backgroundColor: colorScheme.surface,
        elevation: 0,
        foregroundColor: colorScheme.onSurface,
      ),
      body: Padding(
        padding: const EdgeInsets.all(20.0),
        child: BlocBuilder<SettingsCubit, SettingsState>(
          builder: (context, state) {
            return Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const _BuildAppearanceTitleSection(),
                const SizedBox(height: 16),
                _ThemeSwitcher(currentThemeMode: state.themeMode),
                const SizedBox(height: 32),
                const _BuildLanguageTitleSection(),
                const SizedBox(height: 16),
                _LanguageSelector(currentLocale: state.locale),
              ],
            );
          },
        ),
      ),
    );
  }
}

// --- Widgets Building The Screen ---

class _BuildAppearanceTitleSection extends StatelessWidget {
  const _BuildAppearanceTitleSection();

  @override
  Widget build(BuildContext context) {
    return Text(
      'Appearance',
      style: TextStyle(
        fontSize: 14,
        fontWeight: FontWeight.bold,
        color: Theme.of(context).colorScheme.onSurface.withOpacity(0.6), // A less prominent color
      ),
    );
  }
}

class _ThemeSwitcher extends StatelessWidget {
  final ThemeMode currentThemeMode;
  const _ThemeSwitcher({required this.currentThemeMode});

  ThemeOption _getOptionForThemeMode(ThemeMode mode) {
    if (mode == ThemeMode.light) return ThemeOption.light;
    if (mode == ThemeMode.dark) return ThemeOption.dark;
    return ThemeOption.system;
  }

  @override
  Widget build(BuildContext context) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;
    return Container(
      padding: const EdgeInsets.all(6),
      decoration: BoxDecoration(
        color: isDarkMode ? Colors.black.withOpacity(0.2) : Colors.grey.shade200,
        borderRadius: BorderRadius.circular(16),
      ),
      child: Row(
        children: [
          _ThemeOption(
            option: ThemeOption.light,
            currentOption: _getOptionForThemeMode(currentThemeMode),
            title: 'Light',
            icon: Icons.wb_sunny_rounded,
          ),
          const SizedBox(width: 4),
          _ThemeOption(
            option: ThemeOption.dark,
            currentOption: _getOptionForThemeMode(currentThemeMode),
            title: 'Dark',
            icon: Icons.nightlight_round,
          ),
        ],
      ),
    );
  }
}

class _ThemeOption extends StatelessWidget {
  final ThemeOption option;
  final ThemeOption currentOption;
  final String title;
  final IconData icon;

  const _ThemeOption({
    required this.option,
    required this.currentOption,
    required this.title,
    required this.icon,
  });

  ThemeMode _getThemeModeForOption(ThemeOption option) {
    if (option == ThemeOption.light) return ThemeMode.light;
    if (option == ThemeOption.dark) return ThemeMode.dark;
    return ThemeMode.system;
  }

  @override
  Widget build(BuildContext context) {
    final isSelected = option == currentOption;
    final colorScheme = Theme.of(context).colorScheme;

    return Expanded(
      child: GestureDetector(
        onTap: () {
          final newThemeMode = _getThemeModeForOption(option);
          context.read<SettingsCubit>().updateThemeMode(newThemeMode);
        },
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 200),
          padding: const EdgeInsets.symmetric(vertical: 12),
          decoration: BoxDecoration(
            color: isSelected ? colorScheme.surface : Colors.transparent,
            borderRadius: BorderRadius.circular(12),
            boxShadow: isSelected
                ? [BoxShadow(color: Colors.black.withOpacity(0.1), blurRadius: 10, offset: const Offset(0, 4))]
                : [],
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(
                icon,
                color: isSelected ? colorScheme.primary : colorScheme.onSurface.withOpacity(0.6),
                size: 20,
              ),
              const SizedBox(width: 8),
              Text(
                title,
                style: TextStyle(
                  fontWeight: isSelected ? FontWeight.bold : FontWeight.normal,
                  color: isSelected ? colorScheme.onSurface : colorScheme.onSurface.withOpacity(0.6),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _BuildLanguageTitleSection extends StatelessWidget {
  const _BuildLanguageTitleSection();

  @override
  Widget build(BuildContext context) {
    return Text(
      'Language',
      style: TextStyle(
        fontSize: 14,
        fontWeight: FontWeight.bold,
        color: Theme.of(context).colorScheme.onSurface.withOpacity(0.6),
      ),
    );
  }
}

class _LanguageSelector extends StatelessWidget {
  final Locale currentLocale;
  const _LanguageSelector({required this.currentLocale});

  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      decoration: BoxDecoration(
        color: colorScheme.surface,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 10, offset: const Offset(0, 4))],
      ),
      child: ListTile(
        leading: Icon(Icons.language_rounded, color: colorScheme.primary),
        title: Text('Language', style: TextStyle(fontWeight: FontWeight.bold, color: colorScheme.onSurface)),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              currentLocale.languageCode.toUpperCase(),
              style: TextStyle(color: colorScheme.onSurface.withOpacity(0.6)),
            ),
            const SizedBox(width: 8),
            Icon(Icons.arrow_forward_ios_rounded, size: 16, color: colorScheme.onSurface.withOpacity(0.6)),
          ],
        ),
        onTap: () {
          final newLocale = currentLocale.languageCode == 'en' ? const Locale('ar') : const Locale('en');
          context.read<SettingsCubit>().updateLanguage(newLocale);
        },
      ),
    );
  }
}

// =======================================================
// FILE PATH: lib\presentation\screens\side_drawer\app_drawer.dart
// =======================================================

import 'dart:ui';

import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';
import '../../../core/config/color/app_color.dart';
import '../../../l10n/app_localizations.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../cubits/language/language_cubit.dart';
import '../../cubits/location/location_cubit.dart';
import '../../cubits/theme/theme_cubit.dart';
import '../../global_widgets/glowing_key/build_glowing_key.dart';
import '../../global_widgets/user_profile_image/user_profile_image.dart';

enum ThemeOption { light, dark, system }

class AppDrawer extends StatefulWidget {
  const AppDrawer({super.key});

  @override
  State<AppDrawer> createState() => _AppDrawerState();
}

class _AppDrawerState extends State<AppDrawer> {
  @override
  void initState() {
    super.initState();

    context.read<LocationCubit>().loadSavedLocation();
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final colorScheme = theme.colorScheme;
    final tr = AppLocalizations.of(context)!;
    final isDark = theme.brightness == Brightness.dark;

    return BlocListener<AuthCubit, AuthState>(
      listener: (context, state) {
        if (state is AuthUnauthenticated) context.go('/login');
      },
      child: Drawer(
        width: MediaQuery.of(context).size.width * 0.82,
        backgroundColor: theme.scaffoldBackgroundColor,
        elevation: 0,
        child: BackdropFilter(
          filter: ImageFilter.blur(sigmaX: 5, sigmaY: 5),
          child: Column(
            children: [
              _buildUserHeader(context, tr, colorScheme, isDark),
              Expanded(
                child: Container(
                  decoration: BoxDecoration(
                    color: isDark ? Colors.black.withOpacity(0.2) : Colors.grey.shade50.withOpacity(0.5),
                  ),
                  child: ListView(
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 15),
                    children: [
                      _buildDrawerItem(context, Icons.person_outline_rounded, tr.my_profile, () => context.push('/profile')),
                      _buildDrawerItem(context, Icons.palette_outlined, tr.theme, () {
                        Navigator.pop(context);
                        _showThemeBottomSheet(context);
                      }),
                      _buildDrawerItem(context, Icons.language_rounded, tr.language, () {
                        Navigator.pop(context);
                        _showLanguageBottomSheet(context);
                      }),
                      Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                        child: Divider(color: colorScheme.outlineVariant.withOpacity(0.3), thickness: 0.5),
                      ),
                      _buildDrawerItem(context, Icons.apartment_rounded, tr.become_a_renter, () {}),
                      _buildDrawerItem(context, Icons.settings_outlined, tr.settings,(){}),
                    ],
                  ),
                ),
              ),
              _buildLogoutButton(context, colorScheme, tr),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildUserHeader(BuildContext context, AppLocalizations tr, ColorScheme colorScheme, bool isDark) {
    return BlocBuilder<AuthCubit, AuthState>(
      builder: (context, state) {
        String name = 'Guest User';
        String firstName = '';
        String lastName = '';
        String? img;
        int? userId;
        if (state is !AuthAuthenticated) {
          return const SizedBox(height: 100);
        }

        name = "${state.user.first_name} ${state.user.last_name}";
        img = state.user.profile_image_url;
        userId = state.user.id;
        firstName = state.user.first_name;
        lastName = state.user.last_name;

        return Container(
          width: double.infinity,
          decoration: const BoxDecoration(
            gradient: AppColors.premiumGoldGradient2,
            borderRadius: BorderRadiusDirectional.only(bottomEnd: Radius.circular(50)),
            boxShadow: [
              BoxShadow(color: Colors.black12, blurRadius: 20, offset: Offset(0, 10))
            ],
          ),
          child: Stack(
            children: [
              PositionedDirectional(
                end: -40,
                top: 0,
                child: BuildGlowingKey(size: 180,opacity:  0.15,rotation: -0.3),
              ),

              PositionedDirectional(
                top: -30,
                start: -20,
                child: BuildGlowingKey(size: 110,opacity:  0.12,rotation:  0.5),
              ),

              PositionedDirectional(
                bottom: 0,
                end: 50,
                child: BuildGlowingKey(size: 90,opacity:  0.1,rotation:  0.8),
              ),

              Padding(
                padding: const EdgeInsets.fromLTRB(24, 70, 24, 40),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildModernAvatar(userId, colorScheme, isDark, firstName, lastName),
                    const SizedBox(height: 25),
                    Text(
                      name,
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 24,
                        fontWeight: FontWeight.w900,
                        shadows: [Shadow(color: Colors.black26, blurRadius: 12, offset: Offset(0, 4))],
                      ),
                    ),
                    const SizedBox(height: 12),
                    _buildDrawerLocation(context, colorScheme, tr),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildDrawerLocation(BuildContext context, ColorScheme colorScheme, AppLocalizations tr) {
    return BlocBuilder<LocationCubit, LocationState>(
      builder: (context, state) {
        String address = tr.unknown_location;
        bool isLoading = state is LocationLoading;

        if (state is LocationLoading) {
          address = '...';
        }

        if (state is LocationLoaded) {
          address = state.location.address;
        }

        return Container(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          decoration: BoxDecoration(
            color: Colors.white.withOpacity(0.15),
            borderRadius: BorderRadius.circular(15),
            border: Border.all(color: Colors.white.withOpacity(0.2)),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.05),
                blurRadius: 10,
                offset: const Offset(0, 4),
              )
            ],
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              if (isLoading)
                const SizedBox(
                  width: 14,
                  height: 14,
                  child: CircularProgressIndicator(strokeWidth: 2, color: Colors.white),
                )
              else
                PulsingLocationIcon(color: Colors.white),
              const SizedBox(width: 8),
              Flexible(
                child: Text(
                  address,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(
                    color: Colors.white,
                    fontSize: 12,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildModernAvatar(int? userId, ColorScheme colorScheme, bool isDark, String firstName, String lastName) {
    return UserProfileImage(
              userId: userId ?? 0,
              firstName: firstName,
              lastName: lastName,
              radius: 42,
    );
  }

  Widget _buildDrawerItem(BuildContext context, IconData icon, String title, VoidCallback onTap) {
    final colorScheme = Theme.of(context).colorScheme;
    return ListTile(
      leading: Icon(icon, color: colorScheme.onSurface.withOpacity(0.6), size: 22),
      title: Text(title, style: TextStyle(fontWeight: FontWeight.w500, color: colorScheme.onSurface, fontSize: 15)),
      onTap: onTap,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
    );
  }

  Widget _buildLogoutButton(BuildContext context, ColorScheme colorScheme, AppLocalizations tr) {
    return Container(
      margin: const EdgeInsets.all(20),
      padding: const EdgeInsets.all(4),
      decoration: BoxDecoration(
        color: colorScheme.error.withOpacity(0.05),
        borderRadius: BorderRadius.circular(20),
        border: Border.all(color: colorScheme.error.withOpacity(0.1)),
      ),
      child: ListTile(
        leading: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(color: colorScheme.error.withOpacity(0.1), shape: BoxShape.circle),
          child: Icon(Icons.logout_rounded, color: colorScheme.error, size: 20),
        ),
        title: Text(
          tr.logout,
          style: TextStyle(color: colorScheme.error, fontWeight: FontWeight.w800, fontSize: 15),
        ),
        onTap: () async {
          Navigator.pop(context);

          await Future.delayed(const Duration(milliseconds: 210));

          if (context.mounted) {
            context.read<LocationCubit>().clearLocation();
            context.read<AuthCubit>().logout();
          }
        },
      ),
    );
  }

  void _showThemeBottomSheet(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;
    final isDark = Theme.of(context).brightness == Brightness.dark;

    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (ctx) => Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Theme.of(context).scaffoldBackgroundColor,
          borderRadius: const BorderRadius.vertical(top: Radius.circular(30)),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(width: 40, height: 4, decoration: BoxDecoration(color: colorScheme.outlineVariant.withOpacity(0.4), borderRadius: BorderRadius.circular(2))),
            const SizedBox(height: 25),
            Text(tr.select_theme, style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: colorScheme.onSurface)),
            const SizedBox(height: 30),
            _ThemeSwitcher(),
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }

  void _showLanguageBottomSheet(BuildContext context) {
    final tr = AppLocalizations.of(context)!;
    final colorScheme = Theme.of(context).colorScheme;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => Container(
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Theme.of(ctx).scaffoldBackgroundColor,
          borderRadius: const BorderRadius.vertical(top: Radius.circular(30)),
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(width: 40, height: 4, decoration: BoxDecoration(color: colorScheme.outlineVariant.withOpacity(0.4), borderRadius: BorderRadius.circular(2))),
            const SizedBox(height: 25),
            Text(tr.select_language, style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: colorScheme.onSurface)),
            const SizedBox(height: 20),
            BlocBuilder<LanguageCubit, LanguageState>(
              builder: (context, state) => Column(
                children: [
                  _buildLanguageOption(ctx, 'English', const Locale('en'), state.locale),
                  _buildLanguageOption(ctx, 'العربية', const Locale('ar'), state.locale),
                  _buildLanguageOption(ctx, 'Français', const Locale('fr'), state.locale),
                  _buildLanguageOption(ctx, 'Русский', const Locale('ru'), state.locale),
                  _buildLanguageOption(ctx, 'Türkçe', const Locale('tr'), state.locale),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildLanguageOption(BuildContext context, String title, Locale locale, Locale currentLocale) {
    final isSelected = locale == currentLocale;
    final colorScheme = Theme.of(context).colorScheme;

    return InkWell(
      onTap: () => _onLanguageChanged(context, locale),
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 200),
        margin: const EdgeInsets.symmetric(vertical: 4),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: isSelected ? colorScheme.primary.withOpacity(0.08) : Colors.transparent,
          borderRadius: BorderRadius.circular(15),
        ),
        child: Row(
          children: [
            Text(title, style: TextStyle(fontWeight: isSelected ? FontWeight.bold : FontWeight.normal, color: isSelected ? colorScheme.primary : colorScheme.onSurface)),
            if (isSelected) Icon(Icons.check_circle_rounded, color: colorScheme.primary, size: 20),
          ],
        ),
      ),
    );
  }

  void _onLanguageChanged(BuildContext context, Locale? value) {
    if (value != null) {
      context.read<LanguageCubit>().updateLanguage(value);
      Navigator.pop(context);
    }
  }
}

class _ThemeSwitcher extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final colorScheme = Theme.of(context).colorScheme;
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      padding: const EdgeInsets.all(6),
      decoration: BoxDecoration(
          color: isDark ? Colors.white.withOpacity(0.05) : Colors.grey.shade100,
          borderRadius: BorderRadius.circular(20)
      ),
      child: BlocBuilder<ThemeCubit, ThemeState>(
        builder: (context, state) {
          return Row(
            children: [
              _buildThemeToggle(context, 'Light', Icons.wb_sunny_rounded, state.themeMode == ThemeMode.light, ThemeMode.light),
              _buildThemeToggle(context, 'Dark', Icons.nightlight_round, state.themeMode == ThemeMode.dark, ThemeMode.dark),
            ],
          );
        },
      ),
    );
  }

  Widget _buildThemeToggle(BuildContext context, String title, IconData icon, bool isSelected, ThemeMode mode) {
    final colorScheme = Theme.of(context).colorScheme;
    return Expanded(
      child: GestureDetector(
        onTap: () => context.read<ThemeCubit>().changeTheme(mode),
        child: AnimatedContainer(
          duration: const Duration(milliseconds: 250),
          padding: const EdgeInsets.symmetric(vertical: 12),
          decoration: BoxDecoration(
            color: isSelected ? colorScheme.surface : Colors.transparent,
            borderRadius: BorderRadius.circular(15),
            boxShadow: isSelected ? [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 5)] : [],
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(icon, color: isSelected ? colorScheme.primary : colorScheme.onSurface.withOpacity(0.4), size: 18),
              const SizedBox(width: 8),
              Text(title, style: TextStyle(fontWeight: isSelected ? FontWeight.bold : FontWeight.normal, color: isSelected ? colorScheme.onSurface : colorScheme.onSurface.withOpacity(0.4))),
            ],
          ),
        ),
      ),
    );
  }
}

class PulsingLocationIcon extends StatefulWidget {
  final Color color;
  const PulsingLocationIcon({super.key, required this.color});

  @override
  State<PulsingLocationIcon> createState() => _PulsingLocationIconState();
}

class _PulsingLocationIconState extends State<PulsingLocationIcon> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    )..repeat(reverse: true);
    _animation = Tween<double>(begin: 1.0, end: 1.4).animate(
      CurvedAnimation(parent: _controller, curve: Curves.easeInOut),
    );
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return ScaleTransition(
      scale: _animation,
      child: Icon(Icons.location_on_rounded, color: widget.color, size: 14),
    );
  }
}
// =======================================================
// FILE PATH: lib\presentation\screens\splash_screen\splash_screen.dart
// =======================================================

import 'dart:async';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:go_router/go_router.dart';

import '../../../core/config/color/app_color.dart';
import '../../cubits/auth/auth_cubit.dart';
import '../../global_widgets/brand/build_branding.dart';
import '../../global_widgets/glowing_key/build_glowing_key.dart';

/// [SplashScreen]
///
/// An animated splash_screen that displays a logo and branding
/// before transitioning to the main application.
/// the main purpose of this screen is to load vital data from the server
/// moreover, it impacts an awesome user experience
class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  _SplashScreenState createState() => _SplashScreenState();
}

/// [SingleTickerProviderStateMixin]
///
/// To make the UI draw it self ~60 times per second
class _SplashScreenState extends State<SplashScreen>
    with SingleTickerProviderStateMixin {
  late AnimationController _animationController;

  late Animation<double> _fadeAnimation;

  late Animation<double> _scaleAnimation;

  bool _authStarted = false;

  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 5),
    );

    _fadeAnimation = Tween<double>(begin: 0.85, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    _scaleAnimation = Tween<double>(begin: 0.85, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    _animationController.forward();
    _animationController.addStatusListener((status) {
      if (status == AnimationStatus.completed && !_authStarted) {
        _authStarted = true;
        _startAuthCheckAndNavigate();
      }
    });

  }
  Future<void> _startAuthCheckAndNavigate() async {
    final authCubit = context.read<AuthCubit>();

    await authCubit.checkAuth();

    if (!mounted) return;

    final state = authCubit.state;
    if (state is AuthAuthenticated) {
      context.go('/home');
    } else {
      context.go('/login');
    }
  }

  @override
  void dispose() {
    _animationController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Theme.of(context).scaffoldBackgroundColor,
      body: Stack(
        children: [
          _buildBackgroundDecorations(),
          _BuildAnimatedLogoAndLoader(
            fadeAnimation: _fadeAnimation,
            scaleAnimation: _scaleAnimation,
          ),
          BuildBranding.metaStyle(),
        ],
      ),
    );
  }

  Widget _buildBackgroundDecorations() {
    return Stack(
      children: [
        PositionedDirectional(
          top: -30,
          end: -40,
          child: const BuildGlowingKey(size: 220,opacity: 0.16,rotation:  0.4, color: AppColors.primaryLight),
        ),
        PositionedDirectional(
          bottom: 100,
          start: -50,
          child: const BuildGlowingKey(size: 180,opacity: 0.14,rotation: -0.2, color: AppColors.primaryLight),
        ),
        PositionedDirectional(
          top: MediaQuery.of(context).size.height * 0.4,
          end: -20,
          child: const BuildGlowingKey(size: 100,opacity: 0.13,rotation: 0.8, color: AppColors.primaryLight),
        ),
      ],
    );
  }
}

/// [_BuildAnimatedLogoAndLoader]
///
/// A private widget class responsible for building the centered, animated logo
/// and the loading indicator.
class _BuildAnimatedLogoAndLoader extends StatelessWidget {
  final Animation<double> fadeAnimation;
  final Animation<double> scaleAnimation;

  const _BuildAnimatedLogoAndLoader({
    required this.fadeAnimation,
    required this.scaleAnimation,
  });

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          ScaleTransition(
            scale: scaleAnimation,
            child: FadeTransition(
              opacity: fadeAnimation,
              child: ShaderMask(
                shaderCallback: (bounds) => AppColors.premiumGoldGradient2.createShader(bounds),
                child: Image.asset(
                  'assets/icons/key_logo.png',
                  width: 150,
                  height: 150,
                  color: Colors.white,
                ),
              ),
            ),
          ),
          const SizedBox(height: 32),
          FadeTransition(
            opacity: CurvedAnimation(
              parent: fadeAnimation,
              curve: const Interval(0.3, 1.0, curve: Curves.easeIn),
            ),
            child: SizedBox(
              width: 120,
              child: ShaderMask(
                shaderCallback: (bounds) => AppColors.premiumGoldGradient2.createShader(bounds),
                child: LinearProgressIndicator(
                  backgroundColor: Theme.of(
                    context,
                  ).primaryColor.withOpacity(0.1),
                  valueColor: AlwaysStoppedAnimation<Color>(
                    Colors.yellow
                    //Theme.of(context).primaryColor,
                  ),
                  minHeight: 2.5,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
